<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuração de Campanha | AIC - Applied Intelligence Clustering</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/AIC/Imagens%20Vetor%20/AIC%20Icone%20Cheio.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0C1B33">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.25);
      --aic-green-subtle: rgba(14, 204, 151, 0.1);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-red: #ef4444;
      --aic-red-subtle: rgba(239, 68, 68, 0.1);
      --aic-yellow: #f59e0b;
      --aic-yellow-subtle: rgba(245, 158, 11, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      line-height: 1.7;
      min-height: 100vh;
    }

    /* Container */
    .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

    /* Header */
    .header {
      background: rgba(12, 27, 51, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--aic-border);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo {
      height: 36px;
      width: auto;
      filter: brightness(1.1);
    }
    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--aic-green-subtle);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--aic-green);
      font-weight: 500;
    }

    /* Main Content */
    .main {
      padding: 48px 0 80px;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 48px;
    }
    .page-title h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .page-title p {
      font-size: 16px;
      color: var(--aic-gray);
      max-width: 600px;
      margin: 0 auto;
    }

    /* Campaign Info Card */
    .campaign-info {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .campaign-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-gray);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }
    .campaign-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .detail-item {
      background: var(--aic-navy);
      border-radius: 10px;
      padding: 16px;
    }
    .detail-label {
      font-size: 12px;
      color: var(--aic-gray);
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--aic-white);
    }

    /* Warning Box */
    .warning-box {
      background: var(--aic-red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }
    .warning-box.yellow {
      background: var(--aic-yellow-subtle);
      border-color: rgba(245, 158, 11, 0.3);
    }
    .warning-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
      color: var(--aic-red);
      margin-bottom: 12px;
    }
    .warning-box.yellow .warning-title {
      color: var(--aic-yellow);
    }
    .warning-title::before {
      content: '!';
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--aic-red);
      color: white;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
    }
    .warning-box.yellow .warning-title::before {
      background: var(--aic-yellow);
    }
    .warning-box p {
      font-size: 14px;
      color: var(--aic-gray-light);
      line-height: 1.6;
    }
    .warning-box ul {
      margin: 12px 0 0 20px;
      font-size: 14px;
      color: var(--aic-gray-light);
    }
    .warning-box li {
      margin-bottom: 8px;
    }

    /* Section Card */
    .section-card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }
    .section-card.active {
      border-color: var(--aic-green);
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .section-number {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--aic-navy);
      flex-shrink: 0;
    }
    .section-title h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--aic-white);
      margin-bottom: 4px;
    }
    .section-title p {
      font-size: 14px;
      color: var(--aic-gray);
    }

    /* QR Code Area */
    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }
    .qr-placeholder {
      width: 280px;
      height: 280px;
      background: var(--aic-navy);
      border: 2px dashed var(--aic-border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .qr-placeholder.loading {
      border-color: var(--aic-green);
      animation: pulse 2s infinite;
    }
    .qr-placeholder.connected {
      border-color: var(--aic-green);
      border-style: solid;
      background: var(--aic-green-subtle);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .qr-placeholder img {
      max-width: 240px;
      max-height: 240px;
    }
    .qr-status {
      font-size: 14px;
      color: var(--aic-gray);
    }
    .qr-status.connected {
      color: var(--aic-green);
      font-weight: 600;
    }
    .qr-instructions {
      background: var(--aic-navy);
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
    }
    .qr-instructions h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .qr-instructions ol {
      margin-left: 20px;
      font-size: 13px;
      color: var(--aic-gray-light);
    }
    .qr-instructions li {
      margin-bottom: 8px;
    }

    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--aic-white);
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--aic-white);
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--aic-green);
    }
    .form-input::placeholder {
      color: var(--aic-gray);
    }
    .form-hint {
      font-size: 12px;
      color: var(--aic-gray);
      margin-top: 6px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Password Toggle */
    .password-wrapper {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--aic-gray);
      cursor: pointer;
      padding: 4px;
      font-size: 13px;
    }
    .password-toggle:hover {
      color: var(--aic-green);
    }

    /* Checkboxes */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 24px;
    }
    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--aic-green);
      flex-shrink: 0;
    }
    .checkbox-label {
      font-size: 14px;
      color: var(--aic-gray-light);
      line-height: 1.5;
    }
    .checkbox-label strong {
      color: var(--aic-white);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px var(--aic-green-glow);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--aic-border);
      color: var(--aic-white);
    }
    .btn-secondary:hover {
      border-color: var(--aic-green);
      background: var(--aic-green-subtle);
    }
    .btn-full {
      width: 100%;
    }

    /* Status Messages */
    .status-message {
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 20px;
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: var(--aic-green-subtle);
      border: 1px solid rgba(14, 204, 151, 0.3);
      color: var(--aic-green);
    }
    .status-message.error {
      background: var(--aic-red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--aic-red);
    }

    /* Progress Bar */
    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 40px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--aic-navy-light);
      border: 2px solid var(--aic-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--aic-gray);
    }
    .progress-dot.active {
      background: var(--aic-green);
      border-color: var(--aic-green);
      color: var(--aic-navy);
    }
    .progress-dot.completed {
      background: var(--aic-green-subtle);
      border-color: var(--aic-green);
      color: var(--aic-green);
    }
    .progress-line {
      width: 60px;
      height: 2px;
      background: var(--aic-border);
    }
    .progress-line.completed {
      background: var(--aic-green);
    }

    /* Footer */
    .footer {
      background: var(--aic-navy);
      border-top: 1px solid var(--aic-border);
      padding: 24px 0;
      text-align: center;
    }
    .footer p {
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .main { padding: 32px 0 60px; }
      .page-title h1 { font-size: 24px; }
      .section-card { padding: 24px 20px; }
      .form-row { grid-template-columns: 1fr; }
      .campaign-details { grid-template-columns: 1fr; }
      .progress-line { width: 30px; }
      .qr-placeholder { width: 240px; height: 240px; }
      .qr-placeholder img { max-width: 200px; max-height: 200px; }
    }

    @media (max-width: 480px) {
      .header-badge { display: none; }
      .progress-bar { flex-wrap: wrap; }
    }
  </style>
<link rel="stylesheet" href="/css/icons.css"></head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-content">
      <img src="/assets/AIC/Imagens%20Vetor%20/Logo%20Completo%20nome%20Branco%20sem%20fundo.png" alt="AIC" class="header-logo">
      <div class="header-badge">Configuração de Campanha</div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Page Title -->
      <div class="page-title">
        <h1>Configure sua Campanha</h1>
        <p>Conecte suas contas para iniciar o outreach (DM, follow, unfollow). Suas credenciais são criptografadas e nunca armazenadas em texto.</p>
      </div>

      <!-- Briefing Banner -->
      <div class="briefing-banner" id="briefing-banner" style="display: none;">
        <div class="briefing-banner-content">
          <div class="briefing-banner-icon">[B]</div>
          <div class="briefing-banner-text">
            <strong id="briefing-banner-title">Preencha o Briefing da Campanha</strong>
            <p id="briefing-banner-description">O briefing ajuda o agente de IA a personalizar as mensagens com seu diferencial competitivo e tom de voz.</p>
          </div>
          <div class="briefing-banner-progress" id="briefing-progress-container" style="display: none;">
            <span class="briefing-progress-text"><span id="briefing-progress">0</span>%</span>
            <div class="briefing-progress-bar">
              <div class="briefing-progress-fill" id="briefing-progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <a href="#" class="btn btn-primary btn-sm" id="briefing-banner-btn">Preencher Briefing</a>
        </div>
      </div>

      <style>
        .briefing-banner {
          background: linear-gradient(135deg, var(--aic-navy-light), var(--aic-navy-lighter));
          border: 1px solid var(--aic-green);
          border-radius: 16px;
          padding: 20px 24px;
          margin-bottom: 32px;
          box-shadow: 0 0 20px var(--aic-green-glow);
        }
        .briefing-banner-content {
          display: flex;
          align-items: center;
          gap: 16px;
          flex-wrap: wrap;
        }
        .briefing-banner-icon {
          font-size: 32px;
          flex-shrink: 0;
        }
        .briefing-banner-text {
          flex: 1;
          min-width: 200px;
        }
        .briefing-banner-text strong {
          display: block;
          font-size: 16px;
          color: var(--aic-white);
          margin-bottom: 4px;
        }
        .briefing-banner-text p {
          font-size: 13px;
          color: var(--aic-gray-light);
          margin: 0;
        }
        .briefing-banner-progress {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .briefing-progress-text {
          font-size: 14px;
          font-weight: 600;
          color: var(--aic-green);
          min-width: 40px;
        }
        .briefing-progress-bar {
          width: 80px;
          height: 6px;
          background: var(--aic-navy);
          border-radius: 3px;
          overflow: hidden;
        }
        .briefing-progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--aic-green), var(--aic-green-dark));
          transition: width 0.3s ease;
        }
        .btn-sm {
          padding: 10px 20px;
          font-size: 14px;
        }
        .briefing-banner.completed {
          border-color: var(--aic-green);
          background: var(--aic-green-subtle);
        }
        .briefing-banner.completed .briefing-banner-icon::before {
          content: '';
        }
        @media (max-width: 768px) {
          .briefing-banner-content {
            flex-direction: column;
            text-align: center;
          }
          .briefing-banner-progress {
            justify-content: center;
          }
        }
      </style>

      <!-- Progress Bar (3 steps: WhatsApp, Instagram, Finalizar) -->
      <div class="progress-bar">
        <div class="progress-step">
          <div class="progress-dot active" id="progress-1">1</div>
        </div>
        <div class="progress-line" id="line-1"></div>
        <div class="progress-step">
          <div class="progress-dot" id="progress-2">2</div>
        </div>
        <div class="progress-line" id="line-2"></div>
        <div class="progress-step">
          <div class="progress-dot" id="progress-3">3</div>
        </div>
      </div>

      <!-- Campaign Selector (shown when no campaign ID in URL) -->
      <div class="section-card" id="campaign-selector" style="display: none;">
        <div class="section-header">
          <div class="section-number">0</div>
          <div class="section-title">
            <h2>Selecione sua Campanha</h2>
            <p>Escolha a campanha que deseja configurar</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="campaign-dropdown">Campanhas Disponíveis</label>
          <select id="campaign-dropdown" class="form-input" onchange="selectCampaign()">
            <option value="">-- Selecione uma campanha --</option>
          </select>
          <p class="form-hint">Mostrando campanhas pendentes de configuração</p>
        </div>

        <div id="selected-campaign-preview" style="display: none; margin-top: 20px;">
          <div class="campaign-details">
            <div class="detail-item">
              <div class="detail-label">Campanha</div>
              <div class="detail-value" id="preview-name">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Nicho</div>
              <div class="detail-value" id="preview-nicho">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Empresa</div>
              <div class="detail-value" id="preview-business">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status Atual</div>
              <div class="detail-value" id="preview-status">-</div>
            </div>
          </div>

          <button class="btn btn-primary btn-full" onclick="confirmCampaignSelection()" style="margin-top: 20px;">
            Iniciar Configuração desta Campanha
          </button>
        </div>

        <div class="status-message" id="selector-status"></div>
      </div>

      <!-- Campaign Info (shown when campaign is selected) -->
      <div class="campaign-info" id="campaign-info" style="display: none;">
        <h3>Dados da Campanha</h3>
        <div class="campaign-details">
          <div class="detail-item">
            <div class="detail-label">Campanha</div>
            <div class="detail-value" id="campaign-name">Carregando...</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Nicho</div>
            <div class="detail-value" id="campaign-nicho">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Canais</div>
            <div class="detail-value" id="campaign-channels">WhatsApp + Instagram</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value" id="campaign-status">Aguardando configuração</div>
          </div>
        </div>
      </div>

      <!-- Important Warnings -->
      <div class="warning-box">
        <div class="warning-title">Aviso Importante sobre Riscos</div>
        <p>O envio de mensagens e interações via WhatsApp e Instagram envolve riscos inerentes ao uso das plataformas:</p>
        <ul>
          <li><strong>Restrição temporária:</strong> As plataformas podem restringir temporariamente sua conta se detectarem atividade incomum.</li>
          <li><strong>Bloqueio de conta:</strong> Em casos extremos, as contas podem ser bloqueadas. Mitigamos com limites rígidos de envio e comportamento humanizado.</li>
          <li><strong>Recuperação:</strong> Possuímos protocolos de recuperação, mas não garantimos 100% de sucesso em todos os casos.</li>
        </ul>
      </div>

      <div class="warning-box yellow">
        <div class="warning-title">Segurança das Conexões</div>
        <p><strong>WhatsApp:</strong> Conexão via QR Code - nunca pedimos sua senha. <strong>Instagram:</strong> Conexão via OAuth do Facebook - autorizamos acesso à API oficial sem precisar de senha. Todos os tokens são criptografados com AES-256-GCM (padrão bancário) e você pode revogar o acesso a qualquer momento.</p>
      </div>

      <!-- SEO + Tracking -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-number">SEO</div>
          <div class="section-title">
            <h2>SEO + Tracking da Landing</h2>
            <p>Para medir os CTAs e atribuir cliques a leads reais.</p>
          </div>
        </div>
        <ul class="section-list">
          <li><strong>Analytics ativo</strong> (GA4, Plausible ou Umami) com domínio autorizado.</li>
          <li><strong>Eventos por CTA</strong> (WhatsApp, formulário, “Falar com especialista”) usando IDs únicos.</li>
          <li><strong>UTMs padronizadas</strong> nas campanhas: `utm_source`, `utm_medium`, `utm_campaign`.</li>
          <li><strong>Identificação no lead</strong>: ao enviar formulário ou abrir WhatsApp, conectamos o clique anterior ao prospect.</li>
          <li><strong>LGPD</strong>: cláusula “Coleta de dados de navegação para fins analíticos”; banner de cookies + política de privacidade publicada pelo cliente.</li>
        </ul>
      </div>

      <!-- Section 1: WhatsApp (Partner API) -->
      <div class="section-card" id="section-whatsapp">
        <div class="section-header">
          <div class="section-number">1</div>
          <div class="section-title">
            <h2>Conexão WhatsApp</h2>
            <p>Conecte o WhatsApp da campanha para envio de mensagens</p>
          </div>
        </div>

        <div class="qr-container">
          <div class="qr-placeholder" id="qr-placeholder">
            <span class="qr-status" id="qr-status">Clique para conectar WhatsApp</span>
          </div>

          <button class="btn btn-secondary" id="btn-generate-qr" onclick="connectWhatsApp()">
            Conectar WhatsApp
          </button>

          <div class="qr-instructions">
            <h4>Como conectar:</h4>
            <ol>
              <li>Clique em "Conectar WhatsApp"</li>
              <li>Abra o WhatsApp no seu celular</li>
              <li>Vá em Configurações → Aparelhos conectados</li>
              <li>Toque em "Conectar um aparelho"</li>
              <li>Escaneie o QR Code exibido acima</li>
            </ol>
          </div>

          <div class="warning-box yellow" style="margin-top: 20px;">
            <div class="warning-title">Recomendação: Número Dedicado</div>
            <p>Recomendamos fortemente utilizar um <strong>número de celular dedicado</strong> para esta campanha. Isso protege seu número pessoal/comercial principal de possíveis restrições e permite melhor controle da comunicação com leads.</p>
          </div>
        </div>

        <div class="status-message" id="whatsapp-status"></div>
      </div>

      <!-- Section 2: Instagram (OAuth) -->
      <div class="section-card" id="section-instagram">
        <div class="section-header">
          <div class="section-number">2</div>
          <div class="section-title">
            <h2>Conexão Instagram Business</h2>
            <p>Conecte sua conta Instagram Business via Facebook para envio de DMs</p>
          </div>
        </div>

        <!-- Pré-requisitos -->
        <div class="warning-box yellow" style="margin-bottom: 24px;">
          <div class="warning-title">Pré-requisitos Obrigatórios</div>
          <ol style="margin: 12px 0 0 20px; line-height: 1.8;">
            <li><strong>Conta Instagram Business ou Creator</strong> - Converta sua conta em Configurações → Conta → Mudar para conta profissional</li>
            <li><strong>Facebook Page vinculada</strong> - Conecte seu Instagram a uma Facebook Page em Configurações → Conta → Compartilhamento com outras plataformas</li>
            <li><strong>Acesso de Admin à Page</strong> - Você precisa ser administrador da Facebook Page vinculada</li>
          </ol>
        </div>

        <!-- Status da conexão -->
        <div id="instagram-connection-status" class="qr-container" style="margin-bottom: 24px;">
          <div class="qr-placeholder" id="ig-status-placeholder">
            <span class="qr-status" id="ig-status-text">Clique para conectar via Facebook</span>
          </div>

          <button class="btn btn-primary" id="btn-connect-instagram" onclick="connectInstagram()" style="margin-top: 16px;">
            <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/>
            </svg>
            Conectar com Facebook
          </button>
        </div>

        <!-- Conta conectada (oculto inicialmente) -->
        <div id="instagram-connected-info" style="display: none;">
          <div style="display: flex; align-items: center; gap: 16px; padding: 20px; background: var(--aic-green-subtle); border-radius: 12px; border: 1px solid rgba(14, 204, 151, 0.3);">
            <img id="ig-profile-pic" src="" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--aic-green);">
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 18px; color: var(--aic-white);">@<span id="ig-connected-username"></span></div>
              <div style="color: var(--aic-gray); font-size: 14px;">Instagram Business conectado</div>
            </div>
            <span style="font-size: 32px; color: var(--aic-green);">✓</span>
          </div>

          <button class="btn btn-secondary" onclick="disconnectInstagram()" style="margin-top: 16px; width: 100%;">
            Desconectar Instagram
          </button>
        </div>

        <div class="warning-box" style="margin-top: 20px; border-color: var(--aic-green); background: var(--aic-green-subtle);">
          <div class="warning-title" style="color: var(--aic-green);">Segurança via OAuth</div>
          <p><strong>Nunca pedimos sua senha!</strong> A conexão é feita via autorização segura do Facebook/Meta. Você pode revogar o acesso a qualquer momento nas configurações do Facebook.</p>
        </div>

        <div class="warning-box" style="margin-top: 16px;">
          <div class="warning-title">Sobre a Prospecção de Leads</div>
          <p>A <strong>prospecção de leads</strong> (busca de perfis e hashtags) é realizada pela AIC através de contas próprias. Sua conta Instagram será utilizada exclusivamente para <strong>interações de outreach</strong>: envio de DMs aos leads já qualificados.</p>
        </div>

        <div class="status-message" id="instagram-status"></div>
      </div>

      <!-- Section 3: Cliente Contact Info (Destino dos Leads) -->
      <div class="section-card" id="section-client-contact">
        <div class="section-header">
          <div class="section-number">3</div>
          <div class="section-title">
            <h2>Informações de Contato do Cliente</h2>
            <p>Para onde devemos direcionar os leads quentes (interessados)?</p>
          </div>
        </div>

        <div class="warning-box" style="margin-bottom: 24px; border-color: var(--aic-green); background: var(--aic-green-subtle);">
          <div class="warning-title" style="color: var(--aic-green);"><span class="ic ic-phone"></span> Direcionamento de Leads Quentes</div>
          <p>Quando um lead demonstrar interesse genuíno (responder positivamente às DMs, fazer perguntas sobre seus serviços), <strong>encaminharemos as informações dele para o WhatsApp informado abaixo</strong>.</p>
          <p style="margin-top: 8px;"><span class="ic ic-warn"></span> <strong>Atenção:</strong> Este número pode ser diferente do número usado para conexão WhatsApp nas etapas anteriores. Aqui você informa para qual número <strong>VOCÊ quer receber os leads</strong>.</p>
        </div>

        <form id="client-contact-form" onsubmit="return saveClientContact(event)">
          <div class="form-group">
            <label class="form-label" for="client-contact-name">Nome do Responsável pelos Leads *</label>
            <input type="text" id="client-contact-name" class="form-input" placeholder="Ex: João Silva" required>
            <p class="form-hint">Nome da pessoa que vai receber e gerenciar os leads</p>
          </div>

          <div class="form-group">
            <label class="form-label" for="client-whatsapp-number">WhatsApp para Receber Leads *</label>
            <input type="tel" id="client-whatsapp-number" class="form-input" placeholder="+55 11 99999-9999" required pattern="[\+]?[0-9\s\-\(\)]+">
            <p class="form-hint">Número com DDI e DDD (ex: +55 11 99904-0605). Este é o número que receberá os contatos dos leads interessados.</p>
          </div>

          <div class="warning-box yellow" style="margin-top: 20px;">
            <div class="warning-title">Como funciona o encaminhamento?</div>
            <p>1. Nossos agentes IA identificam leads que demonstram interesse<br>
            2. Validamos se o interesse é genuíno (não é spam ou resposta automática)<br>
            3. Enviamos para você via WhatsApp: nome do lead, Instagram, contexto da conversa<br>
            4. Você assume o contato e fecha a venda!</p>
          </div>

          <div class="status-message" id="client-contact-status"></div>

          <button type="submit" class="btn btn-primary btn-full" id="btn-save-client-contact" style="margin-top: 20px;">
            Salvar Informações de Contato
          </button>
        </form>
      </div>

      <!-- Section 5: Terms -->
      <div class="section-card" id="section-terms">
        <div class="section-header">
          <div class="section-number">5</div>
          <div class="section-title">
            <h2>Termos e Confirmação</h2>
            <p>Leia e aceite os termos para finalizar a configuração</p>
          </div>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="term-risks" required>
            <label class="checkbox-label" for="term-risks">
              <strong>Entendo os riscos:</strong> Estou ciente de que o envio de mensagens e interações pode resultar em restrições temporárias ou bloqueios nas plataformas, e que a AIC mitiga mas não elimina completamente esses riscos.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-credentials" required>
            <label class="checkbox-label" for="term-credentials">
              <strong>Autorizo o uso das credenciais:</strong> Autorizo a AIC a utilizar as credenciais fornecidas exclusivamente para execução da campanha contratada, com criptografia e auditoria de acesso.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-limits" required>
            <label class="checkbox-label" for="term-limits">
              <strong>Concordo com os limites:</strong> Entendo que serão respeitados limites de 15 msgs/hora (WhatsApp) e 10 ações/hora (Instagram) para proteger as contas, podendo impactar o volume total.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-dedicated" required>
            <label class="checkbox-label" for="term-dedicated">
              <strong>Número dedicado:</strong> Confirmo que o número de WhatsApp fornecido é dedicado para esta campanha e entendo que não devo usá-lo simultaneamente para outras atividades durante a execução.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-lgpd" required>
            <label class="checkbox-label" for="term-lgpd">
              <strong>Conformidade LGPD:</strong> Confirmo que os dados utilizados são públicos e que o contato será feito com base em legítimo interesse, respeitando opt-out imediato quando solicitado.
            </label>
          </div>
        </div>

        <button class="btn btn-primary btn-full" id="btn-finalize" onclick="finalizeSetup()" disabled style="margin-top: 32px;">
          Finalizar Configuração
        </button>

        <div class="status-message" id="final-status"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>AIC - Applied Intelligence Clustering | Suas credenciais são criptografadas e protegidas</p>
    </div>
  </footer>

  <script>
    // State
    let campaignId = null;
    let whatsappConnected = false;
    let instagramSaved = false;
    let clientContactSaved = false;
    let whatsappChannelId = null; // Partner API channel ID
    let availableCampaigns = [];

    // Get campaign ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    campaignId = urlParams.get('campaign');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      if (campaignId) {
        // Campaign ID provided - show normal flow
        showOnboardingFlow();
        loadCampaignInfo();
        loadBriefingStatus();

        // Check Instagram OAuth callback (if returning from Facebook)
        handleInstagramOAuthCallback();

        // Check Instagram connection status
        checkInstagramStatus();
      } else {
        // No campaign ID - show selector
        showCampaignSelector();
        loadAvailableCampaigns();
      }

      // Setup checkbox listeners
      const checkboxes = document.querySelectorAll('#section-terms input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.addEventListener('change', checkTermsComplete);
      });
    });

    // Load briefing status
    async function loadBriefingStatus() {
      if (!campaignId) return;

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/briefing`);
        const banner = document.getElementById('briefing-banner');
        const bannerBtn = document.getElementById('briefing-banner-btn');
        const bannerTitle = document.getElementById('briefing-banner-title');
        const bannerDesc = document.getElementById('briefing-banner-description');
        const progressContainer = document.getElementById('briefing-progress-container');
        const progressText = document.getElementById('briefing-progress');
        const progressFill = document.getElementById('briefing-progress-fill');

        // Update button link
        bannerBtn.href = `/aic-campaign-briefing.html?campaign=${campaignId}`;

        if (response.ok) {
          const briefing = await response.json();

          if (briefing && briefing.completion_percentage !== undefined) {
            const completion = briefing.completion_percentage || 0;

            // Show progress
            progressContainer.style.display = 'flex';
            progressText.textContent = completion;
            progressFill.style.width = `${completion}%`;

            if (completion >= 80) {
              // Completed
              banner.classList.add('completed');
              bannerTitle.textContent = 'Briefing Completo';
              bannerDesc.textContent = 'O agente de IA já possui contexto completo sobre seu negócio e diferencial.';
              bannerBtn.textContent = 'Ver Briefing';
              document.querySelector('.briefing-banner-icon').textContent = '<span class="ic ic-ok"></span>';
            } else if (completion >= 30) {
              // In progress
              bannerTitle.textContent = 'Continue o Briefing';
              bannerDesc.textContent = `${completion}% preenchido. Complete para melhor personalização das mensagens.`;
              bannerBtn.textContent = 'Continuar';
            } else {
              // Just started
              bannerTitle.textContent = 'Preencha o Briefing da Campanha';
              bannerDesc.textContent = 'O briefing ajuda o agente de IA a destacar seu diferencial competitivo nas conversas.';
              bannerBtn.textContent = 'Preencher';
            }
          } else {
            // No briefing yet
            bannerTitle.textContent = 'Preencha o Briefing da Campanha';
            bannerDesc.textContent = 'Informe seu diferencial competitivo, tom de voz e perfil do cliente ideal para personalizar as mensagens.';
            bannerBtn.textContent = 'Começar';
          }
        } else {
          // Error or no briefing
          bannerTitle.textContent = 'Preencha o Briefing da Campanha';
          bannerDesc.textContent = 'Informe seu diferencial competitivo, tom de voz e perfil do cliente ideal para personalizar as mensagens.';
          bannerBtn.textContent = 'Começar';
        }

        banner.style.display = 'block';
      } catch (error) {
        console.error('Erro ao carregar briefing:', error);
        // Still show the banner with default text
        const banner = document.getElementById('briefing-banner');
        const bannerBtn = document.getElementById('briefing-banner-btn');
        bannerBtn.href = `/aic-campaign-briefing.html?campaign=${campaignId}`;
        banner.style.display = 'block';
      }
    }

    // Show campaign selector
    function showCampaignSelector() {
      document.getElementById('campaign-selector').style.display = 'block';
      document.getElementById('campaign-info').style.display = 'none';
      document.getElementById('section-whatsapp').style.display = 'none';
      document.getElementById('section-instagram').style.display = 'none';
      document.getElementById('section-client-contact').style.display = 'none';
      document.getElementById('section-terms').style.display = 'none';
      document.querySelector('.progress-bar').style.display = 'none';

      // Hide warnings until campaign is selected
      const warnings = document.querySelectorAll('.warning-box');
      warnings.forEach(w => w.style.display = 'none');
    }

    // Show onboarding flow
    function showOnboardingFlow() {
      document.getElementById('campaign-selector').style.display = 'none';
      document.getElementById('campaign-info').style.display = 'block';
      document.getElementById('section-whatsapp').style.display = 'block';
      document.getElementById('section-instagram').style.display = 'block';
      document.getElementById('section-client-contact').style.display = 'block';
      document.getElementById('section-terms').style.display = 'block';
      document.querySelector('.progress-bar').style.display = 'flex';

      // Show warnings
      const warnings = document.querySelectorAll('.warning-box');
      warnings.forEach(w => w.style.display = 'block');
    }

    // Load available campaigns
    async function loadAvailableCampaigns() {
      try {
        const response = await fetch('/api/campaigns/available');
        if (response.ok) {
          availableCampaigns = await response.json();
          populateCampaignDropdown();
        } else {
          showStatus('selector-status', 'Erro ao carregar campanhas disponíveis.', 'error');
        }
      } catch (error) {
        console.error('Erro ao carregar campanhas:', error);
        showStatus('selector-status', 'Erro de conexão. Tente novamente.', 'error');
      }
    }

    // Populate dropdown
    function populateCampaignDropdown() {
      const dropdown = document.getElementById('campaign-dropdown');
      dropdown.innerHTML = '<option value="">-- Selecione uma campanha --</option>';

      if (availableCampaigns.length === 0) {
        dropdown.innerHTML += '<option value="" disabled>Nenhuma campanha disponível</option>';
        showStatus('selector-status', 'Nenhuma campanha pendente de configuração encontrada.', 'error');
        return;
      }

      availableCampaigns.forEach(campaign => {
        const statusIcon = campaign.needsOnboarding ? '' : (campaign.hasWhatsApp || campaign.hasInstagram ? ' (parcial)' : '');
        const option = document.createElement('option');
        option.value = campaign.id;
        option.textContent = `${campaign.campaign_name || 'Sem nome'}${statusIcon} - ${campaign.nicho_principal || 'Sem nicho'}`;
        dropdown.appendChild(option);
      });
    }

    // Handle campaign selection from dropdown
    function selectCampaign() {
      const dropdown = document.getElementById('campaign-dropdown');
      const selectedId = dropdown.value;
      const preview = document.getElementById('selected-campaign-preview');

      if (!selectedId) {
        preview.style.display = 'none';
        return;
      }

      const campaign = availableCampaigns.find(c => c.id === selectedId);
      if (campaign) {
        document.getElementById('preview-name').textContent = campaign.campaign_name || '-';
        document.getElementById('preview-nicho').textContent = campaign.nicho_principal || '-';
        document.getElementById('preview-business').textContent = campaign.business_name || '-';

        let statusText = campaign.status || 'Pendente';
        if (campaign.hasWhatsApp) statusText += ' | WhatsApp: ' + (campaign.whatsappStatus || 'config');
        if (campaign.hasInstagram) statusText += ' | Instagram: ' + (campaign.instagramStatus || 'config');
        document.getElementById('preview-status').textContent = statusText;

        preview.style.display = 'block';
      }
    }

    // Confirm campaign selection and start onboarding
    function confirmCampaignSelection() {
      const dropdown = document.getElementById('campaign-dropdown');
      const selectedId = dropdown.value;

      if (!selectedId) {
        showStatus('selector-status', 'Selecione uma campanha primeiro.', 'error');
        return;
      }

      // Update URL with campaign ID
      const newUrl = window.location.pathname + '?campaign=' + selectedId;
      window.history.pushState({ campaign: selectedId }, '', newUrl);

      // Set campaign ID and show onboarding
      campaignId = selectedId;
      showOnboardingFlow();
      loadCampaignInfo();
    }

    // Load campaign info
    async function loadCampaignInfo() {
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        if (response.ok) {
          const campaign = await response.json();
          document.getElementById('campaign-name').textContent = campaign.campaign_name || 'Campanha';
          document.getElementById('campaign-nicho').textContent = campaign.nicho_principal || '-';
          document.getElementById('campaign-status').textContent = campaign.status || 'Aguardando';
        }
      } catch (error) {
        console.error('Erro ao carregar campanha:', error);
      }
    }

    // Connect WhatsApp via Partner API
    async function connectWhatsApp() {
      const btn = document.getElementById('btn-generate-qr');
      const placeholder = document.getElementById('qr-placeholder');
      const status = document.getElementById('qr-status');

      if (!campaignId) {
        showStatus('whatsapp-status', 'Selecione uma campanha primeiro.', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Conectando...';
      placeholder.classList.add('loading');
      status.textContent = 'Preparando conexão...';

      try {
        // Step 1: Check if campaign already has a channel
        const statusResponse = await fetch(`/api/campaigns/${campaignId}/whatsapp/status`);
        const statusData = await statusResponse.json();

        if (statusData.connected) {
          // Already connected
          handleWhatsAppConnected(statusData.phone);
          return;
        }

        // Step 2: Create channel if needed
        if (!statusData.hasChannel) {
          status.textContent = 'Criando canal WhatsApp...';

          const createResponse = await fetch(`/api/campaigns/${campaignId}/whatsapp/channel`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!createResponse.ok) {
            const errorData = await createResponse.json();
            throw new Error(errorData.error || 'Erro ao criar canal WhatsApp');
          }

          const createData = await createResponse.json();
          whatsappChannelId = createData.channel?.id;
        } else {
          whatsappChannelId = statusData.channelId;
        }

        // Step 3: Get QR Code
        status.textContent = 'Gerando QR Code...';

        const qrResponse = await fetch(`/api/campaigns/${campaignId}/whatsapp/qr`);
        const qrData = await qrResponse.json();

        if (qrData.connected) {
          handleWhatsAppConnected(qrData.phone);
          return;
        }

        if (qrData.qrCode) {
          // Display QR Code (handle both base64 and data URI formats)
          const qrSrc = qrData.qrCode.startsWith('data:')
            ? qrData.qrCode
            : `data:image/png;base64,${qrData.qrCode}`;

          placeholder.innerHTML = `<img src="${qrSrc}" alt="QR Code WhatsApp">`;
          status.textContent = 'Escaneie o QR Code com seu WhatsApp';
          placeholder.classList.remove('loading');

          // Start polling for connection status
          pollWhatsAppStatus();
        } else {
          throw new Error('QR Code não disponível. Tente novamente.');
        }

      } catch (error) {
        console.error('Erro:', error);
        showStatus('whatsapp-status', error.message || 'Erro ao conectar WhatsApp. Tente novamente.', 'error');
        placeholder.classList.remove('loading');
        status.textContent = 'Clique para tentar novamente';
      }

      btn.disabled = false;
      btn.textContent = 'Conectar WhatsApp';
    }

    // Poll for WhatsApp connection status
    async function pollWhatsAppStatus() {
      if (!campaignId) return;

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/whatsapp/status`);
        if (response.ok) {
          const data = await response.json();

          if (data.connected) {
            handleWhatsAppConnected(data.phone);
            return;
          }
        }

        // Continue polling every 3 seconds
        setTimeout(pollWhatsAppStatus, 3000);

      } catch (error) {
        console.error('Erro ao verificar status:', error);
        setTimeout(pollWhatsAppStatus, 5000);
      }
    }

    // Handle WhatsApp connected
    function handleWhatsAppConnected(phone) {
      const placeholder = document.getElementById('qr-placeholder');
      const status = document.getElementById('qr-status');

      placeholder.classList.remove('loading');
      placeholder.classList.add('connected');
      placeholder.innerHTML = '<span style="font-size: 48px; color: var(--aic-green);">&#10003;</span>';

      const phoneDisplay = phone ? ` (${phone})` : '';
      status.textContent = `WhatsApp conectado${phoneDisplay}!`;
      status.classList.add('connected');

      document.getElementById('btn-generate-qr').style.display = 'none';

      whatsappConnected = true;
      updateProgress();
      showStatus('whatsapp-status', `WhatsApp conectado com sucesso${phoneDisplay}!`, 'success');

      // Configure webhook automatically
      configureWebhook();
    }

    // Configure webhook after connection
    async function configureWebhook() {
      try {
        await fetch(`/api/campaigns/${campaignId}/whatsapp/webhook`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        console.log('Webhook configurado automaticamente');
      } catch (error) {
        console.error('Erro ao configurar webhook:', error);
      }
    }

    // =====================================================
    // INSTAGRAM OAUTH FUNCTIONS
    // =====================================================

    // Connect Instagram via OAuth (redirects to Facebook)
    function connectInstagram() {
      if (!campaignId) {
        showStatus('instagram-status', 'Erro: Campaign ID não encontrado', 'error');
        return;
      }

      // Redireciona para iniciar OAuth
      window.location.href = `/api/instagram/oauth/authorize?campaignId=${campaignId}`;
    }

    // Check Instagram connection status
    async function checkInstagramStatus() {
      if (!campaignId) return;

      try {
        const response = await fetch(`/api/instagram/oauth/status/${campaignId}`);
        const status = await response.json();

        if (status.connected) {
          handleInstagramConnected(status.username, status.profile_picture_url);
        } else if (status.error) {
          showStatus('instagram-status', status.error, 'error');
        }
      } catch (error) {
        console.error('Erro ao verificar status Instagram:', error);
      }
    }

    // Handle Instagram connected state
    function handleInstagramConnected(username, profilePicUrl) {
      instagramSaved = true;
      updateProgress();

      // Hide connection button, show connected info
      document.getElementById('instagram-connection-status').style.display = 'none';
      document.getElementById('instagram-connected-info').style.display = 'block';

      // Update connected account info
      document.getElementById('ig-connected-username').textContent = username;
      if (profilePicUrl) {
        document.getElementById('ig-profile-pic').src = profilePicUrl;
      } else {
        document.getElementById('ig-profile-pic').src = `https://ui-avatars.com/api/?name=${username}&background=0ecc97&color=fff`;
      }

      showStatus('instagram-status', `Conta @${username} conectada com sucesso!`, 'success');
    }

    // Disconnect Instagram account
    async function disconnectInstagram() {
      if (!campaignId) return;

      if (!confirm('Tem certeza que deseja desconectar sua conta Instagram?')) {
        return;
      }

      try {
        const response = await fetch(`/api/instagram/oauth/disconnect/${campaignId}`, {
          method: 'POST'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erro ao desconectar');
        }

        // Reset UI
        instagramSaved = false;
        document.getElementById('instagram-connection-status').style.display = 'block';
        document.getElementById('instagram-connected-info').style.display = 'none';
        showStatus('instagram-status', 'Conta desconectada', 'success');
        updateProgress();

      } catch (error) {
        console.error('Erro ao desconectar Instagram:', error);
        showStatus('instagram-status', error.message, 'error');
      }
    }

    // Handle OAuth callback parameters
    function handleInstagramOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);

      if (urlParams.has('instagram_connected')) {
        const username = urlParams.get('instagram_username') || '';
        handleInstagramConnected(username, null);

        // Clean up URL
        const newUrl = window.location.pathname + `?campaign=${campaignId}`;
        window.history.replaceState({}, '', newUrl);
      }

      if (urlParams.has('instagram_error')) {
        const error = urlParams.get('instagram_error');
        showStatus('instagram-status', decodeURIComponent(error), 'error');

        // Clean up URL
        const newUrl = window.location.pathname + `?campaign=${campaignId}`;
        window.history.replaceState({}, '', newUrl);
      }
    }

    // =====================================================
    // CLIENT CONTACT FUNCTIONS
    // =====================================================

    // Save client contact information
    async function saveClientContact(event) {
      event.preventDefault();

      const btn = document.getElementById('btn-save-client-contact');
      const contactName = document.getElementById('client-contact-name').value;
      const whatsappNumber = document.getElementById('client-whatsapp-number').value;

      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/client-contact`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            clientContactName: contactName,
            clientWhatsappNumber: whatsappNumber
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao salvar informações de contato');
        }

        clientContactSaved = true;
        updateProgress();
        showStatus('client-contact-status', 'Informações salvas com sucesso!', 'success');

        // Disable form
        document.getElementById('client-contact-name').disabled = true;
        document.getElementById('client-whatsapp-number').disabled = true;
        btn.textContent = 'Informações Salvas ✓';

      } catch (error) {
        console.error('Erro:', error);
        showStatus('client-contact-status', error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Salvar Informações de Contato';
      }
    }

    // Check if all terms are accepted
    function checkTermsComplete() {
      const checkboxes = document.querySelectorAll('#section-terms input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      document.getElementById('btn-finalize').disabled = !allChecked;
    }

    // Update progress indicators
    function updateProgress() {
      const progress1 = document.getElementById('progress-1');
      const progress2 = document.getElementById('progress-2');
      const progress3 = document.getElementById('progress-3');
      const line1 = document.getElementById('line-1');
      const line2 = document.getElementById('line-2');

      // Step 1: WhatsApp
      if (whatsappConnected) {
        progress1.classList.remove('active');
        progress1.classList.add('completed');
        progress1.innerHTML = '&#10003;';
        line1.classList.add('completed');
        progress2.classList.add('active');
      }

      // Step 2: Instagram
      if (instagramSaved) {
        progress2.classList.remove('active');
        progress2.classList.add('completed');
        progress2.innerHTML = '&#10003;';
        line2.classList.add('completed');
        progress3.classList.add('active');
      }

      // Step 3: Client Contact (implicit - completed on finalize)
    }

    // Finalize setup
    async function finalizeSetup() {
      const btn = document.getElementById('btn-finalize');

      if (!whatsappConnected && !instagramSaved) {
        showStatus('final-status', 'Configure pelo menos um canal (WhatsApp ou Instagram) antes de finalizar.', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Finalizando...';

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/activate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            whatsappSessionId: sessionId,
            termsAccepted: true,
            termsAcceptedAt: new Date().toISOString()
          })
        });

        if (!response.ok) {
          throw new Error('Erro ao finalizar configuração');
        }

        // Integrar com Journey: marcar credenciais como completas
        const journeyId = urlParams.get('journey');
        if (journeyId) {
          try {
            await fetch(`/api/aic/journey/${journeyId}/credentials-complete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            console.log('Journey updated: credentials complete');
          } catch (journeyError) {
            console.warn('Could not update journey:', journeyError);
          }
        }

        showStatus('final-status', 'Configuração finalizada com sucesso! Sua campanha está pronta para iniciar.', 'success');
        btn.textContent = 'Configuração Concluída';

        // Mark all progress as complete
        document.getElementById('progress-4').classList.remove('active');
        document.getElementById('progress-4').classList.add('completed');
        document.getElementById('progress-4').innerHTML = '&#10003;';

        // Redirect after delay - go to briefing if journey exists
        setTimeout(() => {
          if (journeyId) {
            window.location.href = `/aic-campaign-briefing.html?campaign=${campaignId}&journey=${journeyId}`;
          } else {
            window.location.href = `/aic-dashboard-campaign.html?campaign=${campaignId}`;
          }
        }, 3000);

      } catch (error) {
        console.error('Erro:', error);
        showStatus('final-status', error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Finalizar Configuração';
      }
    }

    // Show status message
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status-message show ${type}`;
    }
  </script>

  <!-- Sidebar Menu Component -->
  <script src="/components/aic-sidebar.js"></script>
</body>
</html>
