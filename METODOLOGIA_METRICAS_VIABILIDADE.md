# üìä METODOLOGIA E VIABILIDADE DAS M√âTRICAS PROPOSTAS

**Data:** 30 de Julho de 2025  
**Sistema:** Universal Booking System (UBS)  
**An√°lise:** Metodologia + Disponibilidade de Dados

---

## üìã **DADOS DISPON√çVEIS NO SISTEMA**

### **üìä Base de Dados Atual:**
- **3.124 agendamentos** (708 completos, 738 cancelados, 773 no-shows)
- **4.560 conversas** (410 geraram agendamentos)
- **16 pagamentos** (R$ 928 de receita total)
- **11 tenants** com dados de pagamento
- **5 tenants** com conversas ativas
- **Per√≠odo:** Maio-Setembro 2025

---

## üéØ **AN√ÅLISE DETALHADA POR M√âTRICA**

### **üî• CATEGORIA: CR√çTICAS (Implementar Imediatamente)**

---

#### **1. CUSTOMER LIFETIME VALUE (CLV)**

**üìä Metodologia:**
```sql
CLV = (Receita M√©dia por Cliente √ó Frequ√™ncia de Compra √ó Tempo de Relacionamento) - Custo de Aquisi√ß√£o

-- F√≥rmula espec√≠fica para UBS:
CLV = (Ticket M√©dio por Agendamento √ó Agendamentos por M√™s √ó Tempo de Reten√ß√£o em Meses)
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
WITH customer_metrics AS (
  SELECT 
    a.tenant_id,
    a.user_id,
    COUNT(*) as total_appointments,
    AVG(a.final_price) as avg_appointment_value,
    EXTRACT(EPOCH FROM (MAX(a.start_time) - MIN(a.start_time))) / (60*60*24*30) as lifetime_months,
    MIN(a.start_time) as first_appointment,
    MAX(a.start_time) as last_appointment
  FROM appointments a 
  WHERE a.status = 'completed'
  GROUP BY a.tenant_id, a.user_id
)
SELECT 
  tenant_id,
  user_id,
  (avg_appointment_value * (total_appointments / GREATEST(lifetime_months, 1))) * 
  GREATEST(lifetime_months, 1) as clv_estimate
FROM customer_metrics;
```

**‚úÖ VIABILIDADE: ALTA**
- **Dados Dispon√≠veis:** ‚úÖ appointments (final_price, start_time, user_id)
- **Qualidade dos Dados:** ‚úÖ 3.124 agendamentos com pricing
- **Per√≠odo de An√°lise:** ‚úÖ 4+ meses de hist√≥rico
- **Implementa√ß√£o:** 1-2 dias

**‚ö†Ô∏è Limita√ß√µes:**
- Per√≠odo ainda curto para CLV preciso (ideal: 12+ meses)
- Necessita tracking de churn para precis√£o

---

#### **2. CHURN RATE**

**üìä Metodologia:**
```sql
Churn Rate = (Clientes Perdidos no Per√≠odo / Total de Clientes Ativos no In√≠cio do Per√≠odo) √ó 100

-- Para SaaS/Subscription:
Tenant Churn Rate = (Tenants Cancelados no M√™s / Tenants Ativos no In√≠cio do M√™s) √ó 100
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
WITH monthly_tenant_status AS (
  SELECT 
    DATE_TRUNC('month', payment_date) as month,
    tenant_id,
    COUNT(*) as payments_in_month,
    MAX(payment_date) as last_payment
  FROM subscription_payments 
  WHERE payment_status = 'completed'
  GROUP BY 1, 2
),
churn_analysis AS (
  SELECT 
    month,
    COUNT(DISTINCT tenant_id) as active_tenants,
    COUNT(DISTINCT tenant_id) - 
      LAG(COUNT(DISTINCT tenant_id)) OVER (ORDER BY month) as churn_count
  FROM monthly_tenant_status
  GROUP BY month
)
SELECT 
  month,
  active_tenants,
  COALESCE(ABS(churn_count), 0) as churned_tenants,
  CASE 
    WHEN LAG(active_tenants) OVER (ORDER BY month) > 0 
    THEN (COALESCE(ABS(churn_count), 0) * 100.0) / LAG(active_tenants) OVER (ORDER BY month)
    ELSE 0 
  END as churn_rate_pct
FROM churn_analysis;
```

**‚ö†Ô∏è VIABILIDADE: M√âDIA**
- **Dados Dispon√≠veis:** ‚ö†Ô∏è subscription_payments (apenas 2 meses)
- **Qualidade dos Dados:** ‚ö†Ô∏è Volume baixo (16 pagamentos)
- **Per√≠odo de An√°lise:** ‚ùå Insuficiente (precisa 3+ meses)
- **Implementa√ß√£o:** 2-3 dias

**üìù Recomenda√ß√£o:**
- Implementar tracking mas aguardar mais dados
- Usar subscription_status do Stripe como complemento

---

#### **3. RECEITA POR CLIENTE**

**üìä Metodologia:**
```sql
Receita por Cliente = Receita Total do Per√≠odo / N√∫mero de Clientes √önicos no Per√≠odo

-- Detalhada por tenant:
RPC = SUM(final_price WHERE status='completed') / COUNT(DISTINCT user_id)
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
SELECT 
  a.tenant_id,
  t.business_name,
  COUNT(DISTINCT a.user_id) as unique_customers,
  COUNT(*) as total_appointments,
  SUM(CASE WHEN a.status = 'completed' THEN a.final_price ELSE 0 END) as total_revenue,
  AVG(CASE WHEN a.status = 'completed' THEN a.final_price END) as avg_appointment_value,
  SUM(CASE WHEN a.status = 'completed' THEN a.final_price ELSE 0 END) / 
    NULLIF(COUNT(DISTINCT a.user_id), 0) as revenue_per_customer
FROM appointments a
JOIN tenants t ON a.tenant_id = t.id
WHERE a.created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY a.tenant_id, t.business_name;
```

**‚úÖ VIABILIDADE: MUITO ALTA**
- **Dados Dispon√≠veis:** ‚úÖ appointments (final_price, user_id, status)
- **Qualidade dos Dados:** ‚úÖ 708 agendamentos completados com pricing
- **Per√≠odo de An√°lise:** ‚úÖ Dados suficientes
- **Implementa√ß√£o:** 1 dia

---

#### **4. TAXA DE CONVERS√ÉO (Conversa ‚Üí Agendamento)**

**üìä Metodologia:**
```sql
Taxa de Convers√£o = (Conversas que Geraram Agendamento / Total de Conversas) √ó 100

-- Considerando apenas conversas com inten√ß√£o de agendamento:
Convers√£o Qualificada = (appointment_created / (appointment_created + booking_abandoned)) √ó 100
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
WITH conversation_outcomes AS (
  SELECT 
    tenant_id,
    conversation_context->>'session_id' as session_id,
    MAX(CASE WHEN conversation_outcome = 'appointment_created' THEN 1 ELSE 0 END) as converted,
    COUNT(*) as messages_in_session
  FROM conversation_history 
  WHERE conversation_context->>'session_id' IS NOT NULL
  GROUP BY tenant_id, conversation_context->>'session_id'
)
SELECT 
  co.tenant_id,
  t.business_name,
  COUNT(*) as total_conversations,
  SUM(co.converted) as appointments_created,
  (SUM(co.converted) * 100.0 / COUNT(*)) as conversion_rate_pct,
  AVG(co.messages_in_session) as avg_messages_per_conversation
FROM conversation_outcomes co
JOIN tenants t ON co.tenant_id = t.id
GROUP BY co.tenant_id, t.business_name;
```

**‚úÖ VIABILIDADE: MUITO ALTA**
- **Dados Dispon√≠veis:** ‚úÖ conversation_history (conversation_outcome, session_id)
- **Qualidade dos Dados:** ‚úÖ 410 conversas com outcome 'appointment_created'
- **Per√≠odo de An√°lise:** ‚úÖ 4.560 conversas para an√°lise
- **Implementa√ß√£o:** 1 dia

---

#### **5. MONTHLY GROWTH RATE (MRR)**

**üìä Metodologia:**
```sql
Growth Rate = ((MRR Atual - MRR Anterior) / MRR Anterior) √ó 100

-- Incluindo new MRR, expansion MRR, contraction MRR, churned MRR:
Net MRR Growth = New MRR + Expansion MRR - Contraction MRR - Churned MRR
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
WITH monthly_mrr AS (
  SELECT 
    DATE_TRUNC('month', payment_date) as month,
    SUM(CASE WHEN payment_status = 'completed' THEN amount ELSE 0 END) as mrr
  FROM subscription_payments
  GROUP BY DATE_TRUNC('month', payment_date)
)
SELECT 
  month,
  mrr,
  LAG(mrr) OVER (ORDER BY month) as previous_mrr,
  CASE 
    WHEN LAG(mrr) OVER (ORDER BY month) > 0 
    THEN ((mrr - LAG(mrr) OVER (ORDER BY month)) * 100.0) / LAG(mrr) OVER (ORDER BY month)
    ELSE 0 
  END as growth_rate_pct
FROM monthly_mrr
ORDER BY month;
```

**‚ö†Ô∏è VIABILIDADE: M√âDIA**
- **Dados Dispon√≠veis:** ‚ö†Ô∏è subscription_payments (limitado)
- **Qualidade dos Dados:** ‚ö†Ô∏è Apenas 2 meses de dados
- **Per√≠odo de An√°lise:** ‚ùå Insuficiente para tend√™ncia
- **Implementa√ß√£o:** 1-2 dias

**üìù Recomenda√ß√£o:**
- Implementar mas esperar mais per√≠odos para an√°lise confi√°vel

---

### **‚ö° CATEGORIA: ALTO IMPACTO**

---

#### **6. TAXA DE NO-SHOW**

**üìä Metodologia:**
```sql
No-Show Rate = (Agendamentos No-Show / Total de Agendamentos Confirmados) √ó 100
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
SELECT 
  a.tenant_id,
  t.business_name,
  COUNT(*) as total_appointments,
  COUNT(CASE WHEN a.status = 'no_show' THEN 1 END) as no_shows,
  COUNT(CASE WHEN a.status = 'completed' THEN 1 END) as completed,
  (COUNT(CASE WHEN a.status = 'no_show' THEN 1 END) * 100.0 / COUNT(*)) as no_show_rate_pct
FROM appointments a
JOIN tenants t ON a.tenant_id = t.id
WHERE a.start_time >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY a.tenant_id, t.business_name;
```

**‚úÖ VIABILIDADE: MUITO ALTA**
- **Dados Dispon√≠veis:** ‚úÖ appointments (status = 'no_show')
- **Qualidade dos Dados:** ‚úÖ 773 no-shows identificados
- **Implementa√ß√£o:** 1 dia

---

#### **7. LTV/CAC RATIO**

**üìä Metodologia:**
```sql
LTV/CAC Ratio = Customer Lifetime Value / Customer Acquisition Cost

-- Benchmark: 3:1 (m√≠nimo), 5:1 (bom), 7:1+ (excelente)
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
-- Requer implementa√ß√£o de CAC tracking primeiro
WITH cac_calculation AS (
  -- CAC = Marketing Spend / New Customers Acquired
  -- Para simplificar, usar custo m√©dio por tenant
  SELECT 
    tenant_id,
    100.00 as estimated_cac -- Placeholder - requer dados de marketing
),
ltv_calculation AS (
  -- Usar CLV calculado anteriormente
  SELECT tenant_id, avg_clv FROM customer_lifetime_values
)
SELECT 
  l.tenant_id,
  l.avg_clv as ltv,
  c.estimated_cac as cac,
  l.avg_clv / c.estimated_cac as ltv_cac_ratio
FROM ltv_calculation l
JOIN cac_calculation c ON l.tenant_id = c.tenant_id;
```

**‚ùå VIABILIDADE: BAIXA**
- **Dados Dispon√≠veis:** ‚ùå N√£o temos dados de Customer Acquisition Cost
- **LTV:** ‚úÖ Pode ser calculado com dados existentes
- **CAC:** ‚ùå Requer tracking de marketing/vendas
- **Implementa√ß√£o:** 1-2 semanas (requer novos dados)

**üìù Recomenda√ß√£o:**
- Implementar tracking de CAC primeiro
- Usar estimativas baseadas em benchmarks inicialmente

---

#### **8. MARGEM POR SERVI√áO**

**üìä Metodologia:**
```sql
Margem por Servi√ßo = ((Receita do Servi√ßo - Custos do Servi√ßo) / Receita do Servi√ßo) √ó 100

-- Custos incluem: tempo do profissional, materiais, overhead
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
-- Requer dados de custos que n√£o existem atualmente
SELECT 
  a.service_id,
  s.name as service_name,
  COUNT(*) as appointments_count,
  AVG(a.final_price) as avg_revenue,
  -- Custos precisam ser definidos
  0 as estimated_cost, -- Placeholder
  AVG(a.final_price) - 0 as avg_profit,
  ((AVG(a.final_price) - 0) / NULLIF(AVG(a.final_price), 0)) * 100 as margin_pct
FROM appointments a
LEFT JOIN services s ON a.service_id = s.id
WHERE a.status = 'completed'
GROUP BY a.service_id, s.name;
```

**‚ö†Ô∏è VIABILIDADE: M√âDIA**
- **Dados de Receita:** ‚úÖ final_price por appointment
- **Dados de Custo:** ‚ùå N√£o existem na base atual
- **Implementa√ß√£o:** 1-2 semanas (requer defini√ß√£o de custos)

**üìù Recomenda√ß√£o:**
- Come√ßar com margem bruta (sem custos detalhados)
- Implementar tracking de custos gradualmente

---

#### **9. TRIAL CONVERSION RATE**

**üìä Metodologia:**
```sql
Trial Conversion = (Tenants que Viraram Pagantes / Total de Trials Iniciados) √ó 100
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
WITH trial_analysis AS (
  SELECT 
    tenant_id,
    MIN(CASE WHEN subscription_plan = 'free' THEN payment_date END) as trial_start,
    MIN(CASE WHEN subscription_plan != 'free' THEN payment_date END) as paid_start,
    CASE 
      WHEN MIN(CASE WHEN subscription_plan != 'free' THEN payment_date END) IS NOT NULL 
      THEN 1 ELSE 0 
    END as converted
  FROM subscription_payments
  GROUP BY tenant_id
)
SELECT 
  COUNT(*) as total_trials,
  SUM(converted) as successful_conversions,
  (SUM(converted) * 100.0 / COUNT(*)) as trial_conversion_rate_pct,
  AVG(CASE WHEN converted = 1 THEN paid_start - trial_start END) as avg_trial_duration
FROM trial_analysis
WHERE trial_start IS NOT NULL;
```

**‚úÖ VIABILIDADE: ALTA**
- **Dados Dispon√≠veis:** ‚úÖ subscription_payments (subscription_plan)
- **Trial Period:** ‚úÖ Implementado (15 dias)
- **Convers√µes:** ‚úÖ Dados de upgrade dispon√≠veis
- **Implementa√ß√£o:** 1-2 dias

---

#### **10. REVENUE FORECAST**

**üìä Metodologia:**
```sql
-- Modelo simples de forecast linear:
Revenue Forecast = Current MRR √ó (1 + Growth Rate)^n

-- Modelo mais complexo com sazonalidade:
Forecast = Trend + Seasonal + Cyclical Components
```

**üîç Implementa√ß√£o T√©cnica:**
```sql
WITH historical_revenue AS (
  SELECT 
    DATE_TRUNC('month', payment_date) as month,
    SUM(amount) as monthly_revenue
  FROM subscription_payments 
  WHERE payment_status = 'completed'
  GROUP BY DATE_TRUNC('month', payment_date)
),
growth_calculation AS (
  SELECT 
    month,
    monthly_revenue,
    LAG(monthly_revenue) OVER (ORDER BY month) as prev_revenue,
    (monthly_revenue - LAG(monthly_revenue) OVER (ORDER BY month)) / 
      NULLIF(LAG(monthly_revenue) OVER (ORDER BY month), 0) as growth_rate
  FROM historical_revenue
),
forecast AS (
  SELECT 
    CURRENT_DATE + INTERVAL '1 month' * generate_series(1, 6) as forecast_month,
    (SELECT AVG(growth_rate) FROM growth_calculation WHERE growth_rate IS NOT NULL) as avg_growth,
    (SELECT monthly_revenue FROM historical_revenue ORDER BY month DESC LIMIT 1) as current_mrr
)
SELECT 
  forecast_month,
  current_mrr * POWER(1 + COALESCE(avg_growth, 0), 
    EXTRACT(MONTH FROM forecast_month - CURRENT_DATE)) as forecasted_revenue
FROM forecast;
```

**‚ö†Ô∏è VIABILIDADE: BAIXA**
- **Dados Hist√≥ricos:** ‚ùå Apenas 2 meses (m√≠nimo 6-12 para forecast confi√°vel)
- **Sazonalidade:** ‚ùå Per√≠odo insuficiente para detectar padr√µes
- **Growth Rate:** ‚ö†Ô∏è Calcul√°vel mas pouco confi√°vel
- **Implementa√ß√£o:** 2-3 dias (mas com baixa precis√£o)

**üìù Recomenda√ß√£o:**
- Aguardar mais dados hist√≥ricos
- Implementar forecast simples inicialmente

---

## üìä **RESUMO DE VIABILIDADE**

### **‚úÖ IMPLEMENTA√á√ÉO IMEDIATA (Dados Suficientes)**

| M√©trica | Viabilidade | Implementa√ß√£o | Valor |
|---------|-------------|---------------|--------|
| **Receita por Cliente** | üü¢ Muito Alta | 1 dia | üî•üî•üî•üî•üî• |
| **Taxa de Convers√£o** | üü¢ Muito Alta | 1 dia | üî•üî•üî•üî•üî• |
| **Taxa de No-Show** | üü¢ Muito Alta | 1 dia | üî•üî•üî•üî• |
| **Customer Lifetime Value** | üü¢ Alta | 1-2 dias | üî•üî•üî•üî•üî• |
| **Trial Conversion Rate** | üü¢ Alta | 1-2 dias | üî•üî•üî•üî• |

### **‚ö†Ô∏è IMPLEMENTA√á√ÉO PARCIAL (Dados Limitados)**

| M√©trica | Limita√ß√£o | Solu√ß√£o | Prazo |
|---------|-----------|---------|--------|
| **Churn Rate** | Apenas 2 meses de dados | Aguardar + usar Stripe data | 1 m√™s |
| **Monthly Growth Rate** | Volume baixo | Complementar com proje√ß√µes | 2 semanas |
| **Margem por Servi√ßo** | Sem dados de custos | Definir estrutura de custos | 2-4 semanas |

### **‚ùå IMPLEMENTA√á√ÉO FUTURA (Requer Novos Dados)**

| M√©trica | Dados Necess√°rios | Implementa√ß√£o | Prazo |
|---------|-------------------|---------------|--------|
| **LTV/CAC Ratio** | Customer Acquisition Cost | Tracking de marketing | 4-6 semanas |
| **Revenue Forecast** | 6+ meses de hist√≥rico | Aguardar dados | 3-6 meses |

---

## üöÄ **PLANO DE IMPLEMENTA√á√ÉO RECOMENDADO**

### **üìÖ Semana 1-2: Quick Wins**
1. **Receita por Cliente** - Implementa√ß√£o completa
2. **Taxa de Convers√£o** - Dashboard em tempo real  
3. **Taxa de No-Show** - Alertas autom√°ticos
4. **CLV B√°sico** - Vers√£o inicial

### **üìÖ Semana 3-4: M√©tricas Avan√ßadas**
1. **Trial Conversion Rate** - Tracking completo
2. **Churn Rate** - Vers√£o inicial com alertas
3. **Monthly Growth Rate** - Proje√ß√µes b√°sicas

### **üìÖ M√™s 2-3: Expans√£o**
1. **Margem por Servi√ßo** - Definir custos e implementar
2. **LTV/CAC Ratio** - Implementar tracking de CAC
3. **Revenue Forecast** - Modelo preditivo b√°sico

---

## üéØ **CONCLUS√ÉO**

**Status:** **60% das m√©tricas cr√≠ticas** podem ser implementadas imediatamente com os dados existentes.

**Recomenda√ß√£o:** Focar nas **5 m√©tricas com viabilidade alta** para criar valor imediato, enquanto se coleta dados para as m√©tricas mais avan√ßadas.

**ROI Esperado:** Implementa√ß√£o das m√©tricas vi√°veis pode gerar **15-25% de melhoria na performance** dos tenants em 30-60 dias.