<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tenant Analysis - UBS Super Admin</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- UBS Standard Styles -->
    <link href="css/ubs-standard-styles.css" rel="stylesheet">
    <link href="css/dashboard-widgets.css" rel="stylesheet">
    <link href="css/super-admin-dashboard.css" rel="stylesheet">
    
    <style>
        /* LOGO GRANDE FORÇADO */
        .sidebar .logo {
            min-height: 180px !important;
            padding: 20px 10px !important;
        }
        
        .sidebar .logo img {
            width: 90% !important;
            max-width: 250px !important;
            max-height: 150px !important;
            height: auto !important;
        }
        
        /* Tenant Analysis specific styles */
        .tenant-selector {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #2D5A9B;
            height: 100%;
        }
        
        .metric-card-body {
            display: flex;
            align-items: center;
        }
        
        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            color: white;
        }
        
        .metric-icon-primary { background: #007bff; }
        .metric-icon-success { background: #28a745; }
        .metric-icon-warning { background: #ffc107; }
        .metric-icon-danger { background: #dc3545; }
        .metric-icon-info { background: #17a2b8; }
        
        .metric-content {
            flex: 1;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2D5A9B;
            line-height: 1;
        }
        
        .metric-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-top: 0.5rem;
        }
        
        .metric-trend {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
        }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="logo">
            <img src="assets/images/optimized/Logo_Int_Branco.webp" alt="UBS Logo">
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Dashboard</div>
            <a class="nav-link" href="dashboard-standardized.html">
                <i class="fas fa-chart-line"></i>
                <span>Visão Geral</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Analytics</div>
            <a class="nav-link" href="services-standardized-admin.html">
                <i class="fas fa-concierge-bell"></i>
                <span>Serviços</span>
            </a>
            <a class="nav-link" href="customers-standardized-admin.html">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </a>
            <a class="nav-link" href="appointments-standardized-admin.html">
                <i class="fas fa-calendar-check"></i>
                <span>Agendamentos</span>
            </a>
            <a class="nav-link" href="conversations-standardized-admin.html">
                <i class="fab fa-whatsapp"></i>
                <span>Conversas</span>
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Financeiro</div>
            <a class="nav-link" href="payments-standardized-admin.html">
                <i class="fas fa-credit-card"></i>
                <span>Pagamentos</span>
            </a>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Sistema</div>
            <a class="nav-link" href="settings-standardized-admin.html">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Header -->
        <div class="top-navbar">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">Dashboard Tenant Analysis</h4>
                    <small class="text-muted">Análise individual de tenant</small>
                </div>
                <div class="user-menu d-flex flex-column align-items-end gap-1">
                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle d-flex align-items-center compact-button" data-bs-toggle="dropdown">
                            <div class="user-avatar me-2" id="userAvatar">U</div>
                            <div class="d-none d-md-block text-start">
                                <div class="fw-medium compact-text" id="userName">UBS Platform</div>
                                <small class="text-muted compact-small" id="userRole">Super Administrador</small>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end compact-dropdown">
                            <li><a class="dropdown-item compact-dropdown-item" href="settings-standardized-admin.html"><i class="fas fa-user-cog me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item compact-dropdown-item" href="#" onclick="exportData()"><i class="fas fa-download me-2"></i>Exportar Dados</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item compact-dropdown-item" href="#" onclick="refreshData()"><i class="fas fa-sync me-2"></i>Atualizar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item compact-dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Container -->
        <div class="container-fluid p-4">
            <!-- Actions -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <button class="btn btn-outline-secondary" onclick="backToDashboard()">
                        <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                    </button>
                </div>
                <div class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    <span id="lastUpdate">Atualizado agora</span>
                </div>
            </div>
            
            <!-- Tenant Selector -->
            <div class="tenant-selector">
                <h5 class="mb-3">
                    <i class="fas fa-building me-2"></i>
                    Seleção de Tenant
                </h5>
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center gap-3">
                            <div class="metric-icon metric-icon-primary" id="tenant-logo" style="width: 60px; height: 60px; font-size: 1.2rem;">
                                SA
                            </div>
                            <div>
                                <h5 class="mb-1" id="tenant-name">Selecione um Tenant</h5>
                                <div>
                                    <span class="badge bg-secondary" id="tenant-domain">-</span>
                                    <span class="text-muted ms-2" id="tenant-location">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="tenantSelector" onchange="changeTenant()">
                            <option value="">Carregando tenants...</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Metrics -->
            <div class="row g-3 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-card-body">
                            <div class="metric-icon metric-icon-primary">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="tenant-appointments">-</div>
                                <div class="metric-title">Agendamentos</div>
                                <div class="metric-trend" id="appointments-trend">
                                    <i class="fas fa-info-circle"></i>
                                    Aguardando dados
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-card-body">
                            <div class="metric-icon metric-icon-success">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="tenant-revenue">-</div>
                                <div class="metric-title">Receita Mensal</div>
                                <div class="metric-trend" id="revenue-trend">
                                    <i class="fas fa-info-circle"></i>
                                    Aguardando dados
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-card-body">
                            <div class="metric-icon metric-icon-info">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="tenant-customers">-</div>
                                <div class="metric-title">Clientes Ativos</div>
                                <div class="metric-trend" id="customers-trend">
                                    <i class="fas fa-info-circle"></i>
                                    Aguardando dados
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="metric-card-body">
                            <div class="metric-icon metric-icon-warning">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" id="tenant-services">-</div>
                                <div class="metric-title">Total de Serviços</div>
                                <div class="metric-trend" id="services-trend">
                                    <i class="fas fa-info-circle"></i>
                                    Aguardando dados
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="chart-container">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-line me-2"></i>
                            Performance do Tenant
                        </h5>
                        <canvas id="tenantChart"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="chart-container">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-pie me-2"></i>
                            Distribuição de Serviços
                        </h5>
                        <canvas id="servicesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/utils/secure-auth.js"></script>
    
    <script>
        // Template functions
        function getAuthToken() {
            if (window.secureAuth) {
                return window.secureAuth.getAuthHeader();
            }
            return 'Bearer ' + (localStorage.getItem('ubs_token') || localStorage.getItem('adminToken'));
        }
        
        function exportData() {
            console.log('Exporting tenant analysis data...');
        }
        
        function refreshData() {
            location.reload();
        }
        
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('ubs_token');
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            }
        }
        
        function backToDashboard() {
            window.location.href = 'dashboard-standardized.html';
        }
        
        // Load tenants for selector
        async function loadTenants() {
            try {
                const token = localStorage.getItem('ubs_token') || localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/tenants', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    populateTenantSelector(result.data || []);
                } else {
                    console.warn('⚠️ Não foi possível carregar lista de tenants');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar tenants:', error);
            }
        }
        
        function populateTenantSelector(tenants) {
            const selector = document.getElementById('tenantSelector');
            selector.innerHTML = '<option value="">Selecione um tenant...</option>';
            
            tenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.id;
                option.textContent = tenant.business_name;
                selector.appendChild(option);
            });
        }
        
        function changeTenant() {
            const selector = document.getElementById('tenantSelector');
            const tenantId = selector.value;
            
            if (tenantId) {
                const tenantName = selector.options[selector.selectedIndex].text;
                loadTenantData(tenantId, tenantName);
            }
        }
        
        async function loadTenantData(tenantId, tenantName) {
            try {
                // Update UI
                document.getElementById('tenant-name').textContent = tenantName;
                document.getElementById('tenant-logo').textContent = tenantName.substring(0, 2).toUpperCase();
                
                // Load metrics (mock data for now)
                document.getElementById('tenant-appointments').textContent = '156';
                document.getElementById('tenant-revenue').textContent = 'R$ 12.450';
                document.getElementById('tenant-customers').textContent = '89';
                document.getElementById('tenant-services').textContent = '12';
                
                console.log(`✅ Dados do tenant ${tenantName} carregados`);
            } catch (error) {
                console.error('❌ Erro ao carregar dados do tenant:', error);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Tenant Analysis Dashboard...');
            
            // Load tenants
            loadTenants();
            
            // Check for tenant parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const tenantId = urlParams.get('tenant');
            if (tenantId) {
                setTimeout(() => {
                    document.getElementById('tenantSelector').value = tenantId;
                    changeTenant();
                }, 1000);
            }
            
            console.log('✅ Dashboard initialized successfully');
        });
    </script>
</body>
</html>