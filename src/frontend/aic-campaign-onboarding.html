<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√£o de Campanha | AIC - Applied Intelligence Clustering</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/AIC/Imagens%20Vetor%20/AIC%20Icone%20Cheio.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0C1B33">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.25);
      --aic-green-subtle: rgba(14, 204, 151, 0.1);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-red: #ef4444;
      --aic-red-subtle: rgba(239, 68, 68, 0.1);
      --aic-yellow: #f59e0b;
      --aic-yellow-subtle: rgba(245, 158, 11, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      line-height: 1.7;
      min-height: 100vh;
    }

    /* Container */
    .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

    /* Header */
    .header {
      background: rgba(12, 27, 51, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--aic-border);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo {
      height: 36px;
      width: auto;
      filter: brightness(1.1);
    }
    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--aic-green-subtle);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--aic-green);
      font-weight: 500;
    }

    /* Main Content */
    .main {
      padding: 48px 0 80px;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 48px;
    }
    .page-title h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .page-title p {
      font-size: 16px;
      color: var(--aic-gray);
      max-width: 600px;
      margin: 0 auto;
    }

    /* Campaign Info Card */
    .campaign-info {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .campaign-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-gray);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }
    .campaign-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .detail-item {
      background: var(--aic-navy);
      border-radius: 10px;
      padding: 16px;
    }
    .detail-label {
      font-size: 12px;
      color: var(--aic-gray);
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--aic-white);
    }

    /* Warning Box */
    .warning-box {
      background: var(--aic-red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }
    .warning-box.yellow {
      background: var(--aic-yellow-subtle);
      border-color: rgba(245, 158, 11, 0.3);
    }
    .warning-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
      color: var(--aic-red);
      margin-bottom: 12px;
    }
    .warning-box.yellow .warning-title {
      color: var(--aic-yellow);
    }
    .warning-title::before {
      content: '!';
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--aic-red);
      color: white;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
    }
    .warning-box.yellow .warning-title::before {
      background: var(--aic-yellow);
    }
    .warning-box p {
      font-size: 14px;
      color: var(--aic-gray-light);
      line-height: 1.6;
    }
    .warning-box ul {
      margin: 12px 0 0 20px;
      font-size: 14px;
      color: var(--aic-gray-light);
    }
    .warning-box li {
      margin-bottom: 8px;
    }

    /* Section Card */
    .section-card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }
    .section-card.active {
      border-color: var(--aic-green);
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .section-number {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--aic-navy);
      flex-shrink: 0;
    }
    .section-title h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--aic-white);
      margin-bottom: 4px;
    }
    .section-title p {
      font-size: 14px;
      color: var(--aic-gray);
    }

    /* QR Code Area */
    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }
    .qr-placeholder {
      width: 280px;
      height: 280px;
      background: var(--aic-navy);
      border: 2px dashed var(--aic-border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .qr-placeholder.loading {
      border-color: var(--aic-green);
      animation: pulse 2s infinite;
    }
    .qr-placeholder.connected {
      border-color: var(--aic-green);
      border-style: solid;
      background: var(--aic-green-subtle);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .qr-placeholder img {
      max-width: 240px;
      max-height: 240px;
    }
    .qr-status {
      font-size: 14px;
      color: var(--aic-gray);
    }
    .qr-status.connected {
      color: var(--aic-green);
      font-weight: 600;
    }
    .qr-instructions {
      background: var(--aic-navy);
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
    }
    .qr-instructions h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .qr-instructions ol {
      margin-left: 20px;
      font-size: 13px;
      color: var(--aic-gray-light);
    }
    .qr-instructions li {
      margin-bottom: 8px;
    }

    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--aic-white);
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--aic-white);
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--aic-green);
    }
    .form-input::placeholder {
      color: var(--aic-gray);
    }
    .form-hint {
      font-size: 12px;
      color: var(--aic-gray);
      margin-top: 6px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Password Toggle */
    .password-wrapper {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--aic-gray);
      cursor: pointer;
      padding: 4px;
      font-size: 13px;
    }
    .password-toggle:hover {
      color: var(--aic-green);
    }

    /* Checkboxes */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 24px;
    }
    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--aic-green);
      flex-shrink: 0;
    }
    .checkbox-label {
      font-size: 14px;
      color: var(--aic-gray-light);
      line-height: 1.5;
    }
    .checkbox-label strong {
      color: var(--aic-white);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px var(--aic-green-glow);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--aic-border);
      color: var(--aic-white);
    }
    .btn-secondary:hover {
      border-color: var(--aic-green);
      background: var(--aic-green-subtle);
    }
    .btn-full {
      width: 100%;
    }

    /* Status Messages */
    .status-message {
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 20px;
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: var(--aic-green-subtle);
      border: 1px solid rgba(14, 204, 151, 0.3);
      color: var(--aic-green);
    }
    .status-message.error {
      background: var(--aic-red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--aic-red);
    }

    /* Progress Bar */
    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 40px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--aic-navy-light);
      border: 2px solid var(--aic-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--aic-gray);
    }
    .progress-dot.active {
      background: var(--aic-green);
      border-color: var(--aic-green);
      color: var(--aic-navy);
    }
    .progress-dot.completed {
      background: var(--aic-green-subtle);
      border-color: var(--aic-green);
      color: var(--aic-green);
    }
    .progress-line {
      width: 60px;
      height: 2px;
      background: var(--aic-border);
    }
    .progress-line.completed {
      background: var(--aic-green);
    }

    /* Footer */
    .footer {
      background: var(--aic-navy);
      border-top: 1px solid var(--aic-border);
      padding: 24px 0;
      text-align: center;
    }
    .footer p {
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .main { padding: 32px 0 60px; }
      .page-title h1 { font-size: 24px; }
      .section-card { padding: 24px 20px; }
      .form-row { grid-template-columns: 1fr; }
      .campaign-details { grid-template-columns: 1fr; }
      .progress-line { width: 30px; }
      .qr-placeholder { width: 240px; height: 240px; }
      .qr-placeholder img { max-width: 200px; max-height: 200px; }
    }

    @media (max-width: 480px) {
      .header-badge { display: none; }
      .progress-bar { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-content">
      <img src="/assets/AIC/Imagens%20Vetor%20/Logo%20Completo%20nome%20Branco%20sem%20fundo.png" alt="AIC" class="header-logo">
      <div class="header-badge">Configura√ß√£o de Campanha</div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Page Title -->
      <div class="page-title">
        <h1>Configure sua Campanha</h1>
        <p>Conecte suas contas para iniciar o outreach (DM, follow, unfollow). Suas credenciais s√£o criptografadas e nunca armazenadas em texto.</p>
      </div>

      <!-- Briefing Banner -->
      <div class="briefing-banner" id="briefing-banner" style="display: none;">
        <div class="briefing-banner-content">
          <div class="briefing-banner-icon">üìù</div>
          <div class="briefing-banner-text">
            <strong id="briefing-banner-title">Preencha o Briefing da Campanha</strong>
            <p id="briefing-banner-description">O briefing ajuda o agente de IA a personalizar as mensagens com seu diferencial competitivo e tom de voz.</p>
          </div>
          <div class="briefing-banner-progress" id="briefing-progress-container" style="display: none;">
            <span class="briefing-progress-text"><span id="briefing-progress">0</span>%</span>
            <div class="briefing-progress-bar">
              <div class="briefing-progress-fill" id="briefing-progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <a href="#" class="btn btn-primary btn-sm" id="briefing-banner-btn">Preencher Briefing</a>
        </div>
      </div>

      <style>
        .briefing-banner {
          background: linear-gradient(135deg, var(--aic-navy-light), var(--aic-navy-lighter));
          border: 1px solid var(--aic-green);
          border-radius: 16px;
          padding: 20px 24px;
          margin-bottom: 32px;
          box-shadow: 0 0 20px var(--aic-green-glow);
        }
        .briefing-banner-content {
          display: flex;
          align-items: center;
          gap: 16px;
          flex-wrap: wrap;
        }
        .briefing-banner-icon {
          font-size: 32px;
          flex-shrink: 0;
        }
        .briefing-banner-text {
          flex: 1;
          min-width: 200px;
        }
        .briefing-banner-text strong {
          display: block;
          font-size: 16px;
          color: var(--aic-white);
          margin-bottom: 4px;
        }
        .briefing-banner-text p {
          font-size: 13px;
          color: var(--aic-gray-light);
          margin: 0;
        }
        .briefing-banner-progress {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .briefing-progress-text {
          font-size: 14px;
          font-weight: 600;
          color: var(--aic-green);
          min-width: 40px;
        }
        .briefing-progress-bar {
          width: 80px;
          height: 6px;
          background: var(--aic-navy);
          border-radius: 3px;
          overflow: hidden;
        }
        .briefing-progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--aic-green), var(--aic-green-dark));
          transition: width 0.3s ease;
        }
        .btn-sm {
          padding: 10px 20px;
          font-size: 14px;
        }
        .briefing-banner.completed {
          border-color: var(--aic-green);
          background: var(--aic-green-subtle);
        }
        .briefing-banner.completed .briefing-banner-icon::before {
          content: '';
        }
        @media (max-width: 768px) {
          .briefing-banner-content {
            flex-direction: column;
            text-align: center;
          }
          .briefing-banner-progress {
            justify-content: center;
          }
        }
      </style>

      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-step">
          <div class="progress-dot active" id="progress-1">1</div>
        </div>
        <div class="progress-line" id="line-1"></div>
        <div class="progress-step">
          <div class="progress-dot" id="progress-2">2</div>
        </div>
        <div class="progress-line" id="line-2"></div>
        <div class="progress-step">
          <div class="progress-dot" id="progress-3">3</div>
        </div>
        <div class="progress-line" id="line-3"></div>
        <div class="progress-step">
          <div class="progress-dot" id="progress-4">4</div>
        </div>
      </div>

      <!-- Campaign Selector (shown when no campaign ID in URL) -->
      <div class="section-card" id="campaign-selector" style="display: none;">
        <div class="section-header">
          <div class="section-number">0</div>
          <div class="section-title">
            <h2>Selecione sua Campanha</h2>
            <p>Escolha a campanha que deseja configurar</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="campaign-dropdown">Campanhas Dispon√≠veis</label>
          <select id="campaign-dropdown" class="form-input" onchange="selectCampaign()">
            <option value="">-- Selecione uma campanha --</option>
          </select>
          <p class="form-hint">Mostrando campanhas pendentes de configura√ß√£o</p>
        </div>

        <div id="selected-campaign-preview" style="display: none; margin-top: 20px;">
          <div class="campaign-details">
            <div class="detail-item">
              <div class="detail-label">Campanha</div>
              <div class="detail-value" id="preview-name">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Nicho</div>
              <div class="detail-value" id="preview-nicho">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Empresa</div>
              <div class="detail-value" id="preview-business">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status Atual</div>
              <div class="detail-value" id="preview-status">-</div>
            </div>
          </div>

          <button class="btn btn-primary btn-full" onclick="confirmCampaignSelection()" style="margin-top: 20px;">
            Iniciar Configura√ß√£o desta Campanha
          </button>
        </div>

        <div class="status-message" id="selector-status"></div>
      </div>

      <!-- Campaign Info (shown when campaign is selected) -->
      <div class="campaign-info" id="campaign-info" style="display: none;">
        <h3>Dados da Campanha</h3>
        <div class="campaign-details">
          <div class="detail-item">
            <div class="detail-label">Campanha</div>
            <div class="detail-value" id="campaign-name">Carregando...</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Nicho</div>
            <div class="detail-value" id="campaign-nicho">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Canais</div>
            <div class="detail-value" id="campaign-channels">WhatsApp + Instagram</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value" id="campaign-status">Aguardando configura√ß√£o</div>
          </div>
        </div>
      </div>

      <!-- Important Warnings -->
      <div class="warning-box">
        <div class="warning-title">Aviso Importante sobre Riscos</div>
        <p>O envio de mensagens e intera√ß√µes via WhatsApp e Instagram envolve riscos inerentes ao uso das plataformas:</p>
        <ul>
          <li><strong>Restri√ß√£o tempor√°ria:</strong> As plataformas podem restringir temporariamente sua conta se detectarem atividade incomum.</li>
          <li><strong>Bloqueio de conta:</strong> Em casos extremos, as contas podem ser bloqueadas. Mitigamos com limites r√≠gidos de envio e comportamento humanizado.</li>
          <li><strong>Recupera√ß√£o:</strong> Possu√≠mos protocolos de recupera√ß√£o, mas n√£o garantimos 100% de sucesso em todos os casos.</li>
        </ul>
      </div>

      <div class="warning-box yellow">
        <div class="warning-title">Seguran√ßa das Credenciais</div>
        <p>Suas credenciais s√£o protegidas com criptografia AES-256-GCM (padr√£o banc√°rio). A chave de criptografia √© armazenada separadamente do banco de dados. Nenhum funcion√°rio tem acesso √†s senhas em texto. Ap√≥s o login inicial, utilizamos cookies de sess√£o para evitar novos logins.</p>
      </div>

      <!-- SEO + Tracking -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-number">SEO</div>
          <div class="section-title">
            <h2>SEO + Tracking da Landing</h2>
            <p>Para medir os CTAs e atribuir cliques a leads reais.</p>
          </div>
        </div>
        <ul class="section-list">
          <li><strong>Analytics ativo</strong> (GA4, Plausible ou Umami) com dom√≠nio autorizado.</li>
          <li><strong>Eventos por CTA</strong> (WhatsApp, formul√°rio, ‚ÄúFalar com especialista‚Äù) usando IDs √∫nicos.</li>
          <li><strong>UTMs padronizadas</strong> nas campanhas: `utm_source`, `utm_medium`, `utm_campaign`.</li>
          <li><strong>Identifica√ß√£o no lead</strong>: ao enviar formul√°rio ou abrir WhatsApp, conectamos o clique anterior ao prospect.</li>
          <li><strong>LGPD</strong>: cl√°usula ‚ÄúColeta de dados de navega√ß√£o para fins anal√≠ticos‚Äù; banner de cookies + pol√≠tica de privacidade publicada pelo cliente.</li>
        </ul>
      </div>

      <!-- Section 1: WhatsApp -->
      <div class="section-card" id="section-whatsapp">
        <div class="section-header">
          <div class="section-number">1</div>
          <div class="section-title">
            <h2>Conex√£o WhatsApp</h2>
            <p>Escaneie o QR Code com o WhatsApp da sua empresa</p>
          </div>
        </div>

        <div class="qr-container">
          <div class="qr-placeholder" id="qr-placeholder">
            <span class="qr-status" id="qr-status">Clique para gerar QR Code</span>
          </div>

          <button class="btn btn-secondary" id="btn-generate-qr" onclick="generateQRCode()">
            Gerar QR Code
          </button>

          <div class="qr-instructions">
            <h4>Como conectar:</h4>
            <ol>
              <li>Abra o WhatsApp no seu celular</li>
              <li>Toque em Menu (tr√™s pontos) ou Configura√ß√µes</li>
              <li>Toque em "Aparelhos conectados"</li>
              <li>Toque em "Conectar um aparelho"</li>
              <li>Aponte a c√¢mera para o QR Code acima</li>
            </ol>
          </div>

          <div class="warning-box yellow" style="margin-top: 20px;">
            <div class="warning-title">Recomenda√ß√£o: N√∫mero Dedicado</div>
            <p>Recomendamos fortemente utilizar um <strong>n√∫mero de celular dedicado</strong> para esta campanha. Isso protege seu n√∫mero pessoal/comercial principal de poss√≠veis restri√ß√µes e permite melhor controle da comunica√ß√£o com leads.</p>
          </div>
        </div>

        <div class="status-message" id="whatsapp-status"></div>
      </div>

      <!-- Section 2: WhatsApp Backup (Whapi) -->
      <div class="section-card" id="section-whatsapp-backup">
        <div class="section-header">
          <div class="section-number">2</div>
          <div class="section-title">
            <h2>Conex√£o WhatsApp Backup</h2>
            <p>Escaneie o segundo QR Code para redund√¢ncia e seguran√ßa</p>
          </div>
        </div>

        <div class="qr-container">
          <div class="qr-placeholder" id="qr-placeholder-backup">
            <span class="qr-status" id="qr-status-backup">Clique para gerar QR Code</span>
          </div>

          <button class="btn btn-secondary" id="btn-generate-qr-backup" onclick="generateQRCodeBackup()">
            Gerar QR Code Backup
          </button>

          <div class="qr-instructions">
            <h4>Por que dois QR Codes?</h4>
            <ul style="list-style: disc; margin-left: 20px;">
              <li><strong>Redund√¢ncia:</strong> Se um canal falhar, o outro continua funcionando</li>
              <li><strong>Seguran√ßa:</strong> Distribui√ß√£o de atividade reduz risco de restri√ß√µes</li>
              <li><strong>Performance:</strong> Canais especializados para diferentes opera√ß√µes</li>
            </ul>
          </div>

          <div class="warning-box" style="margin-top: 20px; border-color: var(--aic-green); background: var(--aic-green-subtle);">
            <div class="warning-title" style="color: var(--aic-green);">Mesmo N√∫mero</div>
            <p>Use o <strong>mesmo n√∫mero de celular</strong> que voc√™ usou no passo anterior. O WhatsApp permite at√© 4 aparelhos conectados simultaneamente.</p>
          </div>
        </div>

        <div class="status-message" id="whatsapp-backup-status"></div>
      </div>

      <!-- Section 3: Instagram -->
      <div class="section-card" id="section-instagram">
        <div class="section-header">
          <div class="section-number">3</div>
          <div class="section-title">
            <h2>Conex√£o Instagram</h2>
            <p>Informe as credenciais da sua conta Instagram para envio de DM, follow e unfollow</p>
          </div>
        </div>

        <form id="instagram-form" onsubmit="return saveInstagramCredentials(event)">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="ig-username">Usu√°rio do Instagram</label>
              <input type="text" id="ig-username" class="form-input" placeholder="@seuusuario" required autocomplete="off">
              <p class="form-hint">Sem o @ - apenas o nome de usu√°rio</p>
            </div>
            <div class="form-group">
              <label class="form-label" for="ig-account-name">Nome da Conta (identifica√ß√£o)</label>
              <input type="text" id="ig-account-name" class="form-input" placeholder="Ex: Conta Principal" required>
              <p class="form-hint">Para identificar esta conta internamente</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="ig-password">Senha do Instagram</label>
            <div class="password-wrapper">
              <input type="password" id="ig-password" class="form-input" placeholder="Sua senha do Instagram" required autocomplete="new-password">
              <button type="button" class="password-toggle" onclick="togglePassword()">Mostrar</button>
            </div>
            <p class="form-hint">Criptografada com AES-256-GCM antes de ser salva</p>
          </div>

          <div class="warning-box yellow" style="margin-top: 20px;">
            <div class="warning-title">Autentica√ß√£o em Duas Etapas</div>
            <p>Se voc√™ tem 2FA ativado, ser√° necess√°rio aprovar o login no seu celular quando solicitado. Esta conta ser√° usada apenas para DM, follow e unfollow.</p>
          </div>

          <div class="warning-box" style="margin-top: 20px; border-color: var(--aic-green); background: var(--aic-green-subtle);">
            <div class="warning-title" style="color: var(--aic-green);">Sobre a Prospec√ß√£o de Leads</div>
            <p>A <strong>prospec√ß√£o de leads</strong> (busca de perfis e hashtags) √© realizada pela AIC atrav√©s de contas pr√≥prias. Sua conta Instagram ser√° utilizada exclusivamente para <strong>intera√ß√µes de outreach</strong>: envio de DMs, follow e unfollow dos leads j√° prospectados.</p>
          </div>

          <div class="status-message" id="instagram-status"></div>

          <button type="submit" class="btn btn-primary btn-full" id="btn-save-instagram" style="margin-top: 20px;">
            Salvar Credenciais Instagram
          </button>
        </form>
      </div>

      <!-- Section 4: Cliente Contact Info (Destino dos Leads) -->
      <div class="section-card" id="section-client-contact">
        <div class="section-header">
          <div class="section-number">4</div>
          <div class="section-title">
            <h2>Informa√ß√µes de Contato do Cliente</h2>
            <p>Para onde devemos direcionar os leads quentes (interessados)?</p>
          </div>
        </div>

        <div class="warning-box" style="margin-bottom: 24px; border-color: var(--aic-green); background: var(--aic-green-subtle);">
          <div class="warning-title" style="color: var(--aic-green);">üìû Direcionamento de Leads Quentes</div>
          <p>Quando um lead demonstrar interesse genu√≠no (responder positivamente √†s DMs, fazer perguntas sobre seus servi√ßos), <strong>encaminharemos as informa√ß√µes dele para o WhatsApp informado abaixo</strong>.</p>
          <p style="margin-top: 8px;">‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Este n√∫mero pode ser diferente do n√∫mero usado para conex√£o WhatsApp nas etapas anteriores. Aqui voc√™ informa para qual n√∫mero <strong>VOC√ä quer receber os leads</strong>.</p>
        </div>

        <form id="client-contact-form" onsubmit="return saveClientContact(event)">
          <div class="form-group">
            <label class="form-label" for="client-contact-name">Nome do Respons√°vel pelos Leads *</label>
            <input type="text" id="client-contact-name" class="form-input" placeholder="Ex: Jo√£o Silva" required>
            <p class="form-hint">Nome da pessoa que vai receber e gerenciar os leads</p>
          </div>

          <div class="form-group">
            <label class="form-label" for="client-whatsapp-number">WhatsApp para Receber Leads *</label>
            <input type="tel" id="client-whatsapp-number" class="form-input" placeholder="+55 11 99999-9999" required pattern="[\+]?[0-9\s\-\(\)]+">
            <p class="form-hint">N√∫mero com DDI e DDD (ex: +55 11 99904-0605). Este √© o n√∫mero que receber√° os contatos dos leads interessados.</p>
          </div>

          <div class="warning-box yellow" style="margin-top: 20px;">
            <div class="warning-title">Como funciona o encaminhamento?</div>
            <p>1. Nossos agentes IA identificam leads que demonstram interesse<br>
            2. Validamos se o interesse √© genu√≠no (n√£o √© spam ou resposta autom√°tica)<br>
            3. Enviamos para voc√™ via WhatsApp: nome do lead, Instagram, contexto da conversa<br>
            4. Voc√™ assume o contato e fecha a venda!</p>
          </div>

          <div class="status-message" id="client-contact-status"></div>

          <button type="submit" class="btn btn-primary btn-full" id="btn-save-client-contact" style="margin-top: 20px;">
            Salvar Informa√ß√µes de Contato
          </button>
        </form>
      </div>

      <!-- Section 5: Terms -->
      <div class="section-card" id="section-terms">
        <div class="section-header">
          <div class="section-number">5</div>
          <div class="section-title">
            <h2>Termos e Confirma√ß√£o</h2>
            <p>Leia e aceite os termos para finalizar a configura√ß√£o</p>
          </div>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="term-risks" required>
            <label class="checkbox-label" for="term-risks">
              <strong>Entendo os riscos:</strong> Estou ciente de que o envio de mensagens e intera√ß√µes pode resultar em restri√ß√µes tempor√°rias ou bloqueios nas plataformas, e que a AIC mitiga mas n√£o elimina completamente esses riscos.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-credentials" required>
            <label class="checkbox-label" for="term-credentials">
              <strong>Autorizo o uso das credenciais:</strong> Autorizo a AIC a utilizar as credenciais fornecidas exclusivamente para execu√ß√£o da campanha contratada, com criptografia e auditoria de acesso.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-limits" required>
            <label class="checkbox-label" for="term-limits">
              <strong>Concordo com os limites:</strong> Entendo que ser√£o respeitados limites de 15 msgs/hora (WhatsApp) e 10 a√ß√µes/hora (Instagram) para proteger as contas, podendo impactar o volume total.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-dedicated" required>
            <label class="checkbox-label" for="term-dedicated">
              <strong>N√∫mero dedicado:</strong> Confirmo que o n√∫mero de WhatsApp fornecido √© dedicado para esta campanha e entendo que n√£o devo us√°-lo simultaneamente para outras atividades durante a execu√ß√£o.
            </label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="term-lgpd" required>
            <label class="checkbox-label" for="term-lgpd">
              <strong>Conformidade LGPD:</strong> Confirmo que os dados utilizados s√£o p√∫blicos e que o contato ser√° feito com base em leg√≠timo interesse, respeitando opt-out imediato quando solicitado.
            </label>
          </div>
        </div>

        <button class="btn btn-primary btn-full" id="btn-finalize" onclick="finalizeSetup()" disabled style="margin-top: 32px;">
          Finalizar Configura√ß√£o
        </button>

        <div class="status-message" id="final-status"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>AIC - Applied Intelligence Clustering | Suas credenciais s√£o criptografadas e protegidas</p>
    </div>
  </footer>

  <script>
    // State
    let campaignId = null;
    let whatsappConnected = false;
    let whatsappBackupConnected = false;
    let instagramSaved = false;
    let clientContactSaved = false;
    let sessionId = null;
    let availableCampaigns = [];

    // Get campaign ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    campaignId = urlParams.get('campaign');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      if (campaignId) {
        // Campaign ID provided - show normal flow
        showOnboardingFlow();
        loadCampaignInfo();
        loadBriefingStatus();
      } else {
        // No campaign ID - show selector
        showCampaignSelector();
        loadAvailableCampaigns();
      }

      // Setup checkbox listeners
      const checkboxes = document.querySelectorAll('#section-terms input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.addEventListener('change', checkTermsComplete);
      });
    });

    // Load briefing status
    async function loadBriefingStatus() {
      if (!campaignId) return;

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/briefing`);
        const banner = document.getElementById('briefing-banner');
        const bannerBtn = document.getElementById('briefing-banner-btn');
        const bannerTitle = document.getElementById('briefing-banner-title');
        const bannerDesc = document.getElementById('briefing-banner-description');
        const progressContainer = document.getElementById('briefing-progress-container');
        const progressText = document.getElementById('briefing-progress');
        const progressFill = document.getElementById('briefing-progress-fill');

        // Update button link
        bannerBtn.href = `/aic-campaign-briefing.html?campaign=${campaignId}`;

        if (response.ok) {
          const briefing = await response.json();

          if (briefing && briefing.completion_percentage !== undefined) {
            const completion = briefing.completion_percentage || 0;

            // Show progress
            progressContainer.style.display = 'flex';
            progressText.textContent = completion;
            progressFill.style.width = `${completion}%`;

            if (completion >= 80) {
              // Completed
              banner.classList.add('completed');
              bannerTitle.textContent = 'Briefing Completo';
              bannerDesc.textContent = 'O agente de IA j√° possui contexto completo sobre seu neg√≥cio e diferencial.';
              bannerBtn.textContent = 'Ver Briefing';
              document.querySelector('.briefing-banner-icon').textContent = '‚úÖ';
            } else if (completion >= 30) {
              // In progress
              bannerTitle.textContent = 'Continue o Briefing';
              bannerDesc.textContent = `${completion}% preenchido. Complete para melhor personaliza√ß√£o das mensagens.`;
              bannerBtn.textContent = 'Continuar';
            } else {
              // Just started
              bannerTitle.textContent = 'Preencha o Briefing da Campanha';
              bannerDesc.textContent = 'O briefing ajuda o agente de IA a destacar seu diferencial competitivo nas conversas.';
              bannerBtn.textContent = 'Preencher';
            }
          } else {
            // No briefing yet
            bannerTitle.textContent = 'Preencha o Briefing da Campanha';
            bannerDesc.textContent = 'Informe seu diferencial competitivo, tom de voz e perfil do cliente ideal para personalizar as mensagens.';
            bannerBtn.textContent = 'Come√ßar';
          }
        } else {
          // Error or no briefing
          bannerTitle.textContent = 'Preencha o Briefing da Campanha';
          bannerDesc.textContent = 'Informe seu diferencial competitivo, tom de voz e perfil do cliente ideal para personalizar as mensagens.';
          bannerBtn.textContent = 'Come√ßar';
        }

        banner.style.display = 'block';
      } catch (error) {
        console.error('Erro ao carregar briefing:', error);
        // Still show the banner with default text
        const banner = document.getElementById('briefing-banner');
        const bannerBtn = document.getElementById('briefing-banner-btn');
        bannerBtn.href = `/aic-campaign-briefing.html?campaign=${campaignId}`;
        banner.style.display = 'block';
      }
    }

    // Show campaign selector
    function showCampaignSelector() {
      document.getElementById('campaign-selector').style.display = 'block';
      document.getElementById('campaign-info').style.display = 'none';
      document.getElementById('section-whatsapp').style.display = 'none';
      document.getElementById('section-whatsapp-backup').style.display = 'none';
      document.getElementById('section-instagram').style.display = 'none';
      document.getElementById('section-client-contact').style.display = 'none';
      document.getElementById('section-terms').style.display = 'none';
      document.querySelector('.progress-bar').style.display = 'none';

      // Hide warnings until campaign is selected
      const warnings = document.querySelectorAll('.warning-box');
      warnings.forEach(w => w.style.display = 'none');
    }

    // Show onboarding flow
    function showOnboardingFlow() {
      document.getElementById('campaign-selector').style.display = 'none';
      document.getElementById('campaign-info').style.display = 'block';
      document.getElementById('section-whatsapp').style.display = 'block';
      document.getElementById('section-whatsapp-backup').style.display = 'block';
      document.getElementById('section-instagram').style.display = 'block';
      document.getElementById('section-client-contact').style.display = 'block';
      document.getElementById('section-terms').style.display = 'block';
      document.querySelector('.progress-bar').style.display = 'flex';

      // Show warnings
      const warnings = document.querySelectorAll('.warning-box');
      warnings.forEach(w => w.style.display = 'block');
    }

    // Load available campaigns
    async function loadAvailableCampaigns() {
      try {
        const response = await fetch('/api/campaigns/available');
        if (response.ok) {
          availableCampaigns = await response.json();
          populateCampaignDropdown();
        } else {
          showStatus('selector-status', 'Erro ao carregar campanhas dispon√≠veis.', 'error');
        }
      } catch (error) {
        console.error('Erro ao carregar campanhas:', error);
        showStatus('selector-status', 'Erro de conex√£o. Tente novamente.', 'error');
      }
    }

    // Populate dropdown
    function populateCampaignDropdown() {
      const dropdown = document.getElementById('campaign-dropdown');
      dropdown.innerHTML = '<option value="">-- Selecione uma campanha --</option>';

      if (availableCampaigns.length === 0) {
        dropdown.innerHTML += '<option value="" disabled>Nenhuma campanha dispon√≠vel</option>';
        showStatus('selector-status', 'Nenhuma campanha pendente de configura√ß√£o encontrada.', 'error');
        return;
      }

      availableCampaigns.forEach(campaign => {
        const statusIcon = campaign.needsOnboarding ? '' : (campaign.hasWhatsApp || campaign.hasInstagram ? ' (parcial)' : '');
        const option = document.createElement('option');
        option.value = campaign.id;
        option.textContent = `${campaign.campaign_name || 'Sem nome'}${statusIcon} - ${campaign.nicho_principal || 'Sem nicho'}`;
        dropdown.appendChild(option);
      });
    }

    // Handle campaign selection from dropdown
    function selectCampaign() {
      const dropdown = document.getElementById('campaign-dropdown');
      const selectedId = dropdown.value;
      const preview = document.getElementById('selected-campaign-preview');

      if (!selectedId) {
        preview.style.display = 'none';
        return;
      }

      const campaign = availableCampaigns.find(c => c.id === selectedId);
      if (campaign) {
        document.getElementById('preview-name').textContent = campaign.campaign_name || '-';
        document.getElementById('preview-nicho').textContent = campaign.nicho_principal || '-';
        document.getElementById('preview-business').textContent = campaign.business_name || '-';

        let statusText = campaign.status || 'Pendente';
        if (campaign.hasWhatsApp) statusText += ' | WhatsApp: ' + (campaign.whatsappStatus || 'config');
        if (campaign.hasInstagram) statusText += ' | Instagram: ' + (campaign.instagramStatus || 'config');
        document.getElementById('preview-status').textContent = statusText;

        preview.style.display = 'block';
      }
    }

    // Confirm campaign selection and start onboarding
    function confirmCampaignSelection() {
      const dropdown = document.getElementById('campaign-dropdown');
      const selectedId = dropdown.value;

      if (!selectedId) {
        showStatus('selector-status', 'Selecione uma campanha primeiro.', 'error');
        return;
      }

      // Update URL with campaign ID
      const newUrl = window.location.pathname + '?campaign=' + selectedId;
      window.history.pushState({ campaign: selectedId }, '', newUrl);

      // Set campaign ID and show onboarding
      campaignId = selectedId;
      showOnboardingFlow();
      loadCampaignInfo();
    }

    // Load campaign info
    async function loadCampaignInfo() {
      try {
        const response = await fetch(`/api/campaigns/${campaignId}`);
        if (response.ok) {
          const campaign = await response.json();
          document.getElementById('campaign-name').textContent = campaign.campaign_name || 'Campanha';
          document.getElementById('campaign-nicho').textContent = campaign.nicho_principal || '-';
          document.getElementById('campaign-status').textContent = campaign.status || 'Aguardando';
        }
      } catch (error) {
        console.error('Erro ao carregar campanha:', error);
      }
    }

    // Generate QR Code
    async function generateQRCode() {
      const btn = document.getElementById('btn-generate-qr');
      const placeholder = document.getElementById('qr-placeholder');
      const status = document.getElementById('qr-status');

      btn.disabled = true;
      btn.textContent = 'Gerando...';
      placeholder.classList.add('loading');
      status.textContent = 'Gerando QR Code...';

      try {
        // Create session
        const createResponse = await fetch('/api/whatsapp/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            campaignId: campaignId,
            sessionName: 'Campanha ' + campaignId.substring(0, 8)
          })
        });

        if (!createResponse.ok) {
          throw new Error('Erro ao criar sess√£o');
        }

        const session = await createResponse.json();
        sessionId = session.id;

        // Get QR Code
        const qrResponse = await fetch(`/api/whatsapp/sessions/${sessionId}/qr`, {
          method: 'POST'
        });

        if (!qrResponse.ok) {
          throw new Error('Erro ao gerar QR Code');
        }

        const qrData = await qrResponse.json();

        if (qrData.qrCode) {
          placeholder.innerHTML = `<img src="${qrData.qrCode}" alt="QR Code WhatsApp">`;
          status.textContent = 'Escaneie o QR Code com seu WhatsApp';
          placeholder.classList.remove('loading');

          // Start polling for connection status
          pollConnectionStatus();
        } else if (qrData.connected) {
          handleWhatsAppConnected();
        }

      } catch (error) {
        console.error('Erro:', error);
        showStatus('whatsapp-status', 'Erro ao gerar QR Code. Tente novamente.', 'error');
        placeholder.classList.remove('loading');
        status.textContent = 'Clique para tentar novamente';
      }

      btn.disabled = false;
      btn.textContent = 'Gerar QR Code';
    }

    // Poll for connection status
    async function pollConnectionStatus() {
      if (!sessionId) return;

      try {
        const response = await fetch(`/api/whatsapp/sessions/${sessionId}/status`);
        if (response.ok) {
          const data = await response.json();

          if (data.status === 'connected') {
            handleWhatsAppConnected();
            return;
          } else if (data.status === 'expired') {
            showStatus('whatsapp-status', 'QR Code expirou. Gere um novo.', 'error');
            return;
          }
        }

        // Continue polling
        setTimeout(pollConnectionStatus, 3000);

      } catch (error) {
        console.error('Erro ao verificar status:', error);
        setTimeout(pollConnectionStatus, 5000);
      }
    }

    // Handle WhatsApp connected
    function handleWhatsAppConnected() {
      const placeholder = document.getElementById('qr-placeholder');
      const status = document.getElementById('qr-status');

      placeholder.classList.remove('loading');
      placeholder.classList.add('connected');
      placeholder.innerHTML = '<span style="font-size: 48px; color: var(--aic-green);">&#10003;</span>';
      status.textContent = 'WhatsApp conectado com sucesso!';
      status.classList.add('connected');

      document.getElementById('btn-generate-qr').style.display = 'none';

      whatsappConnected = true;
      updateProgress();
      showStatus('whatsapp-status', 'WhatsApp conectado com sucesso!', 'success');
    }

    // Generate QR Code for Backup (Whapi)
    async function generateQRCodeBackup() {
      const btn = document.getElementById('btn-generate-qr-backup');
      const placeholder = document.getElementById('qr-placeholder-backup');
      const status = document.getElementById('qr-status-backup');

      if (!campaignId) {
        showStatus('whatsapp-backup-status', 'Selecione uma campanha primeiro.', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Gerando...';
      placeholder.classList.add('loading');
      status.textContent = 'Gerando QR Code Backup...';

      try {
        // Buscar whapi_channel_uuid da campanha
        const campaignResponse = await fetch(`/api/campaigns/${campaignId}`);
        if (!campaignResponse.ok) {
          throw new Error('Erro ao buscar dados da campanha');
        }

        const campaign = await campaignResponse.json();
        const channelId = campaign.whapi_channel_uuid;

        if (!channelId) {
          throw new Error('Campanha n√£o tem canal Whapi configurado. Configure um canal primeiro.');
        }

        // Get QR Code from Whapi Channel
        const qrResponse = await fetch(`/api/whapi/channels/${channelId}/qr`, {
          method: 'POST'
        });

        if (!qrResponse.ok) {
          const errorData = await qrResponse.json();
          throw new Error(errorData.error || 'Erro ao gerar QR Code Backup');
        }

        const qrData = await qrResponse.json();

        if (qrData.connected) {
          handleWhatsAppBackupConnected();
        } else if (qrData.qrCode) {
          placeholder.innerHTML = `<img src="${qrData.qrCode}" alt="QR Code WhatsApp Backup">`;
          status.textContent = 'Escaneie o QR Code com o mesmo celular';
          placeholder.classList.remove('loading');

          // Start polling for backup connection status
          pollBackupConnectionStatus(channelId);
        }

      } catch (error) {
        console.error('Erro:', error);
        showStatus('whatsapp-backup-status', error.message || 'Erro ao gerar QR Code. Tente novamente.', 'error');
        placeholder.classList.remove('loading');
        status.textContent = 'Clique para tentar novamente';
      }

      btn.disabled = false;
      btn.textContent = 'Gerar QR Code Backup';
    }

    // Poll for backup connection status
    async function pollBackupConnectionStatus(channelId) {
      if (!channelId) return;

      try {
        const response = await fetch(`/api/whapi/channels/${channelId}/status`);
        if (response.ok) {
          const data = await response.json();

          if (data.connected) {
            handleWhatsAppBackupConnected();
            return;
          }
        }

        // Continue polling
        setTimeout(() => pollBackupConnectionStatus(channelId), 3000);

      } catch (error) {
        console.error('Erro ao verificar status backup:', error);
        setTimeout(() => pollBackupConnectionStatus(channelId), 5000);
      }
    }

    // Handle WhatsApp Backup connected
    function handleWhatsAppBackupConnected() {
      const placeholder = document.getElementById('qr-placeholder-backup');
      const status = document.getElementById('qr-status-backup');

      placeholder.classList.remove('loading');
      placeholder.classList.add('connected');
      placeholder.innerHTML = '<span style="font-size: 48px; color: var(--aic-green);">&#10003;</span>';
      status.textContent = 'Backup conectado com sucesso!';
      status.classList.add('connected');

      document.getElementById('btn-generate-qr-backup').style.display = 'none';

      whatsappBackupConnected = true;
      updateProgress();
      showStatus('whatsapp-backup-status', 'WhatsApp Backup conectado com sucesso!', 'success');
    }

    // Toggle password visibility
    function togglePassword() {
      const input = document.getElementById('ig-password');
      const btn = document.querySelector('.password-toggle');

      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Ocultar';
      } else {
        input.type = 'password';
        btn.textContent = 'Mostrar';
      }
    }

    // Save client contact information
    async function saveClientContact(event) {
      event.preventDefault();

      const btn = document.getElementById('btn-save-client-contact');
      const contactName = document.getElementById('client-contact-name').value;
      const whatsappNumber = document.getElementById('client-whatsapp-number').value;

      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/client-contact`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            clientContactName: contactName,
            clientWhatsappNumber: whatsappNumber
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao salvar informa√ß√µes de contato');
        }

        clientContactSaved = true;
        updateProgress();
        showStatus('client-contact-status', 'Informa√ß√µes salvas com sucesso!', 'success');

        // Disable form
        document.getElementById('client-contact-name').disabled = true;
        document.getElementById('client-whatsapp-number').disabled = true;
        btn.textContent = 'Informa√ß√µes Salvas ‚úì';

      } catch (error) {
        console.error('Erro:', error);
        showStatus('client-contact-status', error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Salvar Informa√ß√µes de Contato';
      }
    }

    // Save Instagram credentials
    async function saveInstagramCredentials(event) {
      event.preventDefault();

      const btn = document.getElementById('btn-save-instagram');
      const username = document.getElementById('ig-username').value.replace('@', '');
      const accountName = document.getElementById('ig-account-name').value;
      const password = document.getElementById('ig-password').value;

      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        const response = await fetch('/api/instagram/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            campaignId: campaignId,
            accountName: accountName,
            username: username,
            password: password
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao salvar credenciais');
        }

        instagramSaved = true;
        updateProgress();
        showStatus('instagram-status', 'Credenciais salvas com sucesso! Senha criptografada.', 'success');

        // Disable form
        document.getElementById('ig-username').disabled = true;
        document.getElementById('ig-account-name').disabled = true;
        document.getElementById('ig-password').disabled = true;
        btn.textContent = 'Credenciais Salvas';

      } catch (error) {
        console.error('Erro:', error);
        showStatus('instagram-status', error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Salvar Credenciais Instagram';
      }
    }

    // Check if all terms are accepted
    function checkTermsComplete() {
      const checkboxes = document.querySelectorAll('#section-terms input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      document.getElementById('btn-finalize').disabled = !allChecked;
    }

    // Update progress indicators
    function updateProgress() {
      const progress1 = document.getElementById('progress-1');
      const progress2 = document.getElementById('progress-2');
      const progress3 = document.getElementById('progress-3');
      const progress4 = document.getElementById('progress-4');
      const line1 = document.getElementById('line-1');
      const line2 = document.getElementById('line-2');
      const line3 = document.getElementById('line-3');

      // Step 1: WhatsApp Principal
      if (whatsappConnected) {
        progress1.classList.remove('active');
        progress1.classList.add('completed');
        progress1.innerHTML = '&#10003;';
        line1.classList.add('completed');
        progress2.classList.add('active');
      }

      // Step 2: WhatsApp Backup
      if (whatsappBackupConnected) {
        progress2.classList.remove('active');
        progress2.classList.add('completed');
        progress2.innerHTML = '&#10003;';
        line2.classList.add('completed');
        progress3.classList.add('active');
      }

      // Step 3: Instagram
      if (instagramSaved) {
        progress3.classList.remove('active');
        progress3.classList.add('completed');
        progress3.innerHTML = '&#10003;';
        line3.classList.add('completed');
        progress4.classList.add('active');
      }
    }

    // Finalize setup
    async function finalizeSetup() {
      const btn = document.getElementById('btn-finalize');

      if (!whatsappConnected && !instagramSaved) {
        showStatus('final-status', 'Configure pelo menos um canal (WhatsApp ou Instagram) antes de finalizar.', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Finalizando...';

      try {
        const response = await fetch(`/api/campaigns/${campaignId}/activate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            whatsappSessionId: sessionId,
            termsAccepted: true,
            termsAcceptedAt: new Date().toISOString()
          })
        });

        if (!response.ok) {
          throw new Error('Erro ao finalizar configura√ß√£o');
        }

        showStatus('final-status', 'Configura√ß√£o finalizada com sucesso! Sua campanha est√° pronta para iniciar.', 'success');
        btn.textContent = 'Configura√ß√£o Conclu√≠da';

        // Mark all progress as complete
        document.getElementById('progress-4').classList.remove('active');
        document.getElementById('progress-4').classList.add('completed');
        document.getElementById('progress-4').innerHTML = '&#10003;';

        // Redirect after delay
        setTimeout(() => {
          window.location.href = `/aic-dashboard-campaign.html?campaign=${campaignId}`;
        }, 3000);

      } catch (error) {
        console.error('Erro:', error);
        showStatus('final-status', error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Finalizar Configura√ß√£o';
      }
    }

    // Show status message
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status-message show ${type}`;
    }
  </script>
</body>
</html>
