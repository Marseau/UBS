<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Super Admin - UBS</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .metric-card {
            border-left: 4px solid #007bff;
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .metric-icon-primary { background: linear-gradient(135deg, #007bff, #0056b3); }
        .metric-icon-success { background: linear-gradient(135deg, #28a745, #1e7e34); }
        .metric-icon-info { background: linear-gradient(135deg, #17a2b8, #117a8b); }
        .metric-icon-warning { background: linear-gradient(135deg, #ffc107, #e0a800); }
        .metric-icon-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
        
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-neutral { color: #6c757d; }
        
        /* Force layout for cards */
        @media (min-width: 992px) {
            .cards-row .col-lg-3 {
                flex: 0 0 25%;
                max-width: 25%;
            }
        }
        
        /* Force layout for charts */
        @media (min-width: 768px) {
            .charts-row .col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Dashboard Super Admin</h1>
            <div class="text-muted">
                <i class="fas fa-clock me-1"></i>
                <span id="lastUpdate">Atualizado agora</span>
            </div>
        </div>
        
        <!-- 8 Cards - 2 Rows of 4 -->
        <div class="mb-4">
            <!-- First Row -->
            <div class="row g-3 mb-3 cards-row">
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-primary me-3">
                                    <i class="fas fa-building fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="tenants-active">-</div>
                                    <div class="text-muted small">Tenants Ativos</div>
                                    <div class="small trend-up" id="tenants-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-success me-3">
                                    <i class="fas fa-dollar-sign fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="mrr-value">-</div>
                                    <div class="text-muted small">MRR Plataforma</div>
                                    <div class="small trend-up" id="mrr-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-info me-3">
                                    <i class="fas fa-calendar-check fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="appointments-total">-</div>
                                    <div class="text-muted small">Total Agendamentos</div>
                                    <div class="small trend-up" id="appointments-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-warning me-3">
                                    <i class="fas fa-robot fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="ai-interactions">-</div>
                                    <div class="text-muted small">Interações IA</div>
                                    <div class="small trend-up" id="ai-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Second Row -->
            <div class="row g-3 cards-row">
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-primary me-3">
                                    <i class="fas fa-user-plus fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="new-tenants">-</div>
                                    <div class="text-muted small">Novos Tenants</div>
                                    <div class="small trend-up" id="new-tenants-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-success me-3">
                                    <i class="fas fa-heart fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="churn-rate">-</div>
                                    <div class="text-muted small">Taxa de Churn</div>
                                    <div class="small trend-down" id="churn-trend">
                                        <i class="fas fa-check"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-info me-3">
                                    <i class="fas fa-bullseye fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="conversion-rate">-</div>
                                    <div class="text-muted small">Taxa de Conversão</div>
                                    <div class="small trend-up" id="conversion-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <div class="card metric-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon metric-icon-warning me-3">
                                    <i class="fas fa-users fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="metric-value" id="total-customers">-</div>
                                    <div class="text-muted small">Total Clientes</div>
                                    <div class="small trend-up" id="customers-trend">
                                        <i class="fas fa-arrow-up"></i> <span>-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 4 Charts - 2x2 Grid -->
        <div class="row g-4 mb-4 charts-row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            Evolução MRR
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="mrrChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-user-plus text-primary me-2"></i>
                            Crescimento de Clientes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="customerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt text-info me-2"></i>
                            Agendamentos vs Cancelamentos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="appointmentsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie text-warning me-2"></i>
                            Segmentos dos Negócios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="segmentsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2 Tables -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy text-warning me-2"></i>
                            Top Negócios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="top-businesses-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Negócio</th>
                                        <th>Domínio</th>
                                        <th>Receita</th>
                                        <th>Crescimento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            Carregando...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            Negócios em Risco
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="at-risk-businesses-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Negócio</th>
                                        <th>Domínio</th>
                                        <th>Status</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            Carregando...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let chartsInitialized = false;
        let dashboardData = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setInterval(updateLastUpdateTime, 60000); // Update every minute
        });
        
        // Load real dashboard data from API
        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('ubs_token') || localStorage.getItem('adminToken');
                
                const response = await fetch('/api/admin/analytics/system-dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    dashboardData = result.data;
                    updateMetricsCards(dashboardData);
                    updateTables(dashboardData);
                    initializeCharts(dashboardData);
                } else {
                    console.warn('API failed, using mock data');
                    useMockData();
                }
                
            } catch (error) {
                console.warn('Error loading data, using mock:', error.message);
                useMockData();
            }
        }
        
        // Use mock data if API fails
        function useMockData() {
            dashboardData = {
                saasMetrics: {
                    activeTenants: 9,
                    monthlyRevenue: 894,
                    churnRate: 0.0,
                    newTenants: 9
                },
                systemMetrics: {
                    totalAppointments: 6620,
                    totalCustomers: 297,
                    aiInteractions: 12847,
                    conversionRate: 65.2
                },
                mrrEvolution: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{
                        data: [148, 297, 445, 594, 742, 891]
                    }]
                },
                topTenants: [
                    { name: 'FitLife Academia', domain: 'sports', revenue: 2939, growth: 15.2 },
                    { name: 'Silva & Associados', domain: 'legal', revenue: 2596, growth: 12.8 },
                    { name: 'GlobalSpeak Idiomas', domain: 'education', revenue: 2078, growth: 8.4 },
                    { name: 'DrSmile Odontologia', domain: 'healthcare', revenue: 1722, growth: 6.2 }
                ]
            };
            
            updateMetricsCards(dashboardData);
            updateTables(dashboardData);
            initializeCharts(dashboardData);
        }
        
        // Update metrics cards with real data
        function updateMetricsCards(data) {
            const saas = data.saasMetrics || {};
            const system = data.systemMetrics || {};
            
            // Update values
            document.getElementById('tenants-active').textContent = saas.activeTenants || '9';
            document.getElementById('mrr-value').textContent = formatCurrency(saas.monthlyRevenue || 894);
            document.getElementById('appointments-total').textContent = formatNumber(system.totalAppointments || 6620);
            document.getElementById('ai-interactions').textContent = formatNumber(system.aiInteractions || 12847);
            document.getElementById('new-tenants').textContent = saas.newTenants || '9';
            document.getElementById('churn-rate').textContent = (saas.churnRate || 0).toFixed(1) + '%';
            document.getElementById('conversion-rate').textContent = (system.conversionRate || 65.2).toFixed(1) + '%';
            document.getElementById('total-customers').textContent = formatNumber(system.totalCustomers || 297);
            
            // Update trends
            document.getElementById('tenants-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +100% este mês';
            document.getElementById('mrr-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +12.3% mensal';
            document.getElementById('appointments-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +8.7% crescimento';
            document.getElementById('ai-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +24.1% automação';
            document.getElementById('new-tenants-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +100% este mês';
            document.getElementById('churn-trend').innerHTML = '<i class="fas fa-check"></i> Excelente';
            document.getElementById('conversion-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +5.2% melhoria';
            document.getElementById('customers-trend').innerHTML = '<i class="fas fa-arrow-up"></i> +100% crescimento';
        }
        
        // Update tables with real data
        function updateTables(data) {
            updateTopBusinessesTable(data.topTenants || []);
            updateAtRiskBusinessesTable();
        }
        
        // Update top businesses table
        function updateTopBusinessesTable(tenants) {
            const tbody = document.querySelector('#top-businesses-table tbody');
            const domainBadges = {
                sports: 'info',
                legal: 'warning', 
                education: 'primary',
                healthcare: 'success',
                beauty: 'danger',
                consulting: 'secondary'
            };
            
            const domainNames = {
                sports: 'Esportes',
                legal: 'Jurídico',
                education: 'Educação', 
                healthcare: 'Saúde',
                beauty: 'Beleza',
                consulting: 'Consultoria'
            };
            
            tbody.innerHTML = tenants.map(tenant => `
                <tr>
                    <td><strong>${tenant.name}</strong></td>
                    <td><span class="badge bg-${domainBadges[tenant.domain] || 'secondary'}">${domainNames[tenant.domain] || tenant.domain}</span></td>
                    <td>${formatCurrency(tenant.revenue)}</td>
                    <td><span class="text-success">+${tenant.growth}%</span></td>
                </tr>
            `).join('');
        }
        
        // Update at-risk businesses table
        function updateAtRiskBusinessesTable() {
            const tbody = document.querySelector('#at-risk-businesses-table tbody');
            const atRiskData = [
                { name: 'Consultoria XYZ', domain: 'Consultoria', status: 'Risco Médio', action: 'Monitorar', statusClass: 'warning', actionClass: 'warning' },
                { name: 'Centro Médico ABC', domain: 'Saúde', status: 'Alto Risco', action: 'Intervir', statusClass: 'danger', actionClass: 'danger' }
            ];
            
            tbody.innerHTML = atRiskData.map(item => `
                <tr>
                    <td><strong>${item.name}</strong></td>
                    <td><span class="badge bg-secondary">${item.domain}</span></td>
                    <td><span class="badge bg-${item.statusClass}">${item.status}</span></td>
                    <td><span class="text-${item.actionClass}">${item.action}</span></td>
                </tr>
            `).join('');
        }
        
        // Initialize all charts
        function initializeCharts(data) {
            if (chartsInitialized) return;
            
            initializeMrrChart(data.mrrEvolution);
            initializeCustomerChart();
            initializeAppointmentsChart();
            initializeSegmentsChart();
            
            chartsInitialized = true;
        }
        
        // Chart 1: MRR Evolution
        function initializeMrrChart(mrrData) {
            const ctx = document.getElementById('mrrChart').getContext('2d');
            
            const data = mrrData || {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                datasets: [{ data: [148, 297, 445, 594, 742, 891] }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'MRR (R$)',
                        data: data.datasets[0].data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'MRR: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Chart 2: Customer Growth
        function initializeCustomerChart() {
            const ctx = document.getElementById('customerChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Novos Clientes',
                        data: [45, 67, 89, 103, 127, 156],
                        backgroundColor: '#007bff',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Chart 3: Appointments vs Cancellations
        function initializeAppointmentsChart() {
            const ctx = document.getElementById('appointmentsChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [
                        {
                            label: 'Agendamentos',
                            data: [185, 202, 234, 256, 278, 303],
                            borderColor: '#28a745',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: 'Cancelamentos',
                            data: [12, 15, 18, 14, 16, 19],
                            borderColor: '#dc3545',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Chart 4: Business Segments
        function initializeSegmentsChart() {
            const ctx = document.getElementById('segmentsChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Beleza', 'Saúde', 'Jurídico', 'Educação', 'Esportes', 'Consultoria'],
                    datasets: [{
                        data: [25, 20, 18, 15, 12, 10],
                        backgroundColor: [
                            '#e91e63',
                            '#28a745',
                            '#ffc107',
                            '#007bff',
                            '#17a2b8',
                            '#6f42c1'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }
        
        // Utility functions
        function formatCurrency(value) {
            return 'R$ ' + Number(value || 0).toLocaleString('pt-BR');
        }
        
        function formatNumber(value) {
            return Number(value || 0).toLocaleString('pt-BR');
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = `Atualizado às ${timeStr}`;
        }
    </script>
</body>
</html>