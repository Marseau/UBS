<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Briefing da Campanha | AIC - Applied Intelligence Clustering</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/AIC/Imagens%20Vetor%20/AIC%20Icone%20Cheio.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0C1B33">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.25);
      --aic-green-subtle: rgba(14, 204, 151, 0.1);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-red: #ef4444;
      --aic-red-subtle: rgba(239, 68, 68, 0.1);
      --aic-yellow: #f59e0b;
      --aic-yellow-subtle: rgba(245, 158, 11, 0.1);
      --aic-blue: #3b82f6;
      --aic-blue-subtle: rgba(59, 130, 246, 0.1);
      --aic-purple: #8b5cf6;
      --aic-purple-subtle: rgba(139, 92, 246, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      line-height: 1.7;
      min-height: 100vh;
    }
    body.has-sidebar {
      margin-left: 280px;
    }
    @media (max-width: 768px) {
      body.has-sidebar { margin-left: 0; }
    }

    /* Container */
    .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

    /* Header */
    .header {
      background: rgba(12, 27, 51, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--aic-border);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo {
      height: 36px;
      width: auto;
      filter: brightness(1.1);
    }
    .header-steps {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-step {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: var(--aic-navy-lighter);
      color: var(--aic-gray);
      transition: all 0.3s;
    }
    .header-step.active {
      background: var(--aic-green-subtle);
      color: var(--aic-green);
    }
    .header-step.completed {
      background: var(--aic-green);
      color: var(--aic-navy);
    }
    .header-step-number {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      background: rgba(255,255,255,0.1);
    }
    .header-step.completed .header-step-number {
      background: rgba(0,0,0,0.2);
    }

    /* Main Content */
    .main {
      padding: 48px 0 80px;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 48px;
    }
    .page-title h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .page-title p {
      font-size: 16px;
      color: var(--aic-gray);
      max-width: 700px;
      margin: 0 auto;
    }

    /* Completion Progress Bar */
    .completion-progress-wrapper {
      max-width: 500px;
      margin: 24px auto 0;
      padding: 16px 20px;
      background: var(--aic-navy-light);
      border-radius: 12px;
      border: 1px solid var(--aic-border);
    }
    .completion-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .completion-progress-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--aic-gray-light);
    }
    .completion-progress-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--aic-green);
    }
    .completion-progress-bar {
      height: 8px;
      background: var(--aic-navy);
      border-radius: 4px;
      overflow: hidden;
    }
    .completion-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }
    .completion-progress-hint {
      font-size: 12px;
      color: var(--aic-gray);
      margin-top: 8px;
      text-align: center;
    }
    .completion-progress-hint.complete {
      color: var(--aic-green);
    }

    /* Step Card */
    .step-card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      display: none;
    }
    .step-card.active {
      display: block;
    }
    .step-header {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 28px;
    }
    .step-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }
    .step-info h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--aic-white);
      margin-bottom: 6px;
    }
    .step-info p {
      font-size: 14px;
      color: var(--aic-gray);
      line-height: 1.5;
    }

    /* Landing Page Section */
    .landing-section {
      margin-bottom: 32px;
    }
    .landing-input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .landing-input {
      flex: 1;
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--aic-white);
      font-family: inherit;
    }
    .landing-input:focus {
      outline: none;
      border-color: var(--aic-green);
    }
    .landing-input::placeholder {
      color: var(--aic-gray);
    }
    .landing-btn {
      padding: 14px 24px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      border: none;
      border-radius: 10px;
      color: var(--aic-navy);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .landing-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--aic-green-glow);
    }
    .landing-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Landing Status */
    .landing-status {
      padding: 16px;
      border-radius: 12px;
      display: none;
    }
    .landing-status.show {
      display: block;
    }
    .landing-status.processing {
      background: var(--aic-blue-subtle);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    .landing-status.success {
      background: var(--aic-green-subtle);
      border: 1px solid rgba(14, 204, 151, 0.3);
    }
    .landing-status.error {
      background: var(--aic-red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .landing-status-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .landing-status-icon {
      font-size: 20px;
    }
    .landing-status-title {
      font-weight: 600;
      font-size: 14px;
    }
    .landing-status.processing .landing-status-title { color: var(--aic-blue); }
    .landing-status.success .landing-status-title { color: var(--aic-green); }
    .landing-status.error .landing-status-title { color: var(--aic-red); }
    .landing-status-text {
      font-size: 13px;
      color: var(--aic-gray-light);
      line-height: 1.5;
    }

    /* Upload Area */
    .upload-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--aic-border);
    }
    .upload-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .upload-area {
      border: 2px dashed var(--aic-border);
      border-radius: 12px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(14, 204, 151, 0.02);
    }
    .upload-area:hover {
      border-color: var(--aic-green);
      background: rgba(14, 204, 151, 0.05);
    }
    .upload-area.dragging {
      border-color: var(--aic-green);
      background: rgba(14, 204, 151, 0.1);
    }
    .upload-area.has-file {
      border-color: var(--aic-green);
      border-style: solid;
    }
    .upload-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }
    .upload-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--aic-white);
      margin-bottom: 6px;
    }
    .upload-subtitle {
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* File Preview */
    .file-preview {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--aic-navy);
      border-radius: 10px;
      margin-top: 12px;
    }
    .file-preview-icon {
      font-size: 24px;
    }
    .file-preview-info {
      flex: 1;
    }
    .file-preview-name {
      font-weight: 500;
      color: var(--aic-white);
      font-size: 14px;
    }
    .file-preview-size {
      font-size: 12px;
      color: var(--aic-gray);
    }
    .file-preview-remove {
      padding: 6px 12px;
      background: var(--aic-red-subtle);
      border: none;
      border-radius: 6px;
      color: var(--aic-red);
      font-size: 12px;
      cursor: pointer;
    }

    /* Progress Indicator */
    .progress-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px;
      background: var(--aic-navy);
      border-radius: 10px;
      margin-top: 12px;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--aic-border);
      border-top-color: var(--aic-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .progress-text {
      font-size: 14px;
      color: var(--aic-gray);
    }

    /* Form */
    .form-section {
      margin-bottom: 28px;
    }
    .form-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--aic-green);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--aic-border);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--aic-white);
      margin-bottom: 8px;
    }
    .form-label .required {
      color: var(--aic-red);
      margin-left: 4px;
    }
    .form-label .optional {
      color: var(--aic-gray);
      font-weight: 400;
      font-size: 12px;
      margin-left: 4px;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%;
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--aic-white);
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--aic-green);
    }
    .form-input::placeholder, .form-textarea::placeholder {
      color: var(--aic-gray);
    }
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    .form-textarea.large {
      min-height: 140px;
    }
    .form-hint {
      font-size: 12px;
      color: var(--aic-gray);
      margin-top: 6px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-select {
      cursor: pointer;
    }
    .form-select option {
      background: var(--aic-navy);
      color: var(--aic-white);
    }

    /* Info Box */
    .info-box {
      background: var(--aic-blue-subtle);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }
    .info-box-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .info-box-content {
      flex: 1;
    }
    .info-box-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-blue);
      margin-bottom: 4px;
    }
    .info-box p {
      font-size: 13px;
      color: var(--aic-gray-light);
      line-height: 1.5;
    }
    .info-box.success {
      background: var(--aic-green-subtle);
      border-color: rgba(14, 204, 151, 0.3);
    }
    .info-box.success .info-box-title {
      color: var(--aic-green);
    }
    .info-box.warning {
      background: var(--aic-yellow-subtle);
      border-color: rgba(245, 158, 11, 0.3);
    }
    .info-box.warning .info-box-title {
      color: var(--aic-yellow);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px var(--aic-green-glow);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--aic-border);
      color: var(--aic-white);
    }
    .btn-secondary:hover {
      border-color: var(--aic-green);
      background: var(--aic-green-subtle);
    }

    /* Step Actions */
    .step-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--aic-border);
    }

    /* Documents List */
    .documents-list {
      margin-top: 24px;
    }
    .documents-list-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .document-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--aic-navy);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .document-item-icon {
      font-size: 24px;
    }
    .document-item-info {
      flex: 1;
    }
    .document-item-name {
      font-weight: 500;
      color: var(--aic-white);
      font-size: 14px;
    }
    .document-item-meta {
      font-size: 12px;
      color: var(--aic-gray);
    }
    .document-item-status {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: var(--aic-green-subtle);
      color: var(--aic-green);
    }
    .document-item-remove {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--aic-border);
      border-radius: 6px;
      color: var(--aic-gray);
      font-size: 12px;
      cursor: pointer;
    }
    .document-item-remove:hover {
      border-color: var(--aic-red);
      color: var(--aic-red);
    }

    /* Status Messages */
    .status-message {
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 20px;
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: var(--aic-green-subtle);
      border: 1px solid rgba(14, 204, 151, 0.3);
      color: var(--aic-green);
    }
    .status-message.error {
      background: var(--aic-red-subtle);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--aic-red);
    }

    /* Completion Card */
    .completion-card {
      text-align: center;
      padding: 48px 32px;
    }
    .completion-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }
    .completion-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--aic-white);
      margin-bottom: 12px;
    }
    .completion-text {
      font-size: 16px;
      color: var(--aic-gray);
      margin-bottom: 32px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Footer */
    .footer {
      background: var(--aic-navy);
      border-top: 1px solid var(--aic-border);
      padding: 24px 0;
      text-align: center;
    }
    .footer p {
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .main { padding: 32px 0 60px; }
      .page-title h1 { font-size: 24px; }
      .step-card { padding: 24px 20px; }
      .form-row { grid-template-columns: 1fr; }
      .header-steps { display: none; }
      .step-header { flex-direction: column; text-align: center; }
      .step-icon { margin: 0 auto; }
      .landing-input-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-content">
      <img src="/assets/AIC/Imagens%20Vetor%20/Logo%20Completo%20nome%20Branco%20sem%20fundo.png" alt="AIC" class="header-logo">
      <div class="header-steps">
        <div class="header-step active" id="header-step-1">
          <span class="header-step-number">1</span>
          Landing Page
        </div>
        <div class="header-step" id="header-step-2">
          <span class="header-step-number">2</span>
          Campanha
        </div>
        <div class="header-step" id="header-step-3">
          <span class="header-step-number">3</span>
          Documentos
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Page Title -->
      <div class="page-title">
        <h1>Briefing da Campanha</h1>
        <p>Configure as informacoes que o agente de IA usara para conversar com seus leads.</p>

        <!-- Completion Progress -->
        <div class="completion-progress-wrapper" id="completion-progress">
          <div class="completion-progress-header">
            <span class="completion-progress-label">Progresso do Briefing</span>
            <span class="completion-progress-value" id="completion-value">0%</span>
          </div>
          <div class="completion-progress-bar">
            <div class="completion-progress-fill" id="completion-fill"></div>
          </div>
          <div class="completion-progress-hint" id="completion-hint">Preencha os campos para ativar o agente de IA</div>
        </div>
      </div>

      <!-- ============================================== -->
      <!-- STEP 1: Landing Page + Empresa -->
      <!-- ============================================== -->
      <div class="step-card active" id="step-1">
        <div class="step-header">
          <div class="step-icon">1</div>
          <div class="step-info">
            <h2>Landing Page e Empresa</h2>
            <p>Informe a URL da sua landing page e, opcionalmente, envie um documento sobre sua empresa.</p>
          </div>
        </div>

        <!-- Landing Page URL -->
        <div class="landing-section">
          <div class="form-group" style="margin-bottom: 0;" id="landing-input-container">
            <label class="form-label">URL da Landing Page<span class="required">*</span></label>
            <div class="landing-input-group">
              <input type="url" id="landing_page_url" class="landing-input" placeholder="https://seusite.com/campanha">
              <button type="button" class="landing-btn" id="btn-process-landing" onclick="processLandingPage()">
                Processar
              </button>
            </div>
            <p class="form-hint">O conteudo da landing page sera extraido automaticamente para o agente de IA.</p>
          </div>

          <!-- Landing Status -->
          <div class="landing-status" id="landing-status">
            <div class="landing-status-header">
              <span class="landing-status-icon" id="landing-status-icon"></span>
              <span class="landing-status-title" id="landing-status-title"></span>
            </div>
            <p class="landing-status-text" id="landing-status-text"></p>
          </div>
        </div>

        <!-- Document Upload (Optional) -->
        <div class="upload-section">
          <div class="upload-section-title">Documento da Empresa <span style="color: var(--aic-gray); font-weight: 400;">(opcional)</span></div>

          <div class="info-box" style="margin-bottom: 16px;">
            <span class="info-box-icon">üí°</span>
            <div class="info-box-content">
              <div class="info-box-title">Dica</div>
              <p>Se voce tem uma apresentacao institucional, pitch deck ou proposta comercial, envie aqui. Isso complementa as informacoes da landing page.</p>
            </div>
          </div>

          <div class="upload-area" id="upload-area-empresa"
               onclick="document.getElementById('file-empresa').click()"
               ondragover="handleDragOver(event, 'empresa')"
               ondragleave="handleDragLeave(event, 'empresa')"
               ondrop="handleDrop(event, 'empresa')">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-title">Arraste um documento ou clique para selecionar</div>
            <div class="upload-subtitle">PDF, DOCX ou TXT - Maximo 10MB</div>
          </div>
          <input type="file" id="file-empresa" style="display: none;" accept=".pdf,.docx,.txt,.md" onchange="handleFileSelect(event, 'empresa')">

          <div class="file-preview" id="file-preview-empresa" style="display: none;">
            <span class="file-preview-icon">üìé</span>
            <div class="file-preview-info">
              <div class="file-preview-name" id="file-name-empresa"></div>
              <div class="file-preview-size" id="file-size-empresa"></div>
            </div>
            <button class="file-preview-remove" onclick="clearFile('empresa')">Remover</button>
          </div>

          <div class="progress-indicator" id="progress-empresa" style="display: none;">
            <div class="spinner"></div>
            <span class="progress-text">Processando documento...</span>
          </div>
        </div>

        <div class="step-actions">
          <div></div>
          <button type="button" class="btn btn-primary" onclick="nextStep()" id="btn-next-1">
            Proximo: Dados da Campanha
          </button>
        </div>
      </div>

      <!-- ============================================== -->
      <!-- STEP 2: Dados da Campanha -->
      <!-- ============================================== -->
      <div class="step-card" id="step-2">
        <div class="step-header">
          <div class="step-icon">2</div>
          <div class="step-info">
            <h2>Dados da Campanha</h2>
            <p>Informacoes especificas que nao estao na landing page: objetivos, concorrentes e objecoes.</p>
          </div>
        </div>

        <!-- AI Auto-Fill Button -->
        <div class="ai-extract-section" id="ai-extract-section">
          <div class="info-box" style="background: linear-gradient(135deg, rgba(14, 204, 151, 0.1), rgba(12, 27, 51, 0.1)); border: 1px solid var(--aic-green);">
            <span class="info-box-icon">ü§ñ</span>
            <div class="info-box-content" style="flex: 1;">
              <div class="info-box-title">Preenchimento Inteligente</div>
              <p>A IA pode analisar seus documentos e sugerir respostas para os campos abaixo. Voce revisa e ajusta conforme necessario.</p>
            </div>
            <button type="button" class="btn btn-secondary" id="btn-ai-extract" onclick="extractWithAI()" style="white-space: nowrap;">
              <span id="ai-extract-text">ü§ñ Preencher com IA</span>
            </button>
          </div>
          <div class="ai-extract-status" id="ai-extract-status" style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 14px;"></div>
        </div>

        <!-- Objetivo -->
        <div class="form-section">
          <div class="form-section-title">Objetivo da Campanha</div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="campaign_objective">Objetivo Principal<span class="required">*</span></label>
              <select id="campaign_objective" class="form-select" onchange="toggleOutroObjective()">
                <option value="">Selecione...</option>
                <option value="agendar_reuniao">Agendar reuniao/demonstracao</option>
                <option value="vender_produto">Vender produto/servico</option>
                <option value="captar_lead">Captar lead qualificado</option>
                <option value="inscricao_evento">Inscricao em evento/webinar</option>
                <option value="teste_gratuito">Iniciar teste gratuito</option>
                <option value="outro">Outro</option>
              </select>
              <input type="text" id="campaign_objective_outro" class="form-input" placeholder="Descreva o objetivo da campanha" style="display: none; margin-top: 8px;">
            </div>
            <div class="form-group">
              <label class="form-label" for="calendar_link">Link de Auto-Agendamento<span class="optional">(opcional)</span></label>
              <input type="url" id="calendar_link" class="form-input" placeholder="https://calendly.com/sua-empresa">
              <p class="form-hint">Opcional: Se voce usa Calendly, Cal.com ou similar, o agente pode compartilhar este link para o lead agendar direto. Caso contrario, o agente encaminha o lead para seu WhatsApp.</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="campaign_cta">Proposta para Lead Qualificado<span class="required">*</span></label>
            <input type="text" id="campaign_cta" class="form-input" placeholder="Ex: Conversar 15 minutos com nosso especialista sobre seu caso">
            <p class="form-hint">O que o agente deve propor quando identificar um lead qualificado? Ex: "agendar uma demonstracao", "receber uma proposta personalizada"</p>
          </div>

          <div class="form-group">
            <label class="form-label" for="campaign_offer">Oferta ou Beneficio Exclusivo<span class="optional">(opcional)</span></label>
            <textarea id="campaign_offer" class="form-textarea" placeholder="Ex: 20% de desconto na primeira compra, consultoria gratuita, bonus exclusivo..."></textarea>
            <p class="form-hint">Algo especial para incentivar a acao. Sera preenchido automaticamente se detectado na landing page.</p>
          </div>
        </div>

        <!-- Publico e Dores -->
        <div class="form-section">
          <div class="form-section-title">Publico-Alvo e Problema</div>

          <div class="form-group">
            <label class="form-label" for="target_audience">Perfil do Cliente Ideal (ICP)<span class="required">*</span></label>
            <textarea id="target_audience" class="form-textarea" placeholder="Ex: Donos de clinicas de estetica em SP, com mais de 3 anos de mercado, que faturam acima de R$50k/mes..."></textarea>
            <p class="form-hint">Descreva QUEM e seu cliente ideal. O agente usara isso para qualificar leads.</p>
          </div>

          <div class="form-group">
            <label class="form-label" for="main_pain">Problema que Voce Resolve<span class="required">*</span></label>
            <textarea id="main_pain" class="form-textarea" placeholder="Ex: Dificuldade em atrair novos clientes qualificados sem depender de indicacoes"></textarea>
            <p class="form-hint">QUAL problema seu produto/servico resolve? O agente usara para criar conexao com o lead.</p>
          </div>
        </div>

        <!-- Concorrentes -->
        <div class="form-section">
          <div class="form-section-title">Concorrentes</div>

          <div class="info-box warning" style="margin-bottom: 16px;">
            <span class="info-box-icon">‚öîÔ∏è</span>
            <div class="info-box-content">
              <div class="info-box-title">Por que isso e importante?</div>
              <p>O agente precisa saber quem sao seus concorrentes para posicionar voce como a melhor opcao quando o lead comparar.</p>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="competitors">Principais Concorrentes<span class="required">*</span></label>
            <input type="text" id="competitors" class="form-input" placeholder="Ex: Empresa A, Empresa B, Empresa C">
            <p class="form-hint">Separe por virgulas</p>
          </div>

          <div class="form-group">
            <label class="form-label" for="competitor_weaknesses">Pontos fracos dos concorrentes</label>
            <textarea id="competitor_weaknesses" class="form-textarea" placeholder="O que eles fazem mal? Onde falham? Que reclamacoes os clientes deles tem?"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="why_choose_us">Por que escolher voce?<span class="required">*</span></label>
            <textarea id="why_choose_us" class="form-textarea large" placeholder="Responda como se um lead perguntasse: 'Por que eu deveria te contratar e nao o concorrente X?'"></textarea>
          </div>
        </div>

        <!-- Objecoes -->
        <div class="form-section">
          <div class="form-section-title">Objecoes Comuns</div>

          <div class="form-group">
            <label class="form-label" for="objections">Objecoes comuns e como responder<span class="required">*</span></label>
            <textarea id="objections" class="form-textarea large" placeholder="Ex:&#10;OBJE√á√ÉO: Est√° muito caro&#10;RESPOSTA: Nosso pre√ßo reflete qualidade e resultados comprovados...&#10;&#10;OBJE√á√ÉO: Preciso pensar&#10;RESPOSTA: Entendo! Posso agendar uma conversa r√°pida amanh√£ para tirar d√∫vidas?"></textarea>
            <p class="form-hint">O agente usara isso para responder objecoes de forma convincente</p>
          </div>
        </div>

        <!-- Tom de Voz -->
        <div class="form-section">
          <div class="form-section-title">Comunicacao</div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="tone_of_voice">Tom de voz</label>
              <select id="tone_of_voice" class="form-select">
                <option value="">Selecione...</option>
                <option value="formal">Formal - Corporativo</option>
                <option value="consultivo">Consultivo - Especialista</option>
                <option value="amigavel">Amigavel - Proximo</option>
                <option value="direto">Direto - Objetivo</option>
                <option value="educativo">Educativo - Didatico</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="response_style">Estilo de resposta</label>
              <select id="response_style" class="form-select">
                <option value="">Selecione...</option>
                <option value="curto">Curto e direto</option>
                <option value="detalhado">Detalhado e explicativo</option>
                <option value="equilibrado">Equilibrado</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="words_avoid">Palavras para evitar<span class="optional">(opcional)</span></label>
            <input type="text" id="words_avoid" class="form-input" placeholder="Ex: barato, promocao, urgente, gratis">
            <p class="form-hint">Separe por virgulas</p>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn btn-secondary" onclick="prevStep()">Voltar</button>
          <button type="button" class="btn btn-primary" onclick="nextStep()" id="btn-next-2">
            Proximo: Documentos Extras
          </button>
        </div>
      </div>

      <!-- ============================================== -->
      <!-- STEP 3: Documentos Complementares -->
      <!-- ============================================== -->
      <div class="step-card" id="step-3">
        <div class="step-header">
          <div class="step-icon">3</div>
          <div class="step-info">
            <h2>Documentos Complementares</h2>
            <p>Envie documentos adicionais que podem ajudar o agente (FAQ, catalogo, tabela de precos, etc).</p>
          </div>
        </div>

        <div class="info-box">
          <span class="info-box-icon">üìö</span>
          <div class="info-box-content">
            <div class="info-box-title">Esta etapa e opcional</div>
            <p>Se voce ja enviou um documento na etapa 1 e preencheu os dados da campanha, pode pular esta etapa.</p>
          </div>
        </div>

        <!-- Upload Area for Additional Docs -->
        <div class="upload-area" id="upload-area-docs"
             onclick="document.getElementById('file-docs').click()"
             ondragover="handleDragOver(event, 'docs')"
             ondragleave="handleDragLeave(event, 'docs')"
             ondrop="handleDrop(event, 'docs')">
          <div class="upload-icon">üìé</div>
          <div class="upload-title">Adicionar documento</div>
          <div class="upload-subtitle">PDF, DOCX ou TXT - Maximo 10MB</div>
        </div>
        <input type="file" id="file-docs" style="display: none;" accept=".pdf,.docx,.txt,.md" onchange="handleFileSelect(event, 'docs')">

        <div class="progress-indicator" id="progress-docs" style="display: none;">
          <div class="spinner"></div>
          <span class="progress-text">Processando documento...</span>
        </div>

        <!-- Documents List -->
        <div class="documents-list">
          <div class="documents-list-title">Documentos da Campanha</div>
          <div id="documents-container">
            <p style="color: var(--aic-gray); text-align: center; padding: 24px;">Carregando...</p>
          </div>
        </div>

        <div class="step-actions">
          <button type="button" class="btn btn-secondary" onclick="prevStep()">Voltar</button>
          <button type="button" class="btn btn-primary" onclick="saveBriefing()" id="btn-save">
            Salvar e Concluir
          </button>
        </div>

        <div class="status-message" id="save-status"></div>
      </div>

      <!-- ============================================== -->
      <!-- STEP 4: Completion -->
      <!-- ============================================== -->
      <div class="step-card" id="step-4">
        <div class="completion-card">
          <div class="completion-icon">üéâ</div>
          <h2 class="completion-title">Briefing Completo!</h2>
          <p class="completion-text">Seu agente de IA esta pronto para comecar a conversar com seus leads de forma personalizada.</p>
          <button class="btn btn-primary" onclick="goToDashboard()">
            Ir para o Dashboard
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>AIC - Applied Intelligence Clustering | Briefing seguro e criptografado</p>
    </div>
  </footer>

  <script>
    // =====================================================
    // STATE
    // =====================================================
    let campaignId = null;
    let clientJourneyId = null;
    let currentStep = 1;
    const totalSteps = 3;
    const isClientPortal = window.location.pathname.startsWith('/cliente');
    let landingPageProcessed = false;
    let completionPercentage = 0;

    const files = {
      empresa: null,
      docs: null
    };

    // Update completion progress bar
    function updateCompletionProgress(percentage) {
      completionPercentage = percentage || 0;
      const fillEl = document.getElementById('completion-fill');
      const valueEl = document.getElementById('completion-value');
      const hintEl = document.getElementById('completion-hint');

      if (fillEl) fillEl.style.width = `${completionPercentage}%`;
      if (valueEl) valueEl.textContent = `${completionPercentage}%`;

      if (hintEl) {
        if (completionPercentage >= 80) {
          hintEl.textContent = 'Briefing completo! Agente de IA pronto para uso.';
          hintEl.classList.add('complete');
        } else if (completionPercentage >= 50) {
          hintEl.textContent = `Faltam ${80 - completionPercentage}% para ativar o agente de IA`;
          hintEl.classList.remove('complete');
        } else if (completionPercentage > 0) {
          hintEl.textContent = 'Continue preenchendo para ativar o agente de IA';
          hintEl.classList.remove('complete');
        } else {
          hintEl.textContent = 'Preencha os campos para ativar o agente de IA';
          hintEl.classList.remove('complete');
        }
      }
    }

    // =====================================================
    // AUTH HELPERS
    // =====================================================
    function getAuthHeaders() {
      const token = localStorage.getItem('aic_access_token') || '';
      return {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      };
    }

    async function authFetch(url, options = {}) {
      const headers = {
        ...getAuthHeaders(),
        ...options.headers
      };
      // Don't set Content-Type for FormData
      if (options.body instanceof FormData) {
        delete headers['Content-Type'];
      }
      return fetch(url, { ...options, headers });
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlCampaignId = urlParams.get('campaign');
      const urlJourneyId = urlParams.get('journey');

      // For client portal, ALWAYS get campaign_id from API to avoid using journey_id by mistake
      if (isClientPortal) {
        try {
          const token = localStorage.getItem('aic_access_token') || '';
          const response = await fetch('/api/aic/journey/me', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.journey) {
              // Always use campaign_id from API for client portal (URL might have wrong ID)
              campaignId = data.journey.campaign_id;
              clientJourneyId = data.journey.id;
              console.log('[Briefing] Using campaign_id from API:', campaignId);
            }
          }
        } catch (e) {
          console.error('Error fetching journey:', e);
        }
      } else {
        // For admin, use URL parameters
        campaignId = urlCampaignId;
        clientJourneyId = urlJourneyId;
      }

      if (!campaignId) {
        alert('ID da campanha nao encontrado.');
        window.location.href = isClientPortal ? '/cliente' : '/aic-campaign-onboarding.html';
        return;
      }

      // Load existing data
      await loadExistingData();
      await loadDocuments();
    });

    // =====================================================
    // LANDING PAGE PROCESSING
    // =====================================================
    async function processLandingPage() {
      const url = document.getElementById('landing_page_url').value.trim();

      if (!url) {
        alert('Informe a URL da landing page.');
        return;
      }

      // Validate URL format
      try {
        new URL(url);
      } catch {
        alert('URL invalida. Use o formato: https://seusite.com/pagina');
        return;
      }

      const btn = document.getElementById('btn-process-landing');
      const statusEl = document.getElementById('landing-status');

      btn.disabled = true;
      btn.textContent = 'Processando...';

      // Show processing status
      showLandingStatus('processing', 'Processando...', 'Extraindo conteudo da landing page...');

      try {
        const response = await authFetch(`/api/campaigns/${campaignId}/landing-page`, {
          method: 'POST',
          body: JSON.stringify({ url })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          showLandingStatus('error', 'Erro', result.error || 'Nao foi possivel processar a landing page.');
          btn.disabled = false;
          btn.textContent = 'Processar';
          return;
        }

        landingPageProcessed = true;
        showLandingStatus(
          'success',
          'Landing page processada!',
          `"${result.title || url}" - ${result.chunksCreated} blocos de conhecimento criados.`
        );

        // Auto-fill form fields from LP data
        autoFillFromLandingPage(result);

        // Reload documents to show the new one
        await loadDocuments();

      } catch (error) {
        console.error('Error processing landing page:', error);
        showLandingStatus('error', 'Erro', 'Erro ao processar landing page. Tente novamente.');
      }

      btn.disabled = false;
      btn.textContent = 'Processar';
    }

    /**
     * Auto-fill form fields from landing page extraction
     * Only fills empty fields - doesn't overwrite user data
     */
    function autoFillFromLandingPage(lpData) {
      if (!lpData) return;

      const content = (lpData.content || '').toLowerCase();
      const description = lpData.description || '';

      // Auto-fill offer if detected and field is empty
      const offerField = document.getElementById('campaign_offer');
      if (offerField && !offerField.value.trim()) {
        // Look for common offer patterns
        const offerPatterns = [
          /(\d+%\s*(?:de\s*)?(?:desconto|off))/gi,
          /(gratu[i√≠]t[oa]|free|bonus|brinde)/gi,
          /(oferta\s*(?:especial|exclusiva|limitada))/gi,
          /(primeira?\s*(?:compra|pedido|mes)\s*(?:gr[a√°]tis|free)?)/gi
        ];

        for (const pattern of offerPatterns) {
          const match = content.match(pattern) || (lpData.content || '').match(pattern);
          if (match) {
            offerField.value = `Detectado na LP: "${match[0]}" - edite conforme necessario`;
            offerField.style.borderColor = '#0ECC97';
            setTimeout(() => offerField.style.borderColor = '', 3000);
            break;
          }
        }
      }

      // Auto-fill description/pain point if detected
      const painField = document.getElementById('main_pain');
      if (painField && !painField.value.trim() && description) {
        // Use LP description as a starting point for pain/problem
        if (description.length > 30 && description.length < 500) {
          painField.value = description;
          painField.style.borderColor = '#0ECC97';
          setTimeout(() => painField.style.borderColor = '', 3000);
        }
      }

      // Show notification about auto-filled fields
      const filledFields = [];
      if (offerField?.value.includes('Detectado na LP')) filledFields.push('Oferta');
      if (painField?.value === description && description) filledFields.push('Problema');

      if (filledFields.length > 0) {
        console.log('[Briefing] Auto-preenchido da LP:', filledFields.join(', '));
      }
    }

    // =====================================================
    // AI EXTRACTION - Preencher com IA
    // =====================================================

    /**
     * Extrai campos do briefing usando IA a partir dos documentos
     * O cliente revisa e ajusta as sugest√µes
     */
    async function extractWithAI() {
      const btn = document.getElementById('btn-ai-extract');
      const btnText = document.getElementById('ai-extract-text');
      const statusEl = document.getElementById('ai-extract-status');

      btn.disabled = true;
      btnText.textContent = '‚è≥ Analisando documentos...';
      statusEl.style.display = 'none';

      try {
        const response = await authFetch(`/api/campaigns/${campaignId}/briefing/ai-extract`, {
          method: 'POST'
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          showAIExtractStatus('error', result.error || 'Erro ao extrair campos');
          btn.disabled = false;
          btnText.textContent = 'ü§ñ Preencher com IA';
          return;
        }

        // Preencher campos com as sugest√µes da IA
        const fields = result.fields || {};
        let filledCount = 0;

        // Oferta especial
        if (fields.campaign_offer) {
          const el = document.getElementById('campaign_offer');
          if (el && !el.value.trim()) {
            el.value = fields.campaign_offer;
            highlightField(el);
            filledCount++;
          }
        }

        // P√∫blico-alvo / ICP
        if (fields.target_audience) {
          const el = document.getElementById('target_audience');
          if (el && !el.value.trim()) {
            el.value = fields.target_audience;
            highlightField(el);
            filledCount++;
          }
        }

        // Problema principal
        if (fields.main_pain) {
          const el = document.getElementById('main_pain');
          if (el && !el.value.trim()) {
            el.value = fields.main_pain;
            highlightField(el);
            filledCount++;
          }
        }

        // Por que escolher
        if (fields.why_choose_us) {
          const el = document.getElementById('why_choose_us');
          if (el && !el.value.trim()) {
            el.value = fields.why_choose_us;
            highlightField(el);
            filledCount++;
          }
        }

        // Obje√ß√µes comuns (novo formato: [{objection, response}])
        if (fields.objections && fields.objections.length > 0) {
          const el = document.getElementById('objections');
          if (el && !el.value.trim()) {
            // Suporta formato antigo (string[]) e novo ({objection, response}[])
            const formatted = fields.objections.map(o => {
              if (typeof o === 'string') return `- ${o}`;
              return `OBJE√á√ÉO: ${o.objection}\nRESPOSTA: ${o.response}`;
            }).join('\n\n');
            el.value = formatted;
            highlightField(el);
            filledCount++;
          }
        }

        // CTA
        if (fields.call_to_action) {
          const el = document.getElementById('campaign_cta');
          if (el && !el.value.trim()) {
            el.value = fields.call_to_action;
            highlightField(el);
            filledCount++;
          }
        }

        // Concorrentes
        if (fields.competitors && fields.competitors.length > 0) {
          const el = document.getElementById('competitors');
          if (el && !el.value.trim()) {
            el.value = fields.competitors.join(', ');
            highlightField(el);
            filledCount++;
          }
        }

        // Tom de voz
        if (fields.tone_of_voice) {
          const el = document.getElementById('tone_of_voice');
          if (el && !el.value) {
            el.value = fields.tone_of_voice;
            highlightField(el);
            filledCount++;
          }
        }

        // Mostrar status de sucesso
        const sources = result.sources || [];
        const sourcesText = sources.length > 0 ? ` (baseado em ${sources.length} documento${sources.length > 1 ? 's' : ''})` : '';
        showAIExtractStatus('success', `‚úÖ ${filledCount} campo${filledCount !== 1 ? 's' : ''} preenchido${filledCount !== 1 ? 's' : ''}${sourcesText}. Revise e ajuste conforme necessario.`);

        console.log('[AI Extract] Campos preenchidos:', filledCount, 'de', Object.keys(fields).length);

      } catch (error) {
        console.error('[AI Extract] Erro:', error);
        showAIExtractStatus('error', 'Erro ao conectar com o servidor. Tente novamente.');
      }

      btn.disabled = false;
      btnText.textContent = 'ü§ñ Preencher com IA';
    }

    /**
     * Destaca visualmente um campo preenchido pela IA
     */
    function highlightField(element) {
      element.style.borderColor = '#0ECC97';
      element.style.boxShadow = '0 0 0 3px rgba(14, 204, 151, 0.2)';
      setTimeout(() => {
        element.style.borderColor = '';
        element.style.boxShadow = '';
      }, 5000);
    }

    /**
     * Mostra status da extra√ß√£o por IA
     */
    function showAIExtractStatus(type, message) {
      const statusEl = document.getElementById('ai-extract-status');
      statusEl.style.display = 'block';
      statusEl.textContent = message;

      if (type === 'success') {
        statusEl.style.background = 'rgba(14, 204, 151, 0.1)';
        statusEl.style.color = '#0ECC97';
        statusEl.style.border = '1px solid rgba(14, 204, 151, 0.3)';
      } else if (type === 'error') {
        statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
        statusEl.style.color = '#ef4444';
        statusEl.style.border = '1px solid rgba(239, 68, 68, 0.3)';
      }
    }

    function showLandingStatus(type, title, text) {
      const statusEl = document.getElementById('landing-status');
      const iconEl = document.getElementById('landing-status-icon');
      const titleEl = document.getElementById('landing-status-title');
      const textEl = document.getElementById('landing-status-text');
      const inputContainer = document.getElementById('landing-input-container');

      statusEl.className = `landing-status show ${type}`;

      // Hide input when already processed successfully
      if (type === 'success' && inputContainer) {
        inputContainer.style.display = 'none';
      } else if (inputContainer) {
        inputContainer.style.display = 'block';
      }

      const icons = {
        processing: '‚è≥',
        success: '‚úÖ',
        error: '‚ùå'
      };

      iconEl.textContent = icons[type] || '';
      titleEl.textContent = title;
      textEl.textContent = text;
    }

    // =====================================================
    // OBJETIVO "OUTRO" TOGGLE
    // =====================================================
    function toggleOutroObjective() {
      const select = document.getElementById('campaign_objective');
      const outroInput = document.getElementById('campaign_objective_outro');
      if (select.value === 'outro') {
        outroInput.style.display = 'block';
        outroInput.required = true;
        outroInput.focus();
      } else {
        outroInput.style.display = 'none';
        outroInput.required = false;
        outroInput.value = '';
      }
    }

    // =====================================================
    // STEP NAVIGATION
    // =====================================================
    function showStep(stepNum) {
      // Hide all steps
      for (let i = 1; i <= totalSteps + 1; i++) {
        const stepEl = document.getElementById(`step-${i}`);
        if (stepEl) stepEl.classList.remove('active');

        const headerStepEl = document.getElementById(`header-step-${i}`);
        if (headerStepEl) {
          headerStepEl.classList.remove('active');
          headerStepEl.classList.remove('completed');
        }
      }

      // Show current step
      document.getElementById(`step-${stepNum}`).classList.add('active');

      // Update header steps
      for (let i = 1; i <= totalSteps; i++) {
        const headerStepEl = document.getElementById(`header-step-${i}`);
        if (headerStepEl) {
          if (i < stepNum) {
            headerStepEl.classList.add('completed');
          } else if (i === stepNum) {
            headerStepEl.classList.add('active');
          }
        }
      }

      currentStep = stepNum;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function nextStep() {
      // Validate step 1
      if (currentStep === 1) {
        const url = document.getElementById('landing_page_url').value.trim();
        if (!url && !landingPageProcessed) {
          alert('Por favor, informe e processe a URL da landing page.');
          return;
        }

        // Upload empresa file if exists
        if (files.empresa) {
          await uploadDocument(files.empresa, 'empresa');
        }
      }

      // Validate and auto-save on step 2
      if (currentStep === 2) {
        // Validar "outro" objetivo
        const objectiveSelect = document.getElementById('campaign_objective').value;
        if (objectiveSelect === 'outro') {
          const outroValue = document.getElementById('campaign_objective_outro').value.trim();
          if (!outroValue) {
            alert('Por favor, descreva o objetivo da campanha.');
            document.getElementById('campaign_objective_outro').focus();
            return;
          }
        }
        await autoSave();
      }

      if (currentStep < totalSteps) {
        showStep(currentStep + 1);
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    }

    // =====================================================
    // FILE HANDLING
    // =====================================================
    function handleDragOver(e, type) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById(`upload-area-${type}`).classList.add('dragging');
    }

    function handleDragLeave(e, type) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById(`upload-area-${type}`).classList.remove('dragging');
    }

    function handleDrop(e, type) {
      e.preventDefault();
      e.stopPropagation();
      handleDragLeave(e, type);

      const droppedFiles = e.dataTransfer.files;
      if (droppedFiles.length > 0) {
        processFile(droppedFiles[0], type);
      }
    }

    function handleFileSelect(e, type) {
      const selectedFiles = e.target.files;
      if (selectedFiles.length > 0) {
        processFile(selectedFiles[0], type);
      }
    }

    function processFile(file, type) {
      const allowedTypes = [
        'application/pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'text/plain',
        'text/markdown'
      ];

      if (!allowedTypes.includes(file.type) && !file.name.endsWith('.md')) {
        alert('Formato nao suportado. Use PDF, DOCX, TXT ou MD.');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        alert('Arquivo muito grande. Maximo 10MB.');
        return;
      }

      files[type] = file;

      if (type === 'empresa') {
        // Show file preview
        const uploadArea = document.getElementById('upload-area-empresa');
        uploadArea.style.display = 'none';

        document.getElementById('file-preview-empresa').style.display = 'flex';
        document.getElementById('file-name-empresa').textContent = file.name;
        document.getElementById('file-size-empresa').textContent = `${(file.size / 1024).toFixed(1)} KB`;
      } else {
        // For additional docs, upload immediately
        uploadDocument(file, type);
      }
    }

    function clearFile(type) {
      files[type] = null;
      document.getElementById(`file-${type}`).value = '';

      if (type === 'empresa') {
        document.getElementById('upload-area-empresa').style.display = 'block';
        document.getElementById('file-preview-empresa').style.display = 'none';
      }
    }

    async function uploadDocument(file, type) {
      const progressEl = document.getElementById(`progress-${type}`);
      progressEl.style.display = 'flex';

      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('title', file.name.replace(/\.[^/.]+$/, ''));
        formData.append('docType', type === 'empresa' ? 'briefing' : 'knowledge');

        const response = await authFetch(`/api/campaigns/${campaignId}/documents`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar documento');
        }

        console.log('Document uploaded:', result);
        await loadDocuments();

        if (type === 'empresa') {
          clearFile('empresa');
        }

      } catch (error) {
        console.error('Upload error:', error);
        alert('Erro ao processar documento: ' + error.message);
      }

      progressEl.style.display = 'none';
    }

    // =====================================================
    // DATA LOADING
    // =====================================================
    async function loadExistingData() {
      try {
        // Load campaign data (for landing_page_url)
        const campaignRes = await authFetch(`/api/hashtag-intelligence/campaign/${campaignId}`);
        if (campaignRes.ok) {
          const campaignData = await campaignRes.json();
          // API returns { success, data: { campaign, project } }
          if (campaignData.success && campaignData.data?.campaign) {
            const c = campaignData.data.campaign;
            if (c.landing_page_url) {
              document.getElementById('landing_page_url').value = c.landing_page_url;
              landingPageProcessed = true;
              showLandingStatus('success', 'Landing page ja processada', c.landing_page_url);
            }
          }
        }

        // Load existing briefing
        const briefingRes = await authFetch(`/api/campaigns/${campaignId}/briefing`);
        if (briefingRes.ok) {
          const briefing = await briefingRes.json();
          if (briefing) {
            // Sempre atualizar progresso (mesmo sem campos preenchidos, pode ter LP)
            if (typeof briefing.completion_percentage === 'number') {
              updateCompletionProgress(briefing.completion_percentage);
            }
            // S√≥ preencher form se tiver campos al√©m de completion_percentage
            if (briefing.id || briefing.company_name) {
              populateForm(briefing);
            }
          }
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function populateForm(briefing) {
      // Objetivo - verificar se √© valor predefinido ou personalizado
      if (briefing.campaign_objective) {
        const select = document.getElementById('campaign_objective');
        const outroInput = document.getElementById('campaign_objective_outro');
        const predefinedValues = ['agendar_reuniao', 'vender_produto', 'captar_lead', 'inscricao_evento', 'teste_gratuito'];

        if (predefinedValues.includes(briefing.campaign_objective)) {
          select.value = briefing.campaign_objective;
        } else {
          // Valor personalizado - selecionar "outro" e preencher campo
          select.value = 'outro';
          outroInput.value = briefing.campaign_objective;
          outroInput.style.display = 'block';
        }
      }

      // Step 2 fields
      if (briefing.call_to_action) document.getElementById('campaign_cta').value = briefing.call_to_action;
      if (briefing.campaign_offer) document.getElementById('campaign_offer').value = briefing.campaign_offer;
      if (briefing.icp_description) document.getElementById('target_audience').value = briefing.icp_description;
      if (briefing.icp_main_pain) document.getElementById('main_pain').value = briefing.icp_main_pain;

      if (briefing.competitors_names && Array.isArray(briefing.competitors_names)) {
        document.getElementById('competitors').value = briefing.competitors_names.join(', ');
      }
      if (briefing.competitor_weaknesses) document.getElementById('competitor_weaknesses').value = briefing.competitor_weaknesses;
      if (briefing.why_choose_us) document.getElementById('why_choose_us').value = briefing.why_choose_us;

      if (briefing.icp_objections && Array.isArray(briefing.icp_objections)) {
        document.getElementById('objections').value = briefing.icp_objections.map(o => `- ${o}`).join('\n');
      }

      if (briefing.tone_of_voice) document.getElementById('tone_of_voice').value = briefing.tone_of_voice;
      if (briefing.communication_style) document.getElementById('response_style').value = briefing.communication_style;

      if (briefing.words_to_avoid && Array.isArray(briefing.words_to_avoid)) {
        document.getElementById('words_avoid').value = briefing.words_to_avoid.join(', ');
      }

      if (briefing.calendar_link) document.getElementById('calendar_link').value = briefing.calendar_link;
    }

    // =====================================================
    // DOCUMENTS LIST
    // =====================================================
    async function loadDocuments() {
      const container = document.getElementById('documents-container');

      try {
        const response = await authFetch(`/api/campaigns/${campaignId}/documents`);
        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao carregar documentos');
        }

        if (!result.documents || result.documents.length === 0) {
          container.innerHTML = '<p style="color: var(--aic-gray); text-align: center; padding: 24px;">Nenhum documento enviado ainda.</p>';
          return;
        }

        container.innerHTML = result.documents.map(doc => `
          <div class="document-item">
            <span class="document-item-icon">${getDocIcon(doc.doc_type)}</span>
            <div class="document-item-info">
              <div class="document-item-name">${doc.title}</div>
              <div class="document-item-meta">${getDocTypeLabel(doc.doc_type)} - ${doc.chunks} blocos</div>
            </div>
            <span class="document-item-status">Pronto</span>
            <button class="document-item-remove" onclick="deleteDocument('${encodeURIComponent(doc.title)}')">Remover</button>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading documents:', error);
        container.innerHTML = '<p style="color: var(--aic-red); text-align: center; padding: 24px;">Erro ao carregar documentos.</p>';
      }
    }

    function getDocIcon(type) {
      const icons = {
        'briefing': 'üìã',
        'landing_page': 'üåê',
        'knowledge': 'üìö',
        'faq': '‚ùì',
        'product': 'üì¶',
        'policy': 'üìú',
        'script': 'üìù',
        'other': 'üìÑ'
      };
      return icons[type] || 'üìÑ';
    }

    function getDocTypeLabel(type) {
      const labels = {
        'briefing': 'Briefing',
        'landing_page': 'Landing Page',
        'knowledge': 'Conhecimento',
        'faq': 'FAQ',
        'product': 'Catalogo',
        'policy': 'Politicas',
        'script': 'Script',
        'other': 'Outro'
      };
      return labels[type] || type;
    }

    async function deleteDocument(title) {
      if (!confirm('Remover este documento?')) return;

      try {
        const response = await authFetch(`/api/campaigns/${campaignId}/documents/${title}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Erro ao remover');
        }

        await loadDocuments();
      } catch (error) {
        console.error('Delete error:', error);
        alert('Erro ao remover documento');
      }
    }

    // =====================================================
    // AUTO-SAVE & SAVE
    // =====================================================
    async function autoSave() {
      try {
        const data = collectFormData();
        const response = await authFetch(`/api/campaigns/${campaignId}/briefing`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        if (response.ok) {
          const result = await response.json();
          if (result.briefing && typeof result.briefing.completion_percentage === 'number') {
            updateCompletionProgress(result.briefing.completion_percentage);
          }
          console.log('Auto-saved, completion:', result.briefing?.completion_percentage);
        }
      } catch (error) {
        console.error('Auto-save error:', error);
      }
    }

    function collectFormData() {
      const data = { campaign_id: campaignId };

      // Landing page
      const landingUrl = document.getElementById('landing_page_url').value.trim();
      if (landingUrl) data.landing_page_url = landingUrl;

      // Objective - se "outro", usar valor do campo de texto
      const objectiveSelect = document.getElementById('campaign_objective').value;
      if (objectiveSelect === 'outro') {
        const outroValue = document.getElementById('campaign_objective_outro').value.trim();
        if (outroValue) data.campaign_objective = outroValue;
      } else if (objectiveSelect) {
        data.campaign_objective = objectiveSelect;
      }

      const calendarLink = document.getElementById('calendar_link').value.trim();
      if (calendarLink) data.calendar_link = calendarLink;

      const cta = document.getElementById('campaign_cta').value.trim();
      if (cta) data.call_to_action = cta;

      const offer = document.getElementById('campaign_offer').value.trim();
      if (offer) data.campaign_offer = offer;

      // Audience
      const audience = document.getElementById('target_audience').value.trim();
      if (audience) data.icp_description = audience;

      const pain = document.getElementById('main_pain').value.trim();
      if (pain) data.icp_main_pain = pain;

      // Competitors
      const competitors = document.getElementById('competitors').value.trim();
      if (competitors) {
        data.competitors_names = competitors.split(',').map(c => c.trim()).filter(c => c);
      }

      const weaknesses = document.getElementById('competitor_weaknesses').value.trim();
      if (weaknesses) data.competitor_weaknesses = weaknesses;

      const whyUs = document.getElementById('why_choose_us').value.trim();
      if (whyUs) data.why_choose_us = whyUs;

      // Objections
      const objections = document.getElementById('objections').value.trim();
      if (objections) {
        data.icp_objections = objections
          .split('\n')
          .map(line => line.replace(/^[-‚Ä¢]\s*/, '').trim())
          .filter(line => line.length > 0);
      }

      // Tone
      const tone = document.getElementById('tone_of_voice').value;
      if (tone) data.tone_of_voice = tone;

      const style = document.getElementById('response_style').value;
      if (style) data.communication_style = style;

      const wordsAvoid = document.getElementById('words_avoid').value.trim();
      if (wordsAvoid) {
        data.words_to_avoid = wordsAvoid.split(',').map(w => w.trim()).filter(w => w);
      }

      return data;
    }

    async function saveBriefing() {
      const btn = document.getElementById('btn-save');
      const statusEl = document.getElementById('save-status');

      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        // Validate required fields
        const cta = document.getElementById('campaign_cta').value.trim();
        const audience = document.getElementById('target_audience').value.trim();
        const whyUs = document.getElementById('why_choose_us').value.trim();
        const objections = document.getElementById('objections').value.trim();

        if (!cta) {
          showStatus('save-status', 'O campo "Call to Action" e obrigatorio.', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar e Concluir';
          showStep(2);
          return;
        }

        if (!audience) {
          showStatus('save-status', 'O campo "Publico-alvo" e obrigatorio.', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar e Concluir';
          showStep(2);
          return;
        }

        if (!whyUs) {
          showStatus('save-status', 'O campo "Por que escolher voce" e obrigatorio.', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar e Concluir';
          showStep(2);
          return;
        }

        if (!objections) {
          showStatus('save-status', 'O campo "Objecoes comuns" e obrigatorio.', 'error');
          btn.disabled = false;
          btn.textContent = 'Salvar e Concluir';
          showStep(2);
          return;
        }

        const data = collectFormData();

        const response = await authFetch(`/api/campaigns/${campaignId}/briefing`, {
          method: 'POST',
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || result.error || 'Erro ao salvar briefing');
        }

        // Update completion progress bar from response
        if (result.briefing && typeof result.briefing.completion_percentage === 'number') {
          updateCompletionProgress(result.briefing.completion_percentage);
        }

        // Update journey if exists
        if (clientJourneyId) {
          try {
            const token = localStorage.getItem('aic_access_token') || '';
            await fetch(`/api/aic/journey/${clientJourneyId}/briefing-complete`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              }
            });
          } catch (e) {
            console.warn('Could not update journey:', e);
          }
        }

        // Show completion
        showStep(4);

      } catch (error) {
        console.error('Save error:', error);
        showStatus('save-status', error.message, 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Salvar e Concluir';
    }

    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status-message show ${type}`;
    }

    function goToDashboard() {
      const dashboardUrl = isClientPortal
        ? '/cliente/dashboard'
        : `/aic-dashboard-campaign.html?campaign=${campaignId}`;
      window.location.href = dashboardUrl;
    }
  </script>

  <!-- AIC Sidebar Navigation -->
  <script>
    (function() {
      const isClientPortal = window.location.pathname.startsWith('/cliente');
      const sidebarScript = document.createElement('script');
      sidebarScript.src = isClientPortal ? '/components/aic-client-sidebar.js' : '/components/aic-sidebar.js';
      document.body.appendChild(sidebarScript);
      if (isClientPortal) {
        document.body.classList.add('has-sidebar');
      }
    })();
  </script>
</body>
</html>
