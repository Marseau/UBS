<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Jornada | AIC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .step-completed { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
    .step-current { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); animation: pulse 2s infinite; }
    .step-pending { background: #374151; opacity: 0.5; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
    }
    .progress-bar { transition: width 0.5s ease-in-out; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
  </style>
</head>
<body class="bg-slate-900 min-h-screen">
  <!-- Header -->
  <header class="bg-slate-800 border-b border-slate-700">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-lg">AIC</span>
        </div>
        <div>
          <h1 class="text-white font-semibold">Minha Jornada</h1>
          <p class="text-slate-400 text-sm" id="clientName">Carregando...</p>
        </div>
      </div>
      <div class="text-right">
        <span class="text-2xl font-bold text-white" id="progressPercent">0%</span>
        <p class="text-slate-400 text-xs">Progresso</p>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-4 py-8">
    <!-- Progress Bar -->
    <div class="mb-8">
      <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
        <div id="progressBar" class="h-full progress-bar bg-gradient-to-r from-blue-500 to-purple-600 rounded-full" style="width: 0%"></div>
      </div>
    </div>

    <!-- Current Step Card -->
    <div id="currentStepCard" class="bg-gradient-to-br from-blue-600 to-purple-700 rounded-2xl p-6 mb-8 card-hover">
      <div class="flex items-start justify-between">
        <div>
          <span class="inline-block px-3 py-1 bg-white/20 rounded-full text-white text-xs font-medium mb-3">
            Etapa Atual
          </span>
          <h2 id="currentStepLabel" class="text-2xl font-bold text-white mb-2">Carregando...</h2>
          <p id="nextActionMessage" class="text-blue-100 text-lg">Aguarde...</p>
        </div>
        <div class="text-6xl opacity-30" id="currentStepIcon">&#x1F4CB;</div>
      </div>
      <div id="actionButtonContainer" class="mt-6 hidden">
        <a id="actionButton" href="#" class="inline-flex items-center gap-2 px-6 py-3 bg-white text-blue-600 font-semibold rounded-xl hover:bg-blue-50 transition-colors">
          Continuar <span>&#8594;</span>
        </a>
      </div>
    </div>

    <!-- Steps Timeline -->
    <div class="bg-slate-800 rounded-2xl p-6 mb-8">
      <h3 class="text-lg font-semibold text-white mb-6">Etapas da Jornada</h3>
      <div id="stepsTimeline" class="space-y-4">
        <!-- Steps will be rendered here -->
        <div class="flex items-center gap-4 text-slate-400">
          <div class="w-8 h-8 bg-slate-700 rounded-full animate-pulse"></div>
          <div class="flex-1 h-4 bg-slate-700 rounded animate-pulse"></div>
        </div>
      </div>
    </div>

    <!-- Proposal Details -->
    <div id="proposalDetails" class="bg-slate-800 rounded-2xl p-6 hidden">
      <h3 class="text-lg font-semibold text-white mb-4">Detalhes da Proposta</h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-slate-700/50 rounded-xl p-4">
          <p class="text-slate-400 text-sm">Valor do Contrato</p>
          <p id="contractValue" class="text-2xl font-bold text-green-400">R$ 0</p>
        </div>
        <div class="bg-slate-700/50 rounded-xl p-4">
          <p class="text-slate-400 text-sm">Valor por Lead</p>
          <p id="leadValue" class="text-2xl font-bold text-blue-400">R$ 0</p>
        </div>
        <div class="bg-slate-700/50 rounded-xl p-4 col-span-2">
          <p class="text-slate-400 text-sm">Nicho Alvo</p>
          <p id="targetNiche" class="text-lg font-medium text-white">-</p>
        </div>
      </div>
    </div>

    <!-- Campaign Info (when created) -->
    <div id="campaignInfo" class="bg-slate-800 rounded-2xl p-6 mt-6 hidden">
      <h3 class="text-lg font-semibold text-white mb-4">Sua Campanha</h3>
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
          <span class="text-3xl">&#x1F680;</span>
        </div>
        <div>
          <p id="campaignName" class="text-xl font-bold text-white">-</p>
          <p id="campaignStatus" class="text-slate-400">Status: <span class="text-yellow-400">Configurando</span></p>
        </div>
      </div>
      <a id="campaignLink" href="#" class="mt-4 inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-colors">
        Acessar Dashboard <span>&#8594;</span>
      </a>
    </div>

    <!-- Help Section -->
    <div class="mt-8 text-center">
      <p class="text-slate-400 text-sm">
        Duvidas? Entre em contato pelo WhatsApp
        <a href="https://wa.me/5511999999999" target="_blank" class="text-green-400 hover:text-green-300 ml-1">
          (11) 99999-9999
        </a>
      </p>
    </div>
  </main>

  <!-- Error Modal -->
  <div id="errorModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-slate-800 rounded-2xl p-6 max-w-md mx-4">
      <div class="text-center">
        <div class="text-5xl mb-4">&#x26A0;</div>
        <h3 class="text-xl font-bold text-white mb-2">Link Invalido</h3>
        <p id="errorMessage" class="text-slate-400 mb-6">O link de acesso e invalido ou expirou.</p>
        <a href="/aic" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-colors">
          Voltar ao Inicio
        </a>
      </div>
    </div>
  </div>

  <script>
    // Step icons mapping
    const STEP_ICONS = {
      'proposta_enviada': '&#x1F4E7;',
      'proposta_visualizada': '&#x1F440;',
      'contrato_enviado': '&#x1F4DD;',
      'contrato_assinado': '&#x270D;',
      'pagamento_pendente': '&#x1F4B3;',
      'pagamento_confirmado': '&#x2705;',
      'credenciais_pendente': '&#x1F511;',
      'credenciais_ok': '&#x1F512;',
      'briefing_pendente': '&#x1F4CB;',
      'briefing_completo': '&#x1F4CA;',
      'campanha_ativa': '&#x1F680;',
      'campanha_concluida': '&#x1F3C6;'
    };

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      document.getElementById('errorModal').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = 'Nenhum token de acesso fornecido.';
    } else {
      loadJourney();
    }

    async function loadJourney() {
      try {
        const response = await fetch(`/api/aic/journey/by-token/${token}`);
        const data = await response.json();

        if (!data.success) {
          document.getElementById('errorModal').classList.remove('hidden');
          document.getElementById('errorMessage').textContent = data.message || 'Erro ao carregar jornada.';
          return;
        }

        renderJourney(data.journey);

      } catch (error) {
        console.error('Error loading journey:', error);
        document.getElementById('errorModal').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = 'Erro de conexao. Tente novamente.';
      }
    }

    function renderJourney(journey) {
      // Client name
      document.getElementById('clientName').textContent = journey.client_name || 'Cliente';

      // Progress
      document.getElementById('progressPercent').textContent = `${journey.progress}%`;
      document.getElementById('progressBar').style.width = `${journey.progress}%`;

      // Current step
      const currentStep = journey.steps.find(s => s.status === 'current');
      if (currentStep) {
        document.getElementById('currentStepLabel').textContent = currentStep.label;
        document.getElementById('currentStepIcon').innerHTML = STEP_ICONS[currentStep.step] || '&#x1F4CB;';
      }

      // Next action
      document.getElementById('nextActionMessage').textContent = journey.next_action_message || '';

      // Action button
      if (journey.next_action_url) {
        document.getElementById('actionButtonContainer').classList.remove('hidden');
        document.getElementById('actionButton').href = journey.next_action_url;
      }

      // Steps timeline
      const timeline = document.getElementById('stepsTimeline');
      timeline.innerHTML = '';

      // Group steps for simplified view
      const groupedSteps = [
        { label: 'Proposta', steps: ['proposta_enviada', 'proposta_visualizada'] },
        { label: 'Contrato', steps: ['contrato_enviado', 'contrato_assinado'] },
        { label: 'Pagamento', steps: ['pagamento_pendente', 'pagamento_confirmado'] },
        { label: 'Credenciais', steps: ['credenciais_pendente', 'credenciais_ok'] },
        { label: 'Briefing', steps: ['briefing_pendente', 'briefing_completo'] },
        { label: 'Campanha', steps: ['campanha_ativa', 'campanha_concluida'] }
      ];

      groupedSteps.forEach((group, index) => {
        const groupSteps = journey.steps.filter(s => group.steps.includes(s.step));
        const isCompleted = groupSteps.every(s => s.status === 'completed');
        const isCurrent = groupSteps.some(s => s.status === 'current');
        const isPending = groupSteps.every(s => s.status === 'pending');

        const stepHtml = `
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold
              ${isCompleted ? 'step-completed' : isCurrent ? 'step-current' : 'step-pending'}">
              ${isCompleted ? '&#x2713;' : index + 1}
            </div>
            <div class="flex-1">
              <p class="text-white font-medium ${isPending ? 'opacity-50' : ''}">${group.label}</p>
              <p class="text-slate-400 text-sm ${isPending ? 'opacity-50' : ''}">
                ${isCompleted ? 'Concluido' : isCurrent ? 'Em andamento' : 'Pendente'}
              </p>
            </div>
            ${isCompleted ? '<span class="text-green-400 text-lg">&#x2713;</span>' : ''}
          </div>
          ${index < groupedSteps.length - 1 ? '<div class="ml-5 w-0.5 h-6 bg-slate-700"></div>' : ''}
        `;
        timeline.innerHTML += stepHtml;
      });

      // Proposal details
      if (journey.proposal_data) {
        const pd = journey.proposal_data;
        document.getElementById('proposalDetails').classList.remove('hidden');
        document.getElementById('contractValue').textContent = `R$ ${(pd.contract_value || 4000).toLocaleString('pt-BR')}`;
        document.getElementById('leadValue').textContent = `R$ ${pd.lead_value || 10}`;
        document.getElementById('targetNiche').textContent = pd.target_niche || '-';
      }

      // Campaign info
      if (journey.campaign_id) {
        document.getElementById('campaignInfo').classList.remove('hidden');
        document.getElementById('campaignName').textContent = journey.proposal_data?.project_name || 'Sua Campanha';
        document.getElementById('campaignLink').href = `/aic/onboarding?campaign=${journey.campaign_id}`;

        // Update status based on current step
        const statusEl = document.getElementById('campaignStatus').querySelector('span');
        if (journey.current_step === 'campanha_ativa') {
          statusEl.textContent = 'Ativa';
          statusEl.className = 'text-green-400';
        } else if (journey.current_step === 'campanha_concluida') {
          statusEl.textContent = 'Concluida';
          statusEl.className = 'text-blue-400';
        } else if (journey.current_step === 'briefing_completo') {
          statusEl.textContent = 'Aguardando Ativacao';
          statusEl.className = 'text-cyan-400';
          // Mostrar mensagem explicativa
          showAwaitingActivationMessage();
        } else {
          statusEl.textContent = 'Configurando';
          statusEl.className = 'text-yellow-400';
        }
      }
    }

    function showAwaitingActivationMessage() {
      const container = document.querySelector('.container');
      const banner = document.createElement('div');
      banner.className = 'awaiting-activation-banner';
      banner.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(14, 204, 151, 0.1)); border: 1px solid rgba(6, 182, 212, 0.3); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
          <h3 style="color: #06b6d4; font-size: 18px; font-weight: 600; margin-bottom: 12px;">Briefing Concluido - Aguardando Ativacao</h3>
          <p style="color: #94a3b8; font-size: 14px; line-height: 1.6; margin-bottom: 16px;">
            Parabens! Voce concluiu todas as etapas de configuracao. Nossa equipe esta revisando seu briefing
            e ativara sua campanha em breve. Voce sera notificado quando a campanha estiver ativa.
          </p>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <span style="background: rgba(6, 182, 212, 0.2); color: #06b6d4; padding: 6px 12px; border-radius: 6px; font-size: 13px;">Briefing revisado pela equipe</span>
            <span style="background: rgba(14, 204, 151, 0.2); color: #0ECC97; padding: 6px 12px; border-radius: 6px; font-size: 13px;">Campanha sera ativada em ate 24h</span>
          </div>
        </div>
      `;
      container.insertBefore(banner, container.firstChild.nextSibling);
    }
  </script>
</body>
</html>
