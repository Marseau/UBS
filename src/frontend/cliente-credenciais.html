<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credenciais | Portal AIC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.15);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-yellow: #F59E0B;
      --aic-danger: #ef4444;
      --sidebar-width: 280px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      line-height: 1.7;
    }
    body.has-sidebar { margin-left: var(--sidebar-width); }

    .main-content {
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Status Banner */
    .status-banner {
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .status-banner.pending {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .status-banner.complete {
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
    }
    .status-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .status-banner.pending .status-icon {
      background: rgba(245, 158, 11, 0.2);
    }
    .status-banner.complete .status-icon {
      background: rgba(14, 204, 151, 0.2);
    }
    .status-text h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: var(--aic-white);
    }
    .status-text p {
      margin: 0;
      font-size: 14px;
      color: var(--aic-gray);
    }

    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }
    .page-header p {
      color: var(--aic-gray);
      margin: 0;
      font-size: 15px;
    }

    /* Progress */
    .progress-section {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .progress-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-gray);
    }
    .progress-count {
      font-size: 14px;
      color: var(--aic-green);
      font-weight: 600;
    }
    .progress-bar {
      height: 8px;
      background: var(--aic-navy);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Cards */
    .card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
    }
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--aic-white);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .card h2 .icon {
      width: 40px;
      height: 40px;
      background: var(--aic-navy);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .card .subtitle {
      color: var(--aic-gray);
      font-size: 14px;
      margin-bottom: 24px;
    }
    .card.complete {
      border-color: rgba(14, 204, 151, 0.3);
    }
    .card.complete h2 .icon {
      background: rgba(14, 204, 151, 0.2);
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--aic-white);
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--aic-white);
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--aic-green);
    }
    .form-input::placeholder {
      color: var(--aic-gray);
    }
    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .form-hint {
      font-size: 12px;
      color: var(--aic-gray);
      margin-top: 6px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Warning Box */
    .warning-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .warning-box h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--aic-danger);
    }
    .warning-box p {
      margin: 0;
      font-size: 13px;
      color: var(--aic-gray-light);
    }

    /* Info Box */
    .info-box {
      background: rgba(14, 204, 151, 0.1);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .info-box h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--aic-green);
    }
    .info-box p {
      margin: 0;
      font-size: 13px;
      color: var(--aic-gray-light);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--aic-green-glow);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--aic-border);
      color: var(--aic-gray);
    }
    .btn-secondary:hover {
      border-color: var(--aic-green);
      color: var(--aic-green);
    }
    .btn-full {
      width: 100%;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: var(--aic-yellow);
    }
    .status-badge.complete {
      background: rgba(14, 204, 151, 0.2);
      color: var(--aic-green);
    }

    /* Success section */
    .success-section {
      text-align: center;
      padding: 40px;
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 16px;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      background: rgba(14, 204, 151, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
    }
    .success-section h2 {
      margin: 0 0 12px 0;
      font-size: 24px;
      color: var(--aic-green);
    }
    .success-section p {
      margin: 0 0 24px 0;
      color: var(--aic-gray-light);
    }

    /* Status Message */
    .status-message {
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: rgba(14, 204, 151, 0.1);
      border: 1px solid rgba(14, 204, 151, 0.3);
      color: var(--aic-green);
    }
    .status-message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    /* Loading */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--aic-border);
      border-top-color: var(--aic-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      body.has-sidebar { margin-left: 0; }
      .main-content { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="has-sidebar">
  <div class="main-content" id="main-content">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p style="color: var(--aic-gray);">Carregando credenciais...</p>
    </div>
  </div>

  <!-- Client Sidebar -->
  <script src="/components/aic-client-sidebar.js"></script>

  <script>
    let journeyData = null;
    let credentialsData = { whatsapp: null, instagram: null };

    // Formatar telefone: +55 11 99999-9999
    function formatPhone(value) {
      if (!value) return '';
      // Remove tudo exceto numeros
      let numbers = value.replace(/\D/g, '');

      // Limita a 13 digitos (55 + DDD + 9 digitos)
      numbers = numbers.slice(0, 13);

      // Aplica mascara
      if (numbers.length === 0) return '';
      if (numbers.length <= 2) return '+' + numbers;
      if (numbers.length <= 4) return '+' + numbers.slice(0, 2) + ' ' + numbers.slice(2);
      if (numbers.length <= 9) return '+' + numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' + numbers.slice(4);
      return '+' + numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' + numbers.slice(4, 9) + '-' + numbers.slice(9);
    }

    async function init() {
      try {
        const isAdmin = localStorage.getItem('aic_user_role') === 'admin';

        // Admin usa cliente selecionado
        if (isAdmin) {
          await new Promise(r => setTimeout(r, 150));
          const selectedClient = window.getSelectedClient ? window.getSelectedClient() : null;
          if (selectedClient) {
            journeyData = selectedClient;
            renderPage();
            return;
          }
          document.getElementById('main-content').innerHTML = `
            <div style="text-align: center; padding: 60px; color: #94a3b8;">
              <p>Selecione um cliente no menu lateral para visualizar.</p>
            </div>
          `;
          return;
        }

        // Cliente normal
        const token = localStorage.getItem('aic_access_token');
        if (!token) {
          window.location.href = '/aic/login?redirect=/cliente';
          return;
        }

        const response = await fetch('/api/aic/journey/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('aic_access_token');
            window.location.href = '/aic/login?redirect=/cliente';
            return;
          }
          throw new Error('Erro ao carregar dados');
        }

        const responseData = await response.json();
        journeyData = responseData.journey || responseData;

        // Check if can access this step
        const STEP_ORDER = [
          'proposta_enviada', 'proposta_visualizada', 'contrato_enviado', 'contrato_assinado',
          'pagamento_pendente', 'pagamento_confirmado', 'credenciais_pendente', 'credenciais_ok',
          'briefing_pendente', 'briefing_completo', 'campanha_ativa', 'campanha_concluida'
        ];
        const currentIndex = STEP_ORDER.indexOf(journeyData.current_step);
        console.log('[Credenciais] current_step:', journeyData.current_step, 'index:', currentIndex);
        if (currentIndex < 5) { // Need at least pagamento_confirmado
          window.location.href = '/cliente/pagamento';
          return;
        }

        // Load existing credentials if available
        if (journeyData.campaign_id) {
          await loadCredentials();
        }

        renderPage();

      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('main-content').innerHTML = `
          <div class="loading-state">
            <p style="color: #ef4444;">Erro ao carregar dados. Por favor, tente novamente.</p>
            <button onclick="location.reload()" class="btn btn-secondary" style="margin-top: 16px;">Tentar Novamente</button>
          </div>
        `;
      }
    }

    async function loadCredentials() {
      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch(`/api/aic/journey/credentials`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          credentialsData = data.credentials || { whatsapp: null, instagram: null };
        }
      } catch (err) {
        console.warn('Could not load credentials:', err);
      }
    }

    function renderPage() {
      const isComplete = ['credenciais_ok', 'briefing_pendente', 'briefing_completo',
        'campanha_ativa', 'campanha_concluida'
      ].includes(journeyData.current_step);

      const hasWhatsapp = credentialsData.whatsapp && credentialsData.whatsapp.phone;
      const hasInstagram = credentialsData.instagram && credentialsData.instagram.username;
      const progress = (hasWhatsapp ? 1 : 0) + (hasInstagram ? 1 : 0);

      document.getElementById('main-content').innerHTML = `
        <!-- Status Banner -->
        <div class="status-banner ${isComplete ? 'complete' : 'pending'}">
          <div class="status-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${isComplete
                ? '<path d="M20 6L9 17l-5-5"/>'
                : '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>'}
            </svg>
          </div>
          <div class="status-text">
            <h3>${isComplete ? 'Credenciais Configuradas' : 'Configure suas Credenciais'}</h3>
            <p>${isComplete ? 'Tudo pronto! Continue para o briefing.' : 'Conecte WhatsApp e Instagram para iniciar a campanha.'}</p>
          </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
          <h1>Credenciais</h1>
          <p>Configure as contas que serao usadas na campanha</p>
        </div>

        ${isComplete ? `
          <!-- Success Section -->
          <div class="success-section">
            <div class="success-icon">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
            </div>
            <h2>Credenciais Configuradas!</h2>
            <p>Suas contas estao prontas. Agora vamos para o briefing para entender melhor seu negocio.</p>
            <a href="/cliente/briefing" class="btn btn-primary">Ir para Briefing</a>
          </div>
        ` : `
          <!-- Progress -->
          <div class="progress-section">
            <div class="progress-header">
              <span class="progress-title">Progresso da Configuracao</span>
              <span class="progress-count">${progress}/2 concluido</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress * 50}%"></div>
            </div>
          </div>

          <!-- WhatsApp Card -->
          <div class="card ${hasWhatsapp ? 'complete' : ''}">
            <h2>
              <div class="icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
              </div>
              WhatsApp
              <span class="status-badge ${hasWhatsapp ? 'complete' : 'pending'}">${hasWhatsapp ? 'Configurado' : 'Pendente'}</span>
            </h2>
            <p class="subtitle">Numero WhatsApp que sera usado para enviar mensagens aos leads.</p>

            <div class="warning-box">
              <h4>Importante</h4>
              <p>Use uma linha WhatsApp exclusiva para a campanha. Nao use seu numero pessoal. Recomendamos criar uma conta WhatsApp normal (nao Business).</p>
            </div>

            <form id="whatsapp-form" onsubmit="return saveWhatsapp(event)">
              <div class="form-group">
                <label class="form-label">Numero WhatsApp *</label>
                <input type="tel" id="wa_phone" class="form-input" placeholder="+55 11 99999-9999" value="${formatPhone(credentialsData.whatsapp?.phone || '')}" oninput="this.value = formatPhone(this.value)" required>
                <p class="form-hint">Formato: +55 DDD NUMERO</p>
              </div>

              <button type="submit" class="btn btn-primary btn-full" id="wa-btn">
                ${hasWhatsapp ? 'Atualizar WhatsApp' : 'Salvar WhatsApp'}
              </button>
              <div id="wa-status" class="status-message"></div>
            </form>
          </div>

          <!-- Instagram Card -->
          <div class="card ${hasInstagram ? 'complete' : ''}">
            <h2>
              <div class="icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
              </div>
              Instagram Business
              <span class="status-badge ${hasInstagram ? 'complete' : 'pending'}" id="ig-status-badge">${hasInstagram ? 'Conectado' : 'Pendente'}</span>
            </h2>
            <p class="subtitle">Conecte sua conta Instagram Business via Facebook para envio de DMs.</p>

            <div class="warning-box" style="background: rgba(255, 193, 7, 0.1); border-color: #ffc107;">
              <h4>Pre-requisitos Obrigatorios</h4>
              <ol style="margin: 8px 0 0 16px; line-height: 1.6;">
                <li><strong>Conta Instagram Business ou Creator</strong> - Converta em Configuracoes → Conta → Mudar para conta profissional</li>
                <li><strong>Facebook Page vinculada</strong> - Conecte seu Instagram a uma Facebook Page</li>
                <li><strong>Acesso de Admin a Page</strong> - Voce precisa ser administrador da Page</li>
              </ol>
            </div>

            <!-- Botao de conexao OAuth -->
            <div id="ig-connect-section" style="display: ${hasInstagram ? 'none' : 'block'};">
              <button type="button" class="btn btn-primary btn-full" onclick="connectInstagram()" id="ig-connect-btn">
                <svg style="width: 18px; height: 18px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/>
                </svg>
                Conectar com Facebook
              </button>
              <p class="form-hint" style="text-align: center; margin-top: 12px;">Voce sera redirecionado para o Facebook para autorizar o acesso.</p>
            </div>

            <!-- Conta conectada -->
            <div id="ig-connected-section" style="display: ${hasInstagram ? 'flex' : 'none'}; align-items: center; gap: 16px; padding: 16px; background: rgba(14, 204, 151, 0.1); border-radius: 8px; margin-top: 16px;">
              <img id="ig-profile-pic" src="${credentialsData.instagram?.profile_picture_url || ''}" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #0ecc97;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #fff;">@<span id="ig-connected-username">${credentialsData.instagram?.username || ''}</span></div>
                <div style="color: #888; font-size: 13px;">Instagram Business conectado</div>
              </div>
              <span style="font-size: 24px; color: #0ecc97;">✓</span>
            </div>

            ${hasInstagram ? `
              <button type="button" class="btn btn-full" onclick="disconnectInstagram()" style="margin-top: 12px; background: transparent; border: 1px solid #666; color: #888;">
                Desconectar Instagram
              </button>
            ` : ''}

            <div class="info-box" style="margin-top: 16px; background: rgba(14, 204, 151, 0.1); border-color: #0ecc97;">
              <h4 style="color: #0ecc97;">Seguranca via OAuth</h4>
              <p><strong>Nunca pedimos sua senha!</strong> A conexao e feita via autorizacao segura do Facebook/Meta. Voce pode revogar o acesso a qualquer momento nas configuracoes do Facebook.</p>
            </div>

            <div id="ig-status" class="status-message"></div>
          </div>

          <!-- Continue Button -->
          ${progress === 2 ? `
            <button class="btn btn-primary btn-full" onclick="completeCredentials()" id="complete-btn" style="margin-top: 16px;">
              Concluir e Ir para Briefing
            </button>
            <div id="complete-status" class="status-message"></div>
          ` : `
            <p style="text-align: center; color: var(--aic-gray); margin-top: 24px;">
              Configure ambas as contas para prosseguir para o briefing.
            </p>
          `}
        `}
      `;
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = message;
      el.className = `status-message show ${type}`;
    }

    async function saveWhatsapp(event) {
      event.preventDefault();
      const btn = document.getElementById('wa-btn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch('/api/aic/journey/credentials/whatsapp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            phone: document.getElementById('wa_phone').value.trim().replace(/\D/g, '')
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao salvar');
        }

        showStatus('wa-status', 'WhatsApp salvo com sucesso!', 'success');
        credentialsData.whatsapp = { phone: document.getElementById('wa_phone').value };

        setTimeout(() => {
          renderPage();
        }, 1000);

      } catch (error) {
        showStatus('wa-status', error.message || 'Erro ao salvar. Tente novamente.', 'error');
        btn.disabled = false;
        btn.textContent = 'Salvar WhatsApp';
      }
    }

    // Connect Instagram via OAuth (redirects to Facebook)
    function connectInstagram() {
      const campaignId = journeyData?.campaign_id;
      if (!campaignId) {
        showStatus('ig-status', 'Erro: Campaign ID nao encontrado', 'error');
        return;
      }

      // Salvar estado para retorno
      localStorage.setItem('ig_oauth_return', window.location.href);

      // Redirecionar para OAuth
      window.location.href = `/api/instagram/oauth/authorize?campaignId=${campaignId}`;
    }

    // Disconnect Instagram account
    async function disconnectInstagram() {
      if (!confirm('Tem certeza que deseja desconectar sua conta Instagram?')) {
        return;
      }

      const campaignId = journeyData?.campaign_id;
      if (!campaignId) {
        showStatus('ig-status', 'Erro: Campaign ID nao encontrado', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/instagram/oauth/disconnect/${campaignId}`, {
          method: 'POST'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erro ao desconectar');
        }

        showStatus('ig-status', 'Conta desconectada com sucesso', 'success');
        credentialsData.instagram = null;

        setTimeout(() => {
          renderPage();
        }, 1000);

      } catch (error) {
        showStatus('ig-status', error.message || 'Erro ao desconectar', 'error');
      }
    }

    // Handle OAuth callback
    function handleInstagramOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);

      if (urlParams.has('instagram_connected')) {
        const username = urlParams.get('instagram_username') || '';
        showStatus('ig-status', `Conta @${username} conectada com sucesso!`, 'success');
        credentialsData.instagram = { username };

        // Limpar URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);

        setTimeout(() => {
          renderPage();
        }, 1000);
      }

      if (urlParams.has('instagram_error')) {
        const error = decodeURIComponent(urlParams.get('instagram_error') || 'Erro desconhecido');
        showStatus('ig-status', error, 'error');

        // Limpar URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);
      }
    }

    // Check on page load
    document.addEventListener('DOMContentLoaded', function() {
      handleInstagramOAuthCallback();
    });

    async function completeCredentials() {
      const btn = document.getElementById('complete-btn');
      btn.disabled = true;
      btn.textContent = 'Finalizando...';

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch('/api/aic/journey/complete-credentials', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao finalizar');
        }

        window.location.href = '/cliente/briefing';

      } catch (error) {
        showStatus('complete-status', error.message || 'Erro. Tente novamente.', 'error');
        btn.disabled = false;
        btn.textContent = 'Concluir e Ir para Briefing';
      }
    }

    // Initialize
    init();
  </script>
</body>
</html>
