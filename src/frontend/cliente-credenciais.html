<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credenciais | Portal AIC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.15);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-yellow: #F59E0B;
      --aic-danger: #ef4444;
      --sidebar-width: 280px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      line-height: 1.7;
    }
    body.has-sidebar { margin-left: var(--sidebar-width); }

    .main-content {
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Status Banner */
    .status-banner {
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .status-banner.pending {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .status-banner.complete {
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
    }
    .status-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    .status-banner.pending .status-icon {
      background: rgba(245, 158, 11, 0.2);
    }
    .status-banner.complete .status-icon {
      background: rgba(14, 204, 151, 0.2);
    }
    .status-text h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: var(--aic-white);
    }
    .status-text p {
      margin: 0;
      font-size: 14px;
      color: var(--aic-gray);
    }

    /* Page Header */
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }
    .page-header p {
      color: var(--aic-gray);
      margin: 0;
      font-size: 15px;
    }

    /* Progress */
    .progress-section {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .progress-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--aic-gray);
    }
    .progress-count {
      font-size: 14px;
      color: var(--aic-green);
      font-weight: 600;
    }
    .progress-bar {
      height: 8px;
      background: var(--aic-navy);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Cards */
    .card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
    }
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--aic-white);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .card h2 .icon {
      width: 40px;
      height: 40px;
      background: var(--aic-navy);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .card .subtitle {
      color: var(--aic-gray);
      font-size: 14px;
      margin-bottom: 24px;
    }
    .card.complete {
      border-color: rgba(14, 204, 151, 0.3);
    }
    .card.complete h2 .icon {
      background: rgba(14, 204, 151, 0.2);
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--aic-white);
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--aic-white);
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--aic-green);
    }
    .form-input::placeholder {
      color: var(--aic-gray);
    }
    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .form-hint {
      font-size: 12px;
      color: var(--aic-gray);
      margin-top: 6px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Warning Box */
    .warning-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .warning-box h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--aic-danger);
    }
    .warning-box p {
      margin: 0;
      font-size: 13px;
      color: var(--aic-gray-light);
    }

    /* Info Box */
    .info-box {
      background: rgba(14, 204, 151, 0.1);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .info-box h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--aic-green);
    }
    .info-box p {
      margin: 0;
      font-size: 13px;
      color: var(--aic-gray-light);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--aic-green-glow);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--aic-border);
      color: var(--aic-gray);
    }
    .btn-secondary:hover {
      border-color: var(--aic-green);
      color: var(--aic-green);
    }
    .btn-full {
      width: 100%;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: var(--aic-yellow);
    }
    .status-badge.complete {
      background: rgba(14, 204, 151, 0.2);
      color: var(--aic-green);
    }

    /* Success section */
    .success-section {
      text-align: center;
      padding: 40px;
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 16px;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      background: rgba(14, 204, 151, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
    }
    .success-section h2 {
      margin: 0 0 12px 0;
      font-size: 24px;
      color: var(--aic-green);
    }
    .success-section p {
      margin: 0 0 24px 0;
      color: var(--aic-gray-light);
    }

    /* Status Message */
    .status-message {
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: rgba(14, 204, 151, 0.1);
      border: 1px solid rgba(14, 204, 151, 0.3);
      color: var(--aic-green);
    }
    .status-message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    /* Loading */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--aic-border);
      border-top-color: var(--aic-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      body.has-sidebar { margin-left: 0; }
      .main-content { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
    }

    /* QR Code Modal */
    .qr-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(12, 27, 51, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .qr-modal.show { display: flex; }
    .qr-modal-content {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 20px;
      padding: 32px;
      max-width: 480px;
      width: 100%;
      text-align: center;
    }
    .qr-modal h2 {
      margin: 0 0 8px 0;
      font-size: 22px;
      color: var(--aic-white);
    }
    .qr-modal .subtitle {
      color: var(--aic-gray);
      margin-bottom: 24px;
    }
    .qr-code-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      display: inline-block;
    }
    .qr-code-container img {
      max-width: 220px;
      height: auto;
    }
    .qr-steps {
      background: var(--aic-navy);
      border-radius: 12px;
      padding: 20px;
      text-align: left;
      margin-bottom: 24px;
    }
    .qr-steps h4 {
      margin: 0 0 16px 0;
      font-size: 14px;
      color: var(--aic-green);
    }
    .qr-steps ol {
      margin: 0;
      padding-left: 20px;
    }
    .qr-steps li {
      margin-bottom: 10px;
      font-size: 14px;
      color: var(--aic-gray-light);
    }
    .qr-steps li strong {
      color: var(--aic-white);
    }
    .qr-status {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .qr-status.checking {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--aic-yellow);
    }
    .qr-status.connected {
      background: rgba(14, 204, 151, 0.1);
      border: 1px solid rgba(14, 204, 151, 0.3);
      color: var(--aic-green);
    }
    .qr-modal-buttons {
      display: flex;
      gap: 12px;
    }
    .qr-modal-buttons .btn {
      flex: 1;
    }

    /* Process Steps */
    .process-steps {
      background: var(--aic-navy);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .process-steps h4 {
      margin: 0 0 16px 0;
      font-size: 14px;
      color: var(--aic-green);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .process-step {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .process-step:last-child { margin-bottom: 0; }
    .step-number {
      width: 24px;
      height: 24px;
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--aic-gray);
      flex-shrink: 0;
    }
    .step-text {
      font-size: 13px;
      color: var(--aic-gray-light);
      padding-top: 2px;
    }
  </style>
</head>
<body class="has-sidebar">
  <div class="main-content" id="main-content">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p style="color: var(--aic-gray);">Carregando credenciais...</p>
    </div>
  </div>

  <!-- Client Sidebar -->
  <script src="/components/aic-client-sidebar.js"></script>

  <script>
    let journeyData = null;
    let credentialsData = { whatsapp: null, instagram: null };

    // Formatar telefone: +55 11 99999-9999
    function formatPhone(value) {
      if (!value) return '';
      // Remove tudo exceto numeros
      let numbers = value.replace(/\D/g, '');

      // Limita a 13 digitos (55 + DDD + 9 digitos)
      numbers = numbers.slice(0, 13);

      // Aplica mascara
      if (numbers.length === 0) return '';
      if (numbers.length <= 2) return '+' + numbers;
      if (numbers.length <= 4) return '+' + numbers.slice(0, 2) + ' ' + numbers.slice(2);
      if (numbers.length <= 9) return '+' + numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' + numbers.slice(4);
      return '+' + numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' + numbers.slice(4, 9) + '-' + numbers.slice(9);
    }

    // Update ratio display
    function updateRatioDisplay(waValue) {
      const waEl = document.getElementById('wa-ratio-value');
      const igEl = document.getElementById('ig-ratio-value');
      if (waEl) waEl.textContent = `${waValue}%`;
      if (igEl) igEl.textContent = `${100 - parseInt(waValue)}%`;
    }

    // Save outreach ratio to campaign
    async function saveOutreachRatio() {
      const btn = document.getElementById('ratio-btn');
      const ratioInput = document.getElementById('outreach-ratio');
      const waRatio = parseInt(ratioInput?.value || '60');

      if (!journeyData?.campaign_id) {
        showStatus('ratio-status', 'Erro: Campanha nao encontrada', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch('/api/aic/journey/credentials/outreach-ratio', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            campaign_id: journeyData.campaign_id,
            whatsapp_ratio: waRatio,
            instagram_ratio: 100 - waRatio
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || 'Erro ao salvar');
        }

        credentialsData.outreach_ratio_whatsapp = waRatio;
        showStatus('ratio-status', 'Proporcao salva com sucesso!', 'success');

      } catch (error) {
        showStatus('ratio-status', error.message || 'Erro ao salvar proporcao', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Salvar Proporcao';
    }

    async function init() {
      try {
        const isAdmin = localStorage.getItem('aic_user_role') === 'admin';

        // Admin usa cliente selecionado
        if (isAdmin) {
          await new Promise(r => setTimeout(r, 150));
          const selectedClient = window.getSelectedClient ? window.getSelectedClient() : null;
          if (selectedClient) {
            journeyData = selectedClient;
            renderPage();
            return;
          }
          document.getElementById('main-content').innerHTML = `
            <div style="text-align: center; padding: 60px; color: #94a3b8;">
              <p>Selecione um cliente no menu lateral para visualizar.</p>
            </div>
          `;
          return;
        }

        // Cliente normal
        const token = localStorage.getItem('aic_access_token');
        if (!token) {
          window.location.href = '/aic/login?redirect=/cliente';
          return;
        }

        const response = await fetch('/api/aic/journey/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('aic_access_token');
            window.location.href = '/aic/login?redirect=/cliente';
            return;
          }
          throw new Error('Erro ao carregar dados');
        }

        const responseData = await response.json();
        journeyData = responseData.journey || responseData;

        // Check if can access this step
        const STEP_ORDER = [
          'proposta_enviada', 'proposta_visualizada', 'contrato_enviado', 'contrato_assinado',
          'pagamento_pendente', 'pagamento_confirmado', 'credenciais_pendente', 'credenciais_ok',
          'briefing_pendente', 'briefing_completo', 'campanha_ativa', 'campanha_concluida'
        ];
        const currentIndex = STEP_ORDER.indexOf(journeyData.current_step);
        console.log('[Credenciais] current_step:', journeyData.current_step, 'index:', currentIndex);
        if (currentIndex < 5) { // Need at least pagamento_confirmado
          window.location.href = '/cliente/pagamento';
          return;
        }

        // Load existing credentials if available
        if (journeyData.campaign_id) {
          await loadCredentials();
        }

        renderPage();

      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('main-content').innerHTML = `
          <div class="loading-state">
            <p style="color: #ef4444;">Erro ao carregar dados. Por favor, tente novamente.</p>
            <button onclick="location.reload()" class="btn btn-secondary" style="margin-top: 16px;">Tentar Novamente</button>
          </div>
        `;
      }
    }

    async function loadCredentials() {
      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch(`/api/aic/journey/credentials`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          const creds = data.credentials || { whatsapp: null, instagram: null };
          credentialsData = {
            whatsapp: creds.whatsapp,
            instagram: creds.instagram,
            outreach_ratio_whatsapp: creds.outreach_ratio_whatsapp ?? 60
          };
        }
      } catch (err) {
        console.warn('Could not load credentials:', err);
      }
    }

    function renderPage() {
      const isComplete = ['credenciais_ok', 'briefing_pendente', 'briefing_completo',
        'campanha_ativa', 'campanha_concluida'
      ].includes(journeyData.current_step);

      const hasWhatsapp = credentialsData.whatsapp && credentialsData.whatsapp.phone;
      const hasInstagram = credentialsData.instagram && credentialsData.instagram.username;
      const progress = (hasWhatsapp ? 1 : 0) + (hasInstagram ? 1 : 0);

      document.getElementById('main-content').innerHTML = `
        <!-- Status Banner -->
        <div class="status-banner ${isComplete ? 'complete' : 'pending'}">
          <div class="status-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${isComplete
                ? '<path d="M20 6L9 17l-5-5"/>'
                : '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>'}
            </svg>
          </div>
          <div class="status-text">
            <h3>${isComplete ? 'Credenciais Configuradas' : 'Configure suas Credenciais'}</h3>
            <p>${isComplete ? 'Tudo pronto! Continue para o briefing.' : 'Conecte WhatsApp e Instagram para iniciar a campanha.'}</p>
          </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
          <h1>Credenciais</h1>
          <p>Configure as contas que serao usadas na campanha</p>
        </div>

        ${isComplete ? `
          <!-- Success Section -->
          <div class="success-section">
            <div class="success-icon">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
            </div>
            <h2>Credenciais Configuradas!</h2>
            <p>Suas contas estao prontas. Agora vamos para o briefing para entender melhor seu negocio.</p>
            <a href="/cliente/briefing" class="btn btn-primary">Ir para Briefing</a>
          </div>
        ` : `
          <!-- Progress -->
          <div class="progress-section">
            <div class="progress-header">
              <span class="progress-title">Progresso da Configuracao</span>
              <span class="progress-count">${progress}/2 concluido</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress * 50}%"></div>
            </div>
          </div>

          <!-- WhatsApp Card -->
          <div class="card ${hasWhatsapp ? 'complete' : ''}">
            <h2>
              <div class="icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
              </div>
              WhatsApp
              <span class="status-badge ${hasWhatsapp ? 'complete' : 'pending'}">${hasWhatsapp ? 'Conectado' : 'Pendente'}</span>
            </h2>
            <p class="subtitle">Conecte o WhatsApp que sera usado para enviar mensagens aos leads.</p>

            ${!hasWhatsapp ? '<div class="process-steps"><h4>Como funciona a conexao</h4><div class="process-step"><div class="step-number">1</div><div class="step-text">Informe o numero do WhatsApp que sera usado na campanha</div></div><div class="process-step"><div class="step-number">2</div><div class="step-text">Um <strong>QR Code</strong> sera exibido na tela</div></div><div class="process-step"><div class="step-number">3</div><div class="step-text">Abra o <strong>WhatsApp no celular</strong> > Menu > <strong>Aparelhos conectados</strong> > Conectar</div></div><div class="process-step"><div class="step-number">4</div><div class="step-text">Escaneie o QR Code e pronto!</div></div></div>' : ''}

            <div class="warning-box">
              <h4>Importante</h4>
              <p>Use uma linha WhatsApp <strong>exclusiva</strong> para a campanha. Nao use seu numero pessoal. Recomendamos criar uma conta WhatsApp normal (nao Business).</p>
            </div>

            <form id="whatsapp-form" onsubmit="return saveWhatsapp(event)">
              <div class="form-group">
                <label class="form-label">Numero WhatsApp *</label>
                <input type="tel" id="wa_phone" class="form-input" placeholder="+55 11 99999-9999" value="${formatPhone(credentialsData.whatsapp?.phone || '')}" oninput="this.value = formatPhone(this.value)" required ${hasWhatsapp ? 'disabled' : ''}>
                <p class="form-hint">Formato: +55 DDD NUMERO</p>
              </div>

              <button type="submit" class="btn btn-primary btn-full" id="wa-btn" ${hasWhatsapp ? 'disabled' : ''}>
                ${hasWhatsapp ? 'WhatsApp Conectado' : 'Conectar WhatsApp'}
              </button>
              <div id="wa-status" class="status-message"></div>
            </form>

            ${hasWhatsapp ? `
              <button type="button" class="btn btn-full" onclick="disconnectWhatsApp()" style="margin-top: 12px; background: transparent; border: 1px solid #666; color: #888;">
                Desconectar e Trocar Numero
              </button>
            ` : ''}
          </div>

          <!-- Instagram Card -->
          <div class="card ${hasInstagram ? 'complete' : ''}">
            <h2>
              <div class="icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
              </div>
              Instagram Business
              <span class="status-badge ${hasInstagram ? 'complete' : 'pending'}" id="ig-status-badge">${hasInstagram ? 'Conectado' : 'Pendente'}</span>
            </h2>
            <p class="subtitle">Conecte sua conta Instagram Business para envio de DMs.</p>

            <div class="warning-box" style="background: rgba(255, 193, 7, 0.1); border-color: #ffc107;">
              <h4>Pre-requisito Obrigatorio</h4>
              <ol style="margin: 8px 0 0 16px; line-height: 1.6;">
                <li><strong>Conta Instagram Business ou Creator</strong> - Converta em Configuracoes → Conta → Mudar para conta profissional</li>
              </ol>
            </div>

            <!-- Botao de conexao OAuth -->
            <div id="ig-connect-section" style="display: ${hasInstagram ? 'none' : 'block'};">
              <button type="button" class="btn btn-primary btn-full" onclick="connectInstagram()" id="ig-connect-btn">
                <svg style="width: 18px; height: 18px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
                Conectar com Instagram
              </button>
              <p class="form-hint" style="text-align: center; margin-top: 12px;">Voce sera redirecionado para o Instagram para autorizar o acesso.</p>
            </div>

            <!-- Conta conectada -->
            <div id="ig-connected-section" style="display: ${hasInstagram ? 'flex' : 'none'}; align-items: center; gap: 16px; padding: 16px; background: rgba(14, 204, 151, 0.1); border-radius: 8px; margin-top: 16px;">
              <img id="ig-profile-pic" src="${credentialsData.instagram?.profile_picture_url || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwZWNjOTciIHN0cm9rZS13aWR0aD0iMS41Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjQiLz48cGF0aCBkPSJNNCAxOXYtMmE0IDQgMCAwIDEgNC00aDhhNCA0IDAgMCAxIDQgNHYyIi8+PC9zdmc+'}" alt="Profile" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #0ecc97; background: rgba(14, 204, 151, 0.2);" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwZWNjOTciIHN0cm9rZS13aWR0aD0iMS41Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjQiLz48cGF0aCBkPSJNNCAxOXYtMmE0IDQgMCAwIDEgNC00aDhhNCA0IDAgMCAxIDQgNHYyIi8+PC9zdmc+'">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #fff;">@<span id="ig-connected-username">${credentialsData.instagram?.username || ''}</span></div>
                <div style="color: #888; font-size: 13px;">Instagram Business conectado</div>
              </div>
              <span style="font-size: 24px; color: #0ecc97;">✓</span>
            </div>

            ${hasInstagram ? `
              <button type="button" class="btn btn-full" onclick="disconnectInstagram()" style="margin-top: 12px; background: transparent; border: 1px solid #666; color: #888;">
                Desconectar Instagram
              </button>
            ` : ''}

            <div class="info-box" style="margin-top: 16px; background: rgba(14, 204, 151, 0.1); border-color: #0ecc97;">
              <h4 style="color: #0ecc97;">Seguranca via OAuth</h4>
              <p><strong>Nunca pedimos sua senha!</strong> A conexao e feita via autorizacao segura do Instagram. Voce pode revogar o acesso a qualquer momento nas configuracoes do Instagram.</p>
            </div>

            <div id="ig-status" class="status-message"></div>
          </div>

          <!-- Outreach Ratio Configuration (shown when both are configured) -->
          ${hasWhatsapp || hasInstagram ? `
          <div class="card" style="margin-top: 16px;">
            <h2>
              <div class="icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 20V10"/>
                  <path d="M18 20V4"/>
                  <path d="M6 20v-4"/>
                </svg>
              </div>
              Configuracao de Outreach
            </h2>
            <p class="subtitle">Defina a proporcao de envio entre WhatsApp e Instagram.</p>

            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">Proporcao de Envio</label>
              <div style="display: flex; align-items: center; gap: 16px; margin-top: 8px;">
                <div style="flex: 1;">
                  <input type="range" id="outreach-ratio" min="0" max="100" value="${credentialsData.outreach_ratio_whatsapp || 60}"
                         oninput="updateRatioDisplay(this.value)"
                         style="width: 100%; accent-color: var(--aic-green);">
                  <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                    <span style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--aic-green);">
                      <span style="font-weight: 600;" id="wa-ratio-value">${credentialsData.outreach_ratio_whatsapp || 60}%</span> WhatsApp
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #E4405F;">
                      <span style="font-weight: 600;" id="ig-ratio-value">${100 - (credentialsData.outreach_ratio_whatsapp || 60)}%</span> Instagram
                    </span>
                  </div>
                </div>
              </div>
              <p class="form-hint">Recomendado: 60% WhatsApp / 40% Instagram (WhatsApp tem maior taxa de resposta)</p>
            </div>

            <button type="button" class="btn btn-secondary btn-full" onclick="saveOutreachRatio()" id="ratio-btn" style="margin-top: 12px;">
              Salvar Proporcao
            </button>
            <div id="ratio-status" class="status-message"></div>
          </div>
          ` : ''}

          <!-- Continue Button -->
          ${progress === 2 ? `
            <button class="btn btn-primary btn-full" onclick="completeCredentials()" id="complete-btn" style="margin-top: 16px;">
              Concluir e Ir para Briefing
            </button>
            <div id="complete-status" class="status-message"></div>
          ` : `
            <p style="text-align: center; color: var(--aic-gray); margin-top: 24px;">
              Configure ambas as contas para prosseguir para o briefing.
            </p>
          `}
        `}

        <!-- URL da Landing Page - Sempre visível se tiver campanha -->
        ${journeyData.campaign?.slug ? `
          <div class="card" style="margin-top: 24px; border-color: var(--aic-green);">
            <h2>
              <div class="icon" style="background: var(--aic-green-glow);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
              </div>
              URL da sua Landing Page
            </h2>

            <div class="info-box" style="background: var(--aic-green-glow); border-color: var(--aic-green);">
              <h4 style="color: var(--aic-green); margin-bottom: 12px;">Link exclusivo da sua campanha</h4>
              <p style="margin-bottom: 16px;">Use este link em suas acoes de marketing. Os leads serao automaticamente direcionados para o WhatsApp da campanha.</p>

              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text"
                  id="lp-url"
                  class="form-input"
                  value="https://aic.ubs.app.br/lp/${journeyData.campaign?.slug}"
                  readonly
                  style="flex: 1; background: var(--aic-navy-light); font-family: monospace; font-size: 13px;"
                >
                <button type="button" class="btn btn-primary" onclick="copyLPUrl()" style="white-space: nowrap;">
                  Copiar
                </button>
              </div>
              <p id="copy-feedback" style="display: none; color: var(--aic-green); font-size: 12px; margin-top: 8px;">Link copiado!</p>
            </div>

            <div style="background: var(--aic-navy-light); border-radius: 12px; padding: 20px; margin-top: 16px;">
              <h4 style="color: var(--aic-white); margin: 0 0 16px 0; font-size: 15px;">Como usar este link?</h4>

              <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; gap: 12px; align-items: flex-start;">
                  <span style="background: var(--aic-green); color: var(--aic-navy); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;">1</span>
                  <div>
                    <strong style="color: var(--aic-white);">Na sua Landing Page</strong>
                    <p style="color: var(--aic-gray); font-size: 13px; margin: 4px 0 0 0;">Coloque um botao ou link apontando para esta URL. Exemplo:</p>
                    <code style="display: block; background: var(--aic-navy); padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-top: 8px; color: var(--aic-gray-light); overflow-x: auto;">&lt;a href="https://aic.ubs.app.br/lp/${journeyData.campaign?.slug}"&gt;Falar com Especialista&lt;/a&gt;</code>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; align-items: flex-start;">
                  <span style="background: var(--aic-green); color: var(--aic-navy); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;">2</span>
                  <div>
                    <strong style="color: var(--aic-white);">Em campanhas de anuncios</strong>
                    <p style="color: var(--aic-gray); font-size: 13px; margin: 4px 0 0 0;">Use como URL de destino em Facebook Ads, Google Ads, etc. Adicione UTM para rastrear:</p>
                    <code style="display: block; background: var(--aic-navy); padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-top: 8px; color: var(--aic-gray-light); overflow-x: auto; word-break: break-all;">https://aic.ubs.app.br/lp/${journeyData.campaign?.slug}?utm_source=facebook&utm_medium=ads</code>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; align-items: flex-start;">
                  <span style="background: var(--aic-green); color: var(--aic-navy); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;">3</span>
                  <div>
                    <strong style="color: var(--aic-white);">Em redes sociais</strong>
                    <p style="color: var(--aic-gray); font-size: 13px; margin: 4px 0 0 0;">Compartilhe diretamente no Instagram, WhatsApp Status, LinkedIn, etc.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="warning-box" style="margin-top: 16px; background: rgba(59, 130, 246, 0.1); border-color: #3b82f6;">
              <h4 style="color: #3b82f6;">O que acontece quando alguem acessa?</h4>
              <ol style="margin: 8px 0 0 16px; line-height: 1.8; color: var(--aic-gray-light);">
                <li>O visitante ve a landing page da AIC</li>
                <li>Preenche nome, email, WhatsApp e Instagram (opcional)</li>
                <li>E redirecionado automaticamente para o <strong>WhatsApp da sua campanha</strong></li>
                <li>O AI Agent inicia a conversa de qualificacao</li>
              </ol>
            </div>
          </div>
        ` : ''}
      `;
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = message;
      el.className = `status-message show ${type}`;
    }

    // Copiar URL da Landing Page
    function copyLPUrl() {
      const urlInput = document.getElementById('lp-url');
      const feedback = document.getElementById('copy-feedback');

      urlInput.select();
      urlInput.setSelectionRange(0, 99999); // Para mobile

      try {
        navigator.clipboard.writeText(urlInput.value);
        feedback.style.display = 'block';
        setTimeout(() => {
          feedback.style.display = 'none';
        }, 2000);
      } catch (err) {
        // Fallback para browsers antigos
        document.execCommand('copy');
        feedback.style.display = 'block';
        setTimeout(() => {
          feedback.style.display = 'none';
        }, 2000);
      }
    }

    async function saveWhatsapp(event) {
      event.preventDefault();
      const btn = document.getElementById('wa-btn');
      btn.disabled = true;
      btn.textContent = 'Conectando...';

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch('/api/aic/journey/credentials/whatsapp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            phone: document.getElementById('wa_phone').value.trim().replace(/\D/g, '')
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Erro ao conectar');
        }

        // Se retornou QR Code, mostrar modal
        if (data.qr_code) {
          btn.disabled = false;
          btn.textContent = 'Conectar WhatsApp';
          showQRModal(data.qr_code);
          return;
        }

        // Se nao precisa de QR (ja conectado), atualizar UI
        showStatus('wa-status', data.message || 'WhatsApp conectado com sucesso!', 'success');
        credentialsData.whatsapp = { phone: document.getElementById('wa_phone').value };

        setTimeout(() => {
          renderPage();
        }, 1000);

      } catch (error) {
        showStatus('wa-status', error.message || 'Erro ao conectar. Tente novamente.', 'error');
        btn.disabled = false;
        btn.textContent = 'Conectar WhatsApp';
      }
    }

    // Connect Instagram via OAuth (redirects to Facebook)
    function connectInstagram() {
      const campaignId = journeyData?.campaign_id;
      if (!campaignId) {
        showStatus('ig-status', 'Erro: Campaign ID nao encontrado', 'error');
        return;
      }

      // Salvar estado para retorno
      localStorage.setItem('ig_oauth_return', window.location.href);

      // Redirecionar para OAuth
      window.location.href = `/api/instagram/oauth/authorize?campaignId=${campaignId}`;
    }

    // Disconnect Instagram account
    async function disconnectWhatsApp() {
      if (!confirm('Tem certeza que deseja desconectar o WhatsApp? Voce precisara escanear o QR code novamente.')) {
        return;
      }

      const campaignId = journeyData?.campaign_id;
      if (!campaignId) {
        showStatus('wa-status', 'Erro: Campaign ID nao encontrado', 'error');
        return;
      }

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch(`/api/aic/journey/credentials/whatsapp/disconnect`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ campaign_id: campaignId })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao desconectar');
        }

        showStatus('wa-status', 'WhatsApp desconectado. Voce pode conectar um novo numero.', 'success');
        credentialsData.whatsapp = null;

        setTimeout(() => {
          renderPage();
        }, 1000);

      } catch (error) {
        showStatus('wa-status', error.message || 'Erro ao desconectar', 'error');
      }
    }

    async function disconnectInstagram() {
      if (!confirm('Tem certeza que deseja desconectar sua conta Instagram?')) {
        return;
      }

      const campaignId = journeyData?.campaign_id;
      if (!campaignId) {
        showStatus('ig-status', 'Erro: Campaign ID nao encontrado', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/instagram/oauth/disconnect/${campaignId}`, {
          method: 'POST'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erro ao desconectar');
        }

        showStatus('ig-status', 'Conta desconectada com sucesso', 'success');
        credentialsData.instagram = null;

        setTimeout(() => {
          renderPage();
        }, 1000);

      } catch (error) {
        showStatus('ig-status', error.message || 'Erro ao desconectar', 'error');
      }
    }

    // Handle OAuth callback
    async function handleInstagramOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);

      if (urlParams.has('instagram_connected')) {
        const username = urlParams.get('instagram_username') || '';
        showStatus('ig-status', `Conta @${username} conectada! Validando...`, 'success');

        // Limpar URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);

        // Validar a conexao com a API do Instagram
        if (journeyData?.campaign_id) {
          try {
            const validationResponse = await fetch(`/api/instagram/oauth/status/${journeyData.campaign_id}`);
            const validationData = await validationResponse.json();

            if (validationData.connected) {
              credentialsData.instagram = {
                username: validationData.username || username,
                profile_picture_url: validationData.profile_picture_url
              };
              showStatus('ig-status', `Conta @${validationData.username || username} validada com sucesso!`, 'success');
            } else {
              showStatus('ig-status', validationData.error || 'Erro na validacao. Tente reconectar.', 'error');
              credentialsData.instagram = null;
            }
          } catch (err) {
            console.error('Erro ao validar Instagram:', err);
            credentialsData.instagram = { username };
          }
        } else {
          credentialsData.instagram = { username };
        }

        setTimeout(() => {
          renderPage();
        }, 1000);
      }

      if (urlParams.has('instagram_error')) {
        const error = decodeURIComponent(urlParams.get('instagram_error') || 'Erro desconhecido');
        showStatus('ig-status', error, 'error');

        // Limpar URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);
      }
    }

    // Check on page load
    document.addEventListener('DOMContentLoaded', function() {
      handleInstagramOAuthCallback();
    });

    async function completeCredentials() {
      const btn = document.getElementById('complete-btn');
      btn.disabled = true;
      btn.textContent = 'Finalizando...';

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch('/api/aic/journey/complete-credentials', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao finalizar');
        }

        window.location.href = '/cliente/briefing';

      } catch (error) {
        showStatus('complete-status', error.message || 'Erro. Tente novamente.', 'error');
        btn.disabled = false;
        btn.textContent = 'Concluir e Ir para Briefing';
      }
    }

    // Initialize
    init();
  </script>

  <!-- QR Code Modal -->
  <div class="qr-modal" id="qr-modal">
    <div class="qr-modal-content">
      <h2>Conectar WhatsApp</h2>
      <p class="subtitle">Escaneie o QR Code com seu celular</p>

      <div class="qr-code-container" id="qr-container">
        <img id="qr-image" src="" alt="QR Code">
      </div>

      <div class="qr-steps">
        <h4>Passo a passo</h4>
        <ol>
          <li>Abra o <strong>WhatsApp</strong> no seu celular</li>
          <li>Toque em <strong>Menu</strong> (tres pontinhos) ou <strong>Configuracoes</strong></li>
          <li>Selecione <strong>Aparelhos conectados</strong></li>
          <li>Toque em <strong>Conectar um aparelho</strong></li>
          <li>Aponte a camera para este QR Code</li>
        </ol>
      </div>

      <div class="qr-status checking" id="qr-status">
        Aguardando conexao...
      </div>

      <div class="qr-modal-buttons">
        <button class="btn btn-secondary" onclick="closeQRModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="checkWhatsAppStatus()">Verificar Conexao</button>
      </div>
    </div>
  </div>

  <script>
    let statusCheckInterval = null;

    function showQRModal(qrCode) {
      const modal = document.getElementById('qr-modal');
      const qrImage = document.getElementById('qr-image');
      const statusEl = document.getElementById('qr-status');

      // QR Code pode vir como base64 ou URL
      if (qrCode.startsWith('data:') || qrCode.startsWith('http')) {
        qrImage.src = qrCode;
      } else {
        // Assume base64 sem prefixo
        qrImage.src = 'data:image/png;base64,' + qrCode;
      }

      statusEl.className = 'qr-status checking';
      statusEl.textContent = 'Aguardando conexao...';

      modal.classList.add('show');

      // Iniciar verificacao automatica a cada 3 segundos
      startStatusCheck();
    }

    function closeQRModal() {
      const modal = document.getElementById('qr-modal');
      modal.classList.remove('show');
      stopStatusCheck();
    }

    function startStatusCheck() {
      stopStatusCheck(); // Limpar intervalo anterior
      statusCheckInterval = setInterval(checkWhatsAppStatus, 3000);
    }

    function stopStatusCheck() {
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
      }
    }

    async function checkWhatsAppStatus() {
      const statusEl = document.getElementById('qr-status');

      try {
        const token = localStorage.getItem('aic_access_token');
        const response = await fetch('/api/aic/journey/credentials/whatsapp/status', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const data = await response.json();

        if (data.connected) {
          statusEl.className = 'qr-status connected';
          statusEl.textContent = 'WhatsApp conectado com sucesso!';
          stopStatusCheck();

          // Atualizar dados e fechar modal apos 2 segundos
          credentialsData.whatsapp = { phone: data.phone || document.getElementById('wa_phone').value };

          setTimeout(() => {
            closeQRModal();
            renderPage();
          }, 2000);
        }
      } catch (error) {
        console.error('Erro ao verificar status:', error);
      }
    }
  </script>
</body>
</html>
