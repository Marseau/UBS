<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Intelligence Dashboard 3.0 - KMeans</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        :root {
            --aic-green: #0ECC97;
            --aic-green-dark: #0BA578;
            --aic-green-glow: rgba(14, 204, 151, 0.15);
            --aic-navy: #0C1B33;
            --aic-navy-light: #122444;
            --aic-navy-lighter: #1a3055;
            --aic-white: #FDFDFD;
            --aic-gray: #94a3b8;
            --aic-gray-light: #cbd5e1;
            --aic-border: #1e3a5f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--aic-navy);
            color: var(--aic-white);
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--aic-navy-light) 0%, var(--aic-navy) 100%);
            border: 1px solid var(--aic-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--aic-green-glow) 0%, transparent 50%);
            pointer-events: none;
        }

        .header h1 {
            color: var(--aic-white);
            font-size: 2em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            color: var(--aic-gray);
            font-size: 1em;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .btn {
            background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
            color: var(--aic-navy);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 204, 151, 0.3);
        }

        .btn:disabled {
            background: var(--aic-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--aic-gray);
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(14, 204, 151, 0.4);
        }

        .stat-card .icon {
            font-size: 1.2em;
            margin-bottom: 8px;
            color: var(--aic-green);
        }

        .stat-card .label {
            color: var(--aic-gray);
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-card .value {
            color: var(--aic-white);
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-card .change {
            color: var(--aic-green);
            font-size: 0.75em;
        }

        .section-title {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title h2 {
            color: var(--aic-white);
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 24px;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h3 {
            color: var(--aic-white);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.tall {
            height: 500px;
        }

        .clusters-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .cluster-card {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .cluster-card:hover {
            transform: translateY(-5px);
            border-color: rgba(14, 204, 151, 0.4);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .cluster-card.active {
            border: 2px solid var(--aic-green);
        }

        .cluster-card h4 {
            color: var(--aic-green);
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .cluster-card .cluster-stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .cluster-card .stat {
            font-size: 0.85em;
            color: var(--aic-gray);
        }

        .cluster-card .stat strong {
            color: var(--aic-white);
        }

        .behavioral-insights {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .behavioral-insights.visible {
            display: block;
        }

        .behavioral-insights h3 {
            color: var(--aic-green);
            margin-bottom: 16px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .insight-section {
            margin-bottom: 16px;
        }

        .insight-section h4 {
            color: var(--aic-white);
            margin-bottom: 8px;
            font-size: 0.95em;
            font-weight: 600;
        }

        .insight-section ul {
            list-style: none;
            padding-left: 0;
        }

        .insight-section li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            font-size: 0.9em;
            color: var(--aic-gray-light);
        }

        .insight-section li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: var(--aic-green);
            font-size: 1.2em;
        }

        .insight-section p {
            font-size: 0.9em;
            margin: 4px 0;
            color: var(--aic-gray-light);
        }

        .behavioral-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 768px) {
            .behavioral-grid {
                grid-template-columns: 1fr;
            }
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 6px;
        }

        .badge.high {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge.low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge.critical {
            background: rgba(220, 38, 38, 0.2);
            color: #dc2626;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .trend-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 15px;
            border-radius: 12px;
        }

        .trend-card.viral {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .trend-card .hashtag {
            font-weight: 600;
            color: var(--aic-white);
            margin-bottom: 5px;
        }

        .trend-card .growth {
            font-size: 0.85em;
            color: var(--aic-gray);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 10px;
            font-size: 0.85em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--aic-border);
        }

        th {
            background: var(--aic-navy);
            font-weight: 600;
            color: var(--aic-green);
            font-size: 0.85em;
        }

        tr:hover {
            background: rgba(14, 204, 151, 0.05);
        }

        td {
            color: var(--aic-gray-light);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #ef4444;
        }

        .vector-store-status {
            margin-top: 20px;
            padding: 16px;
            background: rgba(14, 204, 151, 0.1);
            border: 1px solid rgba(14, 204, 151, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .vector-store-status .icon {
            font-size: 1.5em;
            color: var(--aic-green);
        }

        .vector-store-status .content {
            flex: 1;
        }

        .vector-store-status .title {
            font-weight: 600;
            color: var(--aic-green);
            margin-bottom: 4px;
        }

        .vector-store-status .details {
            font-size: 0.85em;
            color: var(--aic-gray);
        }

        .vector-store-status .badge-status {
            padding: 6px 14px;
            background: var(--aic-green);
            color: var(--aic-navy);
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 700;
        }

        .last-execution-info {
            margin-top: 12px;
            font-size: 0.85em;
            color: var(--aic-gray);
            position: relative;
            z-index: 1;
        }

        .section-header-banner {
            background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
            color: var(--aic-navy);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .section-header-banner h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 700;
        }

        .section-header-banner span {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .section-header-hashtags {
            background: linear-gradient(135deg, var(--aic-navy-lighter), var(--aic-navy-light));
            border: 1px solid var(--aic-border);
            color: var(--aic-white);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 25px 0 15px 0;
        }

        .section-header-hashtags h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 700;
        }

        .section-header-hashtags span {
            font-size: 0.75em;
            color: var(--aic-gray);
        }

        @media (max-width: 768px) {
            .charts-grid, .clusters-list {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Persona Cards */
        .persona-card {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .persona-card:hover {
            transform: translateY(-5px);
            border-color: rgba(14, 204, 151, 0.4);
        }

        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .persona-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .persona-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--aic-navy);
        }

        .persona-name {
            margin: 0;
            color: var(--aic-white);
            font-size: 1.1em;
            font-weight: 600;
        }

        .persona-occupation {
            color: var(--aic-gray);
            font-size: 0.85em;
        }

        .persona-score {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
        }

        .persona-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .persona-metric {
            text-align: center;
            background: var(--aic-navy);
            padding: 10px;
            border-radius: 8px;
        }

        .persona-metric-value {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--aic-green);
        }

        .persona-metric-label {
            font-size: 0.7em;
            color: var(--aic-gray);
        }

        .persona-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .persona-tag {
            background: rgba(14, 204, 151, 0.1);
            border: 1px solid rgba(14, 204, 151, 0.3);
            color: var(--aic-green);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }

        .persona-section-title {
            font-weight: 600;
            color: var(--aic-white);
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .persona-section-content {
            font-size: 0.8em;
            color: var(--aic-gray-light);
            line-height: 1.5;
        }

        .persona-approach-box {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .persona-approach-box .title {
            font-weight: 600;
            color: #fbbf24;
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .persona-approach-box .content {
            font-size: 0.75em;
            color: var(--aic-gray-light);
            line-height: 1.5;
        }

        .persona-footer {
            font-size: 0.75em;
            color: var(--aic-gray);
            border-top: 1px solid var(--aic-border);
            padding-top: 10px;
            margin-top: 10px;
        }

        .persona-stats-grid {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .persona-stat-item {
            text-align: center;
        }

        .persona-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--aic-green);
        }

        .persona-stat-label {
            font-size: 0.85em;
            color: var(--aic-gray);
        }

        .empty-state {
            grid-column: 1/-1;
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 50px;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: var(--aic-gray);
        }

        .empty-state h3 {
            color: var(--aic-white);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--aic-gray);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dynamic Intelligence Dashboard 3.0</h1>
            <p>Sistema inteligente com KMeans local (GRATUITO) | Clustering Automatico + Analise Comportamental + Deteccao de Tendencias</p>
            <div class="header-actions">
                <button class="btn" onclick="loadAllData()">
                    Atualizar Dados
                </button>
                <button class="btn btn-success" id="recalculateBtn" onclick="recalculateMetrics()" title="Recalcula metricas SEM chamar GPT-4 (GRATUITO)">
                    Recalcular Metricas
                </button>
                <button class="btn btn-secondary" id="pipelineBtn" onclick="executePipeline()" title="LEGADO: Executa clustering GPT-4 (PAGO ~$0.10) - Prefira usar KMeans no Cluster-Intention-Dashboard" style="opacity: 0.6;">
                    Pipeline GPT-4 (Legado)
                </button>
                <button class="btn" id="populateSearchTermsBtn" onclick="populateSearchTerms()" title="Cria termos de busca a partir dos clusters GPT-4" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    Gerar Search Terms
                </button>
                <button class="btn" id="syncParquetBtn" onclick="syncVectorStore()" title="Sincroniza PostgreSQL - Parquet - Vector Store" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                    Sync Vector Store
                </button>
            </div>

            <!-- Vector Store Status Badge -->
            <div class="vector-store-status">
                <div class="icon">VS</div>
                <div class="content">
                    <div class="title">Vector Store + Busca Semantica AI</div>
                    <div id="vectorStoreDetails" class="details">Carregando status...</div>
                </div>
                <div id="vectorStoreBadge" class="badge-status">ATIVO</div>
            </div>

            <div id="lastExecutionInfo" class="last-execution-info">
                Carregando ultima execucao...
            </div>
        </div>

        <div id="loading" class="loading">Carregando dados...</div>
        <div id="error-container"></div>

        <!-- KPI Cards -->
        <div id="stats-grid" class="stats-grid" style="display: none;"></div>

        <!-- Scraping Metrics Charts (NEW) -->
        <div id="scraping-metrics-section" class="charts-grid" style="display: none; margin-bottom: 30px;">
            <!-- Chart 1: Line Chart - Daily Scraping Stats -->
            <div class="chart-card">
                <h3>Perfis Coletados por Dia (ultimos 45 dias)</h3>
                <div class="chart-container">
                    <canvas id="dailyScrapingChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Pool Ativo - Leads & Hashtags -->
            <div class="chart-card">
                <h3>Pool Ativo - Leads e Hashtags</h3>
                <p style="font-size: 0.8em; color: var(--aic-gray); margin: 0 0 10px 0;">
                    <span style="color: #10b981;">‚ñ†</span> Leads validos (45d) |
                    <span style="color: var(--aic-green);">‚ñ†</span> Hashtags validas (90d)
                </p>
                <div class="chart-container">
                    <canvas id="dailyEvolutionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="charts-section" style="display: none;">
            <div class="section-title">
                <h2>Analise Visual de Hashtags</h2>
            </div>

            <div class="charts-grid">
                <!-- Top Hashtags -->
                <div class="chart-card full-width">
                    <h3>Top 20 Hashtags por Frequencia</h3>
                    <div class="chart-container tall">
                        <canvas id="topHashtagsChart"></canvas>
                    </div>
                </div>

                <!-- Distribuicao por Clusters -->
                <div class="chart-card">
                    <h3>Distribuicao por Clusters</h3>
                    <div class="chart-container">
                        <canvas id="clustersChart"></canvas>
                    </div>
                </div>

                <!-- Taxa de Contato -->
                <div class="chart-card">
                    <h3>Taxa de Contato por Cluster</h3>
                    <div class="chart-container">
                        <canvas id="contactRateChart"></canvas>
                    </div>
                </div>

                <!-- Premium Hashtags -->
                <div class="chart-card full-width">
                    <h3>Top 15 Hashtags Premium</h3>
                    <div class="chart-container">
                        <canvas id="premiumHashtagsChart"></canvas>
                    </div>
                </div>

                <!-- Search Terms -->
                <div class="chart-card">
                    <h3>Registros de Search Terms</h3>
                    <div class="chart-container">
                        <canvas id="searchTermsChart"></canvas>
                    </div>
                </div>

                <!-- Quality Score -->
                <div class="chart-card">
                    <h3>Distribuicao de Quality Score</h3>
                    <div class="chart-container">
                        <canvas id="qualityScoreChart"></canvas>
                    </div>
                </div>

                <!-- Co-ocorrencias -->
                <div class="chart-card full-width">
                    <h3>Top 10 Co-ocorrencias de Hashtags</h3>
                    <div class="table-container">
                        <table id="cooccurrenceTable">
                            <thead>
                                <tr>
                                    <th>Hashtag 1</th>
                                    <th>Hashtag 2</th>
                                    <th>Co-ocorrencias</th>
                                    <th>Confianca</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <!-- All Behavioral Insights -->
        <div id="all-behavioral-section" style="display: none;">
            <div class="section-title">
                <h2>Analise Comportamental - Todos os Clusters (KMeans)</h2>
            </div>
            <div id="all-behavioral-insights" class="behavioral-grid"></div>
        </div>

        <!-- Clusters Section -->
        <div id="clusters-section" style="display: none;">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h2>Clusters KMeans (Local e Gratuito)</h2>
                <button class="btn" id="btnToggleClusteringControls" onclick="toggleClusteringControls()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    Configurar Clustering
                </button>
            </div>

            <!-- Controles de Clustering Gen√©rico -->
            <div id="clusteringControlsPanel" style="display: none; background: var(--aic-navy-light); border: 1px solid var(--aic-border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--aic-green); margin-bottom: 15px; font-size: 1.1em;">Executar Clustering na Base Completa</h3>
                <p style="color: var(--aic-gray); font-size: 0.85em; margin-bottom: 15px;">
                    Gera clusters da base de dados para demonstrar capacidades da plataforma. Resultados s√£o salvos automaticamente.
                </p>

                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px;">
                    <div style="min-width: 200px; flex: 2;">
                        <label style="display: block; font-size: 0.8em; color: var(--aic-gray); margin-bottom: 4px;">Seeds (hashtags raiz)</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="genericSeeds" class="input-field" placeholder="estetica, beleza, skincare" style="flex: 1; padding: 10px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 8px; color: var(--aic-white);">
                            <button type="button" id="btnGenerateSeedsDID" onclick="generateSeedsWithAI()" title="Gerar seeds otimizadas com IA baseado no nicho" style="padding: 10px 14px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.85em; white-space: nowrap;">
                                ü§ñ Gerar
                            </button>
                        </div>
                    </div>
                    <div style="min-width: 140px;">
                        <label style="display: block; font-size: 0.8em; color: var(--aic-gray); margin-bottom: 4px;">Nicho</label>
                        <input type="text" id="genericNicho" class="input-field" placeholder="Est√©tica" style="width: 100%; padding: 10px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 8px; color: var(--aic-white);">
                    </div>
                    <div style="min-width: 120px;">
                        <label style="display: block; font-size: 0.8em; color: var(--aic-gray); margin-bottom: 4px;">Modo</label>
                        <select id="genericMode" style="width: 100%; padding: 10px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 8px; color: var(--aic-white);">
                            <option value="vector" selected>Vector (embeddings)</option>
                            <option value="vector_hashtag">Vector (hashtags)</option>
                            <option value="hashtag">Hashtags (legado)</option>
                        </select>
                    </div>
                    <div style="min-width: 80px;">
                        <label style="display: block; font-size: 0.8em; color: var(--aic-gray); margin-bottom: 4px;">K</label>
                        <input type="number" id="genericK" placeholder="5" min="2" max="15" style="width: 100%; padding: 10px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 8px; color: var(--aic-white);">
                    </div>
                </div>

                <!-- Filtros de Rec√™ncia e Localiza√ß√£o -->
                <div style="display: flex; flex-wrap: wrap; gap: 12px; padding: 12px; background: rgba(14, 204, 151, 0.08); border: 1px solid rgba(14, 204, 151, 0.2); border-radius: 10px; margin-bottom: 15px;">
                    <div style="width: 100%; margin-bottom: 4px;">
                        <strong style="color: var(--aic-green); font-size: 0.85em;">Filtros de Qualidade</strong>
                    </div>
                    <div style="min-width: 150px;">
                        <label style="display: block; font-size: 0.75em; color: var(--aic-gray); margin-bottom: 4px;">Estados (BR)</label>
                        <input type="text" id="genericTargetStates" placeholder="SP, RJ, MG" title="Estados brasileiros separados por v√≠rgula. Vazio = todos." style="width: 100%; padding: 8px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 6px; color: var(--aic-white); font-size: 0.9em;">
                    </div>
                    <div style="min-width: 110px;">
                        <label style="display: block; font-size: 0.75em; color: var(--aic-gray); margin-bottom: 4px;">Leads (dias)</label>
                        <input type="number" id="genericLeadMaxAge" value="45" min="7" max="180" style="width: 100%; padding: 8px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 6px; color: var(--aic-white); font-size: 0.9em;">
                    </div>
                    <div style="min-width: 110px;">
                        <label style="display: block; font-size: 0.75em; color: var(--aic-gray); margin-bottom: 4px;">Hashtags (dias)</label>
                        <input type="number" id="genericHashtagMaxAge" value="90" min="7" max="365" style="width: 100%; padding: 8px; background: var(--aic-navy); border: 1px solid var(--aic-border); border-radius: 6px; color: var(--aic-white); font-size: 0.9em;">
                    </div>
                    <div style="flex: 1; min-width: 150px; display: flex; align-items: flex-end;">
                        <span style="font-size: 0.7em; color: var(--aic-gray);">Leads recentes (45d) + Hashtags v√°lidas (90d)</span>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn" id="btnExecuteGenericClustering" onclick="executeGenericClustering()" style="background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));">
                        Executar Clustering
                    </button>
                    <span id="genericClusteringStatus" style="font-size: 0.85em; color: var(--aic-gray);"></span>
                </div>

                <!-- Resultado do Clustering (sincronizado do CID) -->
                <div id="clusteringResultSummary" style="display: none; margin-top: 15px; padding: 15px; background: rgba(14, 204, 151, 0.1); border: 1px solid var(--aic-green); border-radius: 10px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: var(--aic-gray);">K (Clusters)</div>
                            <div id="resultK" style="font-size: 1.5em; font-weight: 700; color: var(--aic-white);">-</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: var(--aic-gray);">Leads</div>
                            <div id="resultLeads" style="font-size: 1.5em; font-weight: 700; color: var(--aic-white);">-</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: var(--aic-gray);">Silhouette Score</div>
                            <div id="resultSilhouette" style="font-size: 1.5em; font-weight: 700;">-</div>
                            <div id="resultSilhouetteLabel" style="font-size: 0.7em; margin-top: 2px;">-</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75em; color: var(--aic-gray);">M√©todo</div>
                            <div id="resultMethod" style="font-size: 0.9em; font-weight: 600; color: var(--aic-green);">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Clusters -->
            <div id="clusters-list" class="clusters-list"></div>
        </div>

        <!-- Behavioral Insights -->
        <div id="behavioral-insights" class="behavioral-insights"></div>

        <!-- Trends Section -->
        <div id="trends-section" style="display: none;">
            <div class="section-title">
                <h2>Tendencias Emergentes</h2>
            </div>
            <div id="trends-grid" class="trends-grid"></div>
        </div>

        <!-- Personas Section -->
        <div id="personas-section" style="display: none;">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Personas Dinamicas (GPT-4/5)</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" id="recalcPersonaMetricsBtn" onclick="recalculatePersonaMetrics()" title="Recalcula metricas das personas existentes (GRATUITO)">
                        Atualizar Metricas
                    </button>
                    <button class="btn" id="generatePersonasBtn" onclick="generatePersonas()" style="background: linear-gradient(135deg, #ec4899, #db2777);" title="Gera novas personas via GPT (CUSTO ~$0.15)">
                        Gerar Personas (GPT)
                    </button>
                </div>
            </div>
            <div id="personas-stats" style="margin-bottom: 20px;"></div>
            <div id="personas-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';
        let charts = {};
        let allClusters = [];

        Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
        Chart.defaults.color = '#94a3b8';
        Chart.register(ChartDataLabels);

        async function fetchData(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }

        function showError(message) {
            document.getElementById('error-container').innerHTML = `<div class="error">${message}</div>`;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats-grid').style.display = 'grid';
            document.getElementById('scraping-metrics-section').style.display = 'grid';
            document.getElementById('charts-section').style.display = 'block';
            document.getElementById('clusters-section').style.display = 'block';
            document.getElementById('trends-section').style.display = 'block';
        }

        async function loadKPIs() {
            const response = await fetchData('/hashtag-intelligence/kpis');
            if (response?.success && response.data) {
                const kpis = response.data;
                const totalLeads = kpis.total_leads || 0;
                const pctWithContact = totalLeads > 0 ? ((kpis.leads_with_contact / totalLeads) * 100).toFixed(1) : 0;
                const pctWithoutContact = totalLeads > 0 ? ((kpis.leads_without_contact / totalLeads) * 100).toFixed(1) : 0;
                const pctWithEmail = totalLeads > 0 ? ((kpis.leads_with_email / totalLeads) * 100).toFixed(1) : 0;
                const pctWithPhone = totalLeads > 0 ? ((kpis.leads_with_phone / totalLeads) * 100).toFixed(1) : 0;

                document.getElementById('stats-grid').innerHTML = `
                    <!-- ========== SECAO LEADS (45 dias) ========== -->
                    <div class="section-header-banner" style="grid-column: 1 / -1;">
                        <h3>ESTATISTICAS DE LEADS <span>(45 dias - criados ou revalidados)</span></h3>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--aic-green);">
                        <div class="label">TOTAL</div>
                        <div class="value">${totalLeads.toLocaleString()}</div>
                        <div class="change">Zona Ativa</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #10b981;">
                        <div class="label">COM CONTATO</div>
                        <div class="value">${(kpis.leads_with_contact || 0).toLocaleString()}</div>
                        <div class="change" style="color: #10b981;">${pctWithContact}% do total</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #ef4444;">
                        <div class="label">SEM CONTATO</div>
                        <div class="value">${(kpis.leads_without_contact || 0).toLocaleString()}</div>
                        <div class="change" style="color: #ef4444;">${pctWithoutContact}% do total</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Com Email Principal</div>
                        <div class="value">${(kpis.leads_with_email || 0).toLocaleString()}</div>
                        <div class="change">${pctWithEmail}% do total</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Com Phone Principal</div>
                        <div class="value">${(kpis.leads_with_phone || 0).toLocaleString()}</div>
                        <div class="change">${pctWithPhone}% do total</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Com Emails Adicionais</div>
                        <div class="value">${(kpis.leads_with_additional_emails || 0).toLocaleString()}</div>
                        <div class="change">Campos extras</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Com Phones Adicionais</div>
                        <div class="value">${(kpis.leads_with_additional_phones || 0).toLocaleString()}</div>
                        <div class="change">Campos extras</div>
                    </div>

                    <!-- ========== SECAO HASHTAGS ========== -->
                    <div class="section-header-hashtags" style="grid-column: 1 / -1;">
                        <h3>ESTATISTICAS DE HASHTAGS <span>(90 dias - criados ou revalidados)</span></h3>
                    </div>
                    <!-- Hashtags TOTAL -->
                    <div class="stat-card" style="border-left: 4px solid var(--aic-green);">
                        <div class="label">HASHTAGS UNICAS - TOTAL</div>
                        <div class="value">${(kpis.unique_hashtags_total || 0).toLocaleString()}</div>
                        <div class="change">${(kpis.occurrences_total || 0).toLocaleString()} ocorrencias</div>
                    </div>
                    <!-- Hashtags COM CONTATO -->
                    <div class="stat-card" style="border-left: 4px solid #10b981;">
                        <div class="label">HASHTAGS - COM CONTATO</div>
                        <div class="value">${(kpis.unique_hashtags_with_contact || 0).toLocaleString()}</div>
                        <div class="change" style="color: #10b981;">${(kpis.occurrences_with_contact || 0).toLocaleString()} ocorrencias</div>
                    </div>
                    <!-- Hashtags SEM CONTATO -->
                    <div class="stat-card" style="border-left: 4px solid #ef4444;">
                        <div class="label">HASHTAGS - SEM CONTATO</div>
                        <div class="value">${(kpis.unique_hashtags_without_contact || 0).toLocaleString()}</div>
                        <div class="change" style="color: #ef4444;">${(kpis.occurrences_without_contact || 0).toLocaleString()} ocorrencias</div>
                    </div>
                    <!-- Detalhamento por fonte -->
                    <div class="stat-card">
                        <div class="label">Hashtags na Bio</div>
                        <div class="value">${(kpis.total_hashtags_in_bio || 0).toLocaleString()}</div>
                        <div class="change">${(kpis.leads_with_hashtags_bio || 0).toLocaleString()} leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Hashtags em Posts</div>
                        <div class="value">${(kpis.total_hashtags_in_posts || 0).toLocaleString()}</div>
                        <div class="change">${(kpis.leads_with_hashtags_posts || 0).toLocaleString()} leads</div>
                    </div>
                `;
            }
        }

        async function loadTopHashtags() {
            const response = await fetchData('/hashtag-intelligence/top-hashtags?limit=20');
            if (response?.success && response.data) {
                const ctx = document.getElementById('topHashtagsChart').getContext('2d');
                if (charts.topHashtags) charts.topHashtags.destroy();
                charts.topHashtags = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: response.data.map(d => d.hashtag),
                        datasets: [{
                            label: 'Frequencia',
                            data: response.data.map(d => d.frequency),
                            backgroundColor: 'rgba(14, 204, 151, 0.8)',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#0ECC97',
                                font: { weight: 'bold' },
                                formatter: (v) => v.toLocaleString()
                            }
                        }
                    }
                });
            }
        }

        async function loadClusterDistribution() {
            console.log('[DEBUG] loadClusterDistribution iniciando...');
            // Usar unified-intelligence (KMeans local, gratuito) em vez de dynamic-intelligence (GPT-4, pago)
            const response = await fetchData('/unified-intelligence/clusters');
            console.log('[DEBUG] response:', response);
            if (response?.success && response.clusters) {
                console.log('[DEBUG] Clusters encontrados:', response.clusters.length);
                const ctx = document.getElementById('clustersChart').getContext('2d');
                if (charts.clusters) charts.clusters.destroy();
                const colors = ['rgba(14, 204, 151, 0.8)', 'rgba(16, 185, 129, 0.8)',
                               'rgba(6, 182, 212, 0.8)', 'rgba(59, 130, 246, 0.8)',
                               'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)',
                               'rgba(251, 191, 36, 0.8)', 'rgba(249, 115, 22, 0.8)',
                               'rgba(239, 68, 68, 0.8)'];
                console.log('[DEBUG] Criando chart doughnut...');
                charts.clusters = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: response.clusters.map(c => c.cluster_name),
                        datasets: [{
                            data: response.clusters.map(c => c.hashtag_count || 0),
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: { color: 'white', font: { weight: 'bold', size: 14 } }
                        }
                    }
                });
            }
        }

        async function loadContactRateByCluster() {
            // Usar unified-intelligence (KMeans local, gratuito)
            const response = await fetchData('/unified-intelligence/clusters');
            if (response?.success && response.clusters) {
                const ctx = document.getElementById('contactRateChart').getContext('2d');
                if (charts.contactRate) charts.contactRate.destroy();
                charts.contactRate = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: response.clusters.map(c => c.cluster_name),
                        datasets: [{
                            label: 'Taxa de Contato (%)',
                            data: response.clusters.map(c => ((c.conversion_rate || c.avg_contact_rate || 0) * 100).toFixed(1)),
                            backgroundColor: 'rgba(14, 204, 151, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#0ECC97',
                                font: { weight: 'bold' },
                                formatter: (v) => v + '%'
                            }
                        },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }
        }

        async function loadPremiumHashtags() {
            const response = await fetchData('/hashtag-intelligence/premium-hashtags?limit=15&min_contact_rate=65&min_leads=20');
            if (response?.success && response.data) {
                const ctx = document.getElementById('premiumHashtagsChart').getContext('2d');
                if (charts.premiumHashtags) charts.premiumHashtags.destroy();
                charts.premiumHashtags = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: response.data.map(d => d.hashtag),
                        datasets: [
                            {
                                label: 'Taxa de Contato (%)',
                                data: response.data.map(d => parseFloat(d.contact_rate)),
                                backgroundColor: 'rgba(251, 191, 36, 0.8)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Total Leads',
                                data: response.data.map(d => d.total_leads),
                                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                        scales: {
                            y: { type: 'linear', position: 'left', max: 100 },
                            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
        }

        async function loadSearchTermsStats() {
            const stats = await fetchData('/lead-search-terms/stats/summary');
            if (stats?.data) {
                const ctx = document.getElementById('searchTermsChart').getContext('2d');
                if (charts.searchTerms) charts.searchTerms.destroy();
                const modelData = stats.data.entries_by_model || {};
                charts.searchTerms = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(modelData),
                        datasets: [{
                            data: Object.values(modelData),
                            backgroundColor: ['rgba(14, 204, 151, 0.8)', 'rgba(251, 191, 36, 0.8)',
                                            'rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: { color: 'white', font: { weight: 'bold' } }
                        }
                    }
                });
            }
        }

        async function loadQualityScoreDistribution() {
            const response = await fetchData('/hashtag-intelligence/quality-distribution');
            if (response?.success && response.data) {
                const ctx = document.getElementById('qualityScoreChart').getContext('2d');
                if (charts.qualityScore) charts.qualityScore.destroy();
                charts.qualityScore = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(response.data),
                        datasets: [{
                            data: Object.values(response.data),
                            backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(59, 130, 246, 0.8)',
                                            'rgba(251, 191, 36, 0.8)', 'rgba(249, 115, 22, 0.8)',
                                            'rgba(239, 68, 68, 0.8)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { anchor: 'end', align: 'end', color: '#0ECC97', font: { weight: 'bold' } }
                        }
                    }
                });
            }
        }

        // =====================================================
        // NOVOS GRAFICOS DE SCRAPING METRICS
        // =====================================================

        async function loadDailyScrapingStats() {
            try {
                // Calcular data de 45 dias atras dinamicamente
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 45);
                const startDateStr = startDate.toISOString().split('T')[0];
                const response = await fetchData(`/hashtag-intelligence/daily-scraping-stats?start_date=${startDateStr}`);
                if (response?.success && response.data && response.data.length > 0) {
                    const ctx = document.getElementById('dailyScrapingChart').getContext('2d');
                    if (charts.dailyScraping) charts.dailyScraping.destroy();

                    const labels = response.data.map(d => {
                        // Adiciona T12:00:00 para evitar problema de timezone (UTC->Local)
                        const date = new Date(d.date + 'T12:00:00');
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    });

                    charts.dailyScraping = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Novos Perfis',
                                    data: response.data.map(d => parseInt(d.novos) || 0),
                                    borderColor: 'rgba(14, 204, 151, 1)',
                                    backgroundColor: 'rgba(14, 204, 151, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Atualizados',
                                    data: response.data.map(d => parseInt(d.atualizados) || 0),
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: { display: false },
                                tooltip: {
                                    callbacks: {
                                        footer: (tooltipItems) => {
                                            const total = tooltipItems.reduce((sum, item) => sum + item.raw, 0);
                                            return `Total: ${total}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Quantidade de Perfis' }
                                },
                                x: {
                                    title: { display: true, text: 'Data' },
                                    ticks: {
                                        maxTicksLimit: 7,
                                        callback: function(value, index, ticks) {
                                            const totalTicks = ticks.length;
                                            const interval = Math.ceil(totalTicks / 7);
                                            if (index % interval === 0 || index === totalTicks - 1) {
                                                return this.getLabelForValue(value);
                                            }
                                            return '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar daily scraping stats:', error);
            }
        }

        async function loadDailyEvolutionChart() {
            try {
                const response = await fetchData('/hashtag-intelligence/daily-metrics-evolution');
                console.log('[DEBUG] daily-metrics-evolution response:', response);

                if (response?.success && response.data && response.data.length > 0) {
                    const ctx = document.getElementById('dailyEvolutionChart').getContext('2d');
                    if (charts.dailyEvolution) charts.dailyEvolution.destroy();

                    const rawData = response.data;

                    const labels = rawData.map(d => {
                        const date = new Date(d.date + 'T12:00:00');
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    });

                    charts.dailyEvolution = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                // Leads Total (fundo claro)
                                {
                                    label: 'Leads Total (45d)',
                                    data: rawData.map(d => parseInt(d.total_leads) || 0),
                                    backgroundColor: 'rgba(16, 185, 129, 0.3)',
                                    borderColor: 'rgba(16, 185, 129, 0.5)',
                                    borderWidth: 1,
                                    barPercentage: 0.9,
                                    categoryPercentage: 0.45,
                                    order: 2,
                                    yAxisID: 'y'
                                },
                                // Leads c/ Contato (sobreposto)
                                {
                                    label: 'Leads c/ Contato',
                                    data: rawData.map(d => parseInt(d.leads_with_contact) || 0),
                                    backgroundColor: 'rgba(16, 185, 129, 1)',
                                    borderWidth: 0,
                                    barPercentage: 0.9,
                                    categoryPercentage: 0.45,
                                    order: 1,
                                    yAxisID: 'y'
                                },
                                // Hashtags Total (fundo claro)
                                {
                                    label: 'Hashtags Total (90d)',
                                    data: rawData.map(d => parseInt(d.total_hashtags) || 0),
                                    backgroundColor: 'rgba(14, 204, 151, 0.3)',
                                    borderColor: 'rgba(14, 204, 151, 0.5)',
                                    borderWidth: 1,
                                    barPercentage: 0.9,
                                    categoryPercentage: 0.45,
                                    order: 4,
                                    yAxisID: 'y1'
                                },
                                // Hashtags c/ Contato (sobreposto)
                                {
                                    label: 'Hashtags c/ Contato',
                                    data: rawData.map(d => parseInt(d.hashtags_with_contact) || 0),
                                    backgroundColor: 'rgba(14, 204, 151, 1)',
                                    borderWidth: 0,
                                    barPercentage: 0.9,
                                    categoryPercentage: 0.45,
                                    order: 3,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { intersect: false, mode: 'index' },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: { usePointStyle: true, padding: 10, font: { size: 10 } }
                                },
                                datalabels: { display: false },
                                tooltip: {
                                    callbacks: {
                                        afterBody: (items) => {
                                            const idx = items[0].dataIndex;
                                            const d = rawData[idx];
                                            const leadsPct = d.total_leads > 0 ? ((d.leads_with_contact / d.total_leads) * 100).toFixed(1) : 0;
                                            const hashPct = d.total_hashtags > 0 ? ((d.hashtags_with_contact / d.total_hashtags) * 100).toFixed(1) : 0;
                                            return `\nLeads: ${Number(d.leads_with_contact).toLocaleString('pt-BR')}/${Number(d.total_leads).toLocaleString('pt-BR')} (${leadsPct}%)` +
                                                   `\nHashtags: ${Number(d.hashtags_with_contact).toLocaleString('pt-BR')}/${Number(d.total_hashtags).toLocaleString('pt-BR')} (${hashPct}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    position: 'left',
                                    beginAtZero: true,
                                    title: { display: true, text: 'Leads (45d)', color: '#10b981' },
                                    ticks: {
                                        color: '#10b981',
                                        callback: function(value) {
                                            return Number(value).toLocaleString('pt-BR');
                                        }
                                    },
                                    grid: { display: true, color: 'rgba(16, 185, 129, 0.1)' }
                                },
                                y1: {
                                    type: 'linear',
                                    position: 'right',
                                    beginAtZero: true,
                                    title: { display: true, text: 'Hashtags (90d)', color: '#0ECC97' },
                                    ticks: {
                                        color: '#0ECC97',
                                        callback: function(value) {
                                            return Number(value).toLocaleString('pt-BR');
                                        }
                                    },
                                    grid: { display: false }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        maxTicksLimit: 13,
                                        callback: function(value, index, ticks) {
                                            const interval = Math.ceil(ticks.length / 13);
                                            return (index % interval === 0) ? this.getLabelForValue(value) : '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.warn('[WARN] daily-metrics-evolution sem dados:', response);
                }
            } catch (error) {
                console.error('Erro ao carregar daily evolution chart:', error);
            }
        }

        async function loadCooccurrenceTable() {
            const response = await fetchData('/hashtag-intelligence/cooccurrences?limit=10');
            if (response?.success && response.data) {
                const tbody = document.querySelector('#cooccurrenceTable tbody');
                tbody.innerHTML = response.data.map(row => {
                    const conf = row.cooccurrence >= 50 ? 'high' : row.cooccurrence >= 20 ? 'medium' : 'low';
                    const label = conf === 'high' ? 'Alta' : conf === 'medium' ? 'Media' : 'Baixa';
                    return `<tr>
                        <td><strong>#${row.hashtag1}</strong></td>
                        <td><strong>#${row.hashtag2}</strong></td>
                        <td>${row.cooccurrence}</td>
                        <td><span class="badge ${conf}">${label}</span></td>
                    </tr>`;
                }).join('');
            }
        }

        // ==================== CLUSTERING GEN√âRICO ====================

        // ID da campanha demo para clustering gen√©rico da plataforma
        let platformDemoCampaignId = null;

        function toggleClusteringControls() {
            const panel = document.getElementById('clusteringControlsPanel');
            const btn = document.getElementById('btnToggleClusteringControls');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = 'Ocultar Controles';
            } else {
                panel.style.display = 'none';
                btn.textContent = 'Configurar Clustering';
            }
        }

        async function getOrCreatePlatformDemoCampaign() {
            // Usar endpoint dedicado que cria ou retorna a campanha demo
            const response = await fetch(`${API_BASE}/hashtag-intelligence/platform-demo-campaign`);
            const data = await response.json();

            if (data?.success && data.data?.id) {
                const action = data.created ? 'criada' : 'encontrada';
                console.log(`üì¶ Campanha Platform Demo ${action}:`, data.data.id);
                return data.data.id;
            }

            throw new Error(data?.message || 'N√£o foi poss√≠vel obter campanha demo');
        }

        // ==========================================
        // GERA√á√ÉO DE SEEDS COM IA (sincronizado do CID)
        // ==========================================
        async function generateSeedsWithAI() {
            const btn = document.getElementById('btnGenerateSeedsDID');
            const nichoInput = document.getElementById('genericNicho')?.value?.trim() || '';
            const targetStates = document.getElementById('genericTargetStates')?.value?.trim() || '';

            if (!nichoInput) {
                alert('Preencha o campo "Nicho" para gerar seeds com IA.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥...';

            try {
                const response = await fetch(`${API_BASE}/hashtag-intelligence/generate-seeds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_description: nichoInput,
                        target_audience: 'Profissionais e empresas do nicho ' + nichoInput,
                        location: targetStates || null,
                        objective: 'prospec√ß√£o'
                    })
                });

                const result = await response.json();

                if (result.success && result.data?.seeds?.length > 0) {
                    // Preencher campo de seeds
                    document.getElementById('genericSeeds').value = result.data.seeds.join(', ');

                    // Feedback visual
                    btn.innerHTML = '‚úÖ';
                    setTimeout(() => {
                        btn.innerHTML = 'ü§ñ Gerar';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Erro ao gerar seeds');
                }

            } catch (error) {
                console.error('Erro ao gerar seeds:', error);
                alert(`Erro: ${error.message}`);
                btn.innerHTML = 'ü§ñ Gerar';
                btn.disabled = false;
            }
        }

        async function executeGenericClustering() {
            const btn = document.getElementById('btnExecuteGenericClustering');
            const status = document.getElementById('genericClusteringStatus');

            const seedsRaw = document.getElementById('genericSeeds')?.value || '';
            const nicho = document.getElementById('genericNicho')?.value || 'Geral';
            const mode = document.getElementById('genericMode')?.value || 'vector';
            const kRaw = parseInt(document.getElementById('genericK')?.value || '5', 10);

            // Filtros de rec√™ncia e localiza√ß√£o
            const targetStatesRaw = document.getElementById('genericTargetStates')?.value || '';
            const targetStates = targetStatesRaw
                ? targetStatesRaw.split(',').map(s => s.trim().toUpperCase()).filter(s => s.length === 2)
                : undefined;
            const leadMaxAgeDays = parseInt(document.getElementById('genericLeadMaxAge')?.value || '45', 10);
            const hashtagMaxAgeDays = parseInt(document.getElementById('genericHashtagMaxAge')?.value || '90', 10);

            const seeds = seedsRaw.split(',').map(s => s.trim()).filter(s => s.length > 0);

            // Valida√ß√£o para modo n√£o-vector
            const isVectorMode = mode === 'vector' || mode === 'vector_hashtag';
            if (!isVectorMode && seeds.length === 0) {
                alert('Preencha seeds para o modo hashtag');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Processando...';
            status.textContent = 'Obtendo/criando campanha demo...';
            status.style.color = 'var(--aic-green)';

            try {
                // Obter ou criar campanha demo
                platformDemoCampaignId = await getOrCreatePlatformDemoCampaign();
                status.textContent = 'Executando clustering...';

                const payload = {
                    seeds: seeds.length > 0 ? seeds : undefined,
                    nicho: nicho,
                    campaign_id: platformDemoCampaignId,
                    mode: mode,
                    k: Number.isFinite(kRaw) && kRaw > 0 ? kRaw : undefined,
                    target_states: targetStates,
                    lead_max_age_days: leadMaxAgeDays,
                    hashtag_max_age_days: hashtagMaxAgeDays
                };

                console.log('üéØ [Generic Clustering] Payload:', payload);

                const response = await fetch(`${API_BASE}/hashtag-intelligence/execute-clustering`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;
                    const clustersCount = data.clusters?.length || 0;
                    const leadsCount = data.total_leads || 0;
                    const silhouette = data.silhouette_avg || 0;

                    status.innerHTML = `‚úÖ ${clustersCount} clusters, ${leadsCount} leads | <a href="#" onclick="loadClusters(); loadClusterDistribution(); loadContactRateByCluster(); return false;" style="color: var(--aic-green);">Atualizar gr√°ficos</a>`;

                    // Atualizar resumo visual (sincronizado do CID)
                    const summaryDiv = document.getElementById('clusteringResultSummary');
                    if (summaryDiv) {
                        summaryDiv.style.display = 'block';
                        document.getElementById('resultK').textContent = clustersCount;
                        document.getElementById('resultLeads').textContent = leadsCount.toLocaleString();
                        document.getElementById('resultSilhouette').textContent = silhouette.toFixed(3);

                        // Qualidade do Silhouette Score
                        let silLabel, silColor;
                        if (silhouette >= 0.70) { silLabel = 'Excelente'; silColor = '#10b981'; }
                        else if (silhouette >= 0.50) { silLabel = 'Bom'; silColor = '#22c55e'; }
                        else if (silhouette >= 0.35) { silLabel = 'Razo√°vel'; silColor = '#f59e0b'; }
                        else if (silhouette >= 0.25) { silLabel = 'Aceit√°vel'; silColor = '#f97316'; }
                        else { silLabel = 'Fraco'; silColor = '#ef4444'; }

                        document.getElementById('resultSilhouette').style.color = silColor;
                        document.getElementById('resultSilhouetteLabel').textContent = silLabel;
                        document.getElementById('resultSilhouetteLabel').style.color = silColor;

                        // M√©todo usado
                        const methodLabel = mode === 'vector' ? 'Vector (embeddings)'
                            : mode === 'vector_hashtag' ? 'Vector (hashtags)'
                            : 'Hashtags (legado)';
                        document.getElementById('resultMethod').textContent = methodLabel;
                    }

                    // Recarregar dados automaticamente
                    await loadClusters();
                    await loadClusterDistribution();
                    await loadContactRateByCluster();

                    // Mostrar se√ß√£o de clusters se escondida
                    document.getElementById('clusters-section').style.display = 'block';
                } else {
                    throw new Error(result.message || 'Erro ao executar clustering');
                }
            } catch (error) {
                console.error('Erro no clustering gen√©rico:', error);
                status.textContent = `‚ùå Erro: ${error.message}`;
                status.style.color = '#ef4444';
                alert(`Erro: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Executar Clustering';
            }
        }

        // ==================== FIM CLUSTERING GEN√âRICO ====================

        async function loadClusters() {
            // Usar unified-intelligence (KMeans local, gratuito)
            const response = await fetchData('/unified-intelligence/clusters');
            if (response?.success && response.clusters) {
                allClusters = response.clusters;
                const container = document.getElementById('clusters-list');
                container.innerHTML = allClusters.map(c => `
                    <div class="cluster-card" onclick="selectCluster('${c.id}')">
                        <h4>${c.cluster_name}</h4>
                        <p style="font-size: 0.85em; color: var(--aic-gray); margin-bottom: 10px;">${c.cluster_description || ''}</p>
                        <div class="cluster-stats">
                            <div class="stat"><strong>${c.hashtag_count || 0}</strong> hashtags</div>
                            <div class="stat"><strong>${c.total_leads || 0}</strong> leads</div>
                            <div class="stat"><strong>${((c.conversion_rate || 0) * 100).toFixed(1)}%</strong> conversao</div>
                            <div class="stat">Score: <strong>${c.priority_score || 0}</strong></div>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.7em; color: var(--aic-gray);">KMeans: ${c.generated_at ? c.generated_at.substring(0, 19).replace('T', ' ') : 'N/A'}</div>
                    </div>
                `).join('');
            }
        }

        async function selectCluster(clusterId) {
            document.querySelectorAll('.cluster-card').forEach(card => card.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Usar unified-intelligence (KMeans local, gratuito)
            const response = await fetchData(`/unified-intelligence/cluster/${clusterId}`);
            if (response?.success && response.insights) {
                const insights = response.insights;
                const cluster = response.cluster;
                const painBadge = insights.pain_intensity === 'critica' ? 'critical' :
                                 insights.pain_intensity === 'alta' ? 'high' :
                                 insights.pain_intensity === 'media' ? 'medium' : 'low';

                const container = document.getElementById('behavioral-insights');
                container.innerHTML = `
                    <h3>Analise Comportamental: ${cluster.cluster_name}</h3>
                    <div class="insight-section">
                        <h4>Pain Points <span class="badge ${painBadge}">${insights.pain_intensity}</span></h4>
                        <ul>${(insights.pain_points || []).map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                    <div class="insight-section">
                        <h4>Tendencias Emergentes</h4>
                        <ul>${(insights.emerging_trends || []).map(t => `<li>${t}</li>`).join('')}</ul>
                    </div>
                    <div class="insight-section">
                        <h4>Perfil Psicografico</h4>
                        <p><strong>Consciencia:</strong> ${insights.audience_awareness_level}</p>
                        <p><strong>Estagio de Compra:</strong> ${insights.buying_stage}</p>
                        <p><strong>Tom:</strong> ${insights.communication_tone}</p>
                    </div>
                    <div class="insight-section">
                        <h4>Recomendacoes</h4>
                        <ul>${(insights.approach_recommendations || []).map(r => `<li>${r}</li>`).join('')}</ul>
                    </div>
                    <div class="insight-section">
                        <h4>Gatilhos Mentais</h4>
                        <div>${(insights.mental_triggers || []).map(t => `<span class="badge medium">${t}</span>`).join('')}</div>
                    </div>
                    <div class="insight-section">
                        <h4>Objecoes Comuns</h4>
                        <ul>${(insights.common_objections || []).map(o => `<li>${o}</li>`).join('')}</ul>
                    </div>
                    <div class="insight-section">
                        <h4>Oportunidades</h4>
                        <ul>${(insights.market_gaps || []).map(g => `<li>${g}</li>`).join('')}</ul>
                    </div>
                `;
                container.classList.add('visible');
                container.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadTrends() {
            // Usar unified-intelligence (KMeans local, gratuito)
            const response = await fetchData('/unified-intelligence/trends?limit=20');
            if (response?.success && response.trends) {
                const container = document.getElementById('trends-grid');
                container.innerHTML = response.trends.map(t => `
                    <div class="trend-card ${t.trend_type === 'viral' ? 'viral' : ''}">
                        <div class="hashtag">#${t.hashtag}</div>
                        <div class="growth">${t.growth_rate.toFixed(0)}% crescimento</div>
                        <div class="growth" style="font-size: 0.8em; margin-top: 5px;">${t.trend_type}</div>
                    </div>
                `).join('');
            }
        }

        async function executePipeline() {
            if (!confirm('Isso vai chamar a API GPT-4 (custo ~$0.10).\n\nDeseja continuar?')) {
                return;
            }
            const btn = document.getElementById('pipelineBtn');
            btn.disabled = true;
            btn.innerHTML = 'Executando GPT-4...';
            try {
                // Timeout de 10 minutos (600000ms) - GPT-4 pode demorar com 5k+ hashtags
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000);

                const response = await fetch(`${API_BASE}/dynamic-intelligence/execute-full-pipeline`, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const data = await response.json();
                if (data.success) {
                    alert(`Pipeline executado!\n\nClusters: ${data.clusters_updated}\n\nRecarregando...`);
                    await loadAllData();
                    await loadLastExecution();
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    alert('Timeout: Pipeline demorou mais de 10 minutos.\n\nVerifique os logs do servidor ou execute novamente.');
                } else {
                    alert('Erro: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Pipeline GPT-4 (Legado)';
            }
        }

        async function recalculateMetrics() {
            const btn = document.getElementById('recalculateBtn');
            btn.disabled = true;
            btn.innerHTML = 'Recalculando...';
            try {
                // Usar unified-intelligence (KMeans local, gratuito)
                const response = await fetch(`${API_BASE}/unified-intelligence/recalculate-metrics`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert(`Metricas recalculadas (SEM GPT-4)!\n\nClusters atualizados: ${data.clusters_updated}\nErros: ${data.errors}\n\nRecarregando...`);
                    await loadAllData();
                    await loadLastExecution();
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Recalcular Metricas';
            }
        }

        async function populateSearchTerms() {
            if (!confirm('Isso vai criar termos de busca baseados nos clusters GPT-4.\n\nDeseja continuar?')) {
                return;
            }
            const btn = document.getElementById('populateSearchTermsBtn');
            btn.disabled = true;
            btn.innerHTML = 'Gerando...';
            try {
                const response = await fetch(`${API_BASE}/dynamic-intelligence/populate-search-terms`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert(`Search Terms Gerados!\n\nCriados: ${data.terms_created}\nAtualizados: ${data.terms_updated}\nErros: ${data.errors}\nTotal: ${data.total_processed}\n\nRecarregando...`);
                    await loadAllData();
                    await loadLastExecution();
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Gerar Search Terms';
            }
        }

        async function loadLastExecution() {
            try {
                // Usar unified-intelligence (KMeans local, gratuito)
                const response = await fetch(`${API_BASE}/unified-intelligence/last-execution`);
                if (!response.ok) {
                    console.warn('Endpoint last-execution nao disponivel (servidor precisa reiniciar)');
                    const container = document.getElementById('lastExecutionInfo');
                    if (container) container.innerHTML = 'Reinicie o servidor para ver ultima execucao';
                    return;
                }
                const data = await response.json();

                const container = document.getElementById('lastExecutionInfo');
                if (!container) return;

                let html = '';

                if (data.last_full_pipeline) {
                    const date = new Date(data.last_full_pipeline);
                    html += `<strong>Ultimo Pipeline (GPT-4):</strong> ${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}`;
                }

                if (data.last_metrics_only) {
                    const date = new Date(data.last_metrics_only);
                    if (html) html += ' | ';
                    html += `<strong>Ultima Atualizacao:</strong> ${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR')}`;
                }

                if (!html) {
                    html = 'Nenhuma execucao registrada ainda';
                }

                container.innerHTML = html;
            } catch (error) {
                console.warn('Erro ao carregar ultima execucao:', error);
                const container = document.getElementById('lastExecutionInfo');
                if (container) container.innerHTML = 'Reinicie o servidor para habilitar';
            }
        }


        async function loadAllBehavioralInsights() {
            try {
                // Usar unified-intelligence (KMeans local, gratuito)
                const response = await fetchData('/unified-intelligence/clusters');
                if (response?.success && response.clusters) {
                    const container = document.getElementById('all-behavioral-insights');
                    if (!container) return;

                    let html = '';
                    for (const cluster of response.clusters) {
                        const insightsResp = await fetchData(`/unified-intelligence/cluster/${cluster.id}`);
                        if (insightsResp?.success && insightsResp.insights) {
                            const insights = insightsResp.insights;
                            const painBadge = insights.pain_intensity === 'critica' ? 'critical' :
                                           insights.pain_intensity === 'alta' ? 'high' :
                                           insights.pain_intensity === 'media' ? 'medium' : 'low';

                            html += `
                                <div class="behavioral-insights visible" style="margin-bottom: 30px;">
                                    <h3>${cluster.cluster_name}</h3>
                                    <div class="insight-section">
                                        <h4>Pain Points <span class="badge ${painBadge}">${insights.pain_intensity}</span></h4>
                                        <ul>${(insights.pain_points || []).map(p => `<li>${p}</li>`).join('')}</ul>
                                    </div>
                                    <div class="insight-section">
                                        <h4>Tendencias Emergentes</h4>
                                        <ul>${(insights.emerging_trends || []).map(t => `<li>${t}</li>`).join('')}</ul>
                                    </div>
                                    <div class="insight-section">
                                        <h4>Perfil Psicografico</h4>
                                        <p><strong>Consciencia:</strong> ${insights.audience_awareness_level}</p>
                                        <p><strong>Estagio de Compra:</strong> ${insights.buying_stage}</p>
                                        <p><strong>Tom:</strong> ${insights.communication_tone}</p>
                                    </div>
                                    <div class="insight-section">
                                        <h4>Recomendacoes</h4>
                                        <ul>${(insights.approach_recommendations || []).map(r => `<li>${r}</li>`).join('')}</ul>
                                    </div>
                                    <div class="insight-section">
                                        <h4>Gatilhos Mentais</h4>
                                        <div>${(insights.mental_triggers || []).map(t => `<span class="badge medium">${t}</span>`).join('')}</div>
                                    </div>
                                    <div class="insight-section">
                                        <h4>Objecoes Comuns</h4>
                                        <ul>${(insights.common_objections || []).map(o => `<li>${o}</li>`).join('')}</ul>
                                    </div>
                                    <div class="insight-section">
                                        <h4>Oportunidades</h4>
                                        <ul>${(insights.market_gaps || []).map(g => `<li>${g}</li>`).join('')}</ul>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    container.innerHTML = html;
                    document.getElementById('all-behavioral-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading all behavioral insights:', error);
            }
        }


        async function loadAllData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error-container').innerHTML = '';

                await Promise.allSettled([
                    loadKPIs(), loadTopHashtags(), loadClusterDistribution(),
                    loadContactRateByCluster(), loadPremiumHashtags(), loadSearchTermsStats(),
                    loadQualityScoreDistribution(), loadCooccurrenceTable(), loadClusters(), loadTrends(), loadAllBehavioralInsights(),
                    loadLastExecution(), loadPersonas(),
                    loadDailyScrapingStats(), loadDailyEvolutionChart()
                ]);

                hideLoading();
            } catch (error) {
                console.error('Error:', error);
                showError('Erro ao carregar dashboard');
                document.getElementById('loading').style.display = 'none';
            }
        }

        // =====================================================
        // FUNCOES DE PERSONAS DINAMICAS
        // =====================================================

        async function loadPersonas() {
            try {
                const [personasResp, statsResp] = await Promise.all([
                    fetchData('/dynamic-intelligence/personas'),
                    fetchData('/dynamic-intelligence/persona-stats').catch(() => ({ success: false }))
                ]);

                if (personasResp?.success) {
                    renderPersonasGrid(personasResp.personas);
                    document.getElementById('personas-section').style.display = 'block';
                }

                if (statsResp?.success && statsResp.stats) {
                    renderPersonasStats(statsResp.stats);
                }
            } catch (error) {
                console.warn('Personas nao disponiveis:', error);
                // Nao bloqueia se tabela nao existir ainda
            }
        }

        function renderPersonasStats(stats) {
            const container = document.getElementById('personas-stats');
            if (!container || !stats.total_personas) return;

            container.innerHTML = `
                <div class="persona-stats-grid">
                    <div class="persona-stat-item">
                        <div class="persona-stat-value">${stats.total_personas}</div>
                        <div class="persona-stat-label">Personas Ativas</div>
                    </div>
                    <div class="persona-stat-item">
                        <div class="persona-stat-value" style="color: #3b82f6;">${stats.total_leads_assigned || 0}</div>
                        <div class="persona-stat-label">Leads Associados</div>
                    </div>
                    <div class="persona-stat-item">
                        <div class="persona-stat-value">${(stats.avg_conversion || 0).toFixed(1)}%</div>
                        <div class="persona-stat-label">Conversao Media</div>
                    </div>
                    <div class="persona-stat-item">
                        <div class="persona-stat-value" style="color: #f59e0b;">${(stats.avg_monetization || 0).toFixed(0)}</div>
                        <div class="persona-stat-label">Potencial Medio</div>
                    </div>
                </div>
            `;
        }

        function renderPersonasGrid(personas) {
            const container = document.getElementById('personas-grid');
            if (!container) return;

            if (!personas || personas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">P</div>
                        <h3>Nenhuma Persona Gerada</h3>
                        <p>Clique em "Gerar Personas (GPT)" para criar personas baseadas nos seus clusters dinamicos.</p>
                        <button class="btn" onclick="generatePersonas()" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                            Gerar Personas Agora
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = personas.map(p => `
                <div class="persona-card">
                    <!-- Header -->
                    <div class="persona-header">
                        <div class="persona-info">
                            <div class="persona-avatar">${(p.persona_name || 'P').charAt(0).toUpperCase()}</div>
                            <div>
                                <h3 class="persona-name">${p.persona_name}</h3>
                                <div class="persona-occupation">${p.primary_occupation || 'Profissional'}</div>
                            </div>
                        </div>
                        <div class="persona-score">${(p.monetization_potential || 0).toFixed(0)} pts</div>
                    </div>

                    <!-- Metricas -->
                    <div class="persona-metrics">
                        <div class="persona-metric">
                            <div class="persona-metric-value" style="color: #3b82f6;">${p.total_leads || 0}</div>
                            <div class="persona-metric-label">Leads</div>
                        </div>
                        <div class="persona-metric">
                            <div class="persona-metric-value">${(p.percentage_of_base || 0).toFixed(1)}%</div>
                            <div class="persona-metric-label">da Base</div>
                        </div>
                        <div class="persona-metric">
                            <div class="persona-metric-value" style="color: #f59e0b;">${(p.avg_conversion_rate || 0).toFixed(1)}%</div>
                            <div class="persona-metric-label">Conversao</div>
                        </div>
                    </div>

                    <!-- Perfil -->
                    <div class="persona-tags">
                        ${p.age_range ? `<span class="persona-tag">${p.age_range}</span>` : ''}
                        ${p.business_stage ? `<span class="persona-tag">${p.business_stage}</span>` : ''}
                        ${p.awareness_level ? `<span class="persona-tag">${p.awareness_level.replace(/_/g, ' ')}</span>` : ''}
                    </div>

                    <!-- Motivacoes -->
                    ${p.primary_motivations && p.primary_motivations.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div class="persona-section-title">Motivacoes</div>
                        <div class="persona-section-content">
                            ${p.primary_motivations.slice(0, 3).map(m => `- ${m.replace(/_/g, ' ')}`).join('<br>')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Pain Points -->
                    ${p.core_pain_points && p.core_pain_points.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div class="persona-section-title" style="color: #ef4444;">Dores Principais</div>
                        <div class="persona-section-content">
                            ${p.core_pain_points.slice(0, 3).map(pp => `- ${pp.replace(/_/g, ' ')}`).join('<br>')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Abordagem Ideal -->
                    ${p.ideal_first_contact ? `
                    <div class="persona-approach-box">
                        <div class="title">Abordagem Ideal</div>
                        <div class="content">
                            ${p.ideal_first_contact.substring(0, 200)}${p.ideal_first_contact.length > 200 ? '...' : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Footer -->
                    <div class="persona-footer">
                        ${p.primary_cluster_name ? `Cluster: ${p.primary_cluster_name}` : ''}
                        ${p.created_at ? ` | Gerado: ${new Date(p.created_at).toLocaleDateString('pt-BR')}` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function generatePersonas() {
            if (!confirm('Isso vai gerar personas via GPT (custo ~$0.15).\n\nDeseja continuar?')) {
                return;
            }
            const btn = document.getElementById('generatePersonasBtn');
            btn.disabled = true;
            btn.innerHTML = 'Gerando...';
            try {
                const response = await fetch(`${API_BASE}/dynamic-intelligence/generate-personas`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert(`Personas Geradas!\n\nCriadas: ${data.personas_created}\nAtualizadas: ${data.personas_updated}\nLeads Associados: ${data.leads_assigned}\n\nRecarregando...`);
                    await loadPersonas();
                } else {
                    alert('Erro: ' + (data.errors?.join(', ') || data.error));
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Gerar Personas (GPT)';
            }
        }

        async function recalculatePersonaMetrics() {
            const btn = document.getElementById('recalcPersonaMetricsBtn');
            btn.disabled = true;
            btn.innerHTML = 'Calculando...';
            try {
                const response = await fetch(`${API_BASE}/dynamic-intelligence/recalculate-persona-metrics`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert(`Metricas Atualizadas!\n\nPersonas: ${data.personas_updated}\n\nRecarregando...`);
                    await loadPersonas();
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Atualizar Metricas';
            }
        }

        // ============================================================================
        // VECTOR STORE FUNCTIONS
        // ============================================================================

        async function loadVectorStoreStatus() {
            try {
                const response = await fetch('/api/hashtag-intelligence/sync/status');
                const data = await response.json();

                if (data.success) {
                    const { csv, vectorStore } = data.data;

                    // Update details
                    const detailsDiv = document.getElementById('vectorStoreDetails');
                    const badgeDiv = document.getElementById('vectorStoreBadge');

                    if (csv.exists && vectorStore.exists) {
                        const ageText = csv.ageHours < 1 ? 'Atualizado ha minutos' :
                                       csv.ageHours < 24 ? `Atualizado ha ${csv.ageHours}h` :
                                       `Atualizado ha ${Math.floor(csv.ageHours / 24)}d`;

                        detailsDiv.innerHTML = `
                            ${csv.rowCount.toLocaleString()} hashtags |
                            ${(csv.sizeKB / 1024).toFixed(1)}MB |
                            ${ageText}
                        `;

                        if (csv.needsUpdate) {
                            badgeDiv.style.background = '#f59e0b';
                            badgeDiv.textContent = 'DESATUALIZADO';
                        } else {
                            badgeDiv.style.background = 'var(--aic-green)';
                            badgeDiv.textContent = 'ATIVO';
                        }
                    } else {
                        detailsDiv.innerHTML = 'Vector Store nao inicializado - Execute Sync';
                        badgeDiv.style.background = '#ef4444';
                        badgeDiv.textContent = 'INATIVO';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar status Vector Store:', error);
                document.getElementById('vectorStoreDetails').innerHTML = 'Erro ao carregar status';
            }
        }

        async function syncVectorStore() {
            if (!confirm('Sincronizacao Vector Store\n\nIsso vai:\n1. Exportar todas as hashtags do PostgreSQL para CSV\n2. Fazer upload para OpenAI Vector Store\n3. Processar embeddings para busca semantica\n\nTempo estimado: 2-5 minutos\n\nDeseja continuar?')) {
                return;
            }

            const btn = document.getElementById('syncParquetBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Sincronizando...';

            try {
                const response = await fetch('/api/hashtag-intelligence/sync', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    const { csv, vectorStore } = data.data;
                    alert(`Sincronizacao Concluida!\n\n` +
                          `Hashtags exportadas: ${csv.totalRecords.toLocaleString()}\n` +
                          `Tamanho arquivo: ${(csv.fileSizeKB / 1024).toFixed(1)}MB\n` +
                          `Vector Store: ${vectorStore.vectorStoreId}\n` +
                          `Status: ${vectorStore.status}\n\n` +
                          `Sistema pronto para analise com busca semantica!`);

                    // Reload status
                    await loadVectorStoreStatus();
                } else {
                    alert('Erro na sincronizacao:\n\n' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro ao sincronizar:\n\n' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        window.addEventListener('load', () => {
            loadAllData();
            loadVectorStoreStatus(); // Load Vector Store status on page load
        });

        setInterval(loadAllData, 300000); // Auto-refresh 5 min
        setInterval(loadVectorStoreStatus, 60000); // Auto-refresh Vector Store status every 1 min
    </script>
</body>
</html>
