<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIC — Dashboard de Campanha</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c1b33;
      --panel: #122444;
      --card: #162c4d;
      --accent: #0ecc97;
      --accent-dark: #0ba578;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: #1e3a5f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .page { max-width: 1100px; margin: 0 auto; padding: 32px 20px 64px; }
    h1 { font-size: 28px; margin: 0 0 8px 0; }
    p { color: var(--muted); margin: 0 0 16px 0; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 14px;
    }
    .card h2 { margin: 0 0 8px 0; font-size: 18px; color: var(--text); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(14, 204, 151, 0.12);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 999px;
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
      margin-right: 8px;
    }
    ul { padding-left: 18px; margin: 8px 0; color: var(--muted); }
    code { background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 6px; }
    .cta {
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #0c1b33;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(14, 204, 151, 0.25);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    .nav-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .nav-action {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .nav-action:hover {
      border-color: var(--accent);
      background: rgba(14, 204, 151, 0.1);
    }
    .nav-action.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #0c1b33;
      font-weight: 700;
      border: none;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
      text-decoration: none;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .back-link:hover { color: var(--accent); }
  </style>
<link rel="stylesheet" href="/css/icons.css"></head>
<body>
  <div class="page">
    <a href="/aic-campaigns-dashboard.html" class="back-link">← Voltar para Campanhas</a>

    <div class="card">
      <div class="pill">beta</div>
      <h1 id="campaign-title">Dashboard de Campanha AIC</h1>
      <p id="campaign-subtitle">Carregando informações da campanha...</p>
    </div>

    <!-- Navigation Actions -->
    <div class="nav-actions" id="nav-actions">
      <a href="#" class="nav-action" id="link-onboarding"><span class="ic ic-cfg"></span> Configuração</a>
      <a href="#" class="nav-action" id="link-briefing"><span class="ic ic-doc"></span> Briefing</a>
      <a href="#" class="nav-action" id="link-analytics"><span class="ic ic-chart"></span> Analytics</a>
      <a href="#" class="nav-action primary" id="link-leads"><span class="ic ic-user"></span> Ver Leads</a>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Links rápidos (views)</h2>
        <ul>
          <li><code>vw_funnel_seo</code> — funil SEO → CTA → Lead</li>
          <li><code>vw_leads_by_source</code> — sessões, cliques e leads por origem</li>
          <li><code>vw_cta_performance</code> — ranking de CTAs com conversão</li>
          <li><code>vw_cost_per_source</code> — custo e CPL por origem (se preenchido)</li>
        </ul>
      </div>

      <div class="card" id="como-usar">
        <h2>Como usar</h2>
        <ul>
          <li>Conecte Metabase/Superset ao Postgres/Supabase.</li>
          <li>Crie um dashboard filtrado por <code>campaign_id</code> usando as views acima.</li>
          <li>Widgets sugeridos: cards de Leads/QL/Custo/CPL; funil SEO; barras por origem; tabela de CTAs; custo por origem.</li>
          <li>Instrumente o tracking: <code>campaign_web_sessions</code>, <code>campaign_web_events</code>, <code>campaign_lead_attribution</code>.</li>
        </ul>
      </div>

      <div class="card">
        <h2>Endpoints (a adicionar)</h2>
        <p>Se quiser consumir via API do app, crie uma rota backend que leia as views e retorne JSON. Exemplo:</p>
<pre style="white-space: pre-wrap; color: var(--muted); font-size: 13px;">
GET /api/campaigns/:id/performance
  → usa vw_funnel_seo, vw_leads_by_source, vw_cta_performance, vw_cost_per_source
</pre>
        <p>Esta página é estática: não há chamada API pronta.</p>
      </div>
      </div>
  </div>

  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      let campaignId = params.get('campaign');
      const container = document.querySelector('.grid');
      let campaignsList = [];

      // Setup navigation links
      function setupNavLinks(id) {
        if (!id) {
          document.getElementById('nav-actions').style.display = 'none';
          return;
        }
        document.getElementById('nav-actions').style.display = 'flex';
        document.getElementById('link-onboarding').href = `/aic-campaign-onboarding.html?campaign=${id}`;
        document.getElementById('link-briefing').href = `/aic-campaign-briefing.html?campaign=${id}`;
        document.getElementById('link-analytics').href = `/aic-dashboard-prova.html?campaign=${id}`;
        document.getElementById('link-leads').href = `/aic-campaigns-dashboard.html?campaign=${id}#leads`;
      }

      // Update header with campaign info
      function updateHeader(campaign) {
        const title = document.getElementById('campaign-title');
        const subtitle = document.getElementById('campaign-subtitle');
        if (campaign) {
          title.textContent = campaign.name || campaign.campaign_name || 'Campanha';
          const status = campaign.status ? `Status: ${campaign.status}` : '';
          const dates = campaign.start_date ? ` | ${campaign.start_date}${campaign.end_date ? ' → ' + campaign.end_date : ''}` : '';
          subtitle.textContent = status + dates || 'Dashboard de métricas da campanha';
        } else {
          title.textContent = 'Dashboard de Campanha AIC';
          subtitle.textContent = 'Selecione uma campanha para visualizar métricas';
        }
      }

      // Initialize nav links
      setupNavLinks(campaignId);

      function renderError(msg) {
        document.querySelectorAll('.error-block').forEach(el => el.remove());
        const el = document.createElement('div');
        el.className = 'card error-block dynamic-block';
        el.innerHTML = `<h2>Erro</h2><p style="color:#fca5a5;">${msg}</p>`;
        container.prepend(el);
      }

      function renderData(data) {
        const { funnel, leads_by_source, cta_performance, cost_per_source } = data;

        // Limpar anteriores
        document.querySelectorAll('.dynamic-block').forEach(el => el.remove());
        document.querySelectorAll('.error-block').forEach(el => el.remove());

        const kpi = document.createElement('div');
        kpi.className = 'card dynamic-block';
        const leads = leads_by_source?.reduce((acc, cur) => acc + (cur.leads || 0), 0) || 0;
        const qualified = leads_by_source?.reduce((acc, cur) => acc + (cur.qualified_leads || 0), 0) || 0;
        kpi.innerHTML = `
          <h2>KPIs</h2>
          <p>Leads: <strong>${leads}</strong></p>
          <p>Leads qualificados: <strong>${qualified}</strong></p>
          <p>Funil SEO (sessões → CTA → leads qualificados): <strong>${funnel?.seo_sessions || 0}</strong> → <strong>${funnel?.seo_cta_clicks || 0}</strong> → <strong>${funnel?.seo_qualified_leads || 0}</strong></p>
        `;
        container.prepend(kpi);

        const cta = document.createElement('div');
        cta.className = 'card dynamic-block';
        cta.innerHTML = `<h2>Top CTAs</h2>` + (cta_performance || []).slice(0, 5).map((c) => `
          <p><strong>${c.cta_id}</strong> — cliques: ${c.cta_clicks}, leads: ${c.leads}, conv%: ${c.conv_qualified_per_click ? (c.conv_qualified_per_click * 100).toFixed(1) : '0.0'}</p>
        `).join('') || '<p>Nenhum CTA encontrado.</p>';
        container.append(cta);

        if (cost_per_source && cost_per_source.length) {
          const cost = document.createElement('div');
          cost.className = 'card dynamic-block';
          cost.innerHTML = '<h2>Custo por origem</h2>' + cost_per_source.map((c) =>
            `<p>${c.source}: R$ ${Number(c.cost_total || 0).toFixed(2)} | CPL: R$ ${c.cpl ? Number(c.cpl).toFixed(2) : '—'}</p>`
          ).join('');
          container.append(cost);
        }
      }

      function buildSelector(list, selectedId) {
        // remover seletor antigo e blocos dinâmicos
        document.querySelectorAll('.selector-block').forEach(el => el.remove());
        document.querySelectorAll('.dynamic-block').forEach(el => el.remove());
        document.querySelectorAll('.error-block').forEach(el => el.remove());

        const card = document.createElement('div');
        card.className = 'card selector-block';
        card.innerHTML = '<h2>Escolha a campanha</h2>';
        const select = document.createElement('select');
        select.style.padding = '10px';
        select.style.borderRadius = '10px';
        select.style.border = '1px solid var(--border)';
        select.style.background = 'var(--panel)';
        select.style.color = 'var(--text)';
        select.style.width = '100%';
        select.style.marginTop = '8px';

        list.forEach((c) => {
          const opt = document.createElement('option');
          opt.value = c.id;
          const status = c.status || '—';
          const dates = c.start_date ? ` • ${c.start_date}${c.end_date ? ' → ' + c.end_date : ''}` : '';
          opt.textContent = `${c.name || 'Campanha'} (${status})${dates}`;
          if (c.id === selectedId) opt.selected = true;
          select.appendChild(opt);
        });

        const btn = document.createElement('button');
        btn.textContent = 'Abrir dashboard';
        btn.style.marginTop = '10px';
        btn.style.padding = '10px 14px';
        btn.style.borderRadius = '10px';
        btn.style.border = '1px solid var(--border)';
        btn.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-dark))';
        btn.style.color = '#0c1b33';
        btn.style.fontWeight = '700';
        btn.style.cursor = 'pointer';

        const applySelection = () => {
          const id = select.value;
          if (!id) return;
          const url = new URL(window.location.href);
          url.searchParams.set('campaign', id);
          history.replaceState({}, '', url.toString());
          campaignId = id;
          setupNavLinks(id);
          // Update header with selected campaign
          const selectedCampaign = campaignsList.find(c => c.id === id);
          updateHeader(selectedCampaign);
          loadPerformance(id);
        };

        select.addEventListener('change', applySelection);
        btn.addEventListener('click', applySelection);

        card.appendChild(select);
        card.appendChild(btn);
        container.prepend(card);
      }

      function loadPerformance(id) {
        fetch(`/api/campaigns/${id}/performance`, { cache: 'no-store' })
          .then(async (res) => {
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || 'Falha ao carregar performance');
            }
            return res.json();
          })
          .then(renderData)
          .catch((err) => {
            console.error(err);
            const msg = err?.message || 'Erro ao carregar performance';
            if (msg.includes('views_missing') || msg.includes('vw_funnel_seo') || msg.includes('relation')) {
              renderError('Views não encontradas. Rode os scripts de criação das views (vw_funnel_seo, vw_leads_by_source, vw_cta_performance, vw_cost_per_source) no banco.');
            } else {
              renderError('Erro ao carregar performance: ' + msg);
            }
          });
      }

      fetch('/api/campaigns', { cache: 'no-store' })
        .then(async (res) => {
          if (!res.ok) throw new Error('Falha ao carregar campanhas');
          return res.json();
        })
        .then((data) => {
        const listRaw = data.campaigns || [];
        // Priorizar campanhas aparentemente ativas, mas manter todas na lista
        const activeStatuses = ['active', 'outreach_in_progress', 'ready_for_outreach', 'ready', 'live', 'outreach_completed'];
        const list = [...listRaw].sort((a, b) => {
          const score = (c) => activeStatuses.includes((c.status || '').toLowerCase()) ? 0 : 1;
          return score(a) - score(b);
        });
        // Store globally for applySelection
        campaignsList = list;

          if (!list.length) {
            renderError('Nenhuma campanha encontrada. Crie uma campanha e tente novamente.');
            return;
          }

          const selected = (campaignId && list.some((c) => c.id === campaignId))
            ? campaignId
            : list[0].id;

          // Update header and nav with selected campaign
          const selectedCampaign = list.find(c => c.id === selected);
          updateHeader(selectedCampaign);
          setupNavLinks(selected);

          buildSelector(list, selected);
          loadPerformance(selected);
        })
        .catch((err) => {
          console.error(err);
          renderError('Erro ao listar campanhas: ' + err.message);
        });
    })();
  </script>

  <!-- AIC Sidebar Navigation -->
  <script src="/components/aic-sidebar.js"></script>
</body>
</html>
