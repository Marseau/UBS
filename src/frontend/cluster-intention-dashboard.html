<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Intention Dashboard - AIC v3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .version-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: 600;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .keywords-input {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .input-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .suggestions {
            margin-top: 15px;
        }

        .suggestions-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .suggestion-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-pill {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-pill:hover {
            background: #667eea;
            color: white;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            width: 100%;
            font-weight: 600;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        /* VIABILITY CARD - Nova se√ß√£o principal */
        .viability-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .viability-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .viability-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .viability-viable {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .viability-not-viable {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .criteria-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .criteria-item.passed {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .criteria-item.failed {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .criteria-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .criteria-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .criteria-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .criteria-target {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        /* SCRAPING RECOMMENDATION */
        .scraping-recommendation {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 16px;
            padding: 30px;
            margin: 25px 0;
            color: white;
        }

        .scraping-recommendation h3 {
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .scraping-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .scraping-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .scraping-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .scraping-value {
            font-size: 2em;
            font-weight: 700;
            color: #fbbf24;
        }

        .scraping-detail {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            color: #667eea;
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-sub {
            color: #999;
            font-size: 0.85em;
        }

        /* HASHTAGS SECTION */
        .hashtags-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .hashtags-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hashtags-table {
            width: 100%;
            border-collapse: collapse;
        }

        .hashtags-table th,
        .hashtags-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .hashtags-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            font-size: 0.85em;
            text-transform: uppercase;
        }

        .hashtags-table tr:hover {
            background: #f8f9fa;
        }

        .hashtag-name {
            font-weight: 600;
            color: #667eea;
        }

        .contact-rate-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            width: 100px;
            overflow: hidden;
        }

        .contact-rate-fill {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            height: 100%;
            border-radius: 10px;
        }

        /* FLAGS GRID */
        .flags-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .flag-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
        }

        .flag-card:hover {
            transform: translateY(-3px);
        }

        .flag-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .flag-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .flag-yes {
            border: 3px solid #10b981;
            background: #ecfdf5;
        }

        .flag-no {
            border: 3px solid #e0e0e0;
            opacity: 0.5;
        }

        /* SEARCH TERMS */
        .search-terms-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
        }

        .search-terms-box h3 {
            margin-bottom: 15px;
        }

        .btn-search-terms {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-search-terms:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .search-terms-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.5);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
        }

        /* RECOMMENDATIONS */
        .recommendations-list {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .recommendations-list h4 {
            color: #92400e;
            margin-bottom: 15px;
        }

        .recommendations-list ul {
            margin: 0;
            padding-left: 20px;
        }

        .recommendations-list li {
            color: #92400e;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .criteria-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .scraping-grid {
                grid-template-columns: 1fr;
            }

            .flags-grid {
                grid-template-columns: 1fr;
            }
        }

        /* GENERATED CONTENT SECTION */
        .generated-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
        }

        .generated-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .generated-header h2 {
            color: #10b981;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .generated-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .generated-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .generated-content-card {
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .generated-content-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .generated-content-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .generated-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85em;
            opacity: 0.9;
        }

        .btn-copy-content {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn-copy-content:hover {
            background: rgba(255,255,255,0.3);
        }

        .generated-content-body {
            padding: 25px;
            font-size: 0.95em;
            line-height: 1.8;
            color: #334155;
            max-height: 600px;
            overflow-y: auto;
        }

        .generated-content-body h2 {
            color: #667eea;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .generated-content-body h3 {
            color: #764ba2;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        .generated-content-body h4 {
            color: #475569;
            font-size: 1.05em;
            margin-top: 18px;
            margin-bottom: 10px;
        }

        .generated-content-body strong {
            color: #1e293b;
        }

        .generated-content-body li {
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .generated-content-body .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }

        .generated-content-body code {
            background: #e2e8f0;
            color: #7c3aed;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .flag-completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            border-color: #059669 !important;
        }

        .flag-completed .flag-icon {
            animation: none !important;
        }

        /* CLUSTERING SECTION */
        .clustering-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .clustering-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .clustering-header h2 {
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-clustering {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-clustering:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-clustering:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clustering-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .clustering-status.waiting {
            background: #fef3c7;
            color: #92400e;
        }

        .clustering-status.processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .clustering-status.done {
            background: #d1fae5;
            color: #065f46;
        }

        /* CLUSTER CARDS */
        .clusters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .cluster-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .cluster-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.15);
        }

        .cluster-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .cluster-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
        }

        .cluster-id-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .cluster-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .cluster-stat {
            text-align: center;
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
        }

        .cluster-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }

        .cluster-stat-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
        }

        .cluster-hashtags {
            margin-top: 15px;
        }

        .cluster-hashtags-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .cluster-hashtag-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .cluster-hashtag-pill {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }

        /* CLUSTERING SUMMARY */
        .clustering-summary {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
        }

        .clustering-summary h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .clustering-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .clustering-summary-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .clustering-summary-value {
            font-size: 2em;
            font-weight: 700;
            color: #fbbf24;
        }

        .clustering-summary-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* TOP LEADS LIST */
        .top-leads-section {
            margin-top: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .top-leads-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .leads-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .lead-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .lead-item.has-contact {
            border-left-color: #10b981;
        }

        .lead-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lead-cluster-badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .lead-score {
            font-weight: 700;
            color: #667eea;
        }

        .lead-contact-badge {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                Cluster Intention Dashboard
                <span class="version-badge">v3.0 - Validacao Robusta</span>
            </h1>
            <p>Analise de Intencao do Cliente - Validacao de Massa Critica para Clusterizacao</p>

            <div class="input-section">
                <!-- Informa√ß√µes do Cliente/Projeto/Campanha - Dropdowns em Cascata -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label class="input-label" for="clientSelect">Cliente</label>
                        <select id="clientSelect" class="input-field" onchange="onClientChange()">
                            <option value="">-- Selecione ou crie novo --</option>
                            <option value="__NEW__">+ Novo Cliente</option>
                        </select>
                        <input
                            type="text"
                            id="clientNameInput"
                            class="input-field"
                            placeholder="Nome do novo cliente..."
                            style="display: none; margin-top: 8px;"
                        >
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="projectSelect">Projeto</label>
                        <select id="projectSelect" class="input-field" onchange="onProjectChange()" disabled>
                            <option value="">-- Selecione cliente primeiro --</option>
                        </select>
                        <input
                            type="text"
                            id="projectNameInput"
                            class="input-field"
                            placeholder="Nome do novo projeto..."
                            style="display: none; margin-top: 8px;"
                        >
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="campaignSelect">Campanha</label>
                        <select id="campaignSelect" class="input-field" onchange="onCampaignChange()" disabled>
                            <option value="">-- Selecione projeto primeiro --</option>
                        </select>
                        <input
                            type="text"
                            id="campaignNameInput"
                            class="input-field"
                            placeholder="Nome da nova campanha..."
                            style="display: none; margin-top: 8px;"
                        >
                    </div>
                </div>

                <!-- Modo de edi√ß√£o indicator -->
                <div id="editModeIndicator" style="display: none; background: #e0f2fe; border: 1px solid #0284c7; padding: 12px; border-radius: 8px; margin-bottom: 20px; color: #0369a1;">
                    <strong>Modo Edicao:</strong> <span id="editingCampaignName"></span>
                    <button onclick="clearSelection()" style="float: right; background: #0284c7; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">Limpar Selecao</button>
                </div>

                <!-- Nichos e Seeds -->
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                    <div class="input-group">
                        <label class="input-label" for="nichoInput">Nicho Alvo *</label>
                        <input
                            type="text"
                            id="nichoInput"
                            class="input-field"
                            placeholder="Ex: Gestao de Trafego, Estetica..."
                        >
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="seedsInput">Seeds/Keywords (separadas por virgula) *</label>
                        <input
                            type="text"
                            id="seedsInput"
                            class="input-field"
                            placeholder="Ex: gestao, trafego, marketing, ads"
                        >
                        <div class="input-hint">Keywords que identificam o nicho nas hashtags dos leads</div>
                    </div>
                </div>

                <!-- Descricao do Servico e Publico Alvo -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="input-group">
                        <label class="input-label" for="serviceDescription">Descricao do Servico/Produto *</label>
                        <textarea
                            id="serviceDescription"
                            class="input-field keywords-input"
                            placeholder="Descreva o servico ou produto que sera oferecido..."
                            style="min-height: 60px;"
                        ></textarea>
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="targetAudience">Publico Alvo *</label>
                        <textarea
                            id="targetAudience"
                            class="input-field keywords-input"
                            placeholder="Descreva o publico-alvo ideal para este servico..."
                            style="min-height: 60px;"
                        ></textarea>
                    </div>
                </div>

                <!-- Detalhes adicionais do publico (colapsavel) -->
                <details style="margin-top: 15px;">
                    <summary style="cursor: pointer; color: #667eea; font-weight: 600;">Detalhes do Publico Alvo (opcional)</summary>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Faixa Etaria</label>
                            <input type="text" id="targetAgeRange" class="input-field" placeholder="Ex: 25-45">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Genero</label>
                            <select id="targetGender" class="input-field">
                                <option value="">Todos</option>
                                <option value="female">Feminino</option>
                                <option value="male">Masculino</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Localizacao</label>
                            <input type="text" id="targetLocation" class="input-field" placeholder="Ex: Brasil, SP">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Classe Social</label>
                            <select id="targetIncomeClass" class="input-field">
                                <option value="">Todas</option>
                                <option value="A">Classe A</option>
                                <option value="B">Classe B</option>
                                <option value="C">Classe C</option>
                                <option value="D">Classe D</option>
                            </select>
                        </div>
                    </div>
                </details>

                <!-- Criterios customizaveis (colapsavel) -->
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; color: #667eea; font-weight: 600;">Criterios de Viabilidade (opcional)</summary>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Hashtags freq>=5</label>
                            <input type="number" id="criteriaHashtags" class="input-field" value="20" min="1">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Leads Unicos</label>
                            <input type="number" id="criteriaLeads" class="input-field" value="100" min="1">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Hashtags c/ 3+ leads</label>
                            <input type="number" id="criteriaHashtagsLeads" class="input-field" value="5" min="1">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Contact Rate (%)</label>
                            <input type="number" id="criteriaContactRate" class="input-field" value="20" min="1" max="100">
                        </div>
                    </div>
                </details>

                <div class="suggestions">
                    <div class="suggestions-label">Ou selecione um nicho pre-definido:</div>
                    <div class="suggestion-pills" id="suggestionPills">
                        <!-- Sugestoes serao inseridas via JavaScript -->
                    </div>
                </div>

                <button class="btn" id="analyzeBtn" onclick="validateNiche()">
                    Validar Nicho
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>Validando massa critica do nicho...</p>
        </div>

        <div id="results" class="results">
            <!-- Viability Card -->
            <div class="viability-card">
                <div class="viability-header">
                    <h2>Validacao do Nicho</h2>
                    <div id="viabilityStatus" class="viability-status"></div>
                </div>

                <!-- Criterios Grid -->
                <div class="criteria-grid" id="criteriaGrid">
                    <!-- Preenchido via JS -->
                </div>

                <!-- Recomendacoes (se nao viavel) -->
                <div id="recommendationsBox" class="recommendations-list" style="display: none;">
                    <h4>Recomendacoes para tornar o nicho viavel:</h4>
                    <ul id="recommendationsList"></ul>
                </div>
            </div>

            <!-- Scraping Recommendation (se nao viavel) -->
            <div id="scrapingRecommendation" class="scraping-recommendation" style="display: none;">
                <h3>Necessidade de Scraping</h3>
                <div class="scraping-grid">
                    <div class="scraping-item">
                        <div class="scraping-label">Leads Faltantes</div>
                        <div class="scraping-value" id="leadsFaltantes">0</div>
                        <div class="scraping-detail">para atingir minimo</div>
                    </div>
                    <div class="scraping-item">
                        <div class="scraping-label">Hashtags a Scrapar</div>
                        <div class="scraping-value" id="hashtagsAScraper">0</div>
                        <div class="scraping-detail">das top hashtags</div>
                    </div>
                    <div class="scraping-item">
                        <div class="scraping-label">Perfis Estimados</div>
                        <div class="scraping-value" id="perfisEstimadosScrape">0</div>
                        <div class="scraping-detail">necessarios coletar</div>
                    </div>
                </div>

                <!-- Search Terms Button -->
                <div class="search-terms-box" style="background: rgba(255,255,255,0.1); margin-top: 20px;">
                    <h3>Gerar Search Terms para Scraping</h3>
                    <p style="margin-bottom: 15px; opacity: 0.9;">Crie termos de busca baseados nas top hashtags do nicho para alimentar o scraper.</p>
                    <button id="btnGenerateSearchTerms" onclick="generateSearchTerms()" class="btn-search-terms">
                        Gerar Search Terms
                    </button>
                    <div id="searchTermsResult"></div>
                </div>
            </div>

            <!-- Metricas do Nicho -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Hashtags no Nicho</div>
                    <div class="metric-value" id="totalHashtags">0</div>
                    <div class="metric-sub">contendo as seeds</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Hashtags freq>=5</div>
                    <div class="metric-value" id="hashtagsFreq5">0</div>
                    <div class="metric-sub">com densidade</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Unique Leads</div>
                    <div class="metric-value" id="uniqueLeads">0</div>
                    <div class="metric-sub">no nicho</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Contact Rate</div>
                    <div class="metric-value" id="contactRate">0%</div>
                    <div class="metric-sub">media do nicho</div>
                </div>
            </div>

            <!-- Flags de Acao (so se viavel) -->
            <div id="flagsSection" class="flags-grid" style="display: none;">
                <div class="flag-card flag-yes" id="flagPersona" onclick="generatePersona()">
                    <div class="flag-icon">üë§</div>
                    <div class="flag-label">Gerar Persona</div>
                </div>
                <div class="flag-card flag-yes" id="flagDM" onclick="generateDM()">
                    <div class="flag-icon">‚úâÔ∏è</div>
                    <div class="flag-label">Gerar DM</div>
                </div>
                <div class="flag-card flag-yes" id="flagCopy" onclick="generateCopy()">
                    <div class="flag-icon">üìù</div>
                    <div class="flag-label">Gerar Copy</div>
                </div>
            </div>

            <!-- Clustering Section (so se viavel) -->
            <div id="clusteringSection" class="clustering-section" style="display: none;">
                <div class="clustering-header">
                    <h2>Clusterizacao KMeans</h2>
                    <div>
                        <span id="clusteringStatusBadge" class="clustering-status waiting">Aguardando execucao</span>
                        <button id="btnExecuteClustering" class="btn-clustering" onclick="executeClustering()">
                            Executar Clustering
                        </button>
                    </div>
                </div>

                <!-- Clustering Results (hidden until executed) -->
                <div id="clusteringResults" style="display: none;">
                    <!-- Summary -->
                    <div class="clustering-summary">
                        <h3>Resumo do Clustering</h3>
                        <div class="clustering-summary-grid">
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterK">0</div>
                                <div class="clustering-summary-label">Clusters</div>
                            </div>
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterHashtags">0</div>
                                <div class="clustering-summary-label">Hashtags</div>
                            </div>
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterLeads">0</div>
                                <div class="clustering-summary-label">Leads Associados</div>
                            </div>
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterSilhouette">0</div>
                                <div class="clustering-summary-label">Silhouette Score</div>
                            </div>
                        </div>
                    </div>

                    <!-- Cluster Cards -->
                    <div id="clustersGrid" class="clusters-grid">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Top Leads -->
                    <div class="top-leads-section">
                        <h4>Top 20 Leads por Score</h4>
                        <div id="topLeadsList" class="leads-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Hashtags -->
            <div class="hashtags-section">
                <h2>Top 20 Hashtags do Nicho</h2>
                <table class="hashtags-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Hashtag</th>
                            <th>Frequencia Total</th>
                            <th>Bio</th>
                            <th>Posts</th>
                            <th>Leads Unicos</th>
                            <th>Contact Rate</th>
                        </tr>
                    </thead>
                    <tbody id="hashtagsTableBody">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Se√ß√£o de Conte√∫do Gerado (GPT) -->
            <div id="generatedContentSection" class="generated-section" style="display: none;">
                <div class="generated-header">
                    <h2>Conteudo Gerado por IA</h2>
                    <span class="generated-badge">GPT-4o-mini</span>
                </div>
                <div id="generatedContentContainer" class="generated-container">
                    <!-- Cards de conte√∫do gerado ser√£o inseridos aqui via JS -->
                </div>
            </div>

            <!-- Bot√£o Salvar -->
            <div id="saveSection" class="hashtags-section" style="text-align: center; display: none;">
                <h2>Salvar Analise</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Salve esta analise para acompanhamento futuro e geracao de campanhas.
                </p>
                <div id="saveStatus" style="margin-bottom: 15px;"></div>
                <button class="btn btn-success" id="saveBtn" onclick="saveAnalysis()" style="max-width: 400px;">
                    Salvar no Banco de Dados
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/hashtag-intelligence';

        // Nichos pre-definidos com seeds
        const NICHOS = {
            gestao_trafego: {
                name: 'Gestao de Trafego',
                seeds: ['gestao', 'trafego', 'marketing', 'ads', 'leads']
            },
            social_media: {
                name: 'Social Media',
                seeds: ['socialmedia', 'conteudo', 'instagram', 'redes', 'digital']
            },
            estetica: {
                name: 'Estetica',
                seeds: ['estetica', 'beleza', 'skincare', 'micropigmentacao', 'sobrancelha']
            },
            advocacia: {
                name: 'Advocacia',
                seeds: ['advocacia', 'advogado', 'direito', 'juridico', 'lei']
            },
            contabilidade: {
                name: 'Contabilidade',
                seeds: ['contabilidade', 'contador', 'contabil', 'fiscal', 'tributario']
            },
            psicologia: {
                name: 'Psicologia',
                seeds: ['psicologia', 'psicologo', 'terapia', 'mental', 'emocional']
            },
            fitness: {
                name: 'Fitness',
                seeds: ['fitness', 'treino', 'academia', 'musculacao', 'personal']
            },
            nutricao: {
                name: 'Nutricao',
                seeds: ['nutricao', 'nutricionista', 'dieta', 'alimentacao', 'emagrecimento']
            }
        };

        // Resultado atual da validacao
        let currentValidation = null;

        // Converter resultado do formato antigo para o novo
        function convertLegacyResult(legacy) {
            const metricas = legacy.metricas || {};
            const hashtagsRaiz = legacy.hashtags_raiz || [];

            // Mapear para o novo formato
            return {
                seeds: [], // N√£o temos no formato antigo
                criteria: {
                    minHashtagsWithFreq5: 20,
                    minUniqueLeads: 100,
                    minHashtagsWithLeads3: 5,
                    minContactRate: 20
                },
                totalHashtagsInNiche: metricas.total_hashtags_nicho || 0,
                hashtagsWithFreq5: metricas.hashtags_freq_50_plus || 0,
                hashtagsWithLeads3: hashtagsRaiz.length,
                totalUniqueLeads: metricas.perfis_unicos || 0,
                totalLeadsWithContact: Math.round((metricas.perfis_unicos || 0) * (metricas.taxa_contato_media || 0) / 100),
                averageContactRate: metricas.taxa_contato_media || 0,
                isViable: legacy.pode_gerar_dm || false,
                passedCriteria: {
                    hashtagsWithFreq5: (metricas.hashtags_freq_50_plus || 0) >= 20,
                    uniqueLeads: (metricas.perfis_unicos || 0) >= 100,
                    hashtagsWithLeads3: hashtagsRaiz.length >= 5,
                    contactRate: (metricas.taxa_contato_media || 0) >= 20
                },
                recommendations: legacy.recomendacao ? [legacy.recomendacao] : [],
                topHashtags: hashtagsRaiz.map(h => ({
                    hashtag: h.hashtag,
                    freq_total: h.freq,
                    freq_bio: 0,
                    freq_posts: h.freq,
                    unique_leads: h.unique_leads || 0,
                    leads_with_contact: Math.round((h.unique_leads || 0) * (h.contact_rate || 0) / 100),
                    contact_rate: h.contact_rate || 0
                })),
                // Dados adicionais do formato antigo
                legacyData: legacy
            };
        }

        // Renderizar sugestoes
        function renderSuggestions() {
            const pills = document.getElementById('suggestionPills');
            pills.innerHTML = Object.keys(NICHOS).map(key => {
                const nicho = NICHOS[key];
                return `
                    <div class="suggestion-pill" onclick="loadSuggestion('${key}')">
                        ${nicho.name}
                    </div>
                `;
            }).join('');
        }

        function loadSuggestion(nichoKey) {
            const nicho = NICHOS[nichoKey];
            document.getElementById('nichoInput').value = nicho.name;
            document.getElementById('seedsInput').value = nicho.seeds.join(', ');
        }

        async function validateNiche() {
            const nichoInput = document.getElementById('nichoInput').value.trim();
            const seedsInput = document.getElementById('seedsInput').value.trim();

            if (!nichoInput) {
                alert('Por favor, digite o nicho alvo');
                return;
            }

            if (!seedsInput) {
                alert('Por favor, digite as seeds do nicho');
                return;
            }

            // Processar seeds
            const seeds = seedsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);

            if (seeds.length === 0) {
                alert('Por favor, digite pelo menos uma seed valida');
                return;
            }

            // Obter criterios customizados
            const criteria = {
                minHashtagsWithFreq5: parseInt(document.getElementById('criteriaHashtags').value) || 20,
                minUniqueLeads: parseInt(document.getElementById('criteriaLeads').value) || 100,
                minHashtagsWithLeads3: parseInt(document.getElementById('criteriaHashtagsLeads').value) || 5,
                minContactRate: parseInt(document.getElementById('criteriaContactRate').value) || 20
            };

            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').classList.remove('show');

            try {
                const response = await fetch(`${API_BASE}/validate-niche`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ seeds, criteria })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    currentValidation = result.data;
                    renderResults(result.data);
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao validar nicho:', error);
                alert(`Erro: ${error.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderResults(data) {
            // Status de viabilidade
            const viabilityStatus = document.getElementById('viabilityStatus');
            if (data.isViable) {
                viabilityStatus.className = 'viability-status viability-viable';
                viabilityStatus.innerHTML = '‚úÖ NICHO VIAVEL';
            } else {
                viabilityStatus.className = 'viability-status viability-not-viable';
                viabilityStatus.innerHTML = '‚ö†Ô∏è PRECISA MAIS DADOS';
            }

            // Criterios Grid
            const criteriaGrid = document.getElementById('criteriaGrid');
            criteriaGrid.innerHTML = `
                <div class="criteria-item ${data.passedCriteria.hashtagsWithFreq5 ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.hashtagsWithFreq5 ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Hashtags freq>=5</div>
                    <div class="criteria-value">${data.hashtagsWithFreq5}</div>
                    <div class="criteria-target">min: ${data.criteria.minHashtagsWithFreq5}</div>
                </div>
                <div class="criteria-item ${data.passedCriteria.uniqueLeads ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.uniqueLeads ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Leads Unicos</div>
                    <div class="criteria-value">${data.totalUniqueLeads.toLocaleString('pt-BR')}</div>
                    <div class="criteria-target">min: ${data.criteria.minUniqueLeads}</div>
                </div>
                <div class="criteria-item ${data.passedCriteria.hashtagsWithLeads3 ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.hashtagsWithLeads3 ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Hashtags c/ 3+ leads</div>
                    <div class="criteria-value">${data.hashtagsWithLeads3}</div>
                    <div class="criteria-target">min: ${data.criteria.minHashtagsWithLeads3}</div>
                </div>
                <div class="criteria-item ${data.passedCriteria.contactRate ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.contactRate ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Contact Rate</div>
                    <div class="criteria-value">${data.averageContactRate}%</div>
                    <div class="criteria-target">min: ${data.criteria.minContactRate}%</div>
                </div>
            `;

            // Recomendacoes (se nao viavel)
            const recommendationsBox = document.getElementById('recommendationsBox');
            const recommendationsList = document.getElementById('recommendationsList');

            if (!data.isViable && data.recommendations.length > 0) {
                recommendationsBox.style.display = 'block';
                recommendationsList.innerHTML = data.recommendations
                    .filter(r => !r.startsWith('‚úÖ'))
                    .map(r => `<li>${r}</li>`)
                    .join('');
            } else {
                recommendationsBox.style.display = 'none';
            }

            // Scraping Recommendation (se nao viavel)
            const scrapingSection = document.getElementById('scrapingRecommendation');
            if (!data.isViable) {
                scrapingSection.style.display = 'block';

                // Calcular estimativas de scraping
                const leadsFaltantes = Math.max(0, data.criteria.minUniqueLeads - data.totalUniqueLeads);
                const hashtagsFaltantes = Math.max(0, data.criteria.minHashtagsWithFreq5 - data.hashtagsWithFreq5);

                // Estimativa: ~5 leads por perfil scrapado em media
                const perfisNecessarios = Math.ceil(leadsFaltantes / 5);

                // Hashtags a scrapar = top hashtags que ainda nao tem dados suficientes
                const hashtagsAScraper = Math.min(10, data.topHashtags.length);

                document.getElementById('leadsFaltantes').textContent = leadsFaltantes > 0 ? `+${leadsFaltantes.toLocaleString('pt-BR')}` : '0';
                document.getElementById('hashtagsAScraper').textContent = hashtagsAScraper;
                document.getElementById('perfisEstimadosScrape').textContent = perfisNecessarios > 0 ? `~${perfisNecessarios.toLocaleString('pt-BR')}` : '0';
            } else {
                scrapingSection.style.display = 'none';
            }

            // Metricas
            document.getElementById('totalHashtags').textContent = data.totalHashtagsInNiche.toLocaleString('pt-BR');
            document.getElementById('hashtagsFreq5').textContent = data.hashtagsWithFreq5.toLocaleString('pt-BR');
            document.getElementById('uniqueLeads').textContent = data.totalUniqueLeads.toLocaleString('pt-BR');
            document.getElementById('contactRate').textContent = `${data.averageContactRate}%`;

            // Flags (so se viavel)
            document.getElementById('flagsSection').style.display = data.isViable ? 'grid' : 'none';

            // Top Hashtags Table
            const tbody = document.getElementById('hashtagsTableBody');
            tbody.innerHTML = data.topHashtags.map((h, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="hashtag-name">#${h.hashtag}</td>
                    <td><strong>${h.freq_total}</strong></td>
                    <td>${h.freq_bio}</td>
                    <td>${h.freq_posts}</td>
                    <td>${h.unique_leads}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="contact-rate-bar">
                                <div class="contact-rate-fill" style="width: ${Math.min(h.contact_rate, 100)}%"></div>
                            </div>
                            <span>${h.contact_rate}%</span>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Mostrar resultados
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        async function generateSearchTerms() {
            if (!currentValidation) {
                alert('Execute a validacao primeiro');
                return;
            }

            const nichoInput = document.getElementById('nichoInput').value.trim();
            const btn = document.getElementById('btnGenerateSearchTerms');
            const resultDiv = document.getElementById('searchTermsResult');

            btn.disabled = true;
            btn.textContent = 'Gerando...';

            try {
                // Extrair hashtags das top do nicho
                const hashtagsRaiz = currentValidation.topHashtags.slice(0, 15).map(h => ({
                    hashtag: h.hashtag,
                    freq: h.freq_total,
                    unique_leads: h.unique_leads,
                    contact_rate: h.contact_rate
                }));

                const payload = {
                    campaign_name: nichoInput,
                    nicho_principal: nichoInput,
                    project_name: 'Scraping Campaign',
                    hashtags_raiz: hashtagsRaiz,
                    cluster_status: currentValidation.isViable ? 'viavel' : 'precisa_dados'
                };

                const response = await fetch(`${API_BASE}/generate-search-terms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="search-terms-success">
                            ‚úÖ ${result.message}<br>
                            <small>ID: ${result.data.id} | Termos: ${result.data.terms_count}</small>
                        </div>
                    `;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao gerar search terms:', error);
                resultDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 8px; padding: 12px; margin-top: 15px;">
                        ‚ùå Erro: ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Gerar Search Terms';
            }
        }

        // ==========================================
        // GERA√á√ÉO DE CONTE√öDO COM GPT-4
        // ==========================================

        let currentPersona = null;
        let currentDMScripts = null;
        let currentCopies = null;

        // Fun√ß√£o para coletar dados do formul√°rio
        function collectFormData() {
            return {
                nicho: document.getElementById('nichoInput').value.trim(),
                service_description: document.getElementById('serviceDescription').value.trim(),
                target_audience: document.getElementById('targetAudience').value.trim(),
                target_details: {
                    age_range: document.getElementById('targetAgeRange')?.value || '',
                    gender: document.getElementById('targetGender')?.value || '',
                    location: document.getElementById('targetLocation')?.value || '',
                    income_class: document.getElementById('targetIncomeClass')?.value || ''
                }
            };
        }

        // GERAR PERSONA
        async function generatePersona() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para gerar persona');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description || !formData.target_audience) {
                alert('Preencha a Descricao do Servico e Publico Alvo antes de gerar a persona');
                return;
            }

            const flagCard = document.getElementById('flagPersona');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    clusters: currentClusteringResult?.clusters || [],
                    top_hashtags: currentValidation.topHashtags,
                    total_leads: currentValidation.totalUniqueLeads,
                    contact_rate: currentValidation.averageContactRate
                };

                const response = await fetch(`${API_BASE}/generate-persona`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentPersona = result.data.persona;
                    showGeneratedContent('persona', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Persona Gerada</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar persona');
                }
            } catch (error) {
                console.error('Erro ao gerar persona:', error);
                alert('Erro ao gerar persona: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // GERAR DM
        async function generateDM() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para gerar DM');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description) {
                alert('Preencha a Descricao do Servico antes de gerar scripts de DM');
                return;
            }

            const flagCard = document.getElementById('flagDM');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    persona: currentPersona,
                    clusters: currentClusteringResult?.clusters || [],
                    tone: 'profissional-amigavel'
                };

                const response = await fetch(`${API_BASE}/generate-dm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentDMScripts = result.data.dm_scripts;
                    showGeneratedContent('dm', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">DM Gerado</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar DM');
                }
            } catch (error) {
                console.error('Erro ao gerar DM:', error);
                alert('Erro ao gerar DM: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // GERAR COPY
        async function generateCopy() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para gerar Copy');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description) {
                alert('Preencha a Descricao do Servico antes de gerar copies');
                return;
            }

            const flagCard = document.getElementById('flagCopy');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    persona: currentPersona,
                    clusters: currentClusteringResult?.clusters || [],
                    copy_type: 'all'
                };

                const response = await fetch(`${API_BASE}/generate-copy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentCopies = result.data.copies;
                    showGeneratedContent('copy', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Copy Gerado</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar Copy');
                }
            } catch (error) {
                console.error('Erro ao gerar Copy:', error);
                alert('Erro ao gerar Copy: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // Exibir conte√∫do gerado
        function showGeneratedContent(type, data) {
            const section = document.getElementById('generatedContentSection');
            section.style.display = 'block';

            const container = document.getElementById('generatedContentContainer');

            // Criar card para o conte√∫do
            const cardId = `generated-${type}`;
            let card = document.getElementById(cardId);

            if (!card) {
                card = document.createElement('div');
                card.id = cardId;
                card.className = 'generated-content-card';
                container.appendChild(card);
            }

            const titles = {
                persona: 'üé≠ Persona ICP',
                dm: '‚úâÔ∏è Scripts de DM',
                copy: 'üìù Pack de Copies'
            };

            const contents = {
                persona: data.persona,
                dm: data.dm_scripts,
                copy: data.copies
            };

            // Converter markdown simples para HTML
            const htmlContent = convertMarkdownToHTML(contents[type]);

            card.innerHTML = `
                <div class="generated-content-header">
                    <h3>${titles[type]}</h3>
                    <div class="generated-meta">
                        <span>Modelo: ${data.model}</span>
                        <span>Tokens: ${data.tokens_used}</span>
                        <button class="btn-copy-content" onclick="copyToClipboard('${cardId}-content')">üìã Copiar</button>
                    </div>
                </div>
                <div id="${cardId}-content" class="generated-content-body">
                    ${htmlContent}
                </div>
            `;

            // Scroll para a se√ß√£o
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Converter markdown b√°sico para HTML
        function convertMarkdownToHTML(markdown) {
            if (!markdown) return '';

            return markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre class="code-block">$1</pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Lists
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        // Copiar conte√∫do para clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText;

            navigator.clipboard.writeText(text).then(() => {
                alert('Conteudo copiado para a area de transferencia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Conteudo copiado!');
            });
        }

        // Reset flags quando nova valida√ß√£o √© feita
        function resetGenerationFlags() {
            currentPersona = null;
            currentDMScripts = null;
            currentCopies = null;

            const flags = ['flagPersona', 'flagDM', 'flagCopy'];
            const icons = ['üë§', '‚úâÔ∏è', 'üìù'];
            const labels = ['Gerar Persona', 'Gerar DM', 'Gerar Copy'];

            flags.forEach((id, i) => {
                const flag = document.getElementById(id);
                if (flag) {
                    flag.innerHTML = `<div class="flag-icon">${icons[i]}</div><div class="flag-label">${labels[i]}</div>`;
                    flag.classList.remove('flag-completed');
                }
            });

            // Esconder se√ß√£o de conte√∫do gerado
            const section = document.getElementById('generatedContentSection');
            if (section) {
                section.style.display = 'none';
                document.getElementById('generatedContentContainer').innerHTML = '';
            }
        }

        // ==========================================
        // SISTEMA DE DROPDOWNS EM CASCATA
        // ==========================================

        // Cache de dados carregados
        let clientsData = [];
        let projectsData = [];
        let campaignsData = [];
        let currentCampaignId = null;

        // Carregar lista de clientes ao inicializar
        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/clients`);
                const result = await response.json();

                if (result.success) {
                    clientsData = result.data || [];
                    const clientSelect = document.getElementById('clientSelect');
                    clientSelect.innerHTML = `
                        <option value="">-- Selecione ou crie novo --</option>
                        <option value="__NEW__">+ Novo Cliente</option>
                        ${clientsData.map(client => `<option value="${client}">${client}</option>`).join('')}
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Quando cliente √© selecionado
        async function onClientChange() {
            const clientSelect = document.getElementById('clientSelect');
            const clientNameInput = document.getElementById('clientNameInput');
            const projectSelect = document.getElementById('projectSelect');
            const projectNameInput = document.getElementById('projectNameInput');
            const campaignSelect = document.getElementById('campaignSelect');
            const campaignNameInput = document.getElementById('campaignNameInput');

            const selectedClient = clientSelect.value;

            // Reset projetos e campanhas
            projectSelect.innerHTML = '<option value="">-- Selecione projeto --</option>';
            projectSelect.disabled = true;
            projectNameInput.style.display = 'none';
            projectNameInput.value = '';

            campaignSelect.innerHTML = '<option value="">-- Selecione projeto primeiro --</option>';
            campaignSelect.disabled = true;
            campaignNameInput.style.display = 'none';
            campaignNameInput.value = '';

            hideEditMode();

            if (selectedClient === '__NEW__') {
                clientNameInput.style.display = 'block';
                clientNameInput.focus();
                projectSelect.disabled = false;
                projectSelect.innerHTML = `
                    <option value="">-- Selecione ou crie novo --</option>
                    <option value="__NEW__">+ Novo Projeto</option>
                `;
            } else if (selectedClient) {
                clientNameInput.style.display = 'none';
                clientNameInput.value = '';
                await loadProjects(selectedClient);
            } else {
                clientNameInput.style.display = 'none';
                clientNameInput.value = '';
            }
        }

        // Carregar projetos de um cliente
        async function loadProjects(clientName) {
            const projectSelect = document.getElementById('projectSelect');
            projectSelect.disabled = true;
            projectSelect.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`${API_BASE}/projects?client_name=${encodeURIComponent(clientName)}`);
                const result = await response.json();

                if (result.success) {
                    projectsData = result.data || [];
                    projectSelect.innerHTML = `
                        <option value="">-- Selecione ou crie novo --</option>
                        <option value="__NEW__">+ Novo Projeto</option>
                        ${projectsData.map(p => `<option value="${p.id}">${p.project_name}</option>`).join('')}
                    `;
                    projectSelect.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                projectSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Quando projeto √© selecionado
        async function onProjectChange() {
            const projectSelect = document.getElementById('projectSelect');
            const projectNameInput = document.getElementById('projectNameInput');
            const campaignSelect = document.getElementById('campaignSelect');
            const campaignNameInput = document.getElementById('campaignNameInput');

            const selectedProject = projectSelect.value;

            campaignSelect.innerHTML = '<option value="">-- Selecione campanha --</option>';
            campaignSelect.disabled = true;
            campaignNameInput.style.display = 'none';
            campaignNameInput.value = '';

            hideEditMode();

            if (selectedProject === '__NEW__') {
                projectNameInput.style.display = 'block';
                projectNameInput.focus();
                campaignSelect.disabled = false;
                campaignSelect.innerHTML = `
                    <option value="">-- Selecione ou crie nova --</option>
                    <option value="__NEW__">+ Nova Campanha</option>
                `;
            } else if (selectedProject) {
                projectNameInput.style.display = 'none';
                projectNameInput.value = '';
                await loadCampaigns(selectedProject);
            } else {
                projectNameInput.style.display = 'none';
                projectNameInput.value = '';
            }
        }

        // Carregar campanhas de um projeto
        async function loadCampaigns(projectId) {
            const campaignSelect = document.getElementById('campaignSelect');
            campaignSelect.disabled = true;
            campaignSelect.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`${API_BASE}/campaigns/${projectId}`);
                const result = await response.json();

                if (result.success) {
                    campaignsData = result.data || [];
                    console.log('[DEBUG] loadCampaigns - campaigns received:', campaignsData.map(c => ({ id: c.id, name: c.campaign_name })));
                    campaignSelect.innerHTML = `
                        <option value="">-- Selecione ou crie nova --</option>
                        <option value="__NEW__">+ Nova Campanha</option>
                        ${campaignsData.map(c => `<option value="${c.id}">${c.campaign_name} ${c.cluster_status ? `(${c.cluster_status})` : ''}</option>`).join('')}
                    `;
                    campaignSelect.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
                campaignSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Quando campanha √© selecionada
        async function onCampaignChange() {
            const campaignSelect = document.getElementById('campaignSelect');
            const campaignNameInput = document.getElementById('campaignNameInput');

            const selectedCampaign = campaignSelect.value;
            console.log('[DEBUG] onCampaignChange - selectedCampaign:', selectedCampaign);

            if (selectedCampaign === '__NEW__') {
                campaignNameInput.style.display = 'block';
                campaignNameInput.focus();
                hideEditMode();
                clearFormFields();
            } else if (selectedCampaign) {
                campaignNameInput.style.display = 'none';
                campaignNameInput.value = '';
                await loadCampaignData(selectedCampaign);
            } else {
                campaignNameInput.style.display = 'none';
                campaignNameInput.value = '';
                hideEditMode();
            }
        }

        // Carregar dados completos de uma campanha
        async function loadCampaignData(campaignId) {
            console.log('[DEBUG] loadCampaignData called with:', campaignId);

            // Validar que √© um UUID v√°lido antes de fazer a requisi√ß√£o
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(campaignId)) {
                console.error('[DEBUG] Invalid campaign ID format:', campaignId);
                alert('ID de campanha inv√°lido. Por favor, selecione novamente.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/campaign/${campaignId}`);
                const result = await response.json();

                // Check for API error
                if (!result.success) {
                    console.error('[DEBUG] API returned error:', result);
                    alert(`Erro ao carregar campanha: ${result.message || 'Erro desconhecido'}`);
                    return;
                }

                if (result.success && result.data) {
                    const { campaign } = result.data;

                    currentCampaignId = campaign.id;

                    // Preencher campos principais
                    document.getElementById('nichoInput').value = campaign.nicho_principal || '';
                    document.getElementById('seedsInput').value = Array.isArray(campaign.keywords) ? campaign.keywords.join(', ') : '';

                    // Preencher descricao e publico alvo
                    document.getElementById('serviceDescription').value = campaign.service_description || '';
                    document.getElementById('targetAudience').value = campaign.target_audience || '';

                    // Preencher detalhes do publico (se existirem)
                    document.getElementById('targetAgeRange').value = campaign.target_age_range || '';
                    document.getElementById('targetGender').value = campaign.target_gender || '';
                    document.getElementById('targetLocation').value = campaign.target_location || '';
                    document.getElementById('targetIncomeClass').value = campaign.target_income_class || '';

                    showEditMode(campaign.campaign_name);

                    // Se j√° tem resultado de an√°lise, mostrar
                    if (campaign.analysis_result) {
                        // Verificar se √© formato antigo ou novo
                        const result = campaign.analysis_result;
                        if (result.isViable !== undefined) {
                            // Formato novo - usar diretamente
                            currentValidation = result;
                            renderResults(result);
                        } else if (result.metricas) {
                            // Formato antigo - converter para novo formato
                            const converted = convertLegacyResult(result);
                            currentValidation = converted;
                            renderResults(converted);
                        }
                    }

                    // Se j√° tem resultado de clustering (subnichos), mostrar
                    if (campaign.clustering_result && campaign.clustering_result.clusters) {
                        currentClusteringResult = campaign.clustering_result;
                        renderClusteringResults(campaign.clustering_result);

                        // Atualizar status do clustering
                        const statusBadge = document.getElementById('clusteringStatus');
                        const btn = document.getElementById('btnExecuteClustering');
                        if (statusBadge) {
                            statusBadge.className = 'clustering-status done';
                            statusBadge.innerHTML = 'Clustering concluido';
                        }
                        if (btn) {
                            btn.innerHTML = 'Re-executar Clustering';
                        }

                        console.log(`[DEBUG] Clustering carregado: ${campaign.clustering_result.clusters.length} subnichos`);
                    }

                    // Se j√° tem conte√∫do gerado, atualizar flags
                    if (campaign.generated_persona) {
                        currentPersona = campaign.generated_persona;
                        const flagCard = document.getElementById('flagPersona');
                        if (flagCard) {
                            flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Persona Gerada</div>';
                            flagCard.classList.add('flag-completed');
                        }
                    }
                    if (campaign.generated_dm_scripts) {
                        currentDMScripts = campaign.generated_dm_scripts;
                        const flagCard = document.getElementById('flagDM');
                        if (flagCard) {
                            flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">DM Gerado</div>';
                            flagCard.classList.add('flag-completed');
                        }
                    }
                    if (campaign.generated_copies) {
                        currentCopies = campaign.generated_copies;
                        const flagCard = document.getElementById('flagCopy');
                        if (flagCard) {
                            flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Copy Gerado</div>';
                            flagCard.classList.add('flag-completed');
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar campanha:', error);
                // Check if it was a server error with more details
                if (error.message) {
                    alert(`Erro ao carregar dados da campanha: ${error.message}`);
                } else {
                    alert('Erro ao carregar dados da campanha. Verifique o console para mais detalhes.');
                }
            }
        }

        function showEditMode(campaignName) {
            const indicator = document.getElementById('editModeIndicator');
            const nameSpan = document.getElementById('editingCampaignName');
            nameSpan.textContent = campaignName;
            indicator.style.display = 'block';
        }

        function hideEditMode() {
            document.getElementById('editModeIndicator').style.display = 'none';
            currentCampaignId = null;
        }

        function clearSelection() {
            document.getElementById('clientSelect').value = '';
            document.getElementById('projectSelect').innerHTML = '<option value="">-- Selecione cliente primeiro --</option>';
            document.getElementById('projectSelect').disabled = true;
            document.getElementById('campaignSelect').innerHTML = '<option value="">-- Selecione projeto primeiro --</option>';
            document.getElementById('campaignSelect').disabled = true;

            document.getElementById('clientNameInput').style.display = 'none';
            document.getElementById('clientNameInput').value = '';
            document.getElementById('projectNameInput').style.display = 'none';
            document.getElementById('projectNameInput').value = '';
            document.getElementById('campaignNameInput').style.display = 'none';
            document.getElementById('campaignNameInput').value = '';

            hideEditMode();
            clearFormFields();
            document.getElementById('results').classList.remove('show');
        }

        function clearFormFields() {
            document.getElementById('nichoInput').value = '';
            document.getElementById('seedsInput').value = '';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('targetAudience').value = '';
            document.getElementById('targetAgeRange').value = '';
            document.getElementById('targetGender').value = '';
            document.getElementById('targetLocation').value = '';
            document.getElementById('targetIncomeClass').value = '';
            currentValidation = null;
            document.getElementById('results').classList.remove('show');
        }

        // Obter nome do cliente (do select ou input)
        function getClientName() {
            const select = document.getElementById('clientSelect');
            const input = document.getElementById('clientNameInput');
            if (select.value === '__NEW__') {
                return input.value.trim();
            }
            return select.value;
        }

        // Obter nome do projeto (do select ou input)
        function getProjectName() {
            const select = document.getElementById('projectSelect');
            const input = document.getElementById('projectNameInput');
            if (select.value === '__NEW__') {
                return input.value.trim();
            }
            const project = projectsData.find(p => p.id == select.value);
            return project ? project.project_name : '';
        }

        // Obter nome da campanha (do select ou input)
        function getCampaignName() {
            const select = document.getElementById('campaignSelect');
            const input = document.getElementById('campaignNameInput');
            if (select.value === '__NEW__') {
                return input.value.trim();
            }
            const campaign = campaignsData.find(c => c.id == select.value);
            return campaign ? campaign.campaign_name : '';
        }

        // Salvar an√°lise
        async function saveAnalysis() {
            const clientName = getClientName();
            const projectName = getProjectName();
            const campaignName = getCampaignName();

            if (!clientName || !projectName || !campaignName) {
                alert('Selecione ou preencha Cliente, Projeto e Campanha para salvar.');
                return;
            }

            const serviceDescription = document.getElementById('serviceDescription').value.trim();
            const targetAudience = document.getElementById('targetAudience').value.trim();

            if (!serviceDescription || !targetAudience) {
                alert('Preencha a Descricao do Servico e Publico Alvo para salvar.');
                return;
            }

            if (!currentValidation) {
                alert('Nenhuma analise para salvar. Execute a validacao primeiro.');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');

            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            try {
                const payload = {
                    client_name: clientName,
                    project_name: projectName,
                    campaign_name: campaignName,
                    nicho: document.getElementById('nichoInput').value.trim(),
                    keywords: document.getElementById('seedsInput').value.split(',').map(k => k.trim()).filter(k => k),
                    service_description: serviceDescription,
                    target_audience: targetAudience,
                    target_age_range: document.getElementById('targetAgeRange').value.trim() || null,
                    target_gender: document.getElementById('targetGender').value || null,
                    target_location: document.getElementById('targetLocation').value.trim() || null,
                    target_income_class: document.getElementById('targetIncomeClass').value || null,
                    analysis_result: currentValidation
                };

                const response = await fetch(`${API_BASE}/save-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    saveStatus.innerHTML = `
                        <div style="background: #d1fae5; border: 1px solid #10b981; padding: 15px; border-radius: 8px; color: #065f46;">
                            ‚úÖ <strong>${result.message}</strong><br>
                            <small>Projeto ID: ${result.data.project_id}</small><br>
                            <small>Campanha ID: ${result.data.campaign_id}</small>
                        </div>
                    `;
                    saveBtn.textContent = '‚úÖ Salvo!';
                    saveBtn.style.background = '#10b981';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                saveStatus.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #ef4444; padding: 15px; border-radius: 8px; color: #991b1b;">
                        ‚ùå Erro ao salvar: ${error.message}
                    </div>
                `;
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar no Banco de Dados';
            }
        }

        // Atualizar renderResults para mostrar se√ß√£o salvar
        const originalRenderResults = renderResults;
        renderResults = function(data) {
            originalRenderResults(data);

            // Mostrar bot√£o salvar
            const clientName = getClientName();
            const projectName = getProjectName();
            const campaignName = getCampaignName();

            const saveSection = document.getElementById('saveSection');
            const saveStatus = document.getElementById('saveStatus');

            if (clientName && projectName && campaignName) {
                saveSection.style.display = 'block';
                saveStatus.innerHTML = currentCampaignId
                    ? `<div style="background: #e0f2fe; border: 1px solid #0284c7; padding: 15px; border-radius: 8px; color: #0369a1;">
                        Atualizando campanha existente: <strong>${campaignName}</strong>
                    </div>`
                    : '';
            } else {
                saveSection.style.display = 'block';
                saveStatus.innerHTML = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 15px; border-radius: 8px; color: #92400e;">
                        Selecione ou crie <strong>Cliente</strong>, <strong>Projeto</strong> e <strong>Campanha</strong> para salvar a analise.
                    </div>
                `;
            }
        };

        // ==========================================
        // CLUSTERING EXECUTION
        // ==========================================

        let currentClusteringResult = null;

        async function executeClustering() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para executar clustering');
                return;
            }

            const seedsInput = document.getElementById('seedsInput').value.trim();
            const nichoInput = document.getElementById('nichoInput').value.trim();

            if (!seedsInput || !nichoInput) {
                alert('Preencha nicho e seeds antes de executar clustering');
                return;
            }

            const seeds = seedsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);

            const btn = document.getElementById('btnExecuteClustering');
            const statusBadge = document.getElementById('clusteringStatusBadge');

            btn.disabled = true;
            btn.innerHTML = 'Processando...';
            statusBadge.className = 'clustering-status processing';
            statusBadge.innerHTML = 'Executando KMeans...';

            try {
                const payload = {
                    seeds: seeds,
                    nicho: nichoInput,
                    campaign_id: currentCampaignId || undefined
                };

                const response = await fetch(`${API_BASE}/execute-clustering`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success && result.data) {
                    currentClusteringResult = result.data;
                    renderClusteringResults(result.data);

                    statusBadge.className = 'clustering-status done';
                    statusBadge.innerHTML = 'Clustering concluido';
                    btn.innerHTML = 'Re-executar Clustering';
                } else {
                    throw new Error(result.message || result.data?.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao executar clustering:', error);
                alert(`Erro: ${error.message}`);

                statusBadge.className = 'clustering-status waiting';
                statusBadge.innerHTML = 'Erro - tente novamente';
            } finally {
                btn.disabled = false;
            }
        }

        function renderClusteringResults(data) {
            // Show results section
            document.getElementById('clusteringResults').style.display = 'block';

            // Summary
            document.getElementById('clusterK').textContent = data.k;
            document.getElementById('clusterHashtags').textContent = data.total_hashtags.toLocaleString('pt-BR');
            document.getElementById('clusterLeads').textContent = data.lead_associations.length.toLocaleString('pt-BR');
            document.getElementById('clusterSilhouette').textContent = data.silhouette_avg.toFixed(3);

            // Cluster Cards
            const clustersGrid = document.getElementById('clustersGrid');
            clustersGrid.innerHTML = data.clusters.map(cluster => `
                <div class="cluster-card">
                    <div class="cluster-card-header">
                        <span class="cluster-name">${cluster.cluster_name}</span>
                        <span class="cluster-id-badge">Cluster ${cluster.cluster_id + 1}</span>
                    </div>
                    <div class="cluster-stats">
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${cluster.hashtag_count}</div>
                            <div class="cluster-stat-label">Hashtags</div>
                        </div>
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${cluster.total_leads}</div>
                            <div class="cluster-stat-label">Leads</div>
                        </div>
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${cluster.avg_contact_rate}%</div>
                            <div class="cluster-stat-label">Contact</div>
                        </div>
                    </div>
                    <div class="cluster-hashtags">
                        <div class="cluster-hashtags-label">Top Hashtags:</div>
                        <div class="cluster-hashtag-pills">
                            ${cluster.top_hashtags.slice(0, 6).map(h => `
                                <span class="cluster-hashtag-pill">#${h.hashtag}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');

            // Top Leads
            const topLeadsList = document.getElementById('topLeadsList');
            const topLeads = data.lead_associations.slice(0, 20);
            topLeadsList.innerHTML = topLeads.map((lead, idx) => {
                const clusterName = data.clusters.find(c => c.cluster_id === lead.primary_cluster)?.cluster_name || `Cluster ${lead.primary_cluster + 1}`;
                return `
                    <div class="lead-item ${lead.has_contact ? 'has-contact' : ''}">
                        <div class="lead-info">
                            <span>#${idx + 1}</span>
                            <span class="lead-cluster-badge">${clusterName}</span>
                            ${lead.has_contact ? '<span class="lead-contact-badge">Com Contato</span>' : ''}
                        </div>
                        <span class="lead-score">Score: ${lead.score.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }

        // Update renderResults to show clustering section when viable
        const baseRenderResults = renderResults;
        renderResults = function(data) {
            baseRenderResults(data);

            // Show/hide clustering section based on viability
            const clusteringSection = document.getElementById('clusteringSection');
            if (data.isViable) {
                clusteringSection.style.display = 'block';
                // Reset clustering state
                document.getElementById('clusteringResults').style.display = 'none';
                document.getElementById('clusteringStatusBadge').className = 'clustering-status waiting';
                document.getElementById('clusteringStatusBadge').innerHTML = 'Aguardando execucao';
                document.getElementById('btnExecuteClustering').innerHTML = 'Executar Clustering';
                document.getElementById('btnExecuteClustering').disabled = false;
                currentClusteringResult = null;
            } else {
                clusteringSection.style.display = 'none';
            }
        };

        // Inicializar
        renderSuggestions();
        loadClients();
    </script>
</body>
</html>
