<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Intention Dashboard - AIC v3</title>
    <!-- Umami Analytics -->
    <script defer src="https://analytics.ubs.app.br/script.js" data-website-id="e139b226-0b32-4a40-a53b-cbc5e708ff83"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        rel="preload"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        as="style"
    >
    <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        media="print"
        onload="this.media='all'"
    >
    <style>
        :root {
            --aic-green: #0ECC97;
            --aic-green-dark: #0BA578;
            --aic-navy: #0C1B33;
            --aic-navy-light: #122444;
            --aic-white: #FDFDFD;
            --aic-gray: #94a3b8;
            --aic-border: #1e3a5f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--aic-navy);
            color: var(--aic-white);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        .header h1 {
            color: var(--aic-green);
            font-size: 2.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: var(--aic-gray);
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .version-badge {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: 600;
        }

        .input-section {
            background: var(--aic-navy);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: var(--aic-white);
            margin-bottom: 8px;
            font-size: 1em;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--aic-border);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.2s;
            background: var(--aic-navy-light);
            color: var(--aic-white);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--aic-green);
            box-shadow: 0 0 0 3px rgba(14, 204, 151, 0.15);
        }

        .keywords-input {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .input-hint {
            font-size: 0.85em;
            color: var(--aic-gray);
            margin-top: 5px;
        }

        .suggestions {
            margin-top: 15px;
        }

        .suggestions-label {
            font-size: 0.9em;
            color: var(--aic-gray);
            margin-bottom: 8px;
        }

        .suggestion-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-pill {
            background: var(--aic-navy-light);
            border: 2px solid var(--aic-green);
            color: var(--aic-green);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-pill:hover {
            background: var(--aic-green);
            color: var(--aic-navy);
        }

        .btn {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            width: 100%;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(14, 204, 151, 0.3);
        }

        .btn:disabled {
            background: var(--aic-border);
            color: var(--aic-gray);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--aic-navy);
            border: 1px solid var(--aic-border);
            color: var(--aic-white);
        }

        .btn-secondary:hover {
            border-color: var(--aic-green);
            color: var(--aic-green);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
        }

        .btn-success:hover {
            box-shadow: 0 4px 15px rgba(14, 204, 151, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--aic-white);
            font-size: 1.2em;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        /* VIABILITY CARD - Nova se√ß√£o principal */
        .viability-card {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        .viability-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .viability-header h2 {
            color: var(--aic-white);
        }

        .viability-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .viability-viable {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
        }

        .viability-not-viable {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: var(--aic-navy);
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .criteria-item {
            background: var(--aic-navy);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid var(--aic-border);
            transition: all 0.2s;
        }

        .criteria-item.passed {
            border-color: var(--aic-green);
            background: rgba(14, 204, 151, 0.1);
        }

        .criteria-item.failed {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .criteria-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .criteria-label {
            font-size: 0.85em;
            color: var(--aic-gray);
            margin-bottom: 5px;
        }

        .criteria-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--aic-white);
        }

        .criteria-target {
            font-size: 0.8em;
            color: var(--aic-gray);
            margin-top: 5px;
        }

        /* SCRAPING RECOMMENDATION */
        .scraping-recommendation {
            background: linear-gradient(135deg, var(--aic-border) 0%, #2d5a87 100%);
            border-radius: 16px;
            padding: 30px;
            margin: 25px 0;
            color: var(--aic-white);
        }

        .scraping-recommendation h3 {
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .scraping-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .scraping-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .scraping-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .scraping-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--aic-green);
        }

        .scraping-detail {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            text-align: center;
        }

        .metric-label {
            color: var(--aic-gray);
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            color: var(--aic-green);
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-sub {
            color: var(--aic-gray);
            font-size: 0.85em;
        }

        /* HASHTAGS SECTION */
        .hashtags-section {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        .hashtags-section h2 {
            color: var(--aic-green);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hashtags-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 720px;
        }

        .hashtags-table th,
        .hashtags-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--aic-border);
            color: var(--aic-white);
        }

        .hashtags-table th {
            background: var(--aic-navy);
            font-weight: 600;
            color: var(--aic-gray);
            font-size: 0.85em;
            text-transform: uppercase;
        }

        .hashtags-table tr:hover {
            background: rgba(14, 204, 151, 0.05);
        }

        .hashtag-name {
            font-weight: 600;
            color: var(--aic-green);
        }

        .contact-rate-bar {
            background: var(--aic-border);
            border-radius: 10px;
            height: 8px;
            width: 100px;
            overflow: hidden;
        }

        .contact-rate-fill {
            background: linear-gradient(90deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            height: 100%;
            border-radius: 10px;
        }

        /* FLAGS GRID */
        .flags-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .flag-card {
            background: var(--aic-navy-light);
            border: 2px solid var(--aic-border);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .flag-card:hover {
            transform: translateY(-3px);
            border-color: var(--aic-green);
        }

        .flag-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .flag-label {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--aic-white);
        }

        .flag-sublabel {
            color: var(--aic-gray);
        }

        .flag-yes {
            border: 2px solid var(--aic-green);
            background: rgba(14, 204, 151, 0.1);
        }

        .flag-no {
            border: 2px solid var(--aic-border);
            opacity: 0.5;
        }

        /* SEARCH TERMS */
        .search-terms-box {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
        }

        .search-terms-box h3 {
            margin-bottom: 15px;
        }

        .btn-search-terms {
            background: rgba(12, 27, 51, 0.2);
            color: var(--aic-navy);
            border: 2px solid rgba(12, 27, 51, 0.5);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-search-terms:hover {
            background: rgba(12, 27, 51, 0.3);
            border-color: var(--aic-navy);
        }

        .search-terms-success {
            background: rgba(12, 27, 51, 0.2);
            border: 1px solid rgba(12, 27, 51, 0.5);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
        }

        /* RECOMMENDATIONS */
        .recommendations-list {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .recommendations-list h4 {
            color: #fbbf24;
            margin-bottom: 15px;
        }

        .recommendations-list ul {
            margin: 0;
            padding-left: 20px;
        }

        .recommendations-list li {
            color: var(--aic-white);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .criteria-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .scraping-grid {
                grid-template-columns: 1fr;
            }

            .flags-grid {
                grid-template-columns: 1fr;
            }
        }

        /* GENERATED CONTENT SECTION */
        .generated-section {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
            border-left: 4px solid var(--aic-green);
        }

        .generated-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--aic-border);
        }

        .generated-header h2 {
            color: var(--aic-green);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .generated-badge {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .generated-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .generated-content-card {
            background: var(--aic-navy);
            border-radius: 12px;
            border: 1px solid var(--aic-border);
            overflow: hidden;
        }

        .generated-content-header {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .generated-content-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .generated-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85em;
            opacity: 0.9;
        }

        .btn-copy-content {
            background: rgba(12, 27, 51, 0.2);
            color: var(--aic-navy);
            border: 1px solid rgba(12, 27, 51, 0.3);
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn-copy-content:hover {
            background: rgba(12, 27, 51, 0.3);
        }

        .generated-content-body {
            padding: 25px;
            font-size: 0.95em;
            line-height: 1.8;
            color: var(--aic-white);
            max-height: 600px;
            overflow-y: auto;
        }

        .generated-content-body h2 {
            color: var(--aic-green);
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--aic-border);
        }

        .generated-content-body h3 {
            color: var(--aic-green);
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        .generated-content-body h4 {
            color: var(--aic-gray);
            font-size: 1.05em;
            margin-top: 18px;
            margin-bottom: 10px;
        }

        .generated-content-body strong {
            color: var(--aic-white);
        }

        .generated-content-body li {
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .generated-content-body .code-block {
            background: var(--aic-navy);
            color: var(--aic-white);
            padding: 15px 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            white-space: pre-wrap;
            margin: 15px 0;
            border: 1px solid var(--aic-border);
        }

        .generated-content-body code {
            background: var(--aic-border);
            color: var(--aic-green);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .flag-completed {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%) !important;
            border-color: var(--aic-green-dark) !important;
        }

        .flag-completed .flag-icon {
            animation: none !important;
        }

        /* CLUSTERING SECTION */
        .clustering-section {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        .clustering-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .clustering-header h2 {
            color: var(--aic-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-clustering {
            background: linear-gradient(135deg, var(--aic-green) 0%, var(--aic-green-dark) 100%);
            color: var(--aic-navy);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-clustering:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(14, 204, 151, 0.4);
        }

        .btn-clustering:disabled {
            background: var(--aic-border);
            color: var(--aic-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clustering-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .clustering-status.waiting {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .clustering-status.processing {
            background: rgba(14, 204, 151, 0.2);
            color: var(--aic-green);
        }

        .clustering-status.done {
            background: rgba(14, 204, 151, 0.3);
            color: var(--aic-green);
        }

        /* CLUSTER CARDS */
        .clusters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .cluster-card {
            background: var(--aic-navy);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .cluster-card:hover {
            border-color: var(--aic-green);
            box-shadow: 0 5px 20px rgba(14, 204, 151, 0.15);
        }

        .cluster-card.cluster-blocked {
            opacity: 0.7;
            border-color: #6b7280;
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(75, 85, 99, 0.1) 100%);
        }

        .cluster-blocked-badge {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            color: #fff;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .cluster-capture-btn {
            width: 100%;
            padding: 10px 15px;
            margin-top: 15px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cluster-capture-btn:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .cluster-capture-btn.disabled {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .cluster-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .cluster-name {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--aic-green);
        }

        .cluster-id-badge {
            background: var(--aic-green);
            color: var(--aic-navy);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .cluster-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .cluster-stat {
            text-align: center;
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
            padding: 10px;
            border-radius: 8px;
        }

        .cluster-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--aic-white);
        }

        .cluster-stat-label {
            font-size: 0.75em;
            color: var(--aic-gray);
            text-transform: uppercase;
        }

        .cluster-hashtags {
            margin-top: 15px;
        }

        .cluster-hashtags-label {
            font-size: 0.85em;
            color: var(--aic-gray);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .cluster-hashtag-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .cluster-hashtag-pill {
            background: rgba(14, 204, 151, 0.15);
            color: var(--aic-green);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }

        /* CLUSTERING SUMMARY */
        .clustering-summary {
            background: linear-gradient(135deg, var(--aic-border) 0%, #2d5a87 100%);
            border-radius: 12px;
            padding: 25px;
            color: var(--aic-white);
            margin-bottom: 25px;
        }

        .clustering-summary h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        @media (max-width: 1024px) {
            .clusters-grid {
                grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            }
            .criteria-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .scraping-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .flags-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 640px) {
            .clusters-grid,
            .criteria-grid,
            .scraping-grid,
            .flags-grid {
                grid-template-columns: 1fr;
            }
        }

        .clustering-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .clustering-summary-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .clustering-summary-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--aic-green);
        }

        .clustering-summary-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* TOP LEADS LIST */
        .top-leads-section {
            margin-top: 25px;
            background: var(--aic-navy);
            border: 1px solid var(--aic-border);
            border-radius: 12px;
            padding: 20px;
        }

        .top-leads-section h4 {
            color: var(--aic-white);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .leads-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .lead-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: var(--aic-navy-light);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--aic-green);
        }

        .lead-item.has-contact {
            border-left-color: var(--aic-green);
        }

        .lead-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lead-name {
            color: #ffffff;
            font-weight: 600;
        }

        .lead-username {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
        }

        .lead-cluster-badge {
            background: rgba(14, 204, 151, 0.15);
            color: var(--aic-green);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .lead-score {
            font-weight: 700;
            color: var(--aic-green);
        }

        .lead-contact-badge {
            background: rgba(14, 204, 151, 0.2);
            color: var(--aic-green);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* Content tabs */
        .content-tab {
            padding: 10px 20px;
            border: 2px solid var(--aic-green);
            background: var(--aic-navy-light);
            color: var(--aic-green);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .content-tab:hover,
        .content-tab.active {
            background: var(--aic-green);
            color: var(--aic-navy);
        }

        /* Details/summary for collapsible sections */
        details summary {
            color: var(--aic-green);
        }

        details > div {
            background: var(--aic-navy-light);
            border: 1px solid var(--aic-border);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                Cluster Intention Dashboard
                <span class="version-badge">v3.0 - Validacao Robusta</span>
            </h1>
            <p>Analise de Intencao do Cliente - Validacao de Massa Critica para Clusterizacao</p>

            <div class="input-section">
                <!-- Informa√ß√µes do Cliente/Projeto/Campanha - Dropdowns em Cascata -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label class="input-label" for="clientSelect">Cliente</label>
                        <select id="clientSelect" class="input-field" onchange="onClientChange()">
                            <option value="">-- Selecione ou crie novo --</option>
                            <option value="__NEW__">+ Novo Cliente</option>
                        </select>
                        <input
                            type="text"
                            id="clientNameInput"
                            class="input-field"
                            placeholder="Nome do novo cliente..."
                            style="display: none; margin-top: 8px;"
                        >
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="projectSelect">Projeto</label>
                        <select id="projectSelect" class="input-field" onchange="onProjectChange()" disabled>
                            <option value="">-- Selecione cliente primeiro --</option>
                        </select>
                        <input
                            type="text"
                            id="projectNameInput"
                            class="input-field"
                            placeholder="Nome do novo projeto..."
                            style="display: none; margin-top: 8px;"
                        >
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="campaignSelect">Campanha</label>
                        <select id="campaignSelect" class="input-field" onchange="onCampaignChange()" disabled>
                            <option value="">-- Selecione projeto primeiro --</option>
                        </select>
                        <input
                            type="text"
                            id="campaignNameInput"
                            class="input-field"
                            placeholder="Nome da nova campanha..."
                            style="display: none; margin-top: 8px;"
                        >
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="whapiChannelSelect">Canal Whapi (Linha WhatsApp)</label>
                        <select id="whapiChannelSelect" class="input-field">
                            <option value="">-- Selecione um canal --</option>
                        </select>
                        <div class="input-hint">Linha WhatsApp para envio de mensagens desta campanha.</div>
                    </div>
                </div>

                <!-- Modo de edi√ß√£o indicator -->
                <div id="editModeIndicator" style="display: none; background: rgba(14, 204, 151, 0.1); border: 1px solid var(--aic-green); padding: 12px; border-radius: 8px; margin-bottom: 20px; color: var(--aic-green);">
                    <strong>Modo Edicao:</strong> <span id="editingCampaignName"></span>
                    <button onclick="clearSelection()" style="float: right; background: var(--aic-green); color: var(--aic-navy); border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;">Limpar Selecao</button>
                </div>

                <!-- Status da Campanha (Pipeline) -->
                <div id="campaignStatusIndicator" style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 10px; border: 2px solid;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1em;">üìä Status:</strong>
                            <span id="campaignStatusBadge" style="padding: 5px 12px; border-radius: 15px; font-weight: bold; margin-left: 10px;"></span>
                            <span id="campaignStatusMessage" style="margin-left: 15px; color: #64748b;"></span>
                        </div>
                        <div id="campaignStatusActions">
                            <!-- Bot√µes din√¢micos baseados no status -->
                        </div>
                    </div>
                    <!-- Alerta de bloqueio -->
                    <div id="campaignLockedAlert" style="display: none; margin-top: 12px; padding: 10px; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.5); border-radius: 8px; color: #fbbf24;">
                        ‚ö†Ô∏è <strong>Campanha bloqueada para edi√ß√£o.</strong> Para modificar clustering ou leads, retorne para status "draft".
                    </div>
                </div>

                <!-- Nicho Alvo -->
                <div class="input-group" style="margin-bottom: 15px;">
                    <label class="input-label" for="nichoInput">Nicho Alvo *</label>
                    <input
                        type="text"
                        id="nichoInput"
                        class="input-field"
                        placeholder="Ex: Gestao de Trafego, Estetica..."
                        style="height: 44px;"
                        oninput="checkSeedsButtonState()"
                    >
                    <div class="input-hint">Segmento principal do p√∫blico-alvo.</div>
                </div>

                <!-- Descricao do Servico e Publico Alvo -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="input-group">
                        <label class="input-label" for="serviceDescription">Descricao do Servico/Produto *</label>
                        <textarea
                            id="serviceDescription"
                            class="input-field keywords-input"
                            placeholder="Descreva o servico ou produto que sera oferecido..."
                            style="min-height: 60px;"
                            oninput="checkSeedsButtonState()"
                        ></textarea>
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="targetAudience">Publico Alvo *</label>
                        <textarea
                            id="targetAudience"
                            class="input-field keywords-input"
                            placeholder="Descreva o publico-alvo ideal para este servico..."
                            style="min-height: 60px;"
                            oninput="checkSeedsButtonState()"
                        ></textarea>
                    </div>
                </div>

                <!-- Seeds/Keywords com botao Gerar Seeds -->
                <div class="input-group">
                    <label class="input-label" for="seedsInput">Seeds/Keywords (separadas por virgula) *</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button
                            type="button"
                            id="btnGenerateSeeds"
                            onclick="generateSeedsWithAI()"
                            disabled
                            style="height: 44px; padding: 0 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; cursor: not-allowed; font-size: 0.85em; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 6px; opacity: 0.5;"
                            title="Preencha Nicho, Descri√ß√£o e P√∫blico Alvo para habilitar"
                        >
                            ü§ñ Gerar Seeds
                        </button>
                        <input
                            type="text"
                            id="seedsInput"
                            class="input-field"
                            placeholder="Ex: gestao, trafego, marketing, ads"
                            style="height: 44px; flex: 1;"
                        >
                    </div>
                    <div class="input-hint">Preencha Nicho, Descri√ß√£o e P√∫blico Alvo acima para habilitar o bot√£o Gerar Seeds.</div>

                    <!-- Sugest√µes de Scraping (hashtags que n√£o existem no banco) -->
                    <div id="suggestedScrapingContainer" style="display: none; margin-top: 12px; padding: 12px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 1.1em;">üîç</span>
                            <strong style="color: #fbbf24; font-size: 0.9em;">Sugest√µes para Scraping</strong>
                            <span id="suggestedScrapingCount" style="font-size: 0.75em; color: var(--aic-gray);"></span>
                        </div>
                        <div id="suggestedScrapingList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                        <div style="margin-top: 8px; font-size: 0.75em; color: var(--aic-gray);">
                            üí° Scrape essas hashtags para melhorar a cobertura do nicho
                        </div>
                        <div style="margin-top: 12px; text-align: right;">
                            <button
                                type="button"
                                id="btnSaveSearchTerms"
                                onclick="saveSearchTerms()"
                                class="btn btn-secondary"
                                style="padding: 8px 14px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.8em; white-space: nowrap;"
                                title="Salva as hashtags sugeridas na tabela lead_search_terms para scraping futuro"
                            >
                                üíæ Gerar Search Terms
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Botao Extrair dos Docs -->
                <div style="margin-top: 10px; text-align: right;">
                    <button
                        type="button"
                        id="btnExtractFromDocs"
                        onclick="extractFromDocs()"
                        class="btn btn-secondary"
                        style="padding: 10px 16px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.85em; white-space: nowrap;"
                        title="Extrai Nicho, Publico Alvo e Descricao dos documentos da campanha usando IA"
                    >
                        üìÑ Extrair dos Docs
                    </button>
                    <span style="margin-left: 8px; font-size: 0.8em; color: var(--aic-gray);">Preenche os campos acima com base nos documentos da campanha</span>
                </div>

                <!-- Detalhes adicionais do publico (colapsavel) -->
                <details style="margin-top: 15px;">
                    <summary style="cursor: pointer; color: var(--aic-green); font-weight: 600;">Detalhes do Publico Alvo (opcional)</summary>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; padding: 15px; background: var(--aic-navy-light); border-radius: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Faixa Etaria</label>
                            <input type="text" id="targetAgeRange" class="input-field" placeholder="Ex: 25-45">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Genero</label>
                            <select id="targetGender" class="input-field">
                                <option value="">Todos</option>
                                <option value="female">Feminino</option>
                                <option value="male">Masculino</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Localizacao</label>
                            <input type="text" id="targetLocation" class="input-field" placeholder="Ex: Brasil, SP">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Classe Social</label>
                            <select id="targetIncomeClass" class="input-field">
                                <option value="">Todas</option>
                                <option value="A">Classe A</option>
                                <option value="B">Classe B</option>
                                <option value="C">Classe C</option>
                                <option value="D">Classe D</option>
                            </select>
                        </div>
                    </div>
                </details>

                <!-- Criterios customizaveis (colapsavel) -->
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; color: var(--aic-green); font-weight: 600;">Criterios de Viabilidade (opcional)</summary>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; padding: 15px; background: var(--aic-navy-light); border-radius: 8px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Hashtags freq>=5</label>
                            <input type="number" id="criteriaHashtags" class="input-field" value="20" min="1">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Leads Unicos</label>
                            <input type="number" id="criteriaLeads" class="input-field" value="100" min="1">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. Hashtags c/ 3+ leads</label>
                            <input type="number" id="criteriaHashtagsLeads" class="input-field" value="5" min="1">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Min. WhatsApp Rate (%)</label>
                            <input type="number" id="criteriaContactRate" class="input-field" value="20" min="1" max="100">
                        </div>
                    </div>
                </details>

                <!-- Nichos salvos da campanha (carregados dinamicamente) -->
                <div id="savedNichesSection" style="display: none; margin-top: 15px;">
                    <div class="suggestions-label">Nichos salvos nesta campanha:</div>
                    <div id="savedNichesPills" class="suggestion-pills">
                        <!-- Nichos da campanha ser√£o carregados via API -->
                    </div>
                </div>

                <!-- Configuracao de Leads e Export Meta -->
                <details style="margin-top: 20px;" open>
                    <summary style="cursor: pointer; color: var(--aic-green); font-weight: 600;">üìä Configura√ß√£o de Leads & Export Meta</summary>
                    <div style="display: flex; gap: 15px; margin-top: 15px; padding: 15px; background: var(--aic-navy-light); border-radius: 8px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="input-group" style="margin-bottom: 0; width: 120px; flex-shrink: 0;">
                            <label class="input-label" style="font-size: 0.85em;">N¬∫ Leads</label>
                            <input type="number" id="numLeadsExport" class="input-field" value="2000" min="100" max="10000" step="100">
                        </div>
                        <div class="input-group" style="margin-bottom: 0; width: 140px; flex-shrink: 0;">
                            <label class="input-label" style="font-size: 0.85em;">S√≥ WhatsApp</label>
                            <select id="requireWhatsappExport" class="input-field">
                                <option value="false">N√£o</option>
                                <option value="true" selected>Sim</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 0; width: 160px; flex-shrink: 0;">
                            <label class="input-label" style="font-size: 0.85em;">Formato</label>
                            <select id="exportFormat" class="input-field">
                                <option value="custom">Custom Audience</option>
                                <option value="lookalike" selected>Lookalike Seed</option>
                            </select>
                        </div>
                        <div style="flex-shrink: 0;">
                            <button class="btn" id="exportMetaBtn" onclick="exportMetaAudience()" style="height: 44px; white-space: nowrap; padding: 0 24px;">
                                üì§ Exportar CSV
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.75em; opacity: 0.7; padding: 0 5px;">
                        <strong>Custom Audience:</strong> phone, email, nome, cidade, estado (melhor match rate) &nbsp;|&nbsp;
                        <strong>Lookalike Seed:</strong> apenas phone + email (mais discreto)
                    </div>
                    <div id="metaExportStats" style="display: none; margin-top: 10px; padding: 10px; background: rgba(0,255,136,0.1); border-radius: 6px; font-size: 0.85em;">
                        <!-- Stats ser√£o preenchidos via JS -->
                    </div>
                </details>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button class="btn" id="analyzeBtn" onclick="validateNiche()">
                        üîç Validar Nicho
                    </button>
                    <button class="btn btn-success" id="saveCampaignBtn" onclick="saveAnalysis()">
                        üíæ Salvar Campanha
                    </button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>Validando massa critica do nicho...</p>
        </div>

        <div id="results" class="results">
            <!-- Viability Card -->
            <div class="viability-card">
                <div class="viability-header">
                    <h2>Validacao do Nicho</h2>
                    <div id="viabilityStatus" class="viability-status"></div>
                </div>

                <!-- Criterios Grid -->
                <div class="criteria-grid" id="criteriaGrid">
                    <!-- Preenchido via JS -->
                </div>

                <!-- Recomendacoes (se nao viavel) -->
                <div id="recommendationsBox" class="recommendations-list" style="display: none;">
                    <h4>Recomendacoes para tornar o nicho viavel:</h4>
                    <ul id="recommendationsList"></ul>
                </div>
            </div>

            <!-- Scraping Recommendation (se nao viavel) -->
            <div id="scrapingRecommendation" class="scraping-recommendation" style="display: none;">
                <h3>Necessidade de Scraping</h3>
                <div class="scraping-grid">
                    <div class="scraping-item">
                        <div class="scraping-label">Leads Faltantes</div>
                        <div class="scraping-value" id="leadsFaltantes">0</div>
                        <div class="scraping-detail">para atingir minimo</div>
                    </div>
                    <div class="scraping-item">
                        <div class="scraping-label">Hashtags a Scrapar</div>
                        <div class="scraping-value" id="hashtagsAScraper">0</div>
                        <div class="scraping-detail">das top hashtags</div>
                    </div>
                    <div class="scraping-item">
                        <div class="scraping-label">Perfis Estimados</div>
                        <div class="scraping-value" id="perfisEstimadosScrape">0</div>
                        <div class="scraping-detail">necessarios coletar</div>
                    </div>
                </div>

                <!-- Search Terms Button -->
                <div class="search-terms-box" style="background: rgba(255,255,255,0.1); margin-top: 20px;">
                    <h3>Gerar Search Terms para Scraping</h3>
                    <p style="margin-bottom: 15px; opacity: 0.9;">Crie termos de busca baseados nas top hashtags do nicho para alimentar o scraper.</p>
                    <button id="btnGenerateSearchTerms" onclick="generateSearchTerms()" class="btn-search-terms">
                        Gerar Search Terms
                    </button>
                    <div id="searchTermsResult"></div>
                </div>
            </div>

            <!-- Metricas do Nicho -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Hashtags no Nicho</div>
                    <div class="metric-value" id="totalHashtags">0</div>
                    <div class="metric-sub">contendo as seeds</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Hashtags freq>=5</div>
                    <div class="metric-value" id="hashtagsFreq5">0</div>
                    <div class="metric-sub">com densidade</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Unique Leads</div>
                    <div class="metric-value" id="uniqueLeads">0</div>
                    <div class="metric-sub">no nicho</div>
                </div>
                <div class="metric-card" style="border-left: 3px solid #25D366;">
                    <div class="metric-label">WhatsApp Rate</div>
                    <div class="metric-value" id="contactRate" style="color: #25D366;">0%</div>
                    <div class="metric-sub">leads com WhatsApp</div>
                </div>
            </div>

        <!-- Clustering Section (PRIMEIRO - so se viavel) -->
        <div id="clusteringSection" class="clustering-section" style="display: none;">
            <div class="clustering-header">
                <h2>Clusterizacao KMeans</h2>
                <div>
                    <span id="clusteringStatusBadge" class="clustering-status waiting">Aguardando execucao</span>
                    <button id="btnExecuteClustering" class="btn-clustering" onclick="executeClustering()">
                        Executar Clustering
                    </button>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px;">
                <div style="min-width: 180px;">
                    <label class="input-label" style="font-size: 0.85em;">Modo de Clustering</label>
                    <select id="clusteringMode" class="input-field">
                        <option value="vector" selected>Vector (embeddings)</option>
                        <option value="vector_hashtag">Vector (hashtags)</option>
                        <option value="hashtag">Hashtags (legado)</option>
                    </select>
                </div>
                <div style="min-width: 140px;">
                    <label class="input-label" style="font-size: 0.85em;">K (opcional)</label>
                    <input type="number" id="clusteringK" class="input-field" placeholder="Ex: 5" min="2" max="20" value="5">
                </div>
                <div style="min-width: 170px;">
                    <label class="input-label" style="font-size: 0.85em;">Min Similaridade (vector)</label>
                    <input type="number" step="0.01" id="clusteringSimilarity" class="input-field" placeholder="0.65" min="0.3" max="0.95">
                </div>
                <div style="min-width: 170px;">
                    <label class="input-label" style="font-size: 0.85em;">Min Leads por Cluster</label>
                    <input type="number" id="clusteringMinLeads" class="input-field" placeholder="1" min="1" max="1000" value="1">
                </div>
                <div style="min-width: 170px;">
                    <label class="input-label" style="font-size: 0.85em;">Leads Desejados</label>
                    <input type="number" id="clusteringMaxLeads" class="input-field" placeholder="2000" min="100" max="10000" value="2000" title="Limite de leads a retornar na clusteriza√ß√£o">
                </div>
            </div>
            <!-- Filtros de Rec√™ncia e Localiza√ß√£o -->
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; padding: 12px; background: rgba(14, 204, 151, 0.05); border: 1px solid rgba(14, 204, 151, 0.2); border-radius: 10px;">
                <div style="width: 100%; margin-bottom: 4px;">
                    <strong style="color: var(--aic-green); font-size: 0.85em;">Filtros de Qualidade (Recomendado)</strong>
                </div>
                <div style="min-width: 160px;">
                    <label class="input-label" style="font-size: 0.85em;">Estados (BR)</label>
                    <input type="text" id="clusteringTargetStates" class="input-field" placeholder="SP, RJ, MG" title="Estados brasileiros separados por v√≠rgula. Vazio = todos.">
                </div>
                <div style="min-width: 130px;">
                    <label class="input-label" style="font-size: 0.85em;">Leads (dias)</label>
                    <input type="number" id="clusteringLeadMaxAge" class="input-field" placeholder="45" min="7" max="180" value="45" title="M√°ximo de dias desde cria√ß√£o/atualiza√ß√£o do lead">
                </div>
                <div style="min-width: 130px;">
                    <label class="input-label" style="font-size: 0.85em;">Hashtags (dias)</label>
                    <input type="number" id="clusteringHashtagMaxAge" class="input-field" placeholder="90" min="7" max="365" value="90" title="M√°ximo de dias desde cria√ß√£o/atualiza√ß√£o da hashtag">
                </div>
                <div style="flex: 1; min-width: 200px; display: flex; align-items: flex-end;">
                    <span style="font-size: 0.75em; color: var(--aic-gray); line-height: 1.4;">
                        Leads recentes (45d) + Hashtags v√°lidas (90d) = clustering mais relevante
                    </span>
                </div>
            </div>
            <div style="margin-top: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--aic-border); border-radius: 10px; padding: 12px; font-size: 0.9em; color: var(--aic-gray); line-height: 1.5;">
                <strong style="color: var(--aic-white);">Como usar:</strong>
                <ul style="margin: 8px 0 0 16px; padding: 0; color: var(--aic-gray);">
                    <li style="margin-bottom: 6px;"><strong style="color: var(--aic-white);">Vector:</strong> usa <code>embedding_final</code> (perfil). Mais sem√¢ntico. K t√≠pico: 3‚Äì8. Similaridade: 0.60‚Äì0.70 (mais alto = clusters mais fechados).</li>
                    <li style="margin-bottom: 6px;"><strong style="color: var(--aic-white);">Vector_hashtag:</strong> usa embeddings das hashtags (comportamento). Similaridade: 0.65‚Äì0.75.</li>
                    <li style="margin-bottom: 6px;"><strong style="color: var(--aic-white);">Hashtag (legado):</strong> frequ√™ncia/contagem; use s√≥ se faltar embedding.</li>
                    <li style="margin-bottom: 6px;"><strong style="color: var(--aic-white);">K vazio:</strong> backend tenta K √≥timo por silhouette; preencha K se quiser granularidade fixa.</li>
                    <li><strong style="color: var(--aic-white);">Silhouette:</strong> &gt;0.50 bom, 0.35‚Äì0.50 aceit√°vel, &lt;0.35 refa√ßa seeds/K.</li>
                </ul>
            </div>

                <!-- Clustering Results (hidden until executed) -->
                <div id="clusteringResults" style="display: none;">
                    <!-- Summary -->
                    <div class="clustering-summary">
                        <h3>Resumo do Clustering</h3>
                        <div id="clusteringMethodLabel" style="font-size: 0.9em; opacity: 0.85; margin-bottom: 10px;">
                            M√©todo: ‚Äî
                        </div>
                        <div class="clustering-summary-grid">
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterK">0</div>
                                <div class="clustering-summary-label">K √ìtimo</div>
                                <div class="clustering-summary-sublabel" id="clusterKContext" style="font-size: 0.7em; opacity: 0.7;"></div>
                            </div>
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterHashtags">0</div>
                                <div class="clustering-summary-label">Hashtags</div>
                            </div>
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterLeads">0</div>
                                <div class="clustering-summary-label">Leads Associados</div>
                            </div>
                            <div class="clustering-summary-item">
                                <div class="clustering-summary-value" id="clusterSilhouette">0</div>
                                <div class="clustering-summary-label">Silhouette Score</div>
                                <div class="clustering-summary-sublabel" id="silhouetteQuality" style="font-size: 0.7em; font-weight: bold;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Cluster Cards -->
                    <div id="clustersGrid" class="clusters-grid">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Top Leads -->
                    <div class="top-leads-section">
                        <h4>Top 20 Leads por Score</h4>
                        <div id="topLeadsList" class="leads-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Flags de Acao POR SUBCLUSTER (so apos clustering) -->
                    <div id="flagsSection" class="flags-grid" style="margin-top: 30px;">
                        <div class="flag-card flag-yes" id="flagPersona" onclick="generatePersonaPerCluster()">
                            <div class="flag-icon">üë§</div>
                            <div class="flag-label">Gerar Personas</div>
                            <div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">por subcluster</div>
                        </div>
                        <div class="flag-card flag-yes" id="flagDM" onclick="generateDMPerCluster()">
                            <div class="flag-icon">‚úâÔ∏è</div>
                            <div class="flag-label">Gerar DMs</div>
                            <div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">por subcluster</div>
                        </div>
                        <div class="flag-card flag-yes" id="flagCopy" onclick="generateCopyPerCluster()">
                            <div class="flag-icon">üìù</div>
                            <div class="flag-label">Gerar Copies</div>
                            <div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">√∫nica da campanha</div>
                        </div>
                        <div class="flag-card flag-yes" id="flagCapture" onclick="captureLeadsPerCluster()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <div class="flag-icon">üéØ</div>
                            <div class="flag-label">Capturar Leads</div>
                            <div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">associar ao cluster</div>
                        </div>
                    </div>

                    <!-- Conteudo Gerado por Cluster (Visualizacao) -->
                    <div id="generatedContentSection" style="display: none; margin-top: 30px;">
                        <h3 style="color: var(--aic-green); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">üìã</span> Conteudo Gerado por Cluster
                        </h3>
                        <div id="generatedContentTabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="content-tab active" onclick="showContentTab('personas')" data-tab="personas">Personas</button>
                            <button class="content-tab" onclick="showContentTab('dms')" data-tab="dms">Scripts DM</button>
                            <button class="content-tab" onclick="showContentTab('copies')" data-tab="copies">Copies</button>
                            <button class="content-tab" onclick="showContentTab('leads')" data-tab="leads">Leads</button>
                        </div>
                        <div id="contentPersonas" class="content-panel" style="display: block;"></div>
                        <div id="contentDms" class="content-panel" style="display: none;"></div>
                        <div id="contentCopies" class="content-panel" style="display: none;"></div>
                        <div id="contentLeads" class="content-panel" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Top Hashtags -->
            <div class="hashtags-section">
                <h2>Top 20 Hashtags do Nicho</h2>
                <div class="table-responsive">
                    <table class="hashtags-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Hashtag</th>
                                <th>Frequencia Total</th>
                                <th>Bio</th>
                                <th>Posts</th>
                                <th>Leads Unicos</th>
                                <th style="color: #25D366;">WhatsApp Rate</th>
                            </tr>
                        </thead>
                        <tbody id="hashtagsTableBody">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Se√ß√£o de Conte√∫do Gerado (GPT) -->
            <div id="generatedContentSection" class="generated-section" style="display: none;">
                <div class="generated-header">
                    <h2>Conteudo Gerado por IA</h2>
                    <span class="generated-badge">GPT-4o-mini</span>
                </div>
                <div id="generatedContentContainer" class="generated-container">
                    <!-- Cards de conte√∫do gerado ser√£o inseridos aqui via JS -->
                </div>
            </div>

            <!-- Bot√£o Salvar -->
            <div id="saveSection" class="hashtags-section" style="text-align: center; display: none;">
                <h2>Salvar Analise</h2>
                <p style="color: var(--aic-gray); margin-bottom: 20px;">
                    Salve esta analise para acompanhamento futuro e geracao de campanhas.
                </p>
                <div id="saveStatus" style="margin-bottom: 15px;"></div>
                <button class="btn btn-success" id="saveBtn" onclick="saveAnalysis()" style="max-width: 400px;">
                    Salvar no Banco de Dados
                </button>
            </div>

            <!-- Se√ß√£o Bloqueada (quando leads j√° capturados) -->
            <div id="saveSectionBlocked" class="hashtags-section" style="text-align: center; display: none;">
                <h2 style="color: var(--aic-green);">üîí Campanha Salva</h2>
                <p style="color: var(--aic-gray); margin-bottom: 20px;">
                    Esta campanha j√° possui leads capturados e n√£o pode mais ser editada.
                </p>
                <div style="background: rgba(16, 185, 129, 0.15); border: 1px solid #10b981; padding: 20px; border-radius: 12px; max-width: 500px; margin: 0 auto;">
                    <div style="font-size: 1.2em; color: #10b981; font-weight: 600;">‚úÖ Campanha em Outreach</div>
                    <div style="color: var(--aic-gray); margin-top: 10px;">Os leads est√£o sendo processados pelo sistema de outreach.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/hashtag-intelligence';
        const escapeHTML = (value) => {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        // Nichos s√£o carregados dinamicamente da campanha via API
        // N√£o h√° nichos pr√©-definidos - s√£o criados atrav√©s da valida√ß√£o

        // Resultado atual da validacao
        let currentValidation = null;

        // Converter resultado do formato antigo para o novo
        function convertLegacyResult(legacy) {
            const metricas = legacy.metricas || {};
            const hashtagsRaiz = legacy.hashtags_raiz || [];

            // Mapear para o novo formato
            return {
                seeds: [], // N√£o temos no formato antigo
                criteria: {
                    minHashtagsWithFreq5: 20,
                    minUniqueLeads: 100,
                    minHashtagsWithLeads3: 5,
                    minContactRate: 20
                },
                totalHashtagsInNiche: metricas.total_hashtags_nicho || 0,
                hashtagsWithFreq5: metricas.hashtags_freq_50_plus || 0,
                hashtagsWithLeads3: hashtagsRaiz.length,
                totalUniqueLeads: metricas.perfis_unicos || 0,
                totalLeadsWithContact: Math.round((metricas.perfis_unicos || 0) * (metricas.taxa_contato_media || 0) / 100),
                averageContactRate: metricas.taxa_contato_media || 0,
                isViable: legacy.pode_gerar_dm || false,
                passedCriteria: {
                    hashtagsWithFreq5: (metricas.hashtags_freq_50_plus || 0) >= 20,
                    uniqueLeads: (metricas.perfis_unicos || 0) >= 100,
                    hashtagsWithLeads3: hashtagsRaiz.length >= 5,
                    contactRate: (metricas.taxa_contato_media || 0) >= 20
                },
                recommendations: legacy.recomendacao ? [legacy.recomendacao] : [],
                topHashtags: hashtagsRaiz.map(h => ({
                    hashtag: h.hashtag,
                    freq_total: h.freq,
                    freq_bio: h.freq_bio || 0,
                    freq_posts: h.freq_posts || 0,
                    unique_leads: h.unique_leads || 0,
                    leads_with_contact: Math.round((h.unique_leads || 0) * (h.contact_rate || 0) / 100),
                    contact_rate: h.contact_rate || 0
                })),
                // Dados adicionais do formato antigo
                legacyData: legacy
            };
        }

        // Carregar nichos salvos da campanha
        async function loadCampaignNiches(campaignId) {
            if (!campaignId) {
                hideSavedNiches();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/campaign/${campaignId}/niches`);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    renderSavedNiches(result.data, result.active_niche_index || 0);
                } else {
                    hideSavedNiches();
                }
            } catch (error) {
                console.error('Erro ao carregar nichos da campanha:', error);
                hideSavedNiches();
            }
        }

        // Renderizar nichos salvos da campanha
        function renderSavedNiches(niches, activeIndex) {
            const section = document.getElementById('savedNichesSection');
            const pills = document.getElementById('savedNichesPills');

            if (!niches || niches.length === 0) {
                hideSavedNiches();
                return;
            }

            pills.innerHTML = niches.map((nicho, index) => {
                const isActive = index === activeIndex;
                const isValidated = nicho.is_validated;
                const statusIcon = isValidated ? '‚úÖ' : '‚è≥';
                const activeStyle = isActive ? 'background: var(--aic-green); color: var(--aic-navy);' : '';

                return `
                    <div class="suggestion-pill"
                         onclick="loadSavedNiche(${index})"
                         style="${activeStyle}"
                         title="${isValidated ? 'Nicho validado' : 'Aguardando valida√ß√£o'}">
                        ${statusIcon} ${escapeHTML(nicho.name)}
                    </div>
                `;
            }).join('');

            section.style.display = 'block';
        }

        // Carregar um nicho salvo no formul√°rio
        function loadSavedNiche(nicheIndex) {
            if (!currentCampaignId) return;

            // Buscar nicho do array em mem√≥ria ou recarregar
            fetch(`${API_BASE}/campaign/${currentCampaignId}/niches`)
                .then(res => res.json())
                .then(result => {
                    if (result.success && result.data && result.data[nicheIndex]) {
                        const nicho = result.data[nicheIndex];
                        document.getElementById('nichoInput').value = nicho.name || '';
                        document.getElementById('seedsInput').value = (nicho.seeds || []).join(', ');

                        // Se o nicho tem resultado de valida√ß√£o, carregar
                        if (nicho.validation_result) {
                            currentValidation = nicho.validation_result;
                            renderResults(nicho.validation_result);
                        }

                        // Se o nicho tem resultado de clustering, carregar
                        if (nicho.clustering_result) {
                            currentClusteringResult = nicho.clustering_result;
                            renderClusteringResults(nicho.clustering_result);
                        }

                        // Ativar este nicho na campanha
                        activateNiche(nicheIndex);
                    }
                })
                .catch(err => console.error('Erro ao carregar nicho:', err));
        }

        // Ativar um nicho na campanha
        async function activateNiche(nicheIndex) {
            if (!currentCampaignId) return;

            try {
                await fetch(`${API_BASE}/campaign/${currentCampaignId}/niches/${nicheIndex}/activate`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                // Recarregar nichos para atualizar visual
                await loadCampaignNiches(currentCampaignId);
            } catch (error) {
                console.error('Erro ao ativar nicho:', error);
            }
        }

        // Ocultar se√ß√£o de nichos salvos
        function hideSavedNiches() {
            document.getElementById('savedNichesSection').style.display = 'none';
        }

        // Salvar nicho na campanha ap√≥s valida√ß√£o bem-sucedida
        async function saveNicheToCampaign(nicheName, seeds, validationResult) {
            if (!currentCampaignId) return;

            try {
                const response = await fetch(`${API_BASE}/campaign/${currentCampaignId}/niches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: nicheName,
                        seeds: seeds
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Atualizar valida√ß√£o do nicho rec√©m-criado
                    const nicheIndex = result.data.length - 1; // √öltimo adicionado
                    await updateNicheValidation(nicheIndex, validationResult);
                    // Recarregar nichos
                    await loadCampaignNiches(currentCampaignId);
                }
            } catch (error) {
                console.error('Erro ao salvar nicho na campanha:', error);
            }
        }

        // Atualizar valida√ß√£o de um nicho
        async function updateNicheValidation(nicheIndex, validationResult) {
            if (!currentCampaignId) return;

            try {
                await fetch(`${API_BASE}/campaign/${currentCampaignId}/niches/${nicheIndex}/validate`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        is_validated: validationResult.isViable,
                        validation_result: validationResult
                    })
                });
            } catch (error) {
                console.error('Erro ao atualizar valida√ß√£o do nicho:', error);
            }
        }

        // Atualizar clustering de um nicho
        async function updateNicheClustering(nicheIndex, clusteringResult) {
            if (!currentCampaignId) return;

            try {
                await fetch(`${API_BASE}/campaign/${currentCampaignId}/niches/${nicheIndex}/clustering`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clustering_result: clusteringResult
                    })
                });
            } catch (error) {
                console.error('Erro ao atualizar clustering do nicho:', error);
            }
        }

        // ==================== CONTROLE DO BOTAO GERAR SEEDS ====================
        function checkSeedsButtonState() {
            const btn = document.getElementById('btnGenerateSeeds');
            const nichoInput = document.getElementById('nichoInput')?.value?.trim();
            const serviceDesc = document.getElementById('serviceDescription')?.value?.trim();
            const targetAudience = document.getElementById('targetAudience')?.value?.trim();

            // Habilita botao apenas se os 3 campos estiverem preenchidos
            const allFilled = nichoInput && serviceDesc && targetAudience;

            if (allFilled) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.title = 'Gera seeds automaticamente usando IA';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.title = 'Preencha Nicho, Descri√ß√£o e P√∫blico Alvo para habilitar';
            }
        }

        // ==================== GERADOR DE SEEDS COM IA ====================
        async function generateSeedsWithAI() {
            const btn = document.getElementById('btnGenerateSeeds');
            const serviceDesc = document.getElementById('serviceDescription')?.value?.trim();
            const targetAudience = document.getElementById('targetAudience')?.value?.trim();
            const nichoInput = document.getElementById('nichoInput')?.value?.trim();
            const targetLocation = document.getElementById('targetLocation')?.value?.trim() || '';

            // Valida√ß√£o
            if (!serviceDesc && !targetAudience && !nichoInput) {
                alert('Preencha pelo menos o "Nicho", "Descri√ß√£o do Servi√ßo" ou "P√∫blico Alvo" para gerar seeds.');
                return;
            }

            // Montar descri√ß√£o simples (apenas nicho + servi√ßo + p√∫blico)
            const campaignDescription = [
                nichoInput,
                serviceDesc,
                targetAudience
            ].filter(Boolean).join('. ');

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Analisando hashtags...';

            try {
                // Nova API: sugere seeds baseado em top 100 hashtags (freq >= 20)
                const response = await fetch(`${API_BASE}/suggest-seeds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ campaign_description: campaignDescription })
                });

                const result = await response.json();
                console.log('üì¶ Resposta suggest-seeds:', { success: result.success, seedsCount: result.data?.seeds?.length });

                if (result.success && result.data?.seeds?.length > 0) {
                    // Preencher campo de seeds
                    document.getElementById('seedsInput').value = result.data.seeds.join(', ');

                    // Log detalhado
                    console.log('üå± Seeds sugeridas:', result.data.total_seeds);
                    console.log('üìä Metodologia:', result.data.metodologia);

                    // Log de auto-adjust se aplicado
                    const autoAdj = result.data.auto_adjust;
                    if (autoAdj?.applied) {
                        console.log(`‚öôÔ∏è Auto-adjust aplicado: ${autoAdj.original_count} ‚Üí ${autoAdj.final_count} seeds`);
                        console.log(`   Similaridade: ${(autoAdj.original_similarity * 100).toFixed(0)}% ‚Üí ${(autoAdj.final_similarity * 100).toFixed(0)}%`);
                    }

                    // Mostrar sugest√µes de scraping (hashtags que n√£o existem no banco)
                    const scrapingContainer = document.getElementById('suggestedScrapingContainer');
                    const scrapingList = document.getElementById('suggestedScrapingList');
                    const scrapingCount = document.getElementById('suggestedScrapingCount');
                    const suggested = result.data.suggested_for_scraping || [];

                    // Armazenar para uso pelo bot√£o Gerar Search Terms
                    currentSuggestedHashtags = suggested;

                    if (suggested.length > 0) {
                        scrapingCount.textContent = `(${suggested.length} hashtags n√£o encontradas)`;
                        scrapingList.innerHTML = suggested.map(tag => {
                            const safeTag = escapeHTML(tag);
                            return `<span style="display: inline-block; padding: 4px 10px; background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 16px; font-size: 0.8em; color: #fbbf24; cursor: pointer;" onclick="navigator.clipboard.writeText('${safeTag}').then(() => this.style.background = 'rgba(16, 185, 129, 0.3)')" title="Clique para copiar">#${safeTag}</span>`;
                        }).join('');
                        scrapingContainer.style.display = 'block';
                        console.log('üîç Sugest√µes para scraping:', suggested);
                    } else {
                        scrapingContainer.style.display = 'none';
                    }

                    // Feedback visual
                    btn.innerHTML = `‚úÖ ${result.data.total_seeds} seeds!`;
                    setTimeout(() => {
                        btn.innerHTML = 'ü§ñ Gerar Seeds';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Erro ao gerar seeds');
                }

            } catch (error) {
                console.error('Erro ao gerar seeds:', error);
                alert(`Erro: ${error.message}`);
                btn.innerHTML = 'ü§ñ Gerar Seeds';
                btn.disabled = false;
            }
        }
        // ==================== FIM GERADOR DE SEEDS ====================

        // ==================== SALVAR SEARCH TERMS ====================
        async function saveSearchTerms() {
            const btn = document.getElementById('btnSaveSearchTerms');

            // Validar se h√° hashtags sugeridas
            if (!currentSuggestedHashtags || currentSuggestedHashtags.length === 0) {
                alert('Nenhuma hashtag sugerida dispon√≠vel. Gere as seeds primeiro.');
                return;
            }

            // Obter dados da campanha
            const campaignName = loadedCampaignName || document.getElementById('campaignNameInput')?.value || 'Campanha';
            const clientName = loadedClientName || document.getElementById('clientNameInput')?.value || 'Cliente';
            const nichoAlvo = document.getElementById('nichoInput')?.value || 'Nicho';

            if (!nichoAlvo || nichoAlvo.trim() === '') {
                alert('Por favor, preencha o campo Nicho Alvo antes de salvar os search terms.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Salvando...';

            try {
                const response = await fetch(`${API_BASE}/save-search-terms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaign_name: campaignName,
                        client_name: clientName,
                        nicho_alvo: nichoAlvo,
                        hashtags: currentSuggestedHashtags
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ Search terms salvos:', result.data);
                    btn.innerHTML = '‚úÖ Salvo!';
                    setTimeout(() => {
                        btn.innerHTML = 'üíæ Gerar Search Terms';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Erro ao salvar search terms');
                }

            } catch (error) {
                console.error('‚ùå Erro ao salvar search terms:', error);
                alert(`Erro: ${error.message}`);
                btn.innerHTML = 'üíæ Gerar Search Terms';
                btn.disabled = false;
            }
        }
        // ==================== FIM SALVAR SEARCH TERMS ====================

        // ==================== EXTRA√á√ÉO DE CAMPOS DOS DOCS ====================
        async function extractFromDocs() {
            const btn = document.getElementById('btnExtractFromDocs');

            // Verificar se h√° campanha selecionada
            if (!currentCampaignId) {
                alert('Selecione ou crie uma campanha primeiro para extrair dados dos documentos.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Analisando docs...';

            try {
                const response = await fetch(`${API_BASE}/extract-from-docs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ campaign_id: currentCampaignId })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    // Preencher os campos
                    if (result.data.nicho && result.data.nicho !== 'N√£o identificado') {
                        document.getElementById('nichoInput').value = result.data.nicho;
                    }
                    if (result.data.publicoAlvo && result.data.publicoAlvo !== 'N√£o identificado') {
                        document.getElementById('targetAudience').value = result.data.publicoAlvo;
                    }
                    if (result.data.descricaoServico && result.data.descricaoServico !== 'N√£o identificado') {
                        document.getElementById('serviceDescription').value = result.data.descricaoServico;
                    }

                    console.log('üìÑ Campos extra√≠dos dos documentos:', result.data);

                    btn.innerHTML = '‚úÖ Extra√≠do!';
                    setTimeout(() => {
                        btn.innerHTML = 'üìÑ Extrair dos Docs';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Nenhum documento encontrado para esta campanha');
                }

            } catch (error) {
                console.error('Erro ao extrair dos docs:', error);
                alert(`Erro: ${error.message}`);
                btn.innerHTML = 'üìÑ Extrair dos Docs';
                btn.disabled = false;
            }
        }
        // ==================== FIM EXTRA√á√ÉO DE CAMPOS DOS DOCS ====================

        // ==================== VALIDA√á√ÉO DE FORMUL√ÅRIO ====================
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            field.style.borderColor = '#ef4444';
            field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.15)';

            // Remover mensagem de erro anterior se existir
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) existingError.remove();

            // Adicionar mensagem de erro
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error';
            errorDiv.style.cssText = 'color: #f87171; font-size: 0.85em; margin-top: 5px;';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            field.style.borderColor = '';
            field.style.boxShadow = '';

            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) existingError.remove();
        }

        function clearAllFieldErrors() {
            ['nichoInput', 'seedsInput', 'serviceDescription', 'targetAudience'].forEach(clearFieldError);
        }

        function validateFormFields() {
            clearAllFieldErrors();
            let isValid = true;
            const errors = [];

            const nichoInput = document.getElementById('nichoInput').value.trim();
            const seedsInput = document.getElementById('seedsInput').value.trim();

            if (!nichoInput) {
                showFieldError('nichoInput', 'Nicho alvo √© obrigat√≥rio');
                errors.push('Nicho alvo');
                isValid = false;
            }

            if (!seedsInput) {
                showFieldError('seedsInput', 'Seeds s√£o obrigat√≥rias (separe por v√≠rgula)');
                errors.push('Seeds');
                isValid = false;
            } else {
                const seeds = seedsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                if (seeds.length === 0) {
                    showFieldError('seedsInput', 'Digite pelo menos uma seed v√°lida');
                    errors.push('Seeds v√°lidas');
                    isValid = false;
                }
            }

            return { isValid, errors };
        }

        // Adicionar listeners para limpar erros quando o usu√°rio digita
        document.addEventListener('DOMContentLoaded', function() {
            ['nichoInput', 'seedsInput', 'serviceDescription', 'targetAudience'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => clearFieldError(fieldId));
                }
            });
        });
        // ==================== FIM VALIDA√á√ÉO DE FORMUL√ÅRIO ====================

        // ==================== EXPORT META AUDIENCE ====================
        async function exportMetaAudience() {
            const btn = document.getElementById('exportMetaBtn');
            const statsDiv = document.getElementById('metaExportStats');
            const numLeads = parseInt(document.getElementById('numLeadsExport').value) || 2000;
            const requireWhatsapp = document.getElementById('requireWhatsappExport').value === 'true';
            const exportFormat = document.getElementById('exportFormat').value; // 'custom' ou 'lookalike'

            // Pegar seeds/hashtags do campo
            const seedsInput = document.getElementById('seedsInput').value.trim();
            const hashtags = seedsInput ? seedsInput.split(',').map(s => s.trim().replace('#', '')).filter(s => s) : [];

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Exportando...';
            statsDiv.style.display = 'none';

            try {
                // Primeiro buscar estat√≠sticas
                const statsResponse = await fetch(`${API_BASE}/leads/meta-audience-stats`);
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    statsDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: var(--aic-green);">${statsData.stats.total_leads.toLocaleString()}</div>
                                <div style="opacity: 0.7;">Total Zona Ativa</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #00d4ff;">${statsData.stats.with_phone.toLocaleString()}</div>
                                <div style="opacity: 0.7;">Com WhatsApp</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #ff6b6b;">${statsData.stats.with_email.toLocaleString()}</div>
                                <div style="opacity: 0.7;">Com Email</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #ffd93d;">${statsData.stats.meta_match_rate}%</div>
                                <div style="opacity: 0.7;">Match Rate</div>
                            </div>
                        </div>
                    `;
                    statsDiv.style.display = 'block';
                }

                // Agora fazer o export
                const response = await fetch(`${API_BASE}/leads/export-meta-audience`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hashtags: hashtags,
                        limit: numLeads,
                        requireWhatsapp: requireWhatsapp,
                        format: 'csv',
                        metaFormat: exportFormat // 'custom' ou 'lookalike'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao exportar');
                }

                // Baixar o CSV
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const formatSuffix = exportFormat === 'lookalike' ? 'lookalike' : 'custom';
                a.download = `meta_${formatSuffix}_${numLeads}_leads_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                btn.innerHTML = '‚úÖ CSV Baixado!';
                setTimeout(() => {
                    btn.innerHTML = 'üì§ Exportar Meta CSV';
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Erro ao exportar Meta:', error);
                statsDiv.innerHTML = `<div style="color: #ff6b6b;">‚ùå Erro: ${error.message}</div>`;
                statsDiv.style.display = 'block';
                btn.innerHTML = 'üì§ Exportar Meta CSV';
                btn.disabled = false;
            }
        }
        // ==================== FIM EXPORT META AUDIENCE ====================

        async function validateNiche() {
            // Validar campos primeiro
            const validation = validateFormFields();
            if (!validation.isValid) {
                return;
            }

            const nichoInput = document.getElementById('nichoInput').value.trim();
            const seedsInput = document.getElementById('seedsInput').value.trim();

            // Processar seeds (j√° validadas acima)
            const seeds = seedsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);

            // ========== RESET DE ESTADOS ANTERIORES ==========
            // Evita reutiliza√ß√£o de dados de nichos anteriores
            currentPersona = null;
            currentDMScripts = null;
            currentCopies = null;
            currentClusteringResult = null;
            currentValidation = null;

            // Reset visual dos flag cards
            const flagPersona = document.getElementById('flagPersona');
            const flagDM = document.getElementById('flagDM');
            const flagCopy = document.getElementById('flagCopy');

            if (flagPersona) {
                flagPersona.innerHTML = '<div class="flag-icon">üé≠</div><div class="flag-label">Persona</div><div class="flag-sublabel">Por cluster</div>';
            }
            if (flagDM) {
                flagDM.innerHTML = '<div class="flag-icon">üí¨</div><div class="flag-label">Scripts DM</div><div class="flag-sublabel">Personalizados</div>';
            }
            if (flagCopy) {
                flagCopy.innerHTML = '<div class="flag-icon">üìù</div><div class="flag-label">Copies</div><div class="flag-sublabel">Landing + Ads</div>';
            }

            // Reset status do clustering
            const clusteringBadge = document.getElementById('clusteringStatusBadge');
            if (clusteringBadge) {
                clusteringBadge.className = 'clustering-status waiting';
                clusteringBadge.innerHTML = 'Pendente';
            }

            // Esconder resultados de clustering anterior
            const clusteringResults = document.getElementById('clusteringResults');
            if (clusteringResults) {
                clusteringResults.style.display = 'none';
            }

            // Limpar resultados de personas/DMs/copies anteriores
            const personaResults = document.getElementById('personaResults');
            const dmResults = document.getElementById('dmResults');
            const copyResults = document.getElementById('copyResults');
            if (personaResults) personaResults.innerHTML = '';
            if (dmResults) dmResults.innerHTML = '';
            if (copyResults) copyResults.innerHTML = '';
            // ========== FIM RESET ==========

            // Obter criterios customizados
            const criteria = {
                minHashtagsWithFreq5: parseInt(document.getElementById('criteriaHashtags').value) || 20,
                minUniqueLeads: parseInt(document.getElementById('criteriaLeads').value) || 100,
                minHashtagsWithLeads3: parseInt(document.getElementById('criteriaHashtagsLeads').value) || 5,
                minContactRate: parseInt(document.getElementById('criteriaContactRate').value) || 20
            };

            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').classList.remove('show');

            try {
                const response = await fetch(`${API_BASE}/validate-niche`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ seeds, criteria })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    currentValidation = result.data;
                    renderResults(result.data);

                    // Se temos uma campanha selecionada, salvar o nicho validado
                    if (currentCampaignId) {
                        await saveNicheToCampaign(nichoInput, seeds, result.data);
                    }
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao validar nicho:', error);
                alert(`Erro: ${error.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderResults(data) {
            // Status de viabilidade
            const viabilityStatus = document.getElementById('viabilityStatus');
            if (data.isViable) {
                viabilityStatus.className = 'viability-status viability-viable';
                viabilityStatus.innerHTML = '‚úÖ NICHO VIAVEL';
            } else {
                viabilityStatus.className = 'viability-status viability-not-viable';
                viabilityStatus.innerHTML = '‚ö†Ô∏è PRECISA MAIS DADOS';
            }

            // Criterios Grid
            const criteriaGrid = document.getElementById('criteriaGrid');
            criteriaGrid.innerHTML = `
                <div class="criteria-item ${data.passedCriteria.hashtagsWithFreq5 ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.hashtagsWithFreq5 ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Hashtags freq>=5</div>
                    <div class="criteria-value">${data.hashtagsWithFreq5}</div>
                    <div class="criteria-target">min: ${data.criteria.minHashtagsWithFreq5}</div>
                </div>
                <div class="criteria-item ${data.passedCriteria.uniqueLeads ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.uniqueLeads ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Leads Unicos</div>
                    <div class="criteria-value">${data.totalUniqueLeads.toLocaleString('pt-BR')}</div>
                    <div class="criteria-target">min: ${data.criteria.minUniqueLeads}</div>
                </div>
                <div class="criteria-item ${data.passedCriteria.hashtagsWithLeads3 ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.hashtagsWithLeads3 ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">Hashtags c/ 3+ leads</div>
                    <div class="criteria-value">${data.hashtagsWithLeads3}</div>
                    <div class="criteria-target">min: ${data.criteria.minHashtagsWithLeads3}</div>
                </div>
                <div class="criteria-item ${data.passedCriteria.contactRate ? 'passed' : 'failed'}">
                    <div class="criteria-icon">${data.passedCriteria.contactRate ? '‚úÖ' : '‚ùå'}</div>
                    <div class="criteria-label">WhatsApp Rate</div>
                    <div class="criteria-value" style="color: #25D366;">${data.averageContactRate}%</div>
                    <div class="criteria-target">min: ${data.criteria.minContactRate}%</div>
                </div>
            `;

            // Recomendacoes (se nao viavel)
            const recommendationsBox = document.getElementById('recommendationsBox');
            const recommendationsList = document.getElementById('recommendationsList');

            if (!data.isViable && data.recommendations.length > 0) {
                recommendationsBox.style.display = 'block';
                recommendationsList.innerHTML = data.recommendations
                    .filter(r => !r.startsWith('‚úÖ'))
                    .map(r => `<li>${r}</li>`)
                    .join('');
            } else {
                recommendationsBox.style.display = 'none';
            }

            // Scraping Recommendation (se nao viavel)
            const scrapingSection = document.getElementById('scrapingRecommendation');
            if (!data.isViable) {
                scrapingSection.style.display = 'block';

                // Calcular estimativas de scraping
                const leadsFaltantes = Math.max(0, data.criteria.minUniqueLeads - data.totalUniqueLeads);
                const hashtagsFaltantes = Math.max(0, data.criteria.minHashtagsWithFreq5 - data.hashtagsWithFreq5);

                // Estimativa: ~5 leads por perfil scrapado em media
                const perfisNecessarios = Math.ceil(leadsFaltantes / 5);

                // Hashtags a scrapar = top hashtags que ainda nao tem dados suficientes
                const hashtagsAScraper = Math.min(10, data.topHashtags.length);

                document.getElementById('leadsFaltantes').textContent = leadsFaltantes > 0 ? `+${leadsFaltantes.toLocaleString('pt-BR')}` : '0';
                document.getElementById('hashtagsAScraper').textContent = hashtagsAScraper;
                document.getElementById('perfisEstimadosScrape').textContent = perfisNecessarios > 0 ? `~${perfisNecessarios.toLocaleString('pt-BR')}` : '0';
            } else {
                scrapingSection.style.display = 'none';
            }

            // Metricas
            document.getElementById('totalHashtags').textContent = data.totalHashtagsInNiche.toLocaleString('pt-BR');
            document.getElementById('hashtagsFreq5').textContent = data.hashtagsWithFreq5.toLocaleString('pt-BR');
            document.getElementById('uniqueLeads').textContent = data.totalUniqueLeads.toLocaleString('pt-BR');
            document.getElementById('contactRate').textContent = `${data.averageContactRate}%`;

            // Flags agora aparecem APOS o clustering (dentro de clusteringResults)
            // Removido: flagsSection.style.display = data.isViable ? 'grid' : 'none';

            // Top Hashtags Table - ordenar por frequ√™ncia (maior para menor)
            const tbody = document.getElementById('hashtagsTableBody');
            const sortedHashtags = [...data.topHashtags].sort((a, b) => (b.freq_total || 0) - (a.freq_total || 0));
            tbody.innerHTML = sortedHashtags.map((h, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="hashtag-name">#${h.hashtag}</td>
                    <td><strong>${h.freq_total}</strong></td>
                    <td>${h.freq_bio}</td>
                    <td>${h.freq_posts}</td>
                    <td>${h.unique_leads}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="contact-rate-bar">
                                <div class="contact-rate-fill" style="width: ${Math.min(h.contact_rate, 100)}%"></div>
                            </div>
                            <span>${h.contact_rate}%</span>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Mostrar resultados
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        async function generateSearchTerms() {
            if (!currentValidation) {
                alert('Execute a validacao primeiro');
                return;
            }

            const nichoInput = document.getElementById('nichoInput').value.trim();
            const btn = document.getElementById('btnGenerateSearchTerms');
            const resultDiv = document.getElementById('searchTermsResult');

            btn.disabled = true;
            btn.textContent = 'Gerando...';

            try {
                // Extrair hashtags das top do nicho
                const hashtagsRaiz = currentValidation.topHashtags.slice(0, 15).map(h => ({
                    hashtag: h.hashtag,
                    freq: h.freq_total,
                    unique_leads: h.unique_leads,
                    contact_rate: h.contact_rate
                }));

                const payload = {
                    campaign_name: nichoInput,
                    nicho_principal: nichoInput,
                    project_name: 'Scraping Campaign',
                    hashtags_raiz: hashtagsRaiz,
                    cluster_status: currentValidation.isViable ? 'viavel' : 'precisa_dados'
                };

                const response = await fetch(`${API_BASE}/generate-search-terms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="search-terms-success">
                            ‚úÖ ${result.message}<br>
                            <small>ID: ${result.data.id} | Termos: ${result.data.terms_count}</small>
                        </div>
                    `;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao gerar search terms:', error);
                resultDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 8px; padding: 12px; margin-top: 15px;">
                        ‚ùå Erro: ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Gerar Search Terms';
            }
        }

        // ==========================================
        // GERA√á√ÉO DE CONTE√öDO COM GPT-4
        // ==========================================

        let currentPersona = null;
        let currentDMScripts = null;
        let currentCopies = null;

        // Fun√ß√£o para coletar dados do formul√°rio
        function collectFormData() {
            return {
                nicho: document.getElementById('nichoInput').value.trim(),
                service_description: document.getElementById('serviceDescription').value.trim(),
                target_audience: document.getElementById('targetAudience').value.trim(),
                target_details: {
                    age_range: document.getElementById('targetAgeRange')?.value || '',
                    gender: document.getElementById('targetGender')?.value || '',
                    location: document.getElementById('targetLocation')?.value || '',
                    income_class: document.getElementById('targetIncomeClass')?.value || ''
                }
            };
        }

        // ============================================
        // FUN√á√ïES PER CLUSTER (PERSONALIZA√á√ÉO REAL)
        // ============================================

        // Vari√°vel para armazenar subclusters com conte√∫do gerado
        let currentSubclustersContent = null;
        let currentCampaignCopy = null; // Copy √∫nica da campanha (n√£o por cluster)

        // GERAR CONTE√öDO POR CLUSTER (endpoint unificado)
        async function generateContentPerCluster(contentTypes = ['persona', 'dm', 'copy']) {
            if (!currentCampaignId) {
                alert('Salve a campanha primeiro antes de gerar conte√∫do personalizado');
                return;
            }

            if (!currentClusteringResult || !currentClusteringResult.clusters || currentClusteringResult.clusters.length === 0) {
                alert('Execute o Clustering primeiro');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description || !formData.target_audience) {
                alert('Preencha a Descri√ß√£o do Servi√ßo e P√∫blico Alvo');
                return;
            }

            // Atualizar todos os flag cards para loading
            const flags = {
                persona: document.getElementById('flagPersona'),
                dm: document.getElementById('flagDM'),
                copy: document.getElementById('flagCopy')
            };

            const numClusters = currentClusteringResult.clusters.length;

            contentTypes.forEach(type => {
                if (flags[type]) {
                    flags[type].innerHTML = `<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div><div class="flag-sublabel">${numClusters} clusters</div>`;
                    flags[type].style.pointerEvents = 'none';
                }
            });

            try {
                const payload = {
                    campaign_id: currentCampaignId,
                    nicho: formData.nicho,
                    service_description: formData.service_description,
                    target_audience: formData.target_audience,
                    content_types: contentTypes
                };

                const response = await fetch(`${API_BASE}/generate-content-per-cluster`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentSubclustersContent = result.data.clusters;
                    currentCampaignCopy = result.data.campaign_copy; // Copy √∫nica da campanha

                    // Atualizar flags com sucesso
                    contentTypes.forEach(type => {
                        if (flags[type]) {
                            const label = type === 'persona' ? 'Personas' : type === 'dm' ? 'DMs' : 'Copies';
                            // Copy √© √∫nica da campanha, n√£o por cluster
                            const sublabel = type === 'copy' ? '1 √∫nica da campanha' : `${numClusters} personalizados`;
                            flags[type].innerHTML = `<div class="flag-icon">‚úÖ</div><div class="flag-label">${label}</div><div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">${sublabel}</div>`;
                            flags[type].classList.add('flag-completed');
                        }
                    });

                    // Renderizar resultados (clusters + copy √∫nica)
                    renderSubclustersContent(result.data.clusters, contentTypes, result.data.campaign_copy);

                    const copyMsg = result.data.campaign_copy ? '\nüìù Copy √∫nica da campanha: GERADA' : '';
                    alert(`‚úÖ Conte√∫do gerado para ${numClusters} clusters!${copyMsg}\nüìä Tokens usados: ${result.data.total_tokens}`);
                } else {
                    throw new Error(result.message || 'Erro ao gerar conte√∫do');
                }
            } catch (error) {
                console.error('Erro ao gerar conte√∫do por cluster:', error);
                alert('Erro: ' + error.message);

                // Restaurar flags
                contentTypes.forEach(type => {
                    if (flags[type]) {
                        const icon = type === 'persona' ? 'üé≠' : type === 'dm' ? 'üí¨' : 'üìù';
                        const label = type === 'persona' ? 'Persona' : type === 'dm' ? 'Scripts DM' : 'Copies';
                        const sublabel = type === 'persona' ? 'Por cluster' : type === 'dm' ? 'Personalizados' : 'Landing + Ads';
                        flags[type].innerHTML = `<div class="flag-icon">${icon}</div><div class="flag-label">${label}</div><div class="flag-sublabel">${sublabel}</div>`;
                    }
                });
            } finally {
                Object.values(flags).forEach(flag => {
                    if (flag) flag.style.pointerEvents = 'auto';
                });
            }
        }

        // Renderizar conte√∫do dos subclusters
        function renderSubclustersContent(clusters, contentTypes, campaignCopy = null) {
            let html = '';

            // === COPY √öNICA DA CAMPANHA (mostrar se existir, independente do contentTypes) ===
            if (campaignCopy) {
                const c = campaignCopy;
                html += `
                    <div class="campaign-copy-section" style="margin-top: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #92400e; margin-bottom: 15px;">üìù Copy √önica da Campanha</h3>
                        <p style="color: #78350f; font-size: 0.85em; margin-bottom: 15px; opacity: 0.8;">Consolidando insights de ${clusters.length} clusters</p>

                        ${c.landing ? `
                            <div style="background: var(--aic-navy-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h4 style="color: #d97706; margin-bottom: 10px;">üéØ Landing Page</h4>
                                <p style="font-size: 1.2em; font-weight: bold; color: #1e293b;">${c.landing.headline || ''}</p>
                                <p style="color: #64748b; margin-top: 5px;">${c.landing.subheadline || ''}</p>
                                ${c.landing.bullets ? `
                                    <ul style="margin-top: 10px; color: #475569;">
                                        ${c.landing.bullets.map(b => `<li>‚úì ${b}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${c.landing.cta ? `<p style="margin-top: 10px;"><strong>CTA:</strong> <span style="background: #f59e0b; color: #fff; padding: 5px 10px; border-radius: 4px;">${c.landing.cta}</span></p>` : ''}
                            </div>
                        ` : ''}

                        ${c.ads && c.ads.length > 0 ? `
                            <div style="background: var(--aic-navy-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <h4 style="color: #d97706; margin-bottom: 10px;">üì± An√∫ncios</h4>
                                ${c.ads.map(ad => `
                                    <div style="border-left: 3px solid #f59e0b; padding-left: 10px; margin-bottom: 10px;">
                                        <strong>${ad.tipo || 'Ad'}:</strong> ${ad.texto || ''}<br>
                                        <span style="color: #f59e0b; font-size: 0.9em;">${ad.cta || ''}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${c.secoes_dor ? `
                            <div style="background: var(--aic-navy-light); padding: 15px; border-radius: 8px;">
                                <h4 style="color: #d97706; margin-bottom: 10px;">üí° Se√ß√µes Adicionais</h4>
                                <p><strong>Dores:</strong> ${c.secoes_dor.join(' | ')}</p>
                                ${c.secoes_solucao ? `<p><strong>Solu√ß√µes:</strong> ${c.secoes_solucao.join(' | ')}</p>` : ''}
                                ${c.secoes_beneficios ? `<p><strong>Benef√≠cios:</strong> ${c.secoes_beneficios.join(' | ')}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // === PERSONA E DM POR CLUSTER ===
            // Verificar se algum cluster tem conte√∫do (independente do que foi solicitado nessa requisi√ß√£o)
            const hasAnyContent = clusters.some(c => c.persona || c.dm_scripts);
            if (hasAnyContent && clusters.length > 0) {
                html += `
                    <div class="subclusters-content" style="margin-top: 20px;">
                        <h3 style="color: #6366f1; margin-bottom: 15px;">üì¶ Conte√∫do Personalizado por Cluster (${clusters.length} clusters)</h3>
                        <div style="display: grid; gap: 15px;">
                `;

                clusters.forEach((cluster, index) => {
                    // Verificar se tem conte√∫do para mostrar (independente do contentTypes solicitado)
                    const hasContent = cluster.persona || cluster.dm_scripts;
                    if (!hasContent) return;

                    html += `
                        <details class="cluster-content-card" style="background: var(--aic-navy); border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #1e293b;">
                                üìç ${cluster.cluster_name} <span style="color: #64748b; font-weight: normal;">(${cluster.total_leads} leads)</span>
                            </summary>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    `;

                    // Persona (mostrar se existir, independente do contentTypes)
                    if (cluster.persona) {
                        const p = cluster.persona;
                        html += `
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #8b5cf6; margin-bottom: 8px;">üé≠ Persona: ${p.nome || 'N/A'}</h4>
                                <p style="color: #64748b; font-size: 0.9em;">${p.perfil || ''}</p>
                                <ul style="color: #475569; font-size: 0.85em; margin-top: 8px;">
                                    <li><strong>Dores:</strong> ${(p.dores_principais || []).join(', ')}</li>
                                    <li><strong>Gatilhos:</strong> ${(p.gatilhos_conversao || []).join(', ')}</li>
                                    <li><strong>Tom:</strong> ${p.tom_comunicacao || 'N/A'}</li>
                                </ul>
                            </div>
                        `;
                    }

                    // DM Scripts (mostrar se existir, independente do contentTypes)
                    if (cluster.dm_scripts) {
                        const scripts = cluster.dm_scripts.scripts || [];
                        html += `
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #06b6d4; margin-bottom: 8px;">üí¨ Scripts de DM (${scripts.length})</h4>
                                ${scripts.map((s, i) => `
                                    <div style="background: var(--aic-navy-light); padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #06b6d4;">
                                        <strong>${s.nome || `Script ${i + 1}`}</strong><br>
                                        <em style="color: #64748b; font-size: 0.85em;">Abertura:</em> ${s.abertura || ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </details>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // Inserir ap√≥s os resultados do clustering
            const clusteringResults = document.getElementById('clusteringResults');
            let subclustersDiv = document.getElementById('subclustersContentDiv');
            if (!subclustersDiv) {
                subclustersDiv = document.createElement('div');
                subclustersDiv.id = 'subclustersContentDiv';
                clusteringResults.appendChild(subclustersDiv);
            }
            subclustersDiv.innerHTML = html;
        }

        // GERAR APENAS PERSONAS POR SUBCLUSTER
        async function generatePersonaPerCluster() {
            await generateContentPerCluster(['persona']);
        }

        // GERAR APENAS DMs POR SUBCLUSTER
        async function generateDMPerCluster() {
            await generateContentPerCluster(['dm']);
        }

        // GERAR APENAS COPIES POR SUBCLUSTER
        async function generateCopyPerCluster() {
            await generateContentPerCluster(['copy']);
        }

        // GERAR TUDO POR SUBCLUSTER (bot√£o principal)
        async function generateAllContentPerCluster() {
            await generateContentPerCluster(['persona', 'dm', 'copy']);
        }

        // ============================================
        // CAPTURAR LEADS E ASSOCIAR AOS CLUSTERS
        // ============================================

        // Vari√°vel para armazenar resultado da captura
        let currentCapturedLeads = null;

        // CAPTURAR LEADS E ASSOCIAR AOS SUBCLUSTERS
        async function captureLeadsPerCluster() {
            if (!currentCampaignId) {
                alert('Salve a campanha primeiro antes de capturar leads');
                return;
            }

            if (!currentClusteringResult || !currentClusteringResult.clusters || currentClusteringResult.clusters.length === 0) {
                alert('Execute o Clustering primeiro');
                return;
            }

            // Verificar se tem personas, DMs e copy geradas
            const hasPersonas = currentSubclustersContent && currentSubclustersContent.some(c => c.persona);
            const hasDms = currentSubclustersContent && currentSubclustersContent.some(c => c.dm_scripts);
            const hasCopy = !!currentCampaignCopy;
            if (!hasPersonas || !hasDms || !hasCopy) {
                alert('Gere personas, DMs e a copy da campanha antes de capturar leads.');
                return;
            }

            const flagCapture = document.getElementById('flagCapture');
            if (flagCapture) {
                flagCapture.innerHTML = `<div class="flag-icon">‚è≥</div><div class="flag-label">Capturando...</div><div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">aguarde</div>`;
                flagCapture.style.pointerEvents = 'none';
            }

            try {
                const response = await fetch(`/api/hashtag-intelligence/campaign/${currentCampaignId}/capture-leads`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        only_with_contact: false
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentCapturedLeads = result.data;

                    // Atualizar flag com sucesso
                    if (flagCapture) {
                        flagCapture.innerHTML = `<div class="flag-icon">‚úÖ</div><div class="flag-label">Leads Capturados</div><div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">${result.data.captured} leads</div>`;
                        flagCapture.style.pointerEvents = 'auto';
                    }

                    // Renderizar estat√≠sticas por cluster
                    renderCapturedLeadsStats(result.data);

                    alert(`‚úÖ ${result.data.captured} leads capturados e associados aos clusters!\n\nAgora voc√™ pode iniciar o Outreach personalizado.`);
                } else {
                    throw new Error(result.message || 'Erro ao capturar leads');
                }
            } catch (error) {
                console.error('Erro ao capturar leads:', error);
                alert(`Erro: ${error.message}`);

                if (flagCapture) {
                    flagCapture.innerHTML = `<div class="flag-icon">‚ùå</div><div class="flag-label">Erro</div><div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">clique para tentar</div>`;
                    flagCapture.style.pointerEvents = 'auto';
                }
            }
        }

        // CAPTURAR LEADS DE UM CLUSTER ESPEC√çFICO
        async function captureClusterLeads(clusterId, clusterName) {
            if (!currentCampaignId) {
                alert('Salve a campanha primeiro antes de capturar leads');
                return;
            }

            const hasPersonas = currentSubclustersContent && currentSubclustersContent.some(c => c.persona);
            const hasDms = currentSubclustersContent && currentSubclustersContent.some(c => c.dm_scripts);
            const hasCopy = !!currentCampaignCopy;
            if (!hasPersonas || !hasDms || !hasCopy) {
                alert('Gere personas, DMs e a copy da campanha antes de capturar leads.');
                return;
            }

            // Confirmar captura
            const proceed = confirm(`Capturar leads do cluster "${clusterName}"?\n\nAp√≥s capturar, este cluster ser√° bloqueado para edi√ß√£o.`);
            if (!proceed) return;

            // Encontrar o bot√£o e desabilitar
            const card = document.querySelector(`.cluster-card[data-cluster-id="${clusterId}"]`);
            const btn = card?.querySelector('.cluster-capture-btn');
            if (btn) {
                btn.innerHTML = '‚è≥ Capturando...';
                btn.disabled = true;
            }

            try {
                const response = await fetch(`/api/hashtag-intelligence/campaign/${currentCampaignId}/capture-leads`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cluster_ids: [clusterId],
                        only_with_contact: false
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Atualizar card para mostrar como bloqueado
                    if (card) {
                        card.classList.add('cluster-blocked');
                        const header = card.querySelector('.cluster-card-header');
                        if (header && !card.querySelector('.cluster-blocked-badge')) {
                            header.insertAdjacentHTML('afterend', '<div class="cluster-blocked-badge">üîí Em Outreach</div>');
                        }
                    }
                    if (btn) {
                        btn.innerHTML = 'üîí Bloqueado';
                        btn.classList.add('disabled');
                    }

                    // Atualizar currentSubclusters para refletir mudan√ßa
                    if (currentSubclusters) {
                        const sc = currentSubclusters.find(s => s.cluster_index === clusterId);
                        if (sc) sc.status = 'in_outreach';
                    }

                    alert(`‚úÖ ${result.data.captured} leads capturados do cluster "${clusterName}"!\n\nCluster bloqueado para edi√ß√£o.`);

                    // Recarregar subclusters para atualizar estado
                    await loadGeneratedContent(currentCampaignId);
                } else {
                    throw new Error(result.message || 'Erro ao capturar leads');
                }
            } catch (error) {
                console.error('Erro ao capturar leads do cluster:', error);
                alert(`Erro: ${error.message}`);

                if (btn) {
                    btn.innerHTML = '‚ûï Capturar Leads';
                    btn.disabled = false;
                }
            }
        }

        // Renderizar estat√≠sticas de leads capturados por cluster
        function renderCapturedLeadsStats(captureData) {
            if (!captureData || !captureData.by_cluster) return;

            let html = `
                <div class="captured-leads-section" style="margin-top: 20px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #10b981; border-radius: 12px; padding: 20px;">
                    <h3 style="color: var(--aic-green); margin-bottom: 15px;">üéØ Leads Capturados: ${captureData.captured} total</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            `;

            for (const [clusterId, stats] of Object.entries(captureData.by_cluster)) {
                const hasPersona = stats.has_persona ? '‚úÖ' : '‚ö†Ô∏è';
                const personaLabel = stats.has_persona ? 'Com Persona' : 'Sem Persona';

                html += `
                    <div style="background: var(--aic-navy-light); padding: 12px; border-radius: 8px; border-left: 4px solid ${stats.has_persona ? '#10b981' : '#f59e0b'};">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">üìç ${stats.name}</div>
                        <div style="font-size: 1.5em; color: #059669; font-weight: bold;">${stats.count}</div>
                        <div style="font-size: 0.8em; color: #64748b;">${hasPersona} ${personaLabel}</div>
                    </div>
                `;
            }

            html += `
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #10b981;">
                        <button onclick="startOutreach()" style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üöÄ Iniciar Outreach
                        </button>
                    </div>
                </div>
            `;

            // Inserir ap√≥s os resultados do clustering
            const clusteringResults = document.getElementById('clusteringResults');
            let capturedDiv = document.getElementById('capturedLeadsDiv');
            if (!capturedDiv) {
                capturedDiv = document.createElement('div');
                capturedDiv.id = 'capturedLeadsDiv';
                clusteringResults.appendChild(capturedDiv);
            }
            capturedDiv.innerHTML = html;
        }

        // Ver lista de leads capturados
        async function viewCapturedLeads() {
            if (!currentCampaignId) return;

            // Abrir em nova aba ou modal
            window.open(`/api/hashtag-intelligence/campaign/${currentCampaignId}/leads?limit=100`, '_blank');
        }

        // Iniciar outreach (placeholder)
        function startOutreach() {
            alert('üöÄ Funcionalidade de Outreach em desenvolvimento!\n\nPor enquanto, use os workflows N8N:\n- Unified Outreach Sender\n- Response Handler');
        }

        // ============================================
        // FUN√á√ïES LEGADAS (mantidas para compatibilidade)
        // ============================================

        // GERAR COPIES LEGADO (chama endpoint antigo se necess√°rio)
        async function generateCopyLegacy() {
            if (!currentClusteringResult || !currentClusteringResult.clusters || currentClusteringResult.clusters.length === 0) {
                alert('Execute o Clustering primeiro para gerar Copies por subcluster');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description) {
                alert('Preencha a Descricao do Servico antes de gerar copies');
                return;
            }

            const flagCard = document.getElementById('flagCopy');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div><div class="flag-sublabel">' + currentClusteringResult.clusters.length + ' subclusters</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    persona: currentPersona,
                    clusters: currentClusteringResult.clusters,
                    copy_type: 'all',
                    generate_per_cluster: true // Flag para API gerar por subcluster
                };

                const response = await fetch(`${API_BASE}/generate-copy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentCopies = result.data.copies;
                    showGeneratedContent('copy', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Copies Gerados</div><div class="flag-sublabel" style="font-size: 0.75em; opacity: 0.8;">' + currentClusteringResult.clusters.length + ' subclusters</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar copies');
                }
            } catch (error) {
                console.error('Erro ao gerar copies:', error);
                alert('Erro ao gerar copies: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // ============================================
        // FUN√á√ïES LEGADAS (mantidas para compatibilidade)
        // ============================================

        // GERAR PERSONA (legado - usa generatePersonaPerCluster se clustering disponivel)
        async function generatePersona() {
            if (currentClusteringResult && currentClusteringResult.clusters && currentClusteringResult.clusters.length > 0) {
                return generatePersonaPerCluster();
            }

            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para gerar persona');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description || !formData.target_audience) {
                alert('Preencha a Descricao do Servico e Publico Alvo antes de gerar a persona');
                return;
            }

            const flagCard = document.getElementById('flagPersona');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    clusters: currentClusteringResult?.clusters || [],
                    top_hashtags: currentValidation.topHashtags,
                    total_leads: currentValidation.totalUniqueLeads,
                    contact_rate: currentValidation.averageContactRate
                };

                const response = await fetch(`${API_BASE}/generate-persona`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentPersona = result.data.persona;
                    showGeneratedContent('persona', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Persona Gerada</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar persona');
                }
            } catch (error) {
                console.error('Erro ao gerar persona:', error);
                alert('Erro ao gerar persona: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // GERAR DM
        async function generateDM() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para gerar DM');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description) {
                alert('Preencha a Descricao do Servico antes de gerar scripts de DM');
                return;
            }

            const flagCard = document.getElementById('flagDM');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    persona: currentPersona,
                    clusters: currentClusteringResult?.clusters || [],
                    tone: 'profissional-amigavel'
                };

                const response = await fetch(`${API_BASE}/generate-dm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentDMScripts = result.data.dm_scripts;
                    showGeneratedContent('dm', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">DM Gerado</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar DM');
                }
            } catch (error) {
                console.error('Erro ao gerar DM:', error);
                alert('Erro ao gerar DM: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // GERAR COPY
        async function generateCopy() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para gerar Copy');
                return;
            }

            const formData = collectFormData();
            if (!formData.service_description) {
                alert('Preencha a Descricao do Servico antes de gerar copies');
                return;
            }

            const flagCard = document.getElementById('flagCopy');
            const originalHTML = flagCard.innerHTML;
            flagCard.innerHTML = '<div class="flag-icon">‚è≥</div><div class="flag-label">Gerando...</div>';
            flagCard.style.pointerEvents = 'none';

            try {
                const payload = {
                    ...formData,
                    campaign_id: currentCampaignId || undefined,
                    persona: currentPersona,
                    clusters: currentClusteringResult?.clusters || [],
                    copy_type: 'all'
                };

                const response = await fetch(`${API_BASE}/generate-copy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    currentCopies = result.data.copies;
                    showGeneratedContent('copy', result.data);
                    flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Copy Gerado</div>';
                    flagCard.classList.add('flag-completed');
                } else {
                    throw new Error(result.message || 'Erro ao gerar Copy');
                }
            } catch (error) {
                console.error('Erro ao gerar Copy:', error);
                alert('Erro ao gerar Copy: ' + error.message);
                flagCard.innerHTML = originalHTML;
            } finally {
                flagCard.style.pointerEvents = 'auto';
            }
        }

        // Exibir conte√∫do gerado
        function showGeneratedContent(type, data) {
            const section = document.getElementById('generatedContentSection');
            section.style.display = 'block';

            const container = document.getElementById('generatedContentContainer');

            // Criar card para o conte√∫do
            const cardId = `generated-${type}`;
            let card = document.getElementById(cardId);

            if (!card) {
                card = document.createElement('div');
                card.id = cardId;
                card.className = 'generated-content-card';
                container.appendChild(card);
            }

            const titles = {
                persona: 'üé≠ Persona ICP',
                dm: '‚úâÔ∏è Scripts de DM',
                copy: 'üìù Pack de Copies'
            };

            const contents = {
                persona: data.persona,
                dm: data.dm_scripts,
                copy: data.copies
            };

            // Converter markdown simples para HTML
            const htmlContent = convertMarkdownToHTML(contents[type]);

            card.innerHTML = `
                <div class="generated-content-header">
                    <h3>${titles[type]}</h3>
                    <div class="generated-meta">
                        <span>Modelo: ${data.model}</span>
                        <span>Tokens: ${data.tokens_used}</span>
                        <button class="btn-copy-content" onclick="copyToClipboard('${cardId}-content')">üìã Copiar</button>
                    </div>
                </div>
                <div id="${cardId}-content" class="generated-content-body">
                    ${htmlContent}
                </div>
            `;

            // Scroll para a se√ß√£o
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Converter markdown b√°sico para HTML
        function convertMarkdownToHTML(markdown) {
            if (!markdown) return '';

            return markdown
                // Headers
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre class="code-block">$1</pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Lists
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        // Copiar conte√∫do para clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.innerText;

            navigator.clipboard.writeText(text).then(() => {
                alert('Conteudo copiado para a area de transferencia!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Conteudo copiado!');
            });
        }

        // Reset flags quando nova valida√ß√£o √© feita
        function resetGenerationFlags() {
            currentPersona = null;
            currentDMScripts = null;
            currentCopies = null;

            const flags = ['flagPersona', 'flagDM', 'flagCopy'];
            const icons = ['üë§', '‚úâÔ∏è', 'üìù'];
            const labels = ['Gerar Persona', 'Gerar DM', 'Gerar Copy'];

            flags.forEach((id, i) => {
                const flag = document.getElementById(id);
                if (flag) {
                    flag.innerHTML = `<div class="flag-icon">${icons[i]}</div><div class="flag-label">${labels[i]}</div>`;
                    flag.classList.remove('flag-completed');
                }
            });

            // Esconder se√ß√£o de conte√∫do gerado
            const section = document.getElementById('generatedContentSection');
            if (section) {
                section.style.display = 'none';
                document.getElementById('generatedContentContainer').innerHTML = '';
            }
        }

        // ==========================================
        // SISTEMA DE DROPDOWNS EM CASCATA
        // ==========================================

        // Cache de dados carregados
        let clientsData = [];
        let projectsData = [];
        let campaignsData = [];
        let currentCampaignId = null;
        // Armazenar nomes da campanha carregada para upsert
        let loadedClientName = null;
        let loadedProjectName = null;
        let loadedCampaignName = null;
        // Armazenar hashtags sugeridas para scraping (usadas pelo bot√£o Gerar Search Terms)
        let currentSuggestedHashtags = [];

        // Status da campanha (pipeline lifecycle)
        let currentCampaignStatus = null;
        let campaignEditable = true;

        // Configura√ß√£o de status (cores AIC)
        const STATUS_CONFIG = {
            'draft': { label: 'Rascunho', color: '#3b82f6', bgColor: 'rgba(59, 130, 246, 0.15)', icon: 'üìù', message: 'Pode editar clustering, leads e conte√∫do' },
            'ready': { label: 'Pronto', color: '#0ECC97', bgColor: 'rgba(14, 204, 151, 0.15)', icon: '‚úÖ', message: 'Bloqueado - Pronto para iniciar outreach' },
            'ready_for_outreach': { label: 'Pronto p/ Outreach', color: '#0ECC97', bgColor: 'rgba(14, 204, 151, 0.15)', icon: '‚úÖ', message: 'Bloqueado - Pronto para iniciar outreach' },
            'active': { label: 'Em Andamento', color: '#f59e0b', bgColor: 'rgba(245, 158, 11, 0.15)', icon: 'üöÄ', message: 'Outreach em execu√ß√£o' },
            'completed': { label: 'Conclu√≠do', color: '#94a3b8', bgColor: 'rgba(148, 163, 184, 0.15)', icon: 'üèÅ', message: 'Campanha finalizada' },
            'paused': { label: 'Pausado', color: '#ef4444', bgColor: 'rgba(239, 68, 68, 0.15)', icon: '‚è∏Ô∏è', message: 'Temporariamente pausado' }
        };

        // Carregar status da campanha
        async function loadCampaignStatus(campaignId) {
            if (!campaignId) {
                hideCampaignStatus();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/campaign/${campaignId}/status`);
                const result = await response.json();

                if (result.success) {
                    currentCampaignStatus = result.data.status;

                    // Verificar se todos subclusters est√£o bloqueados (leads capturados)
                    // Se sim, campanha n√£o √© mais edit√°vel independente do status do backend
                    const allSubclustersBlocked = currentSubclusters && currentSubclusters.length > 0 &&
                        currentSubclusters.every(sc => sc.status === 'in_outreach' || sc.status === 'completed');

                    campaignEditable = allSubclustersBlocked ? false : result.data.editable;

                    displayCampaignStatus(result.data);
                    updateButtonsState();
                }
            } catch (error) {
                console.error('Erro ao carregar status:', error);
            }
        }

        // Exibir status da campanha
        function displayCampaignStatus(statusData) {
            const indicator = document.getElementById('campaignStatusIndicator');
            const badge = document.getElementById('campaignStatusBadge');
            const message = document.getElementById('campaignStatusMessage');
            const actions = document.getElementById('campaignStatusActions');
            const lockedAlert = document.getElementById('campaignLockedAlert');

            const config = STATUS_CONFIG[statusData.status] || STATUS_CONFIG['draft'];

            indicator.style.display = 'block';
            indicator.style.borderColor = config.color;
            indicator.style.background = config.bgColor;

            badge.textContent = `${config.icon} ${config.label}`;
            badge.style.background = config.color;
            badge.style.color = 'white';

            message.textContent = config.message;

            // Mostrar/ocultar alerta de bloqueio
            lockedAlert.style.display = statusData.editable ? 'none' : 'block';

            // Gerar bot√µes de a√ß√£o baseado no status
            let actionsHtml = '';
            if (statusData.status === 'draft' && statusData.has_clustering && statusData.has_leads) {
                actionsHtml = `<button onclick="changeCampaignStatus('ready')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">üîí Finalizar Prepara√ß√£o</button>`;
            } else if (statusData.status === 'ready' || statusData.status === 'ready_for_outreach') {
                actionsHtml = `
                    <button onclick="changeCampaignStatus('draft')" style="background: #6b7280; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 8px;">‚Ü©Ô∏è Voltar p/ Edi√ß√£o</button>
                    <button onclick="changeCampaignStatus('active')" style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">üöÄ Iniciar Outreach</button>
                `;
            } else if (statusData.status === 'active') {
                actionsHtml = `
                    <button onclick="changeCampaignStatus('paused')" style="background: #f59e0b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 8px;">‚è∏Ô∏è Pausar</button>
                    <button onclick="changeCampaignStatus('completed')" style="background: #6b7280; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">üèÅ Finalizar</button>
                `;
            } else if (statusData.status === 'paused') {
                actionsHtml = `
                    <button onclick="changeCampaignStatus('active')" style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 8px;">‚ñ∂Ô∏è Retomar</button>
                    <button onclick="changeCampaignStatus('completed')" style="background: #6b7280; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">üèÅ Finalizar</button>
                `;
            }
            actions.innerHTML = actionsHtml;
        }

        // Ocultar indicador de status
        function hideCampaignStatus() {
            document.getElementById('campaignStatusIndicator').style.display = 'none';
            currentCampaignStatus = null;
            campaignEditable = true;
            updateButtonsState();
        }

        // Alterar status da campanha
        async function changeCampaignStatus(newStatus) {
            if (!currentCampaignId) return;

            const confirmMessages = {
                'ready': 'üîí Ao finalizar a prepara√ß√£o, voc√™ n√£o poder√° mais editar clustering ou capturar novos leads.\n\nDeseja continuar?',
                'active': 'üöÄ Iniciar o outreach ir√° come√ßar a enviar mensagens para os leads.\n\nDeseja continuar?',
                'completed': 'üèÅ Marcar como conclu√≠da ir√° encerrar a campanha permanentemente.\n\nDeseja continuar?',
                'draft': '‚Ü©Ô∏è Voltar para rascunho permitir√° editar clustering e leads novamente.\n\nDeseja continuar?'
            };

            if (confirmMessages[newStatus] && !confirm(confirmMessages[newStatus])) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/campaign/${currentCampaignId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    await loadCampaignStatus(currentCampaignId);
                } else {
                    alert(`‚ùå ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                alert('‚ùå Erro ao alterar status da campanha');
            }
        }

        // Atualizar estado dos bot√µes baseado no status da campanha
        function updateButtonsState() {
            const editable = campaignEditable;

            // Bot√µes que devem ser OCULTOS quando n√£o edit√°vel
            const editableButtons = [
                'btnExecuteClustering',  // Bot√£o de clustering
                'saveCampaignBtn',       // Bot√£o de salvar campanha
                'analyzeBtn',            // Bot√£o de validar nicho
                'flagCapture',           // Bot√£o de captura de leads
                'flagPersona',           // Bot√£o de gerar personas
                'flagDM',                // Bot√£o de gerar DMs
                'flagCopy'               // Bot√£o de gerar copies
            ];

            editableButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    // Ocultar completamente quando n√£o edit√°vel
                    btn.style.display = editable ? '' : 'none';
                }
            });

            // Tamb√©m ocultar a se√ß√£o de flags inteira se n√£o edit√°vel
            const flagsSection = document.getElementById('flagsSection');
            if (flagsSection) {
                flagsSection.style.display = editable ? '' : 'none';
            }

            // Alternar entre se√ß√£o de salvar e se√ß√£o bloqueada
            const saveSection = document.getElementById('saveSection');
            const saveSectionBlocked = document.getElementById('saveSectionBlocked');

            if (editable) {
                // Campanha edit√°vel: mostrar bot√£o de salvar, ocultar bloqueado
                if (saveSection) saveSection.style.display = '';
                if (saveSectionBlocked) saveSectionBlocked.style.display = 'none';
            } else {
                // Campanha bloqueada: ocultar bot√£o de salvar, mostrar bloqueado
                if (saveSection) saveSection.style.display = 'none';
                if (saveSectionBlocked) saveSectionBlocked.style.display = 'block';
            }
        }

        // Armazenar dados dos subclusters para visualiza√ß√£o
        let subclustersData = [];

        // Carregar conte√∫do gerado dos subclusters
        async function loadGeneratedContent(campaignId) {
            if (!campaignId) return;

            try {
                const response = await fetch(`${API_BASE}/campaign/${campaignId}/subclusters`);
                const result = await response.json();

                if (result.success && result.data && result.data.subclusters) {
                    subclustersData = result.data.subclusters;
                    currentSubclusters = result.data.subclusters; // Para verificar status nos cards

                    // Verificar se TODOS os clusters est√£o bloqueados (leads j√° capturados)
                    const allBlocked = subclustersData.length > 0 && subclustersData.every(sc =>
                        sc.status === 'in_outreach' || sc.status === 'completed'
                    );

                    // Se todos bloqueados, marcar campanha como n√£o-edit√°vel
                    // Isso garante que updateButtonsState() manter√° os bot√µes ocultos
                    if (allBlocked) {
                        campaignEditable = false;

                        // Atualizar badge de status para mostrar que est√° em outreach
                        const statusBadge = document.getElementById('clusteringStatusBadge');
                        if (statusBadge) {
                            statusBadge.className = 'clustering-status completed';
                            statusBadge.innerHTML = 'üîí Leads Capturados - Em Outreach';
                        }

                        // Atualizar estado dos bot√µes imediatamente
                        updateButtonsState();
                    }

                    // Re-renderizar cards de cluster AGORA que temos currentSubclusters
                    // Isso garante que os bot√µes de captura n√£o apare√ßam nos cards bloqueados
                    if (currentClusteringResult) {
                        renderClusteringResults(currentClusteringResult);
                    }

                    // Verificar se h√° conte√∫do gerado
                    const hasContent = subclustersData.some(sc => sc.persona || sc.dm_scripts || sc.copies);

                    if (hasContent) {
                        document.getElementById('generatedContentSection').style.display = 'block';
                        renderPersonasContent();
                        renderDmsContent();
                        renderCopiesContent();
                        renderLeadsContent(campaignId);
                    } else {
                        document.getElementById('generatedContentSection').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar conte√∫do gerado:', error);
            }
        }

        // Alternar entre tabs de conte√∫do
        function showContentTab(tabName) {
            // Atualizar bot√µes
            document.querySelectorAll('.content-tab').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.style.background = isActive ? '#667eea' : 'white';
                btn.style.color = isActive ? 'white' : '#667eea';
            });

            // Atualizar paineis
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            const panelId = 'content' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            document.getElementById(panelId).style.display = 'block';
        }

        // Renderizar Personas
        function renderPersonasContent() {
            const container = document.getElementById('contentPersonas');

            const personasHtml = subclustersData.map(sc => {
                if (!sc.persona) return '';
                const p = sc.persona;
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--aic-green); margin: 0;">üë§ ${p.nome || 'Persona'}</h4>
                            <span style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">${sc.cluster_name}</span>
                        </div>
                        <p style="color: #64748b; margin-bottom: 15px;">${p.perfil || ''}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="background: var(--aic-navy); padding: 12px; border-radius: 8px;">
                                <strong style="color: #334155;">üéØ Objetivos:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #64748b;">
                                    ${(p.objetivos || []).map(o => `<li>${o}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.15); padding: 12px; border-radius: 8px;">
                                <strong style="color: #f87171;">üíî Dores:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #64748b;">
                                    ${(p.dores_principais || []).map(d => `<li>${d}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="background: rgba(14, 204, 151, 0.1); padding: 12px; border-radius: 8px;">
                                <strong style="color: #166534;">‚ö° Gatilhos de Convers√£o:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #64748b;">
                                    ${(p.gatilhos_conversao || []).map(g => `<li>${g}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; color: #64748b; font-size: 0.9em;">
                            <span>üìÖ <strong>Idade:</strong> ${p.idade_tipica || 'N/A'}</span>
                            <span>üïê <strong>Hor√°rios ativos:</strong> ${p.horarios_ativos || 'N/A'}</span>
                            <span>üí¨ <strong>Tom:</strong> ${p.tom_comunicacao || 'N/A'}</span>
                        </div>
                    </div>
                `;
            }).filter(html => html).join('');

            container.innerHTML = personasHtml || '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhuma persona gerada ainda.</p>';
        }

        // Renderizar Scripts DM
        function renderDmsContent() {
            const container = document.getElementById('contentDms');

            const dmsHtml = subclustersData.map(sc => {
                if (!sc.dm_scripts || !sc.dm_scripts.scripts) return '';
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: var(--aic-green); margin: 0;">‚úâÔ∏è Scripts DM</h4>
                            <span style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">${sc.cluster_name}</span>
                        </div>
                        <div style="display: grid; gap: 15px;">
                            ${sc.dm_scripts.scripts.map((script, idx) => `
                                <div style="background: var(--aic-navy); padding: 15px; border-radius: 8px; border-left: 4px solid var(--aic-green);">
                                    <strong style="color: #334155;">üìå ${script.nome || 'Script ' + (idx + 1)}</strong>
                                    <div style="margin-top: 10px;">
                                        <p style="margin: 8px 0;"><strong style="color: #10b981;">Abertura:</strong> <span style="color: #64748b;">${script.abertura || ''}</span></p>
                                        <p style="margin: 8px 0;"><strong style="color: #f59e0b;">Proposta:</strong> <span style="color: #64748b;">${script.proposta || ''}</span></p>
                                        <p style="margin: 8px 0;"><strong style="color: #6366f1;">Follow-up:</strong> <span style="color: #64748b;">${script.follow_up || ''}</span></p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).filter(html => html).join('');

            container.innerHTML = dmsHtml || '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum script DM gerado ainda.</p>';
        }

        // Renderizar Copies
        function renderCopiesContent() {
            const container = document.getElementById('contentCopies');

            // Pegar copies do primeiro cluster que tiver (geralmente s√£o iguais para toda campanha)
            const scWithCopies = subclustersData.find(sc => sc.copies);

            if (!scWithCopies || !scWithCopies.copies) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhuma copy gerada ainda.</p>';
                return;
            }

            const copies = scWithCopies.copies;
            container.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: rgba(245, 158, 11, 0.15); padding: 15px; border-radius: 8px;">
                            <h5 style="color: #92400e; margin: 0 0 10px 0;">üé£ Hooks</h5>
                            <ul style="margin: 0; padding-left: 20px; color: #78350f;">
                                ${(copies.hooks || []).map(h => `<li style="margin: 5px 0;">${h}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.15); padding: 15px; border-radius: 8px;">
                            <h5 style="color: #1e40af; margin: 0 0 10px 0;">üíé Value Propositions</h5>
                            <ul style="margin: 0; padding-left: 20px; color: #1e3a8a;">
                                ${(copies.value_propositions || []).map(v => `<li style="margin: 5px 0;">${v}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: rgba(14, 204, 151, 0.15); padding: 15px; border-radius: 8px;">
                            <h5 style="color: var(--aic-green); margin: 0 0 10px 0;">üì¢ CTAs</h5>
                            <ul style="margin: 0; padding-left: 20px; color: #064e3b;">
                                ${(copies.ctas || []).map(c => `<li style="margin: 5px 0;">${c}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.15); padding: 15px; border-radius: 8px;">
                            <h5 style="color: #5b21b6; margin: 0 0 10px 0;"># Hashtags Recomendadas</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${(copies.hashtags_recomendadas || []).map(h => `<span style="background: #c4b5fd; color: #4c1d95; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">${h}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar Leads por Cluster
        async function renderLeadsContent(campaignId) {
            const container = document.getElementById('contentLeads');

            try {
                const response = await fetch(`${API_BASE}/campaign/${campaignId}/leads-by-cluster`);
                const result = await response.json();

                if (result.success && result.data && result.data.clusters) {
                    const clusters = result.data.clusters;
                    const leadsHtml = clusters.map(cluster => {
                        const clusterNameRaw = cluster.cluster_name || 'Cluster ' + (cluster.cluster_index ?? '');
                        const clusterName = escapeHTML(clusterNameRaw);
                        const totalLeads = Number(cluster.total_leads || 0);
                        const leadRows = (cluster.leads || []).slice(0, 50).map(lead => {
                            const username = escapeHTML(lead.username || '');
                            const fullName = escapeHTML(lead.full_name || '');
                            const score = Number(lead.fit_score || 0);
                            const hasContact = Boolean(lead.phone || lead.email);
                            return `
                                            <tr>
                                                <td style="padding: 8px; border-bottom: 1px solid #f1f5f9;">@${username}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #f1f5f9;">${fullName}</td>
                                                <td style="padding: 8px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                                                    ${hasContact ? '<span style="color: #10b981;">‚úÖ</span>' : '<span style="color: #94a3b8;">-</span>'}
                                                </td>
                                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #f1f5f9;">${score.toFixed(0)}</td>
                                            </tr>
                            `;
                        }).join('');

                        return `
                        <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #10b981; margin: 0;">üéØ ${clusterName}</h4>
                                <span style="background: rgba(14, 204, 151, 0.15); color: var(--aic-green); padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">${totalLeads} leads</span>
                            </div>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; min-width: 520px;">
                                    <thead>
                                        <tr style="background: var(--aic-navy);">
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">Username</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">Nome</th>
                                            <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e2e8f0;">Contato</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${leadRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    }).join('');

                    container.innerHTML = leadsHtml || '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum lead capturado ainda.</p>';
                } else {
                    container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum lead capturado ainda.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar leads:', error);
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Erro ao carregar leads.</p>';
            }
        }

        // Carregar lista de clientes ao inicializar
        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/clients`);
                const result = await response.json();

                if (result.success) {
                    clientsData = result.data || [];
                    const clientSelect = document.getElementById('clientSelect');
                    clientSelect.innerHTML = `
                        <option value="">-- Selecione ou crie novo --</option>
                        <option value="__NEW__">+ Novo Cliente</option>
                        ${clientsData.map(client => `<option value="${client}">${client}</option>`).join('')}
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar canais Whapi dispon√≠veis
        async function loadWhapiChannels() {
            try {
                const response = await fetch(`${API_BASE}/whapi-channels`);
                const result = await response.json();

                if (result.success) {
                    const channelSelect = document.getElementById('whapiChannelSelect');
                    const channels = result.data || [];
                    channelSelect.innerHTML = `
                        <option value="">-- Selecione um canal --</option>
                        ${channels.map(ch => `<option value="${ch.id}">${ch.name} (${ch.phone_number || ch.channel_id})</option>`).join('')}
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar canais Whapi:', error);
            }
        }

        // Quando cliente √© selecionado
        async function onClientChange() {
            const clientSelect = document.getElementById('clientSelect');
            const clientNameInput = document.getElementById('clientNameInput');
            const projectSelect = document.getElementById('projectSelect');
            const projectNameInput = document.getElementById('projectNameInput');
            const campaignSelect = document.getElementById('campaignSelect');
            const campaignNameInput = document.getElementById('campaignNameInput');

            const selectedClient = clientSelect.value;

            // Reset projetos e campanhas
            projectSelect.innerHTML = '<option value="">-- Selecione projeto --</option>';
            projectSelect.disabled = true;
            projectNameInput.style.display = 'none';
            projectNameInput.value = '';

            campaignSelect.innerHTML = '<option value="">-- Selecione projeto primeiro --</option>';
            campaignSelect.disabled = true;
            campaignNameInput.style.display = 'none';
            campaignNameInput.value = '';

            hideEditMode();

            if (selectedClient === '__NEW__') {
                clientNameInput.style.display = 'block';
                clientNameInput.focus();
                projectSelect.disabled = false;
                projectSelect.innerHTML = `
                    <option value="">-- Selecione ou crie novo --</option>
                    <option value="__NEW__">+ Novo Projeto</option>
                `;
            } else if (selectedClient) {
                clientNameInput.style.display = 'none';
                clientNameInput.value = '';
                await loadProjects(selectedClient);
            } else {
                clientNameInput.style.display = 'none';
                clientNameInput.value = '';
            }
        }

        // Carregar projetos de um cliente
        async function loadProjects(clientName) {
            const projectSelect = document.getElementById('projectSelect');
            projectSelect.disabled = true;
            projectSelect.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`${API_BASE}/projects?client_name=${encodeURIComponent(clientName)}`);
                const result = await response.json();

                if (result.success) {
                    projectsData = result.data || [];
                    projectSelect.innerHTML = `
                        <option value="">-- Selecione ou crie novo --</option>
                        <option value="__NEW__">+ Novo Projeto</option>
                        ${projectsData.map(p => `<option value="${p.id}">${p.project_name}</option>`).join('')}
                    `;
                    projectSelect.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                projectSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Quando projeto √© selecionado
        async function onProjectChange() {
            const projectSelect = document.getElementById('projectSelect');
            const projectNameInput = document.getElementById('projectNameInput');
            const campaignSelect = document.getElementById('campaignSelect');
            const campaignNameInput = document.getElementById('campaignNameInput');

            const selectedProject = projectSelect.value;

            campaignSelect.innerHTML = '<option value="">-- Selecione campanha --</option>';
            campaignSelect.disabled = true;
            campaignNameInput.style.display = 'none';
            campaignNameInput.value = '';

            hideEditMode();

            if (selectedProject === '__NEW__') {
                projectNameInput.style.display = 'block';
                projectNameInput.focus();
                campaignSelect.disabled = false;
                campaignSelect.innerHTML = `
                    <option value="">-- Selecione ou crie nova --</option>
                    <option value="__NEW__">+ Nova Campanha</option>
                `;
            } else if (selectedProject) {
                projectNameInput.style.display = 'none';
                projectNameInput.value = '';
                await loadCampaigns(selectedProject);
            } else {
                projectNameInput.style.display = 'none';
                projectNameInput.value = '';
            }
        }

        // Carregar campanhas de um projeto
        async function loadCampaigns(projectId) {
            const campaignSelect = document.getElementById('campaignSelect');
            campaignSelect.disabled = true;
            campaignSelect.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`${API_BASE}/campaigns/${projectId}`);
                const result = await response.json();

                if (result.success) {
                    campaignsData = result.data || [];
                    console.log('[DEBUG] loadCampaigns - campaigns received:', campaignsData.map(c => ({ id: c.id, name: c.campaign_name })));
                    campaignSelect.innerHTML = `
                        <option value="">-- Selecione ou crie nova --</option>
                        <option value="__NEW__">+ Nova Campanha</option>
                        ${campaignsData.map(c => `<option value="${c.id}">${c.campaign_name} ${c.cluster_status ? `(${c.cluster_status})` : ''}</option>`).join('')}
                    `;
                    campaignSelect.disabled = false;
                }
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
                campaignSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Quando campanha √© selecionada
        async function onCampaignChange() {
            const campaignSelect = document.getElementById('campaignSelect');
            const campaignNameInput = document.getElementById('campaignNameInput');

            const selectedCampaign = campaignSelect.value;
            console.log('[DEBUG] onCampaignChange - selectedCampaign:', selectedCampaign);

            if (selectedCampaign === '__NEW__') {
                campaignNameInput.style.display = 'block';
                campaignNameInput.focus();
                hideEditMode();
                clearFormFields();
                // Nova campanha - esconder indicador de status e habilitar bot√µes
                document.getElementById('campaignStatusIndicator').style.display = 'none';
                campaignEditable = true;
                updateButtonsState();
            } else if (selectedCampaign) {
                campaignNameInput.style.display = 'none';
                campaignNameInput.value = '';
                await loadCampaignData(selectedCampaign);
                // Carregar status da campanha selecionada
                await loadCampaignStatus(selectedCampaign);
            } else {
                campaignNameInput.style.display = 'none';
                campaignNameInput.value = '';
                hideEditMode();
                // Nenhuma campanha selecionada - esconder indicador de status
                document.getElementById('campaignStatusIndicator').style.display = 'none';
                campaignEditable = true;
                updateButtonsState();
            }
        }

        // Carregar dados completos de uma campanha
        async function loadCampaignData(campaignId) {
            console.log('[DEBUG] loadCampaignData called with:', campaignId);

            // Validar que √© um UUID v√°lido antes de fazer a requisi√ß√£o
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(campaignId)) {
                console.error('[DEBUG] Invalid campaign ID format:', campaignId);
                alert('ID de campanha inv√°lido. Por favor, selecione novamente.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/campaign/${campaignId}`);
                const result = await response.json();

                // Check for API error
                if (!result.success) {
                    console.error('[DEBUG] API returned error:', result);
                    alert(`Erro ao carregar campanha: ${result.message || 'Erro desconhecido'}`);
                    return;
                }

                if (result.success && result.data) {
                    const { campaign } = result.data;

                    currentCampaignId = campaign.id;

                    // Salvar nomes para upsert (pegar dos dropdowns que j√° est√£o selecionados)
                    loadedClientName = document.getElementById('clientSelect').value;
                    const selectedProject = projectsData.find(p => p.id == document.getElementById('projectSelect').value);
                    loadedProjectName = selectedProject ? selectedProject.project_name : campaign.project_name;
                    loadedCampaignName = campaign.campaign_name;

                    console.log('[DEBUG] Loaded campaign context:', { loadedClientName, loadedProjectName, loadedCampaignName });

                    // Preencher campos principais
                    document.getElementById('nichoInput').value = campaign.nicho_principal || '';
                    document.getElementById('seedsInput').value = Array.isArray(campaign.keywords) ? campaign.keywords.join(', ') : '';

                    // Preencher descricao e publico alvo
                    document.getElementById('serviceDescription').value = campaign.service_description || '';
                    document.getElementById('targetAudience').value = campaign.target_audience || '';

                    // Preencher detalhes do publico (se existirem)
                    document.getElementById('targetAgeRange').value = campaign.target_age_range || '';
                    document.getElementById('targetGender').value = campaign.target_gender || '';
                    document.getElementById('targetLocation').value = campaign.target_location || '';
                    document.getElementById('targetIncomeClass').value = campaign.target_income_class || '';

                    // Preencher canal Whapi (se existir)
                    document.getElementById('whapiChannelSelect').value = campaign.whapi_channel_uuid || '';

                    showEditMode(campaign.campaign_name);

                    // Se j√° tem resultado de an√°lise, mostrar
                    if (campaign.analysis_result) {
                        // Verificar se √© formato antigo ou novo
                        const result = campaign.analysis_result;
                        if (result.isViable !== undefined) {
                            // Formato novo - usar diretamente
                            currentValidation = result;
                            renderResults(result);
                        } else if (result.metricas) {
                            // Formato antigo - converter para novo formato
                            const converted = convertLegacyResult(result);
                            currentValidation = converted;
                            renderResults(converted);
                        }
                    }

                    // Se j√° tem resultado de clustering (subnichos), mostrar
                    if (campaign.clustering_result && campaign.clustering_result.clusters) {
                        currentClusteringResult = campaign.clustering_result;
                        renderClusteringResults(campaign.clustering_result);

                        // Atualizar status do clustering (ID correto: clusteringStatusBadge)
                        const statusBadge = document.getElementById('clusteringStatusBadge');
                        const btn = document.getElementById('btnExecuteClustering');
                        if (statusBadge) {
                            // Usar cohesion_centroid (KPI PRINCIPAL) com fallback para avg_intra_similarity
                            const cohesion = Number(campaign.clustering_result.cohesion_centroid || campaign.clustering_result.avg_intra_similarity) || 0;
                            const k = campaign.clustering_result.k || campaign.clustering_result.clusters.length;
                            statusBadge.className = 'clustering-status done';
                            statusBadge.innerHTML = `K=${k} | Cohesion: ${(cohesion * 100).toFixed(1)}%`;
                        }
                        if (btn) {
                            btn.innerHTML = 'Re-executar Clustering';
                        }

                        console.log(`[DEBUG] Clustering carregado: ${campaign.clustering_result.clusters.length} subnichos`);
                    }

                    // Se j√° tem conte√∫do gerado, atualizar flags
                    if (campaign.generated_persona) {
                        currentPersona = campaign.generated_persona;
                        const flagCard = document.getElementById('flagPersona');
                        if (flagCard) {
                            flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Persona Gerada</div>';
                            flagCard.classList.add('flag-completed');
                        }
                    }
                    if (campaign.generated_dm_scripts) {
                        currentDMScripts = campaign.generated_dm_scripts;
                        const flagCard = document.getElementById('flagDM');
                        if (flagCard) {
                            flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">DM Gerado</div>';
                            flagCard.classList.add('flag-completed');
                        }
                    }
                    if (campaign.generated_copies) {
                        currentCopies = campaign.generated_copies;
                        const flagCard = document.getElementById('flagCopy');
                        if (flagCard) {
                            flagCard.innerHTML = '<div class="flag-icon">‚úÖ</div><div class="flag-label">Copy Gerado</div>';
                            flagCard.classList.add('flag-completed');
                        }
                    }

                    // Carregar conte√∫do gerado (personas, DMs, copies, leads) para visualiza√ß√£o
                    await loadGeneratedContent(campaign.id);

                    // Carregar nichos salvos da campanha
                    await loadCampaignNiches(campaign.id);
                }
            } catch (error) {
                console.error('Erro ao carregar campanha:', error);
                // Check if it was a server error with more details
                if (error.message) {
                    alert(`Erro ao carregar dados da campanha: ${error.message}`);
                } else {
                    alert('Erro ao carregar dados da campanha. Verifique o console para mais detalhes.');
                }
            }
        }

        function showEditMode(campaignName) {
            const indicator = document.getElementById('editModeIndicator');
            const nameSpan = document.getElementById('editingCampaignName');
            nameSpan.textContent = campaignName;
            indicator.style.display = 'block';
        }

        function hideEditMode() {
            document.getElementById('editModeIndicator').style.display = 'none';
            currentCampaignId = null;
            // Ocultar nichos salvos quando sair do modo de edi√ß√£o
            hideSavedNiches();
        }

        function clearSelection() {
            document.getElementById('clientSelect').value = '';
            document.getElementById('projectSelect').innerHTML = '<option value="">-- Selecione cliente primeiro --</option>';
            document.getElementById('projectSelect').disabled = true;
            document.getElementById('campaignSelect').innerHTML = '<option value="">-- Selecione projeto primeiro --</option>';
            document.getElementById('campaignSelect').disabled = true;

            document.getElementById('clientNameInput').style.display = 'none';
            document.getElementById('clientNameInput').value = '';
            document.getElementById('projectNameInput').style.display = 'none';
            document.getElementById('projectNameInput').value = '';
            document.getElementById('campaignNameInput').style.display = 'none';
            document.getElementById('campaignNameInput').value = '';

            hideEditMode();
            clearFormFields();
            document.getElementById('results').classList.remove('show');
        }

        function clearFormFields() {
            document.getElementById('nichoInput').value = '';
            document.getElementById('seedsInput').value = '';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('targetAudience').value = '';
            document.getElementById('targetAgeRange').value = '';
            document.getElementById('targetGender').value = '';
            document.getElementById('targetLocation').value = '';
            document.getElementById('targetIncomeClass').value = '';
            document.getElementById('whapiChannelSelect').value = '';
            currentValidation = null;
            currentCampaignId = null;
            // Limpar cache de campanha carregada
            loadedClientName = null;
            loadedProjectName = null;
            loadedCampaignName = null;
            document.getElementById('results').classList.remove('show');
        }

        // Obter nome do cliente (do select ou input ou campanha carregada)
        function getClientName() {
            const select = document.getElementById('clientSelect');
            const input = document.getElementById('clientNameInput');
            if (select.value === '__NEW__') {
                return input.value.trim();
            }
            // Usar valor do select ou fallback para campanha carregada
            return select.value || loadedClientName || '';
        }

        // Obter nome do projeto (do select ou input ou campanha carregada)
        function getProjectName() {
            const select = document.getElementById('projectSelect');
            const input = document.getElementById('projectNameInput');
            if (select.value === '__NEW__') {
                return input.value.trim();
            }
            const project = projectsData.find(p => p.id == select.value);
            // Usar valor encontrado ou fallback para campanha carregada
            return project ? project.project_name : (loadedProjectName || '');
        }

        // Obter nome da campanha (do select ou input ou campanha carregada)
        function getCampaignName() {
            const select = document.getElementById('campaignSelect');
            const input = document.getElementById('campaignNameInput');
            if (select.value === '__NEW__') {
                return input.value.trim();
            }
            const campaign = campaignsData.find(c => c.id == select.value);
            // Usar valor encontrado ou fallback para campanha carregada
            return campaign ? campaign.campaign_name : (loadedCampaignName || '');
        }

        // Salvar an√°lise
        async function saveAnalysis() {
            const clientName = getClientName();
            const projectName = getProjectName();
            const campaignName = getCampaignName();

            // Valida√ß√£o espec√≠fica para cada campo
            const missing = [];
            if (!clientName) missing.push('Cliente');
            if (!projectName) {
                const projectSelect = document.getElementById('projectSelect');
                if (projectSelect.value === '__NEW__') {
                    missing.push('Nome do novo Projeto (preencha o campo)');
                } else {
                    missing.push('Projeto');
                }
            }
            if (!campaignName) {
                const campaignSelect = document.getElementById('campaignSelect');
                if (campaignSelect.value === '__NEW__') {
                    missing.push('Nome da nova Campanha (preencha o campo)');
                } else {
                    missing.push('Campanha');
                }
            }

            if (missing.length > 0) {
                alert('Campos faltando:\n‚Ä¢ ' + missing.join('\n‚Ä¢ '));
                return;
            }

            const serviceDescription = document.getElementById('serviceDescription').value.trim();
            const targetAudience = document.getElementById('targetAudience').value.trim();

            if (!serviceDescription || !targetAudience) {
                alert('Preencha a Descricao do Servico e Publico Alvo para salvar.');
                return;
            }

            if (!currentValidation) {
                alert('Nenhuma analise para salvar. Execute a validacao primeiro.');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');

            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            try {
                const payload = {
                    client_name: clientName,
                    project_name: projectName,
                    campaign_name: campaignName,
                    nicho: document.getElementById('nichoInput').value.trim(),
                    keywords: document.getElementById('seedsInput').value.split(',').map(k => k.trim()).filter(k => k),
                    service_description: serviceDescription,
                    target_audience: targetAudience,
                    target_age_range: document.getElementById('targetAgeRange').value.trim() || null,
                    target_gender: document.getElementById('targetGender').value || null,
                    target_location: document.getElementById('targetLocation').value.trim() || null,
                    target_income_class: document.getElementById('targetIncomeClass').value || null,
                    whapi_channel_uuid: document.getElementById('whapiChannelSelect').value || null,
                    analysis_result: currentValidation
                };

                const response = await fetch(`${API_BASE}/save-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    saveStatus.innerHTML = `
                        <div style="background: rgba(14, 204, 151, 0.15); border: 1px solid #10b981; padding: 15px; border-radius: 8px; color: var(--aic-green);">
                            ‚úÖ <strong>${result.message}</strong><br>
                            <small>Projeto ID: ${result.data.project_id}</small><br>
                            <small>Campanha ID: ${result.data.campaign_id}</small>
                        </div>
                    `;
                    saveBtn.textContent = '‚úÖ Salvo!';
                    saveBtn.style.background = '#10b981';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                saveStatus.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; padding: 15px; border-radius: 8px; color: #f87171;">
                        ‚ùå Erro ao salvar: ${error.message}
                    </div>
                `;
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar no Banco de Dados';
            }
        }

        // Atualizar renderResults para mostrar se√ß√£o salvar
        const originalRenderResults = renderResults;
        renderResults = function(data) {
            originalRenderResults(data);

            // Mostrar bot√£o salvar
            const clientName = getClientName();
            const projectName = getProjectName();
            const campaignName = getCampaignName();

            const saveSection = document.getElementById('saveSection');
            const saveStatus = document.getElementById('saveStatus');

            if (clientName && projectName && campaignName) {
                saveSection.style.display = 'block';
                saveStatus.innerHTML = currentCampaignId
                    ? `<div style="background: rgba(56, 189, 248, 0.15); border: 1px solid #0284c7; padding: 15px; border-radius: 8px; color: #38bdf8;">
                        Atualizando campanha existente: <strong>${campaignName}</strong>
                    </div>`
                    : `<div style="background: rgba(14, 204, 151, 0.15); border: 1px solid #10b981; padding: 15px; border-radius: 8px; color: var(--aic-green);">
                        Criando nova campanha: <strong>${campaignName}</strong> no projeto <strong>${projectName}</strong>
                    </div>`;
            } else {
                // Mensagem espec√≠fica sobre o que est√° faltando
                const missing = [];
                const projectSelect = document.getElementById('projectSelect');
                const campaignSelect = document.getElementById('campaignSelect');

                if (!clientName) missing.push('Selecione um Cliente');
                if (!projectName) {
                    if (projectSelect.value === '__NEW__') {
                        missing.push('Digite o nome do novo Projeto');
                    } else {
                        missing.push('Selecione um Projeto');
                    }
                }
                if (!campaignName) {
                    if (campaignSelect.value === '__NEW__') {
                        missing.push('Digite o nome da nova Campanha');
                    } else {
                        missing.push('Selecione uma Campanha');
                    }
                }

                saveSection.style.display = 'block';
                saveStatus.innerHTML = `
                    <div style="background: rgba(245, 158, 11, 0.15); border: 1px solid #f59e0b; padding: 15px; border-radius: 8px; color: #92400e;">
                        <strong>Para salvar, complete:</strong><br>
                        ${missing.map(m => '‚Ä¢ ' + m).join('<br>')}
                    </div>
                `;
            }
        };

        // ==========================================
        // CLUSTERING EXECUTION
        // ==========================================

        let currentClusteringResult = null;
        let currentSubclusters = null;

        async function executeClustering() {
            if (!currentValidation || !currentValidation.isViable) {
                alert('Nicho precisa ser viavel para executar clustering');
                return;
            }

            if (!currentCampaignId) {
                alert('Salve a campanha antes de executar o clustering (cliente/projeto/campanha)');
                return;
            }

            const seedsInput = document.getElementById('seedsInput').value.trim();
            const nichoInput = document.getElementById('nichoInput').value.trim();
            const mode = document.getElementById('clusteringMode')?.value || 'vector';

            if (!nichoInput) {
                alert('Preencha nicho antes de executar clustering');
                return;
            }

            const isVectorMode = mode === 'vector' || mode === 'vector_hashtag';
            const seeds = isVectorMode
                ? (seedsInput ? seedsInput.split(',').map(s => s.trim()).filter(s => s.length > 0) : [])
                : seedsInput.split(',').map(s => s.trim()).filter(s => s.length > 0);

            if (!isVectorMode && seeds.length === 0) {
                alert('Preencha seeds antes de executar clustering no modo hashtags');
                return;
            }
            const kRaw = parseInt(document.getElementById('clusteringK')?.value || '0', 10);
            const similarityRaw = parseFloat(document.getElementById('clusteringSimilarity')?.value || '0');
            const minLeadsRaw = parseInt(document.getElementById('clusteringMinLeads')?.value || '1', 10);
            const maxLeadsRaw = parseInt(document.getElementById('clusteringMaxLeads')?.value || '2000', 10);
            const kValue = Number.isFinite(kRaw) && kRaw >= 2 ? kRaw : undefined;
            const similarityThreshold = Number.isFinite(similarityRaw) && similarityRaw > 0 ? similarityRaw : undefined;
            const minLeadsPerCluster = Number.isFinite(minLeadsRaw) && minLeadsRaw > 0 ? minLeadsRaw : 1;
            const maxLeads = Number.isFinite(maxLeadsRaw) && maxLeadsRaw >= 100 ? maxLeadsRaw : 2000;

            // Filtros de rec√™ncia e localiza√ß√£o
            const targetStatesRaw = document.getElementById('clusteringTargetStates')?.value || '';
            const targetStates = targetStatesRaw
                ? targetStatesRaw.split(',').map(s => s.trim().toUpperCase()).filter(s => s.length === 2)
                : undefined;
            const leadMaxAgeRaw = parseInt(document.getElementById('clusteringLeadMaxAge')?.value || '45', 10);
            const hashtagMaxAgeRaw = parseInt(document.getElementById('clusteringHashtagMaxAge')?.value || '90', 10);
            const leadMaxAgeDays = Number.isFinite(leadMaxAgeRaw) && leadMaxAgeRaw > 0 ? leadMaxAgeRaw : 45;
            const hashtagMaxAgeDays = Number.isFinite(hashtagMaxAgeRaw) && hashtagMaxAgeRaw > 0 ? hashtagMaxAgeRaw : 90;

            const btn = document.getElementById('btnExecuteClustering');
            const statusBadge = document.getElementById('clusteringStatusBadge');

            btn.disabled = true;
            btn.innerHTML = 'Processando...';
            statusBadge.className = 'clustering-status processing';
            statusBadge.innerHTML = 'Executando KMeans...';

            try {
                const payload = {
                    seeds: seeds,
                    nicho: nichoInput,
                    campaign_id: currentCampaignId,
                    mode,
                    k: kValue,
                    similarity_threshold: similarityThreshold,
                    // Filtros de rec√™ncia e localiza√ß√£o
                    target_states: targetStates,
                    lead_max_age_days: leadMaxAgeDays,
                    hashtag_max_age_days: hashtagMaxAgeDays,
                    min_leads_per_cluster: minLeadsPerCluster,
                    max_leads: maxLeads
                };

                console.log('üéØ [Clustering] Payload:', {
                    mode, k: kValue, similarity: similarityThreshold,
                    target_states: targetStates,
                    lead_max_age_days: leadMaxAgeDays,
                    hashtag_max_age_days: hashtagMaxAgeDays
                });

                const response = await fetch(`${API_BASE}/execute-clustering`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success && result.data) {
                    currentClusteringResult = result.data;
                    renderClusteringResults(result.data);

                    // Salvar resultado do clustering no nicho ativo da campanha
                    // O nicho ativo √© o √∫ltimo adicionado (ou o active_niche_index)
                    if (currentCampaignId) {
                        // Buscar o √≠ndice do nicho ativo
                        try {
                            const nichesResponse = await fetch(`${API_BASE}/campaign/${currentCampaignId}/niches`);
                            const nichesResult = await nichesResponse.json();
                            if (nichesResult.success && nichesResult.data && nichesResult.data.length > 0) {
                                const activeIndex = nichesResult.active_niche_index || nichesResult.data.length - 1;
                                await updateNicheClustering(activeIndex, result.data);
                            }
                        } catch (err) {
                            console.error('Erro ao salvar clustering no nicho:', err);
                        }
                    }

                    // Usar cohesion_centroid (KPI PRINCIPAL) com fallback
                    const cohesion = Number(result.data.cohesion_centroid || result.data.avg_intra_similarity || 0);
                    if (cohesion < 0.35) {
                        alert('‚ö†Ô∏è Clustering com coes√£o baixa (' + (cohesion * 100).toFixed(1) + '%). Considere ajustar seeds/K ou refazer antes de gerar personas/DM.');
                    }

                    statusBadge.className = 'clustering-status done';
                    statusBadge.innerHTML = 'Clustering concluido';
                    btn.innerHTML = 'Re-executar Clustering';
                } else {
                    throw new Error(result.message || result.data?.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao executar clustering:', error);
                alert(`Erro: ${error.message}`);

                statusBadge.className = 'clustering-status waiting';
                statusBadge.innerHTML = 'Erro - tente novamente';
            } finally {
                btn.disabled = false;
            }
        }

        function renderClusteringResults(data) {
            // Show results section
            document.getElementById('clusteringResults').style.display = 'block';

            // Guards para dados opcionais
            const leads = Array.isArray(data.lead_associations) ? data.lead_associations : [];
            // Usar cohesion_centroid (KPI PRINCIPAL) com fallback para avg_intra_similarity
            const cohesion = Number(data.cohesion_centroid || data.avg_intra_similarity) || 0;
            const clusters = Array.isArray(data.clusters) ? data.clusters : [];
            // Calcular total de leads somando os clusters (n√∫mero efetivo ap√≥s filtros)
            const totalLeads = clusters.reduce((sum, c) => sum + (c.total_leads || 0), 0) || data.total_leads || leads.length || 0;
            const totalHashtags = data.total_hashtags || 0;
            const method = data.method || 'kmeans_hashtag';

            // Fun√ß√£o helper para interpretar qualidade do Cohesion Score
            function getCohesionQuality(score) {
                if (score >= 0.70) return { label: 'Excelente', color: '#10b981' };
                if (score >= 0.50) return { label: 'Bom', color: '#22c55e' };
                if (score >= 0.35) return { label: 'Razo√°vel', color: '#f59e0b' };
                if (score >= 0.25) return { label: 'Aceit√°vel', color: '#f97316' };
                return { label: 'Fraco', color: '#ef4444' };
            }

            const k = data.k || clusters.length;
            const quality = getCohesionQuality(cohesion);
            const methodLabel = document.getElementById('clusteringMethodLabel');
            if (methodLabel) {
                const label = (method === 'similarity_groups' || method === 'kmeans_vector')
                    ? 'Vector (embeddings)'
                    : (method === 'hashtag_vector' ? 'Vector (hashtags)' : 'Hashtags (legado)');

                // Ler filtros aplicados da UI
                const appliedStates = document.getElementById('clusteringTargetStates')?.value || 'Todos';
                const appliedLeadAge = document.getElementById('clusteringLeadMaxAge')?.value || '45';
                const appliedHashtagAge = document.getElementById('clusteringHashtagMaxAge')?.value || '90';

                methodLabel.innerHTML = `M√©todo: ${label} | <span style="color: var(--aic-green); font-size: 0.85em;">Filtros: Estados=${appliedStates || 'Todos'}, Leads‚â§${appliedLeadAge}d, Hashtags‚â§${appliedHashtagAge}d</span>`;
            }

            // Summary com guards
            document.getElementById('clusterK').textContent = k;
            document.getElementById('clusterHashtags').textContent = totalHashtags.toLocaleString('pt-BR');
            document.getElementById('clusterLeads').textContent = totalLeads.toLocaleString('pt-BR');
            document.getElementById('clusterSilhouette').textContent = (cohesion * 100).toFixed(1) + '%';

            // Contexto do K escolhido
            const kContextEl = document.getElementById('clusterKContext');
            if (kContextEl) {
                kContextEl.textContent = `Cohesion: ${(cohesion * 100).toFixed(1)}%`;
            }

            // Qualidade do Cohesion
            const qualityEl = document.getElementById('silhouetteQuality');
            if (qualityEl) {
                qualityEl.textContent = quality.label;
                qualityEl.style.color = quality.color;
            }

            // Cluster Cards
            const clustersGrid = document.getElementById('clustersGrid');
            clustersGrid.innerHTML = clusters.map((cluster, idx) => {
                // Buscar subcluster correspondente para verificar status
                const subcluster = currentSubclusters?.find(sc => sc.cluster_index === cluster.cluster_id);
                const isBlocked = subcluster && (subcluster.status === 'in_outreach' || subcluster.status === 'completed');
                const statusLabel = isBlocked ? (subcluster.status === 'completed' ? '‚úÖ Conclu√≠do' : 'üîí Em Outreach') : '';
                const clusterId = Number.isFinite(Number(cluster.cluster_id)) ? Number(cluster.cluster_id) : idx;
                const clusterNameRaw = cluster.cluster_name || `Cluster ${clusterId + 1}`;
                const clusterNameSafe = escapeHTML(clusterNameRaw);
                const topHashtags = (cluster.top_hashtags || []).slice(0, 6).map(h => {
                    const tag = h?.hashtag ?? h ?? '';
                    return `<span class="cluster-hashtag-pill">#${escapeHTML(tag)}</span>`;
                }).join('');
                const hashtagCount = Number(cluster.hashtag_count || 0);
                const totalLeadsCluster = Number(cluster.total_leads || 0);
                const contactRate = Number(cluster.avg_contact_rate || 0);

                return `
                <div class="cluster-card ${isBlocked ? 'cluster-blocked' : ''}" data-cluster-id="${clusterId}">
                    <div class="cluster-card-header">
                        <span class="cluster-name" style="color: #fff;">${clusterNameSafe}</span>
                        <span class="cluster-id-badge">Cluster ${clusterId + 1}</span>
                    </div>
                    ${isBlocked ? `<div class="cluster-blocked-badge">${statusLabel}</div>` : ''}
                    <div class="cluster-stats">
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${hashtagCount}</div>
                            <div class="cluster-stat-label">Hashtags</div>
                        </div>
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${totalLeadsCluster}</div>
                            <div class="cluster-stat-label">Leads</div>
                        </div>
                        <div class="cluster-stat">
                            <div class="cluster-stat-value" style="color: #25D366;">${contactRate.toFixed(1)}%</div>
                            <div class="cluster-stat-label">WhatsApp</div>
                        </div>
                    </div>
                    <div class="cluster-hashtags">
                        <div class="cluster-hashtags-label">Top Hashtags:</div>
                        <div class="cluster-hashtag-pills">
                            ${topHashtags}
                        </div>
                    </div>
                    ${!isBlocked ? `
                    <button class="cluster-capture-btn"
                            onclick="captureClusterLeads(${clusterId}, '${clusterNameRaw.replace(/'/g, "\\'")}')"
                            >
                        ‚ûï Capturar Leads
                    </button>` : ''}
                </div>
            `}).join('');

            // Top Leads (com guard)
            const topLeadsList = document.getElementById('topLeadsList');
            if (leads.length > 0) {
                const topLeads = leads.slice(0, 20);
                topLeadsList.innerHTML = topLeads.map((lead, idx) => {
                    const clusterNameRaw = clusters.find(c => c.cluster_id === lead.primary_cluster)?.cluster_name || `Cluster ${(lead.primary_cluster || 0) + 1}`;
                    const clusterName = escapeHTML(clusterNameRaw);
                    const leadName = escapeHTML(lead.full_name || lead.username || 'Lead sem nome');
                    const leadUsername = escapeHTML(lead.username || '');
                    const score = Number(lead.score) || 0;
                    return `
                        <div class="lead-item ${lead.has_contact ? 'has-contact' : ''}">
                            <div class="lead-info">
                                <span>#${idx + 1}</span>
                                <strong class="lead-name">${leadName}</strong>
                                ${leadUsername ? `<span class="lead-username">@${leadUsername}</span>` : ''}
                                <span class="lead-cluster-badge">${clusterName}</span>
                                ${lead.has_contact ? '<span class="lead-contact-badge">Com Contato</span>' : ''}
                            </div>
                            <span class="lead-score">Score: ${score.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');
            } else {
                topLeadsList.innerHTML = '<div class="lead-item"><span>Nenhum lead associado ainda</span></div>';
            }
        }

        // Update renderResults to show clustering section when viable
        const baseRenderResults = renderResults;
        renderResults = function(data) {
            baseRenderResults(data);

            // Show/hide clustering section based on viability
            const clusteringSection = document.getElementById('clusteringSection');
            if (data.isViable) {
                clusteringSection.style.display = 'block';
                // Reset clustering state
                document.getElementById('clusteringResults').style.display = 'none';
                document.getElementById('clusteringStatusBadge').className = 'clustering-status waiting';
                document.getElementById('clusteringStatusBadge').innerHTML = 'Aguardando execucao';
                document.getElementById('btnExecuteClustering').innerHTML = 'Executar Clustering';
                document.getElementById('btnExecuteClustering').disabled = false;
                currentClusteringResult = null;
            } else {
                clusteringSection.style.display = 'none';
            }
        };

        // Inicializar
        loadClients().then(() => {
            // Verificar se h√° campaign_id na URL e auto-selecionar
            handleUrlCampaignParam();
        });
        loadWhapiChannels();

        // Auto-selecionar dropdowns se campaign_id estiver na URL
        async function handleUrlCampaignParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const campaignId = urlParams.get('campaign');

            if (!campaignId) return;

            // Buscar dados do sessionStorage (passado pelo dashboard)
            const storedData = sessionStorage.getItem('selectedCampaign');
            if (!storedData) {
                console.log('[URL] Sem dados em sessionStorage, ignorando auto-sele√ß√£o');
                return;
            }

            const campaign = JSON.parse(storedData);
            if (campaign.id !== campaignId) {
                console.log('[URL] Campaign ID n√£o corresponde ao sessionStorage');
                return;
            }

            console.log('[URL] Auto-selecionando dropdowns:', campaign);

            try {
                // Auto-selecionar cliente
                if (campaign.client_name) {
                    const clientSelect = document.getElementById('clientSelect');
                    const clientOption = Array.from(clientSelect.options).find(opt => opt.text === campaign.client_name);
                    if (clientOption) {
                        clientSelect.value = clientOption.value;
                        await loadProjects(campaign.client_name);

                        // Auto-selecionar projeto pelo project_id
                        if (campaign.project_id) {
                            const projectSelect = document.getElementById('projectSelect');
                            const projectOption = Array.from(projectSelect.options).find(opt => opt.value === campaign.project_id);
                            if (projectOption) {
                                projectSelect.value = campaign.project_id;
                                await loadCampaigns(campaign.project_id);

                                // Auto-selecionar campanha
                                const campaignSelect = document.getElementById('campaignSelect');
                                campaignSelect.value = campaignId;
                                await onCampaignChange();
                                console.log('[URL] Dropdowns auto-selecionados com sucesso');
                            }
                        }
                    }
                }

                // Limpar sessionStorage ap√≥s uso
                sessionStorage.removeItem('selectedCampaign');

            } catch (error) {
                console.error('[URL] Erro ao auto-selecionar dropdowns:', error);
            }
        }
    </script>

    <!-- AIC Sidebar Navigation -->
    <script src="/components/aic-sidebar.js"></script>
</body>
</html>
