<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposta | Portal AIC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.15);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-yellow: #F59E0B;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      line-height: 1.7;
    }
    /* Sidebar margin is handled by aic-client-sidebar.js via body.aic-sidebar-open */

    .main-content {
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
    }

    /* Quando sidebar está aberto, centralizar no espaço restante */
    body.aic-sidebar-open .main-content {
      margin-left: 40px;
      margin-right: auto;
    }

    /* Status Checklist */
    .status-checklist {
      display: flex;
      gap: 20px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 12px;
      padding: 16px 24px;
      flex: 1;
      min-width: 200px;
    }
    .status-item.ok {
      border-color: rgba(14, 204, 151, 0.4);
      background: var(--aic-green-glow);
    }
    .status-item.pending {
      border-color: rgba(245, 158, 11, 0.4);
      background: rgba(245, 158, 11, 0.1);
    }
    .status-check {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .status-item.ok .status-check {
      background: var(--aic-green);
      color: var(--aic-navy);
    }
    .status-item.pending .status-check {
      background: var(--aic-yellow);
      color: var(--aic-navy);
    }
    .status-label {
      font-size: 14px;
      font-weight: 500;
    }
    .status-item.ok .status-label {
      color: var(--aic-green);
    }
    .status-item.pending .status-label {
      color: var(--aic-yellow);
    }

    /* Welcome Modal */
    .welcome-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(12, 27, 51, 0.9);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .welcome-modal {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-green);
      border-radius: 16px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .welcome-modal-header {
      padding: 24px 24px 16px;
      border-bottom: 1px solid var(--aic-border);
      text-align: center;
    }
    .welcome-modal-header h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      color: var(--aic-green);
    }
    .welcome-modal-header p {
      margin: 0;
      font-size: 14px;
      color: var(--aic-gray-light);
    }
    .welcome-modal-body {
      padding: 20px 24px;
    }
    .welcome-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .welcome-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--aic-navy);
      border-radius: 8px;
      border: 1px solid var(--aic-border);
    }
    .welcome-step.active {
      border-color: var(--aic-green);
      background: var(--aic-green-glow);
    }
    .welcome-step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--aic-border);
      color: var(--aic-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .welcome-step.active .welcome-step-number {
      background: var(--aic-green);
      color: var(--aic-navy);
    }
    .welcome-step-text {
      font-size: 13px;
      color: var(--aic-gray);
    }
    .welcome-step.active .welcome-step-text {
      color: var(--aic-white);
      font-weight: 500;
    }
    .welcome-modal-contact {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--aic-border);
      text-align: center;
    }
    .welcome-modal-contact p {
      font-size: 12px;
      color: var(--aic-gray);
      margin: 0 0 10px 0;
    }
    .welcome-contact-links {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .welcome-contact-links a {
      font-size: 11px;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
    }
    .welcome-contact-links .wa {
      background: #25D366;
      color: white;
    }
    .welcome-contact-links .email {
      background: var(--aic-navy);
      color: var(--aic-gray-light);
      border: 1px solid var(--aic-border);
    }
    .welcome-contact-links .landing {
      background: transparent;
      color: var(--aic-green);
      border: 1px solid var(--aic-green);
    }
    .welcome-modal-footer {
      padding: 16px 24px 24px;
    }
    .welcome-modal-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .welcome-modal-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px var(--aic-green-glow);
    }

    /* Header */
    .page-header {
      text-align: center;
      padding: 20px 0 40px;
    }
    .logo {
      width: 140px;
      height: auto;
      margin-bottom: 20px;
    }
    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 12px 0;
      color: var(--aic-white);
    }
    .page-header .subtitle {
      font-size: 16px;
      color: var(--aic-gray);
      max-width: 500px;
      margin: 0 auto;
    }
    .client-name {
      color: var(--aic-green);
    }

    /* Cards */
    .card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
    }
    .card h2 {
      margin: 0 0 16px 0;
      font-size: 20px;
      color: var(--aic-green);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h3 {
      margin: 20px 0 10px 0;
      font-size: 16px;
      color: var(--aic-white);
    }
    .card p {
      margin: 0 0 16px 0;
      font-size: 15px;
      color: var(--aic-gray-light);
    }
    .card ul {
      margin: 0 0 16px 0;
      padding-left: 20px;
    }
    .card li {
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--aic-gray-light);
    }
    .card li strong {
      color: var(--aic-white);
    }

    /* Highlight box */
    .highlight-box {
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .highlight-box p {
      margin: 0;
      color: var(--aic-white);
      font-size: 15px;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .stat-card {
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--aic-green);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Benefits grid */
    .benefits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .benefit {
      background: var(--aic-navy);
      border: 1px solid var(--aic-border);
      border-radius: 12px;
      padding: 20px;
    }
    .benefit-icon {
      font-size: 14px;
      font-weight: 700;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--aic-navy);
      margin-bottom: 12px;
    }
    .benefit h4 {
      margin: 0 0 8px 0;
      font-size: 15px;
      color: var(--aic-white);
    }
    .benefit p {
      margin: 0;
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Pricing */
    .pricing-card {
      background: linear-gradient(135deg, var(--aic-navy-lighter), var(--aic-navy-light));
      border: 2px solid var(--aic-green);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      margin: 20px 0;
    }
    .pricing-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--aic-green);
      margin-bottom: 8px;
    }
    .pricing-detail {
      font-size: 14px;
      color: var(--aic-gray);
      margin-bottom: 16px;
    }
    .pricing-bonus {
      display: inline-block;
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      color: var(--aic-green);
    }

    /* Lead Pricing Promo - igual landing page */
    .lead-pricing {
      margin: 24px 0;
      padding: 20px;
      background: var(--aic-navy);
      border-radius: 12px;
    }
    .lead-price-normal {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .price-label {
      font-size: 14px;
      color: var(--aic-gray);
    }
    .price-crossed {
      font-size: 18px;
      color: var(--aic-gray);
      text-decoration: line-through;
      opacity: 0.7;
    }
    .lead-price-promo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .promo-tag {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .price-promo {
      font-size: 32px;
      font-weight: 800;
      color: var(--aic-green);
    }
    .price-per {
      font-size: 14px;
      color: var(--aic-gray);
    }
    .lead-price-note {
      font-size: 12px;
      color: var(--aic-gray);
      text-align: center;
      margin: 0;
    }

    /* Steps */
    .steps {
      counter-reset: step;
    }
    .step {
      position: relative;
      padding-left: 50px;
      margin-bottom: 24px;
    }
    .step::before {
      counter-increment: step;
      content: counter(step);
      position: absolute;
      left: 0;
      top: 0;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--aic-navy);
    }
    .step h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: var(--aic-white);
    }
    .step p {
      margin: 0;
      font-size: 14px;
      color: var(--aic-gray);
    }

    /* CTA Section */
    .cta-section {
      text-align: center;
      padding: 40px 20px;
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      margin-top: 32px;
    }
    .cta-section h3 {
      margin: 0 0 12px 0;
      font-size: 20px;
      color: var(--aic-white);
    }
    .cta-section p {
      margin: 0 0 24px 0;
      color: var(--aic-gray);
      font-size: 15px;
    }
    .cta-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
      text-decoration: none;
      padding: 16px 40px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--aic-green-glow);
    }
    .cta-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .cta-button.secondary {
      background: transparent;
      border: 2px solid var(--aic-green);
      color: var(--aic-green);
    }

    /* Already accepted */
    .accepted-section {
      text-align: center;
      padding: 32px;
      background: var(--aic-green-glow);
      border: 1px solid rgba(14, 204, 151, 0.3);
      border-radius: 16px;
      margin-top: 32px;
    }
    .accepted-section h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: var(--aic-green);
    }
    .accepted-section p {
      margin: 0 0 20px 0;
      color: var(--aic-gray-light);
    }

    /* Disclaimer */
    .disclaimer {
      font-size: 12px;
      color: var(--aic-gray);
      text-align: center;
      padding: 20px;
      border-top: 1px solid var(--aic-border);
      margin-top: 40px;
    }

    /* Loading */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--aic-border);
      border-top-color: var(--aic-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-content { padding: 20px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .benefits-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="main-content" id="main-content">
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p style="color: var(--aic-gray);">Carregando proposta...</p>
    </div>
  </div>

  <!-- Client Sidebar -->
  <script src="/components/aic-client-sidebar.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase-client.js"></script>

  <!-- PDF Generator - pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    let journeyData = null;

    // Get campaign parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const campaignParam = urlParams.get('campaign');

    function buildUrl(path) {
      if (campaignParam) {
        return path + '?campaign=' + campaignParam;
      }
      return path;
    }

    // Funcao para baixar PDF - documento estruturado com pdfmake
    async function downloadPDF() {
      if (!journeyData) {
        alert('Dados da proposta nao carregados');
        return;
      }

      const clientName = journeyData.client_name || 'Cliente';
      const contractValue = journeyData.contract_value || 4000;

      // Carregar logo como base64
      let logoBase64 = null;
      try {
        const response = await fetch('/assets/AIC/Imagens%20Vetor%20/LOGO%20completo%20sem%20fundo%20Icone%20cheio%20e%20nome%20cheio.png');
        const blob = await response.blob();
        logoBase64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch (e) {
        console.warn('Nao foi possivel carregar o logo:', e);
      }

      // Definicao do documento - MESMO TEXTO DA PAGINA HTML
      const docDefinition = {
        pageSize: 'A4',
        pageMargins: [40, 40, 40, 50],

        footer: function(currentPage, pageCount) {
          return {
            columns: [
              { text: 'AIC - Transformando dados em resultados', style: 'footerText', margin: [40, 0, 0, 0] },
              { text: 'Pagina ' + currentPage + ' de ' + pageCount, alignment: 'right', style: 'footerText', margin: [0, 0, 40, 0] }
            ]
          };
        },

        content: [
          // Logo e Titulo
          logoBase64 ? { image: logoBase64, width: 120, alignment: 'center', margin: [0, 0, 0, 15] } : {},
          { text: 'PROPOSTA COMERCIAL', style: 'title', margin: [0, 0, 0, 25] },

          // Seção 1: O que é AIC
          { text: 'O que é a AIC?', style: 'sectionTitle' },
          { text: 'A AIC (Applied Intelligence Clustering) é uma plataforma inovadora desenvolvida para transformar dados públicos em agrupamentos inteligentes e acionáveis.', style: 'paragraph' },
          { text: 'Utilizando algoritmos avançados de análise de dados e machine learning, a AIC identifica grupos de indivíduos com comportamentos e características semelhantes, permitindo que empresas obtenham insights estratégicos para suas ações de marketing e negócios.', style: 'paragraph' },
          {
            text: 'Diferencial: Enquanto o público-alvo representa um segmento amplo e a persona detalha um perfil semificcional, o cluster AIC agrupa indivíduos reais que compartilham padrões de comportamento e atributos.',
            style: 'highlight',
            margin: [0, 5, 0, 15]
          },

          // Seção 2: Benefícios
          { text: 'Benefícios da AIC', style: 'sectionTitle' },
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  { stack: [{ text: '01 - Personalização Eficaz', style: 'benefitTitle' }, { text: 'Campanhas personalizadas para cada grupo.', style: 'benefitText' }], margin: [0, 3, 0, 3] },
                  { stack: [{ text: '02 - Decisão Baseada em Dados', style: 'benefitTitle' }, { text: 'Padrões e relações para decisão estratégica.', style: 'benefitText' }], margin: [0, 3, 0, 3] }
                ],
                [
                  { stack: [{ text: '03 - Otimização de Recursos', style: 'benefitTitle' }, { text: 'Esforços para segmentos com maior potencial.', style: 'benefitText' }], margin: [0, 3, 0, 3] },
                  { stack: [{ text: '04 - Escalabilidade Inteligente', style: 'benefitTitle' }, { text: 'Validação e expansão eficiente.', style: 'benefitText' }], margin: [0, 3, 0, 3] }
                ]
              ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 15]
          },

          // Seção 3: Objetivo da Campanha
          { text: 'Objetivo da Campanha', style: 'sectionTitle' },
          { text: 'Campanha estruturada de prospecção ativa com até 2.000 potenciais clientes ao longo de 30 dias.', style: 'paragraph' },
          {
            columns: [
              { stack: [{ text: '2.000', style: 'statNumber' }, { text: 'Contatos', style: 'statLabel' }], alignment: 'center' },
              { stack: [{ text: '30', style: 'statNumber' }, { text: 'Dias', style: 'statLabel' }], alignment: 'center' },
              { stack: [{ text: '1 a 5', style: 'statNumber' }, { text: 'Clusters', style: 'statLabel' }], alignment: 'center' }
            ],
            margin: [0, 8, 0, 10]
          },
          { text: 'Foco:', style: 'sectionSubtitle' },
          {
            ul: [
              { text: [{ text: 'Gerar conversas reais', bold: true }, ' - não apenas números'] },
              { text: [{ text: 'Identificar interesse genuíno', bold: true }, ' - sinais de intenção'] },
              { text: [{ text: 'Transformar conversas em leads qualificados', bold: true }, ' - prontos para seu funil'] }
            ],
            style: 'list',
            margin: [0, 0, 0, 10]
          },

          // Seção 4: Metodologia
          { text: 'Metodologia AIC', style: 'sectionTitle' },
          { text: 'Nossa metodologia é estruturada em 6 etapas para garantir resultados consistentes:', style: 'paragraph' },
          {
            ol: [
              { text: [{ text: 'Diagnóstico Estruturado: ', bold: true, color: '#0ECC97' }, 'Entendemos seu negócio, produto, problema que resolve, dores do cliente ideal e posicionamento.'] },
              { text: [{ text: 'Seleção dos 2.000 Perfis: ', bold: true, color: '#0ECC97' }, 'Analisamos comportamento, sinais de intenção e perfis ativos para filtrar prospects qualificados.'] },
              { text: [{ text: 'Avaliação da Landing Page: ', bold: true, color: '#0ECC97' }, 'Revisamos sua landing page com foco em clareza, narrativa e consistência com a campanha.'] },
              { text: [{ text: 'Coleta de Materiais: ', bold: true, color: '#0ECC97' }, 'Solicitamos fotos, vídeos, depoimentos e referências como insumo para a linha editorial.'] },
              { text: [{ text: 'Criação da Linha Editorial: ', bold: true, color: '#0ECC97' }, 'Desenvolvemos conteúdo estratégico alinhado ao cluster, com DMs personalizados.'] },
              { text: [{ text: 'Acompanhamento Contínuo: ', bold: true, color: '#0ECC97' }, 'Análise de comportamento, ajustes de estratégia e métricas em tempo real.'] }
            ],
            style: 'list',
            margin: [0, 0, 0, 15]
          },

          // Seção 5: Expectativa de Resultados
          { text: 'Expectativa de Resultados', style: 'sectionTitle' },
          {
            columns: [
              { stack: [{ text: '2.000', style: 'statNumber' }, { text: 'Contatos enviados', style: 'statLabel' }], alignment: 'center' },
              { stack: [{ text: '300-500', style: 'statNumber' }, { text: 'Respostas', style: 'statLabel' }], alignment: 'center' },
              { stack: [{ text: '120-200', style: 'statNumber' }, { text: 'Leads qualificados', style: 'statLabel' }], alignment: 'center' }
            ],
            margin: [0, 8, 0, 10]
          },
          {
            text: 'Importante: Projeções baseadas em histórico, não garantias. Resultados variam conforme nicho e oferta.',
            style: 'note',
            margin: [0, 0, 0, 15]
          },

          // Seção 6: Investimento
          { text: 'Investimento', style: 'sectionTitle' },
          {
            table: {
              widths: ['*'],
              body: [
                [{ text: 'CAMPANHA COMPLETA', style: 'pricingHeader', fillColor: '#0ECC97', color: 'white', alignment: 'center' }],
                [{ text: 'R$ ' + contractValue.toLocaleString('pt-BR') + ',00', style: 'pricingValue', alignment: 'center', margin: [0, 10, 0, 10] }],
                [{
                  stack: [
                    { text: 'Valor por lead: De R$ 55,00 por R$ 10,00 (1ª CAMPANHA)', style: 'pricingDetail', alignment: 'center' },
                    { text: '* Promoção válida até 31/03/2026', style: 'promoNote', alignment: 'center', margin: [0, 3, 0, 0] }
                  ],
                  margin: [0, 0, 0, 8]
                }],
                [{ text: 'Pagamento: 50% no início + 50% após 15 dias', style: 'pricingBonus', alignment: 'center', fillColor: '#f0f9f6' }]
              ]
            },
            margin: [0, 0, 0, 15]
          },

          { text: 'O que está incluso:', style: 'sectionSubtitle' },
          {
            ul: [
              'Diagnóstico completo e definição de cluster',
              'Seleção e validação de até 2.000 perfis',
              'Avaliação da landing page',
              'Linha editorial e scripts personalizados',
              'Execução por 30 dias + relatórios',
              'Entrega de leads qualificados'
            ],
            style: 'list',
            margin: [0, 0, 0, 12]
          },

          { text: 'Lead qualificado = Resposta com intenção + contato válido ou agendamento. Exclui spam e curiosidade sem fit.', style: 'note', margin: [0, 0, 0, 15] },

          // Próximos passos
          { text: 'Próximos Passos', style: 'sectionTitle' },
          {
            ol: [
              'Aceite desta proposta',
              'Assinatura do contrato',
              'Pagamento (50%)',
              'Briefing',
              'Inicio da campanha'
            ],
            style: 'list'
          }
        ],

        styles: {
          footerText: { fontSize: 8, color: '#999' },
          title: { fontSize: 22, bold: true, color: '#0ECC97', alignment: 'center' },
          sectionTitle: { fontSize: 14, bold: true, color: '#0ECC97', margin: [0, 12, 0, 6] },
          sectionSubtitle: { fontSize: 11, bold: true, color: '#333', margin: [0, 8, 0, 4] },
          paragraph: { fontSize: 10, color: '#333', lineHeight: 1.4, margin: [0, 0, 0, 6] },
          highlight: { fontSize: 10, color: '#333', fillColor: '#f0f9f6', margin: [8, 8, 8, 8], lineHeight: 1.3 },
          note: { fontSize: 9, color: '#666', italics: true },
          list: { fontSize: 10, color: '#333', lineHeight: 1.4 },
          benefitTitle: { fontSize: 10, bold: true, color: '#0ECC97' },
          benefitText: { fontSize: 9, color: '#444' },
          methodItem: { fontSize: 10, color: '#333', margin: [0, 2, 0, 2] },
          statNumber: { fontSize: 20, bold: true, color: '#0ECC97' },
          statLabel: { fontSize: 9, color: '#666' },
          pricingHeader: { fontSize: 11, bold: true },
          pricingValue: { fontSize: 26, bold: true, color: '#0ECC97' },
          pricingDetail: { fontSize: 10, color: '#333' },
          promoNote: { fontSize: 8, color: '#666' },
          pricingBonus: { fontSize: 10, color: '#0ECC97' }
        }
      };

      const fileName = 'Proposta-AIC-' + clientName.replace(/\s+/g, '-') + '.pdf';
      pdfMake.createPdf(docDefinition).download(fileName);
    }

    async function init() {
      try {
        // Verificar sessao Supabase
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
          window.location.href = buildUrl('/cliente/login');
          return;
        }

        // Se tem campaign param, tentar carregar jornada existente
        if (campaignParam) {
          const apiUrl = '/api/aic/journey/me?campaign=' + campaignParam;
          const response = await fetch(apiUrl, {
            headers: { 'Authorization': `Bearer ${session.access_token}` }
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.journey) {
              journeyData = result.journey;
            }
          }
        }

        // Se não tem jornada, usar dados padrão (proposta é padrão!)
        if (!journeyData) {
          const user = session.user;
          journeyData = {
            client_name: user.user_metadata?.name || user.user_metadata?.full_name || user.email || 'Cliente',
            client_email: user.email,
            contract_value: 4000,
            lead_value: 10,
            current_step: 'proposta_enviada',  // Ainda não aceitou
            isNewClient: true  // Flag para saber que é cliente novo
          };
        }

        renderPage();

      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('main-content').innerHTML = `
          <div class="loading-state">
            <p style="color: #ef4444;">Erro ao carregar proposta. Por favor, tente novamente.</p>
            <button onclick="location.reload()" class="cta-button secondary" style="margin-top: 16px;">Tentar Novamente</button>
          </div>
        `;
      }
    }

    function renderPage() {
      const isAccepted = ['proposta_aceita', 'contrato_enviado', 'contrato_assinado',
        'pagamento_pendente', 'pagamento_confirmado', 'credenciais_pendente', 'credenciais_ok',
        'briefing_pendente', 'briefing_completo', 'campanha_ativa', 'campanha_concluida'
      ].includes(journeyData.current_step);

      const contractValue = journeyData.contract_value || 4000;
      const leadValue = journeyData.lead_value || 10;
      const clientName = journeyData.client_name || 'Cliente';

      document.getElementById('main-content').innerHTML = `
        ${journeyData.isNewClient ? `
        <!-- Welcome Modal - Popup de orientação para clientes novos -->
        <div class="welcome-modal-overlay" id="welcome-modal">
          <div class="welcome-modal">
            <div class="welcome-modal-header">
              <h2>Olá, ${clientName.split(' ')[0]}! Bem-vindo ao Portal AIC</h2>
              <p>Sua conta foi criada. Aqui você acompanha toda a jornada da sua campanha.</p>
            </div>
            <div class="welcome-modal-body">
              <div class="welcome-steps">
                <div class="welcome-step active">
                  <div class="welcome-step-number">1</div>
                  <div class="welcome-step-text">Proposta Comercial (você está aqui)</div>
                </div>
                <div class="welcome-step">
                  <div class="welcome-step-number">2</div>
                  <div class="welcome-step-text">Contrato</div>
                </div>
                <div class="welcome-step">
                  <div class="welcome-step-number">3</div>
                  <div class="welcome-step-text">Pagamento</div>
                </div>
                <div class="welcome-step">
                  <div class="welcome-step-number">4</div>
                  <div class="welcome-step-text">Briefing</div>
                </div>
                <div class="welcome-step">
                  <div class="welcome-step-number">5</div>
                  <div class="welcome-step-text">Campanha Ativa</div>
                </div>
              </div>
              <div class="welcome-modal-contact">
                <p>Dúvidas? Fale conosco ou veja mais informações:</p>
                <div class="welcome-contact-links">
                  <a href="https://wa.me/5511999040605?text=Olá!%20Tenho%20dúvidas%20sobre%20a%20proposta%20AIC" target="_blank" class="wa">WhatsApp</a>
                  <a href="mailto:admin@stratfin.tec.br?subject=Dúvida%20sobre%20proposta%20AIC" class="email">Email</a>
                  <a href="/aic-landing.html" target="_blank" class="landing">Ver FAQs</a>
                </div>
              </div>
            </div>
            <div class="welcome-modal-footer">
              <button class="welcome-modal-btn" onclick="document.getElementById('welcome-modal').remove()">
                Entendi, ver proposta
              </button>
            </div>
          </div>
        </div>
        ` : `
        <!-- Status Checklist - Para clientes com jornada -->
        <div class="status-checklist">
          <div class="status-item ok">
            <div class="status-check">&#10003;</div>
            <span class="status-label">OK da AIC</span>
          </div>
          <div class="status-item ${isAccepted ? 'ok' : 'pending'}">
            <div class="status-check">${isAccepted ? '&#10003;' : '&#8226;'}</div>
            <span class="status-label">${isAccepted ? 'OK do Cliente' : 'Aguardando Cliente'}</span>
          </div>
        </div>
        `}

        <!-- Header -->
        <div class="page-header">
          <img src="/assets/AIC/Imagens%20Vetor%20/Logo%20Completo%20nome%20Branco%20sem%20fundo.png" alt="AIC" class="logo">
          <h1>Proposta Comercial</h1>
        </div>

        <!-- O que é AIC -->
        <div class="card">
          <h2>O que é a AIC?</h2>
          <p>
            A <strong style="color: var(--aic-green);">AIC (Applied Intelligence Clustering)</strong> é uma plataforma inovadora desenvolvida para transformar dados públicos em agrupamentos inteligentes e acionáveis.
          </p>
          <p>
            Utilizando algoritmos avançados de análise de dados e machine learning, a AIC identifica grupos de indivíduos com comportamentos e características semelhantes, permitindo que empresas obtenham insights estratégicos para suas ações de marketing e negócios.
          </p>
          <div class="highlight-box">
            <p><strong>Diferencial:</strong> Enquanto o público-alvo representa um segmento amplo e a persona detalha um perfil semificcional, o <strong>cluster AIC agrupa indivíduos reais</strong> que compartilham padrões de comportamento e atributos.</p>
          </div>
        </div>

        <!-- Benefícios -->
        <div class="card">
          <h2>Benefícios da AIC</h2>
          <div class="benefits-grid">
            <div class="benefit">
              <div class="benefit-icon">01</div>
              <h4>Personalização Eficaz</h4>
              <p>Campanhas e mensagens altamente personalizadas para cada grupo identificado.</p>
            </div>
            <div class="benefit">
              <div class="benefit-icon">02</div>
              <h4>Decisão Baseada em Dados</h4>
              <p>Identificação de padrões e relações para tomada de decisão estratégica.</p>
            </div>
            <div class="benefit">
              <div class="benefit-icon">03</div>
              <h4>Otimização de Recursos</h4>
              <p>Esforços direcionados para segmentos com maior potencial de conversão.</p>
            </div>
            <div class="benefit">
              <div class="benefit-icon">04</div>
              <h4>Escalabilidade Inteligente</h4>
              <p>Validação de perfis no mercado e expansão eficiente das estratégias.</p>
            </div>
          </div>
        </div>

        <!-- Objetivo da Campanha -->
        <div class="card">
          <h2>Objetivo da Campanha</h2>
          <p>
            Realizar uma campanha estruturada de prospecção ativa, enviando mensagens personalizadas a até <strong style="color: var(--aic-green);">2.000 potenciais clientes</strong> pertencentes ao seu segmento, ao longo de 30 dias.
          </p>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">2.000</div>
              <div class="stat-label">Contatos qualificados</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">30</div>
              <div class="stat-label">Dias de campanha</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">1 a 5</div>
              <div class="stat-label">Clusters focados</div>
            </div>
          </div>
          <h3>Foco:</h3>
          <ul>
            <li><strong>Gerar conversas reais</strong> - não apenas números</li>
            <li><strong>Identificar interesse genuíno</strong> - sinais de intenção</li>
            <li><strong>Transformar conversas em leads qualificados</strong> - prontos para seu funil</li>
          </ul>
        </div>

        <!-- Metodologia -->
        <div class="card">
          <h2>Metodologia AIC</h2>
          <p>Nossa metodologia é estruturada em 6 etapas para garantir resultados consistentes:</p>
          <div class="steps">
            <div class="step">
              <h4>Diagnóstico Estruturado</h4>
              <p>Entendemos seu negócio, produto, problema que resolve, dores do cliente ideal e posicionamento.</p>
            </div>
            <div class="step">
              <h4>Seleção dos 2.000 Perfis</h4>
              <p>Analisamos comportamento, sinais de intenção e perfis ativos para filtrar prospects qualificados.</p>
            </div>
            <div class="step">
              <h4>Avaliação da Landing Page</h4>
              <p>Revisamos sua landing page com foco em clareza, narrativa e consistência com a campanha.</p>
            </div>
            <div class="step">
              <h4>Coleta de Materiais</h4>
              <p>Solicitamos fotos, vídeos, depoimentos e referências como insumo para a linha editorial.</p>
            </div>
            <div class="step">
              <h4>Criação da Linha Editorial</h4>
              <p>Desenvolvemos conteúdo estratégico alinhado ao cluster, com DMs personalizados.</p>
            </div>
            <div class="step">
              <h4>Acompanhamento Contínuo</h4>
              <p>Análise de comportamento, ajustes de estratégia e métricas em tempo real.</p>
            </div>
          </div>
        </div>

        <!-- Expectativa de Resultados -->
        <div class="card">
          <h2>Expectativa de Resultados</h2>
          <p>Com base em campanhas semelhantes, projetamos:</p>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">2.000</div>
              <div class="stat-label">Contatos enviados</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">300-500</div>
              <div class="stat-label">Respostas iniciais</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">120-200</div>
              <div class="stat-label">Leads qualificados</div>
            </div>
          </div>
          <div class="highlight-box">
            <p><strong>Importante:</strong> Esses números são projeções realistas baseadas em histórico, não garantias. Os resultados variam conforme nicho, oferta e maturidade do mercado.</p>
          </div>
        </div>

        <!-- Investimento -->
        <div class="card">
          <h2>Investimento</h2>
          <div class="pricing-card">
            <div class="pricing-value">R$ ${contractValue.toLocaleString('pt-BR')}</div>

            <!-- Lead Pricing com Promo - igual landing page -->
            <div class="lead-pricing">
              <div class="lead-price-normal">
                <span class="price-label">Valor por lead qualificado:</span>
                <span class="price-crossed">R$ 55,00</span>
              </div>
              <div class="lead-price-promo">
                <span class="promo-tag">1ª CAMPANHA</span>
                <span class="price-promo">R$ 10,00</span>
                <span class="price-per">por lead</span>
              </div>
              <p class="lead-price-note">* Preço promocional válido apenas para a primeira campanha (até 31/03/2026)</p>
            </div>

            <div class="pricing-bonus">Pagamento: 50% no início + 50% após 15 dias</div>
          </div>
          <h3>O que está incluso:</h3>
          <ul>
            <li>Diagnóstico completo do negócio e cluster</li>
            <li>Seleção e validação de até 2.000 perfis</li>
            <li>Avaliação e sugestões para landing page</li>
            <li>Criação de linha editorial completa</li>
            <li>Execução da campanha por 30 dias</li>
            <li>Acompanhamento e relatórios</li>
            <li>Entrega de leads qualificados</li>
          </ul>
          <h3>Lead qualificado = </h3>
          <p>
            Quem responde com intenção aderente + contato válido (email/telefone/WA) ou agenda conversa.
            Exclui spam, concorrente ou curiosidade sem fit. Contestação em até 5 dias.
          </p>
        </div>

        <!-- CTA -->
        ${isAccepted ? `
          <div class="accepted-section">
            <h3>Proposta Aceita!</h3>
            <p>Você aceitou esta proposta. O próximo passo é revisar e assinar o contrato.</p>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
              <button onclick="downloadPDF()" class="cta-button secondary">Baixar PDF</button>
              <a href="/cliente/contrato" class="cta-button">Ir para o Contrato</a>
            </div>
          </div>
        ` : `
          <div class="cta-section">
            <h3>Pronto para começar?</h3>
            <p>Ao aceitar a proposta, você será direcionado para revisar o contrato.</p>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
              <button onclick="downloadPDF()" class="cta-button secondary" disabled title="Disponível após aceitar a proposta">Baixar PDF</button>
              <button id="accept-btn" class="cta-button" onclick="acceptProposal()">
                Aceitar Proposta e Continuar
              </button>
            </div>
          </div>
        `}

        <!-- Disclaimer -->
        <div class="disclaimer">
          <p>Documento confidencial AIC. &copy; 2025 Applied Intelligence Clustering.</p>
          <p>Faixas de resultado são típicas e variam por nicho/copy/maturidade.</p>
        </div>
      `;
    }

    async function acceptProposal() {
      const btn = document.getElementById('accept-btn');
      btn.disabled = true;
      btn.textContent = 'Processando...';

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = buildUrl('/cliente/login');
          return;
        }

        // Se é cliente novo (sem jornada), criar jornada ao aceitar proposta
        if (journeyData.isNewClient) {
          const createResponse = await fetch('/api/aic/journey', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
              client_name: journeyData.client_name,
              client_email: journeyData.client_email,
              current_step: 'proposta_visualizada',  // Proposta aceita
              contract_value: journeyData.contract_value,
              lead_value: journeyData.lead_value
            })
          });

          if (!createResponse.ok) {
            const errorData = await createResponse.json().catch(() => ({}));
            throw new Error(errorData.message || 'Erro ao criar jornada');
          }

          const createResult = await createResponse.json();
          // Redirecionar para contrato com a nova jornada
          window.location.href = '/cliente/contrato?campaign=' + createResult.journey.id;
          return;
        }

        // Se já tem jornada, avançar etapa
        let advanceUrl = '/api/aic/journey/advance';
        if (campaignParam) {
          advanceUrl += '?journey=' + campaignParam;
        }

        const response = await fetch(advanceUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            action: 'accept_proposal',
            journey_id: campaignParam || journeyData?.id
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Erro ao aceitar proposta');
        }

        // Redirect to contract with campaign parameter
        window.location.href = buildUrl('/cliente/contrato');

      } catch (error) {
        console.error('Erro:', error);
        btn.disabled = false;
        btn.textContent = 'Aceitar Proposta e Continuar';
        alert(error.message || 'Erro ao aceitar proposta. Por favor, tente novamente.');
      }
    }

    // Initialize
    init();
  </script>
</body>
</html>
