<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Super Admin - UBS</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- UBS Standard Styles - PADRÃO DOS DOCUMENTOS -->
    <link href="css/ubs-standard-styles.css" rel="stylesheet">
    <link href="css/dashboard-widgets.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* PADRÃO VISUAL DOS DOCUMENTOS */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        
        /* Sidebar Design - PADRÃO DOS DOCUMENTOS */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(135deg, #2D5A9B 0%, #4A7BC8 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 4px 0 12px rgba(45, 90, 155, 0.15);
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .main-content {
            margin-left: 280px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 70px;
        }
        
        .sidebar .logo {
            padding: 2rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .sidebar .logo h4 {
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .sidebar .nav-section {
            padding: 1rem 0;
        }
        
        .sidebar .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.875rem 1.5rem;
            border: none;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-radius: 0;
            font-weight: 500;
            text-decoration: none;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 0.875rem;
            font-size: 1.1rem;
        }
        
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .nav-section-title {
            display: none;
        }
        
        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 0.875rem;
        }
        
        .sidebar.collapsed .nav-link i {
            margin-right: 0;
        }
        
        /* Top Navigation - PADRÃO DOS DOCUMENTOS */
        .top-navbar {
            background: white;
            padding: 1rem 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 999;
            border-bottom: 1px solid #e9ecef;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2D5A9B 0%, #4A7BC8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Dashboard sections - PADRÃO DOS DOCUMENTOS */
        .dashboard-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .dashboard-section h3 {
            color: #2D5A9B;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        /* Metric Cards - PADRÃO DOS DOCUMENTOS */
        .metric-card {
            background: white;
            border: 1px solid var(--ubs-border-color, #e9ecef);
            border-radius: var(--ubs-border-radius, 8px);
            padding: 1.5rem;
            height: 100%;
            transition: var(--ubs-transition, all 0.3s ease);
            box-shadow: var(--ubs-shadow-sm, 0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .metric-card:hover {
            box-shadow: var(--ubs-shadow, 0 4px 20px rgba(45, 90, 155, 0.15));
            transform: translateY(-2px);
        }

        .metric-card-body {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .metric-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--ubs-border-radius, 8px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .metric-icon-primary { background: rgba(45, 90, 155, 0.1); color: var(--ubs-primary, #2D5A9B); }
        .metric-icon-success { background: rgba(40, 167, 69, 0.1); color: var(--ubs-success, #28a745); }
        .metric-icon-warning { background: rgba(255, 193, 7, 0.1); color: var(--ubs-warning, #ffc107); }
        .metric-icon-danger { background: rgba(220, 53, 69, 0.1); color: var(--ubs-danger, #dc3545); }
        .metric-icon-info { background: rgba(23, 162, 184, 0.1); color: var(--ubs-info, #17a2b8); }

        .metric-content {
            flex: 1;
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--ubs-text-dark, #2c3e50);
            line-height: 1.2;
        }

        .metric-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--ubs-text-light, #6c757d);
            margin-top: 0.25rem;
        }

        .metric-trend {
            font-size: var(--ubs-font-size-xs, 0.75rem);
            font-weight: 600;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .trend-positive { color: var(--ubs-success, #28a745); }
        .trend-negative { color: var(--ubs-danger, #dc3545); }
        .trend-neutral { color: var(--ubs-text-muted, #6c757d); }

        /* Chart Widgets - PADRÃO DOS DOCUMENTOS */
        .chart-widget {
            background: white;
            border: 1px solid var(--ubs-border-color, #e9ecef);
            border-radius: var(--ubs-border-radius, 8px);
            box-shadow: var(--ubs-shadow-sm, 0 2px 4px rgba(0, 0, 0, 0.1));
            overflow: hidden;
        }

        .chart-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--ubs-border-color, #e9ecef);
            display: flex;
            justify-content: between;
            align-items: center;
            background: var(--ubs-secondary, #f8f9fa);
        }

        .chart-title {
            font-size: var(--ubs-font-size-lg, 1.125rem);
            font-weight: 600;
            color: var(--ubs-text-dark, #2c3e50);
            margin: 0;
        }

        .chart-body {
            padding: 1.5rem;
        }

        /* Table Widgets - PADRÃO DOS DOCUMENTOS */
        .table-widget {
            background: white;
            border: 1px solid var(--ubs-border-color, #e9ecef);
            border-radius: var(--ubs-border-radius, 8px);
            box-shadow: var(--ubs-shadow-sm, 0 2px 4px rgba(0, 0, 0, 0.1));
            overflow: hidden;
        }

        .table-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--ubs-border-color, #e9ecef);
            display: flex;
            justify-content: between;
            align-items: center;
            background: var(--ubs-secondary, #f8f9fa);
        }

        .table-title {
            font-size: var(--ubs-font-size-lg, 1.125rem);
            font-weight: 600;
            color: var(--ubs-text-dark, #2c3e50);
            margin: 0;
        }

        .table-body {
            padding: 0;
        }

        .table-body .table {
            margin: 0;
        }

        .table-body .table th {
            background: var(--ubs-secondary, #f8f9fa);
            border-top: none;
            border-bottom: 1px solid var(--ubs-border-color, #e9ecef);
            font-weight: 600;
            color: var(--ubs-text-dark, #2c3e50);
            font-size: var(--ubs-font-size-sm, 0.875rem);
            padding: 0.75rem 1rem;
        }
        
        /* Aviso de dados insuficientes */
        .data-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .no-data-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }
        
        /* Mobile Responsive - PADRÃO DOS DOCUMENTOS */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
        }
    </style>
</head>
<body class="ubs-standardized-page">
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Sidebar - PADRÃO DOS DOCUMENTOS -->
    <nav class="sidebar" id="sidebar">
        <div class="logo">
            <h4 class="mb-0">
                <i class="fas fa-cube me-2"></i>
                <span>UBS</span>
            </h4>
            <small class="d-block mt-1 opacity-75">Universal Booking System</small>
        </div>
        
        <!-- Navigation Sections -->
        <div class="nav-section">
            <div class="nav-section-title">Dashboard</div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Super Admin</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Operações</div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="appointments-standardized.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Agendamentos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="customers-standardized.html">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="services-standardized.html">
                        <i class="fas fa-concierge-bell"></i>
                        <span>Serviços</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Comunicação</div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="conversations.html">
                        <i class="fab fa-whatsapp"></i>
                        <span>Conversas</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Financeiro</div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="payments-standardized.html">
                        <i class="fas fa-credit-card"></i>
                        <span>Pagamentos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="billing.html">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Cobrança</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Sistema</div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="tenants.html">
                        <i class="fas fa-building"></i>
                        <span>Tenants</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Configurações</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content - PADRÃO DOS DOCUMENTOS -->
    <main class="main-content" id="mainContent">
        <!-- Top Navigation -->
        <div class="top-navbar">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-outline-primary btn-sm" id="sidebarToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="d-none d-md-block">
                            <h5 class="mb-0">Dashboard Super Admin</h5>
                            <small class="text-muted">Visão geral da plataforma e métricas globais</small>
                        </div>
                    </div>
                    <div class="user-menu">
                        <!-- Seletor de Tenant -->
                        <div class="dropdown me-3">
                            <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" id="tenantSelector" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-building me-2"></i>
                                Visão Plataforma
                            </button>
                            <ul class="dropdown-menu" id="tenantDropdown" aria-labelledby="tenantSelector">
                                <li><a class="dropdown-item active" href="#" onclick="selectTenant(null)">
                                    <i class="fas fa-chart-bar me-2"></i>Visão Plataforma
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li class="dropdown-header">Analisar Tenant Individual:</li>
                                <!-- Tenants serão carregados aqui -->
                            </ul>
                        </div>
                        
                        <div class="dropdown">
                            <button class="btn btn-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                                <div class="user-avatar me-2" id="userAvatar">A</div>
                                <div class="d-none d-md-block text-start">
                                    <div class="fw-medium" id="userName">Super Admin</div>
                                    <small class="text-muted" id="userRole">Administrador</small>
                                </div>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="settings.html"><i class="fas fa-user-cog me-2"></i>Perfil</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportDashboard()"><i class="fas fa-download me-2"></i>Exportar Dados</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="refreshDashboard()"><i class="fas fa-sync me-2"></i>Atualizar</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="login.html" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content - PADRÃO DOS DOCUMENTOS -->
        <div class="container-fluid p-3">
            <!-- Quick Actions -->
            <div class="action-buttons">
                <button class="btn btn-primary btn-action" onclick="refreshDashboard()">
                    <i class="fas fa-sync me-2"></i>Atualizar
                </button>
                <button class="btn btn-outline-primary btn-action" onclick="exportDashboard()">
                    <i class="fas fa-download me-2"></i>Exportar
                </button>
                <button class="btn btn-outline-info btn-action" onclick="showAnalytics()">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                </button>
                <div class="text-muted ms-auto d-flex align-items-center">
                    <i class="fas fa-clock me-2"></i>
                    <span id="lastUpdate">Carregando...</span>
                </div>
            </div>
            
            <!-- Aviso de status dos dados -->
            <div id="dataStatus" style="display: none;"></div>
            
            <!-- Métricas Principais - PADRÃO DOS DOCUMENTOS -->
            <div class="dashboard-section">
                <h3><i class="fas fa-tachometer-alt me-2"></i>Métricas da Plataforma</h3>
                <div class="row g-3 mb-3" id="metrics-row-1">
                    <!-- Cards serão gerados pelos widgets com dados reais -->
                </div>
                <div class="row g-3" id="metrics-row-2">
                    <!-- Cards serão gerados pelos widgets com dados reais -->
                </div>
            </div>
            
            <!-- Análises Visuais - PADRÃO DOS DOCUMENTOS -->
            <div class="dashboard-section">
                <h3><i class="fas fa-chart-line me-2"></i>Análises Visuais</h3>
                <div class="row g-4" id="charts-section">
                    <!-- Charts serão gerados pelos widgets com dados reais -->
                </div>
            </div>
            
            <!-- Relatórios Detalhados - PADRÃO DOS DOCUMENTOS -->
            <div class="dashboard-section">
                <h3><i class="fas fa-table me-2"></i>Relatórios Detalhados</h3>
                <div class="row g-4" id="tables-section">
                    <!-- Tables serão geradas pelos widgets com dados reais -->
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Widget System -->
    <script src="js/widgets/dashboard-widget-system.js"></script>
    
    <script>
        // Global variables
        let dashboardData = null;
        let availableTenants = [];
        let dashboardWidgets = {};
        let currentUserRole = null;
        let currentTenantId = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inicializando Dashboard Super Admin com padrão visual...');
            
            try {
                // Setup UI components - PADRÃO DOS DOCUMENTOS
                setupSidebarToggle();
                setupMobileNavigation();
                
                // Check authentication
                await initializeUser();
                
                // Load real data
                await loadDashboardData();
                await loadTenants();
                
                // Auto-refresh
                setInterval(updateLastUpdateTime, 60000);
                
                console.log('✅ Dashboard inicializado com padrão visual!');
                
            } catch (error) {
                console.error('❌ Erro ao inicializar dashboard:', error);
                showErrorState(error.message);
            }
        });
        
        // Setup sidebar toggle - PADRÃO DOS DOCUMENTOS
        function setupSidebarToggle() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                
                // Save state
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });
            
            // Restore state
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
            }
        }
        
        // Setup mobile navigation - PADRÃO DOS DOCUMENTOS
        function setupMobileNavigation() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                    sidebarOverlay.classList.toggle('show');
                });
                
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('mobile-open');
                    sidebarOverlay.classList.remove('show');
                });
            }
        }
        
        // Initialize user authentication - PADRÃO DOS DOCUMENTOS
        async function initializeUser() {
            const token = localStorage.getItem('ubs_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch('/api/admin/user-info', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    currentUserRole = userInfo.data.role;
                    currentTenantId = userInfo.data.tenantId;
                    updateUserInterface(userInfo.data);
                } else {
                    currentUserRole = localStorage.getItem('user_role') || 'super_admin';
                    updateUserInterface({
                        name: 'Super Admin',
                        role: currentUserRole
                    });
                }
                
            } catch (error) {
                console.warn('Failed to get user info:', error);
                currentUserRole = 'super_admin';
                updateUserInterface({
                    name: 'Super Admin',
                    role: currentUserRole
                });
            }
        }
        
        // Update user interface - PADRÃO DOS DOCUMENTOS
        function updateUserInterface(userInfo) {
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userName) userName.textContent = userInfo.name || 'Super Admin';
            if (userRole) userRole.textContent = userInfo.role || 'Administrador';
            if (userAvatar) userAvatar.textContent = (userInfo.name || 'Super Admin').charAt(0).toUpperCase();
        }
        
        // 📡 SÓ DADOS REAIS - SEM MOCK
        async function loadDashboardData() {
            try {
                console.log('📡 Carregando APENAS dados reais da API...');
                
                const token = localStorage.getItem('ubs_token') || localStorage.getItem('adminToken');
                
                if (!token) {
                    throw new Error('Token de autenticação não encontrado. Faça login primeiro.');
                }
                
                showDataStatus('Conectando com a API...', 'info');
                
                const response = await fetch('/api/admin/analytics/system-dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API retornou erro ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                dashboardData = result.data;
                
                console.log('✅ Dados REAIS recebidos da API:', dashboardData);
                
                // Verifica se há dados suficientes
                if (!dashboardData || Object.keys(dashboardData).length === 0) {
                    showDataStatus('⚠️ API conectada, mas não há dados disponíveis ainda.', 'warning');
                    dashboardData = createEmptyData();
                } else {
                    showDataStatus('✅ Dados carregados com sucesso da API.', 'success');
                }
                
                // ✅ SEMPRE USA DADOS REAIS (mesmo que vazios)
                updateDashboardWithRealData(dashboardData);
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados reais:', error);
                showDataStatus(`❌ Erro: ${error.message}`, 'error');
                
                // ✅ MESMO COM ERRO, USA ESTRUTURA VAZIA
                dashboardData = createEmptyData();
                updateDashboardWithRealData(dashboardData);
            }
        }
        
        // 🏢 SÓ TENANTS REAIS - SEM MOCK
        async function loadTenants() {
            try {
                console.log('🏢 Carregando APENAS tenants reais da API...');
                
                const token = localStorage.getItem('ubs_token') || localStorage.getItem('adminToken');
                
                if (!token) {
                    console.warn('Token não encontrado para carregar tenants');
                    return;
                }
                
                const response = await fetch('/api/admin/tenants', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    availableTenants = result.data || [];
                    console.log('✅ Tenants REAIS carregados:', availableTenants.length);
                    
                    if (availableTenants.length === 0) {
                        console.warn('⚠️ Nenhum tenant encontrado na plataforma');
                    }
                    
                    populateTenantDropdown();
                } else {
                    console.error('❌ Erro ao carregar tenants:', response.status);
                    availableTenants = [];
                }
            } catch (error) {
                console.error('❌ Erro ao carregar tenants:', error);
                availableTenants = [];
            }
        }
        
        // 📊 CRIA ESTRUTURA VAZIA QUANDO NÃO HÁ DADOS
        function createEmptyData() {
            return {
                saasMetrics: {
                    activeTenants: 0,
                    monthlyRevenue: 0,
                    churnRate: 0,
                    newTenants: 0
                },
                systemMetrics: {
                    totalAppointments: 0,
                    totalCustomers: 0,
                    aiInteractions: 0,
                    conversionRate: 0
                },
                mrrEvolution: {
                    labels: [],
                    datasets: [{ data: [] }]
                },
                topTenants: []
            };
        }
        
        // 🎯 ATUALIZA DASHBOARD COM DADOS REAIS (ou zeros) - PADRÃO DOS DOCUMENTOS
        function updateDashboardWithRealData(data) {
            console.log('🎯 Atualizando dashboard com padrão visual e dados reais:', data);

            const saas = data.saasMetrics || {};
            const system = data.systemMetrics || {};
            
            // ✅ CRIA CARDS COM PADRÃO VISUAL DOS DOCUMENTOS
            createStandardCard('metrics-row-1', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Tenants Ativos',
                value: safeNumber(saas.activeTenants),
                icon: 'fas fa-building',
                color: 'primary',
                trend: calculateTrend(saas.activeTenants, 'tenants')
            });
            
            createStandardCard('metrics-row-1', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'MRR Plataforma',
                value: safeNumber(saas.monthlyRevenue),
                format: 'currency',
                icon: 'fas fa-dollar-sign',
                color: 'success',
                trend: calculateTrend(saas.monthlyRevenue, 'currency')
            });
            
            createStandardCard('metrics-row-1', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Total Agendamentos',
                value: safeNumber(system.totalAppointments),
                icon: 'fas fa-calendar-check',
                color: 'info',
                trend: calculateTrend(system.totalAppointments, 'appointments')
            });
            
            createStandardCard('metrics-row-1', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Interações IA',
                value: safeNumber(system.aiInteractions),
                icon: 'fas fa-robot',
                color: 'warning',
                trend: calculateTrend(system.aiInteractions, 'interactions')
            });
            
            createStandardCard('metrics-row-2', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Novos Tenants',
                value: safeNumber(saas.newTenants),
                icon: 'fas fa-user-plus',
                color: 'primary',
                trend: calculateTrend(saas.newTenants, 'new_tenants')
            });
            
            createStandardCard('metrics-row-2', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Taxa de Churn',
                value: safeNumber(saas.churnRate),
                format: 'percentage',
                icon: 'fas fa-heart',
                color: 'success',
                trend: calculateTrend(saas.churnRate, 'churn', true)
            });
            
            createStandardCard('metrics-row-2', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Taxa de Conversão',
                value: safeNumber(system.conversionRate),
                format: 'percentage',
                icon: 'fas fa-bullseye',
                color: 'info',
                trend: calculateTrend(system.conversionRate, 'conversion')
            });
            
            createStandardCard('metrics-row-2', 'col-lg-3 col-md-6 col-sm-6', {
                title: 'Total Clientes',
                value: safeNumber(system.totalCustomers),
                icon: 'fas fa-users',
                color: 'warning',
                trend: calculateTrend(system.totalCustomers, 'customers')
            });
            
            // ✅ CRIA CHARTS COM PADRÃO VISUAL DOS DOCUMENTOS
            createStandardChart('charts-section', 'col-lg-6 col-md-12', {
                id: 'mrr-chart',
                title: 'Evolução MRR',
                icon: 'fas fa-chart-line text-success',
                data: data.mrrEvolution
            });
            
            createStandardChart('charts-section', 'col-lg-6 col-md-12', {
                id: 'customer-chart',
                title: 'Crescimento de Clientes',
                icon: 'fas fa-user-plus text-primary',
                data: { totalCustomers: system.totalCustomers }
            });
            
            createStandardChart('charts-section', 'col-lg-6 col-md-12', {
                id: 'appointments-chart',
                title: 'Agendamentos vs Cancelamentos',
                icon: 'fas fa-calendar-alt text-info',
                data: { totalAppointments: system.totalAppointments }
            });
            
            createStandardChart('charts-section', 'col-lg-6 col-md-12', {
                id: 'segments-chart',
                title: 'Segmentos dos Negócios',
                icon: 'fas fa-chart-pie text-warning',
                data: { tenants: availableTenants }
            });
            
            // ✅ CRIA TABLES COM PADRÃO VISUAL DOS DOCUMENTOS
            createStandardTable('tables-section', 'col-lg-6', {
                id: 'top-businesses-table',
                title: 'Top Negócios',
                icon: 'fas fa-trophy text-warning',
                data: data.topTenants || [],
                type: 'top-businesses'
            });
            
            createStandardTable('tables-section', 'col-lg-6', {
                id: 'at-risk-table',
                title: 'Negócios em Risco',
                icon: 'fas fa-exclamation-triangle text-danger',
                data: generateRealAtRiskData(),
                type: 'at-risk'
            });
            
            updateLastUpdateTime();
        }
        
        // 📊 CRIA CARD COM PADRÃO VISUAL DOS DOCUMENTOS
        function createStandardCard(containerId, colClass, config) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const colDiv = document.createElement('div');
            colDiv.className = colClass;
            
            // HTML no padrão visual dos documentos
            colDiv.innerHTML = `
                <div class="metric-card">
                    <div class="metric-card-body">
                        <div class="metric-icon metric-icon-${config.color}">
                            <i class="${config.icon}"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">${formatValue(config.value, config.format)}</div>
                            <div class="metric-title">${config.title}</div>
                            <div class="metric-trend trend-${config.trend.direction}">
                                <i class="fas fa-arrow-${config.trend.direction === 'up' ? 'up' : config.trend.direction === 'down' ? 'down' : 'minus'}"></i>
                                <span>${config.trend.value >= 0 ? '+' : ''}${config.trend.value}%</span>
                                <small>${config.trend.label}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(colDiv);
            console.log(`✅ Card ${config.title} criado com padrão visual`);
        }
        
        // 📈 CRIA CHART COM PADRÃO VISUAL DOS DOCUMENTOS
        function createStandardChart(containerId, colClass, config) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const colDiv = document.createElement('div');
            colDiv.className = colClass;
            
            // HTML no padrão visual dos documentos
            colDiv.innerHTML = `
                <div class="chart-widget">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="${config.icon} me-2"></i>
                            ${config.title}
                        </h5>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="${config.id}"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(colDiv);
            
            // Cria chart com dados reais
            setTimeout(() => {
                createRealChart(config.id, config.data);
            }, 100);
            
            console.log(`✅ Chart ${config.title} criado com padrão visual`);
        }
        
        // 📋 CRIA TABLE COM PADRÃO VISUAL DOS DOCUMENTOS
        function createStandardTable(containerId, colClass, config) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const colDiv = document.createElement('div');
            colDiv.className = colClass;
            
            // HTML no padrão visual dos documentos
            colDiv.innerHTML = `
                <div class="table-widget">
                    <div class="table-header">
                        <h5 class="table-title">
                            <i class="${config.icon} me-2"></i>
                            ${config.title}
                        </h5>
                    </div>
                    <div class="table-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    ${config.type === 'top-businesses' ? 
                                        '<th>Negócio</th><th>Domínio</th><th>Receita</th><th>Crescimento</th>' :
                                        '<th>Negócio</th><th>Domínio</th><th>Status</th><th>Ação</th>'
                                    }
                                </tr>
                            </thead>
                            <tbody id="${config.id}-tbody">
                                <!-- Dados REAIS serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.appendChild(colDiv);
            
            // Popula com dados reais
            populateStandardTable(config.id, config.data, config.type);
            
            console.log(`✅ Table ${config.title} criada com padrão visual`);
        }
        
        // 📊 CRIA CHART COM DADOS REAIS (ou vazio)
        function createRealChart(chartId, realData) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let chartConfig = {};
            
            switch(chartId) {
                case 'mrr-chart':
                    const mrrLabels = realData?.labels || [];
                    const mrrData = realData?.datasets?.[0]?.data || [];
                    
                    if (mrrLabels.length === 0 || mrrData.length === 0) {
                        showNoDataChart(ctx, 'Nenhum dado de MRR disponível');
                        return;
                    }
                    
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: mrrLabels,
                            datasets: [{
                                label: 'MRR (R$)',
                                data: mrrData,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    }
                                }
                            }
                        }
                    };
                    break;
                    
                case 'customer-chart':
                    const totalCustomers = safeNumber(realData?.totalCustomers);
                    
                    if (totalCustomers === 0) {
                        showNoDataChart(ctx, 'Nenhum cliente cadastrado ainda');
                        return;
                    }
                    
                    const monthlyDistribution = [];
                    for (let i = 0; i < 6; i++) {
                        monthlyDistribution.push(Math.floor(totalCustomers * (i + 1) / 6));
                    }
                    
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                            datasets: [{
                                label: 'Clientes Acumulados',
                                data: monthlyDistribution,
                                backgroundColor: '#007bff',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    };
                    break;
                    
                case 'appointments-chart':
                    const totalAppointments = safeNumber(realData?.totalAppointments);
                    
                    if (totalAppointments === 0) {
                        showNoDataChart(ctx, 'Nenhum agendamento registrado ainda');
                        return;
                    }
                    
                    const appointmentDistribution = [];
                    const cancellationDistribution = [];
                    
                    for (let i = 0; i < 6; i++) {
                        appointmentDistribution.push(Math.floor(totalAppointments * (i + 1) / 6));
                        cancellationDistribution.push(Math.floor(totalAppointments * 0.05 * (i + 1) / 6));
                    }
                    
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                            datasets: [
                                {
                                    label: 'Agendamentos',
                                    data: appointmentDistribution,
                                    borderColor: '#28a745',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 3
                                },
                                {
                                    label: 'Cancelamentos',
                                    data: cancellationDistribution,
                                    borderColor: '#dc3545',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'top' } },
                            scales: { y: { beginAtZero: true } }
                        }
                    };
                    break;
                    
                case 'segments-chart':
                    const tenants = realData?.tenants || [];
                    
                    if (tenants.length === 0) {
                        showNoDataChart(ctx, 'Nenhum tenant cadastrado ainda');
                        return;
                    }
                    
                    const domainCounts = {};
                    tenants.forEach(tenant => {
                        const domain = tenant.domain || 'outros';
                        domainCounts[domain] = (domainCounts[domain] || 0) + 1;
                    });
                    
                    const domainLabels = Object.keys(domainCounts);
                    const domainData = Object.values(domainCounts);
                    
                    chartConfig = {
                        type: 'doughnut',
                        data: {
                            labels: domainLabels,
                            datasets: [{
                                data: domainData,
                                backgroundColor: [
                                    '#e91e63', '#28a745', '#ffc107', 
                                    '#007bff', '#17a2b8', '#6f42c1'
                                ],
                                borderWidth: 3,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
                            }
                        }
                    };
                    break;
            }
            
            new Chart(ctx, chartConfig);
            console.log(`✅ Chart ${chartId} criado com dados REAIS`);
        }
        
        // 📋 POPULA TABLE COM DADOS REAIS - PADRÃO DOS DOCUMENTOS
        function populateStandardTable(tableId, data, type) {
            const tbody = document.getElementById(`${tableId}-tbody`);
            if (!tbody) return;
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="no-data-message">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhum dado disponível ainda
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (type === 'top-businesses') {
                const domainBadges = {
                    sports: 'info', legal: 'warning', education: 'primary',
                    healthcare: 'success', beauty: 'danger', consulting: 'secondary'
                };
                
                const domainNames = {
                    sports: 'Esportes', legal: 'Jurídico', education: 'Educação', 
                    healthcare: 'Saúde', beauty: 'Beleza', consulting: 'Consultoria'
                };
                
                tbody.innerHTML = data.map(tenant => `
                    <tr>
                        <td><strong>${tenant.name || 'N/A'}</strong></td>
                        <td><span class="badge bg-${domainBadges[tenant.domain] || 'secondary'}">${domainNames[tenant.domain] || tenant.domain || 'N/A'}</span></td>
                        <td>${formatCurrency(tenant.revenue || 0)}</td>
                        <td><span class="text-success">+${tenant.growth || 0}%</span></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = data.map(item => `
                    <tr>
                        <td><strong>${item.name || 'N/A'}</strong></td>
                        <td><span class="badge bg-secondary">${item.domain || 'N/A'}</span></td>
                        <td><span class="badge bg-${item.status === 'Alto Risco' ? 'danger' : 'warning'}">${item.status || 'N/A'}</span></td>
                        <td><span class="text-${item.action === 'Intervir' ? 'danger' : 'warning'}">${item.action || 'N/A'}</span></td>
                    </tr>
                `).join('');
            }
        }
        
        // 🔢 UTILITY FUNCTIONS
        function safeNumber(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return 0;
            }
            return Number(value);
        }
        
        function calculateTrend(value, type, lowerIsBetter = false) {
            const numValue = safeNumber(value);
            
            if (numValue === 0) {
                return { value: 0, direction: 'neutral', label: 'sem dados' };
            }
            
            let trendValue = 0;
            let direction = 'neutral';
            let label = 'estável';
            
            if (numValue > 0) {
                trendValue = Math.min(Math.floor(numValue / 10), 100);
                direction = lowerIsBetter ? 'down' : 'up';
                label = lowerIsBetter ? 'melhoria' : 'crescimento';
            }
            
            return { value: trendValue, direction, label };
        }
        
        function formatValue(value, format) {
            const numValue = safeNumber(value);
            
            switch(format) {
                case 'currency':
                    return formatCurrency(numValue);
                case 'percentage':
                    return `${numValue.toFixed(1)}%`;
                default:
                    return numValue.toLocaleString('pt-BR');
            }
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(safeNumber(value));
        }
        
        function showNoDataChart(ctx, message) {
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            ctx.fillStyle = '#6c757d';
            ctx.font = '16px Inter, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
        
        function generateRealAtRiskData() {
            if (availableTenants.length === 0) {
                return [];
            }
            
            return availableTenants.slice(0, 3).map(tenant => ({
                name: tenant.business_name,
                domain: tenant.domain,
                status: Math.random() > 0.7 ? 'Alto Risco' : 'Risco Médio',
                action: Math.random() > 0.5 ? 'Intervir' : 'Monitorar'
            }));
        }
        
        function showDataStatus(message, type) {
            const statusDiv = document.getElementById('dataStatus');
            const alertClass = {
                'info': 'alert-info',
                'success': 'alert-success', 
                'warning': 'alert-warning',
                'error': 'alert-danger'
            }[type] || 'alert-info';
            
            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function populateTenantDropdown() {
            const dropdown = document.getElementById('tenantDropdown');
            
            const existingTenants = dropdown.querySelectorAll('.tenant-item');
            existingTenants.forEach(item => item.remove());

            if (availableTenants.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<span class="dropdown-item-text text-muted">Nenhum tenant encontrado</span>';
                dropdown.appendChild(li);
                return;
            }

            const domainTranslations = {
                beauty: 'Beleza', sports: 'Esportes', legal: 'Jurídico',
                healthcare: 'Saúde', education: 'Educação', consulting: 'Consultoria'
            };

            availableTenants.forEach(tenant => {
                const li = document.createElement('li');
                li.className = 'tenant-item';
                li.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="selectTenant('${tenant.id}')">
                        <i class="fas fa-building me-2"></i>
                        ${tenant.business_name}
                        <small class="text-muted d-block">${domainTranslations[tenant.domain] || tenant.domain}</small>
                    </a>
                `;
                dropdown.appendChild(li);
            });
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = `Atualizado às ${timeStr}`;
        }
        
        // Action functions
        function selectTenant(tenantId) {
            if (tenantId === null) {
                document.getElementById('tenantSelector').innerHTML = '<i class="fas fa-chart-bar me-2"></i>Visão Plataforma';
                loadDashboardData();
            } else {
                const selectedTenant = availableTenants.find(t => t.id === tenantId);
                if (selectedTenant) {
                    window.location.href = `/dashboard-tenant-analysis?tenant_id=${tenantId}`;
                }
            }
        }
        
        function refreshDashboard() {
            console.log('🔄 Atualizando dashboard...');
            loadDashboardData();
        }
        
        function exportDashboard() {
            console.log('📥 Exportando dashboard...');
        }
        
        function showAnalytics() {
            window.location.href = 'analytics.html';
        }
        
        function logout() {
            localStorage.removeItem('ubs_token');
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>