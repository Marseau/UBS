<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minhas Campanhas | Portal AIC</title>
  <link rel="icon" type="image/png" href="/assets/AIC/Imagens%20Vetor%20/AIC%20Icone%20Cheio.png">
  <meta name="theme-color" content="#0C1B33">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --aic-green: #0ECC97;
      --aic-green-dark: #0BA578;
      --aic-green-glow: rgba(14, 204, 151, 0.15);
      --aic-navy: #0C1B33;
      --aic-navy-light: #122444;
      --aic-navy-lighter: #1a3055;
      --aic-white: #FDFDFD;
      --aic-gray: #94a3b8;
      --aic-gray-light: #cbd5e1;
      --aic-border: #1e3a5f;
      --aic-blue: #3b82f6;
      --aic-purple: #8b5cf6;
      --aic-yellow: #f59e0b;
      --aic-red: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--aic-navy);
      color: var(--aic-white);
      min-height: 100vh;
    }

    .main-content {
      padding: 32px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header Section */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .page-header p {
      color: var(--aic-gray);
      font-size: 15px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Filters */
    .filter-select {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 12px 16px;
      color: var(--aic-white);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      min-width: 180px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--aic-green);
    }

    /* Search Input */
    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 14px;
      color: var(--aic-gray);
      pointer-events: none;
    }

    .search-input {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 10px;
      padding: 12px 16px 12px 42px;
      color: var(--aic-white);
      font-size: 14px;
      font-family: inherit;
      min-width: 220px;
      transition: border-color 0.2s;
    }

    .search-input::placeholder {
      color: var(--aic-gray);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--aic-green);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s;
    }

    .stat-card.clickable {
      cursor: pointer;
    }

    .stat-card.clickable:hover {
      border-color: var(--aic-green);
      transform: translateY(-2px);
    }

    .stat-card.selected {
      border-color: var(--aic-green);
      background: rgba(14, 204, 151, 0.1);
      box-shadow: 0 0 0 1px var(--aic-green);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon.green { background: rgba(14, 204, 151, 0.15); color: var(--aic-green); }
    .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--aic-blue); }
    .stat-icon.yellow { background: rgba(245, 158, 11, 0.15); color: var(--aic-yellow); }
    .stat-icon.gray { background: rgba(148, 163, 184, 0.15); color: var(--aic-gray); }

    .stat-info h3 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .stat-info p {
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Campaign Sections */
    .campaigns-section {
      margin-bottom: 40px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .section-count {
      background: var(--aic-navy-lighter);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--aic-gray);
    }

    /* Campaign Cards Grid */
    .campaigns-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }

    .campaign-card {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .campaign-card:hover {
      border-color: var(--aic-green);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    .campaign-card.active {
      border-color: var(--aic-green);
      box-shadow: 0 0 0 1px var(--aic-green), 0 0 20px var(--aic-green-glow);
    }

    .campaign-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .campaign-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .campaign-client {
      font-size: 13px;
      color: var(--aic-gray);
    }

    .campaign-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .campaign-status.setup {
      background: rgba(59, 130, 246, 0.15);
      color: var(--aic-blue);
    }

    .campaign-status.active {
      background: rgba(14, 204, 151, 0.15);
      color: var(--aic-green);
    }

    .campaign-status.completed {
      background: rgba(148, 163, 184, 0.15);
      color: var(--aic-gray);
    }

    .campaign-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--aic-yellow);
    }

    /* Progress Bar */
    .campaign-progress {
      margin-bottom: 16px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 12px;
      color: var(--aic-gray);
    }

    .progress-percent {
      font-size: 12px;
      font-weight: 600;
      color: var(--aic-green);
    }

    .progress-bar {
      height: 6px;
      background: var(--aic-navy);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aic-green), var(--aic-green-dark));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Campaign Step */
    .campaign-step {
      background: var(--aic-navy);
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(59, 130, 246, 0.15);
      color: var(--aic-blue);
    }

    .step-info {
      flex: 1;
    }

    .step-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .step-action {
      font-size: 12px;
      color: var(--aic-gray);
    }

    .step-arrow {
      color: var(--aic-gray);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: var(--aic-navy-light);
      border: 1px dashed var(--aic-border);
      border-radius: 16px;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      background: var(--aic-navy-lighter);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: var(--aic-gray);
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: var(--aic-gray);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .btn-new-campaign {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 28px;
      background: var(--aic-green);
      color: var(--aic-navy);
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-new-campaign:hover {
      background: #10E6A8;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(14, 204, 151, 0.3);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--aic-green), var(--aic-green-dark));
      color: var(--aic-navy);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--aic-green-glow);
    }

    .btn-secondary {
      background: var(--aic-navy-light);
      border: 1px solid var(--aic-border);
      color: var(--aic-white);
    }

    .btn-secondary:hover {
      border-color: var(--aic-green);
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px;
      color: var(--aic-gray);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--aic-navy-lighter);
      border-top-color: var(--aic-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive - Tablet */
    @media (max-width: 1024px) {
      body { margin-left: 0 !important; }
      .main-content { padding: 24px 20px; }
    }

    /* Responsive - Mobile */
    @media (max-width: 768px) {
      .main-content {
        padding: 16px;
        padding-top: 70px; /* Espaço para header mobile */
      }
      .page-header {
        flex-direction: column;
        gap: 16px;
      }
      .page-header h1 {
        font-size: 22px;
      }
      .header-actions {
        width: 100%;
      }
      .filter-select {
        flex: 1;
        min-width: 140px;
      }
      .campaigns-grid {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .stat-card {
        padding: 16px;
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      .stat-icon {
        width: 40px;
        height: 40px;
      }
      .stat-info h3 {
        font-size: 20px;
      }
      .campaign-card {
        padding: 20px;
      }
      .campaign-name {
        font-size: 16px;
      }
      .section-header h2 {
        font-size: 16px;
      }
    }

    /* Responsive - Small Mobile */
    @media (max-width: 480px) {
      .main-content {
        padding: 12px;
        padding-top: 70px;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .stat-card {
        padding: 12px;
      }
      .stat-info h3 {
        font-size: 18px;
      }
      .stat-info p {
        font-size: 11px;
      }
      .header-actions {
        flex-direction: column;
      }
      .filter-select {
        width: 100%;
      }
    }

    /* Mobile Header */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--aic-navy-light);
      border-bottom: 1px solid var(--aic-border);
      z-index: 999;
      padding: 0 16px;
      align-items: center;
      justify-content: space-between;
    }

    .mobile-header-logo {
      height: 28px;
    }

    .mobile-menu-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      color: var(--aic-white);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .mobile-menu-btn:hover {
      background: var(--aic-navy-lighter);
    }

    @media (max-width: 1024px) {
      .mobile-header {
        display: flex;
      }
      .main-content {
        padding-top: 80px; /* Espaço para header mobile */
      }
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Hide toggle button from sidebar on mobile (we use our own) */
    @media (max-width: 1024px) {
      .aic-sidebar-toggle {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <header class="mobile-header" id="mobileHeader">
    <img src="/assets/AIC/Imagens%20Vetor%20/Logo%20Completo%20nome%20Branco%20sem%20fundo.png" alt="AIC" class="mobile-header-logo">
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileSidebar()">
      &#9776;
    </button>
  </header>

  <!-- Sidebar overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

  <div class="main-content">
    <!-- Loading State -->
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>Carregando campanhas...</p>
    </div>

    <!-- Content -->
    <div id="contentArea" style="display: none;">
      <!-- Header -->
      <div class="page-header">
        <div>
          <h1 id="pageTitle">Minhas Campanhas</h1>
          <p id="pageSubtitle">Gerencie suas campanhas de prospeccao inteligente</p>
        </div>
        <div class="header-actions">
          <!-- Search by name -->
          <div class="search-wrapper">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar campanha...">
          </div>
          <!-- Admin: Client Filter -->
          <select class="filter-select" id="clientFilter" style="display: none;">
            <option value="">Todos os clientes</option>
          </select>
          <!-- Status Filter -->
          <select class="filter-select" id="statusFilter">
            <option value="">Todos os status</option>
            <option value="setup">Em Setup</option>
            <option value="active">Ativas</option>
            <option value="completed">Concluidas</option>
          </select>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card clickable" id="statCardSetup" data-status="setup">
          <div class="stat-icon blue" id="statSetupIcon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          </div>
          <div class="stat-info">
            <h3 id="statSetup">0</h3>
            <p>Em Setup</p>
          </div>
        </div>
        <div class="stat-card clickable" id="statCardActive" data-status="active">
          <div class="stat-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          </div>
          <div class="stat-info">
            <h3 id="statActive">0</h3>
            <p>Ativas</p>
          </div>
        </div>
        <div class="stat-card clickable" id="statCardCompleted" data-status="completed">
          <div class="stat-icon gray">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </div>
          <div class="stat-info">
            <h3 id="statCompleted">0</h3>
            <p>Concluidas</p>
          </div>
        </div>
        <div class="stat-card clickable" id="statCardPending" data-status="pending">
          <div class="stat-icon yellow">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="stat-info">
            <h3 id="statPending">0</h3>
            <p>Aguardando</p>
          </div>
        </div>
      </div>

      <!-- Campaigns Container -->
      <div id="campaignsContainer">
        <!-- Will be populated by JS -->
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        </div>
        <h3 id="emptyTitle">Nenhuma campanha encontrada</h3>
        <p id="emptyMessage">Voce ainda nao possui campanhas cadastradas.</p>
        <a href="/cliente/proposta" class="btn-new-campaign" id="btnNewCampaign" style="margin-top: 24px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span>Ver Proposta</span>
        </a>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://qsdfyffuonywmtnlycri.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZGZ5ZmZ1b255d210bmx5Y3JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMjY0NzgsImV4cCI6MjA2NjcwMjQ3OH0.IDJdOApiNM0FJvRe5mp28L7U89GWeHpPoPlPreexwbg';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;  // Exportar para sidebar usar

    // Icons
    const ICONS = {
      proposta: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      contrato: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/></svg>',
      pagamento: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
      briefing: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      onboarding: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
      campanha: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
      arrow: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>'
    };

    // Step configuration - mapping current_step to display info
    const STEP_CONFIG = {
      'proposta_enviada': { label: 'Proposta Enviada', action: 'Aguardando visualizacao', icon: 'proposta', group: 'setup', progress: 10 },
      'proposta_visualizada': { label: 'Proposta Visualizada', action: 'Aguardando aceitacao', icon: 'proposta', group: 'setup', progress: 15 },
      'proposta_aceita': { label: 'Proposta Aceita', action: 'Assinar contrato', icon: 'contrato', group: 'setup', progress: 20 },
      'contrato_enviado': { label: 'Contrato Enviado', action: 'Aguardando assinatura', icon: 'contrato', group: 'setup', progress: 25 },
      'contrato_assinado': { label: 'Contrato Assinado', action: 'Aguardando pagamento', icon: 'contrato', group: 'setup', progress: 35 },
      'pagamento_pendente': { label: 'Pagamento Pendente', action: 'Aguardando confirmacao', icon: 'pagamento', group: 'pending', progress: 40 },
      'pagamento_confirmado': { label: 'Pagamento Confirmado', action: 'Configurar credenciais', icon: 'pagamento', group: 'setup', progress: 50 },
      'credenciais_pendente': { label: 'Credenciais Pendente', action: 'Configurar WhatsApp/Instagram', icon: 'onboarding', group: 'setup', progress: 55 },
      'credenciais_ok': { label: 'Credenciais Configuradas', action: 'Preencher briefing', icon: 'onboarding', group: 'setup', progress: 60 },
      'briefing_pendente': { label: 'Briefing Pendente', action: 'Completar briefing', icon: 'briefing', group: 'setup', progress: 70 },
      'briefing_completo': { label: 'Briefing Completo', action: 'Aguardando ativacao', icon: 'briefing', group: 'setup', progress: 80 },
      'onboarding_pendente': { label: 'Onboarding Pendente', action: 'Configurar conta', icon: 'onboarding', group: 'setup', progress: 85 },
      'onboarding_completo': { label: 'Onboarding Completo', action: 'Aguardando ativacao', icon: 'onboarding', group: 'setup', progress: 90 },
      'campanha_ativa': { label: 'Campanha Ativa', action: 'Ver metricas', icon: 'campanha', group: 'active', progress: 95 },
      'campanha_concluida': { label: 'Campanha Concluida', action: 'Ver relatorio', icon: 'campanha', group: 'completed', progress: 100 }
    };

    let campaigns = [];
    let allCampaignsCount = 0;  // Total de campanhas (para saber se é cliente novo ou retornando)
    let clients = [];
    let isAdmin = false;
    let currentClientId = null;

    async function init() {
      // Esta página é SEMPRE visão do cliente, nunca admin
      isAdmin = false;

      // Setup filters (apenas status filter, client filter não existe para cliente)
      document.getElementById('statusFilter').addEventListener('change', renderCampaigns);
      document.getElementById('searchInput').addEventListener('input', renderCampaigns);

      // Garantir que elementos de admin estejam ocultos
      document.getElementById('clientFilter').style.display = 'none';

      await loadCampaigns();
    }

    async function loadCampaigns() {
      try {
        // Obter token - tentar Supabase primeiro, depois localStorage
        let token = null;

        // Tentar pegar do localStorage primeiro (mais confiavel)
        token = localStorage.getItem('aic_access_token');

        // Se nao tiver no localStorage, tentar do Supabase
        if (!token) {
          const { data: { session } } = await supabaseClient.auth.getSession();
          token = session?.access_token;
        }

        console.log('[ClientHome] Token:', token ? 'found' : 'not found', 'isAdmin:', isAdmin);

        if (!token && !isAdmin) {
          console.log('[ClientHome] No token and not admin, redirecting to login');
          window.location.href = '/aic/login?redirect=/cliente';
          return;
        }

        const endpoint = isAdmin ? '/api/aic/campaigns/all' : '/api/aic/campaigns/me';

        const response = await fetch(endpoint, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });

        if (!response.ok) {
          if (response.status === 401 && !isAdmin) {
            window.location.href = '/aic/login?redirect=/cliente';
            return;
          }
          throw new Error('Erro ao carregar campanhas');
        }

        const data = await response.json();
        console.log('[ClientHome] API response:', data);
        campaigns = data.campaigns || [];
        console.log('[ClientHome] Loaded campaigns:', campaigns);
        allCampaignsCount = data.total_count || campaigns.length;  // Total histórico de campanhas

        // Extract unique clients for admin filter
        if (isAdmin && campaigns.length > 0) {
          const clientMap = new Map();
          campaigns.forEach(c => {
            if (c.client_id && c.client_name) {
              clientMap.set(c.client_id, c.client_name);
            }
          });
          clients = Array.from(clientMap, ([id, name]) => ({ id, name }));
          populateClientFilter();
        }

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('contentArea').style.display = 'block';

        renderCampaigns();

      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('loadingState').innerHTML = `
          <p style="color: #ef4444;">Erro ao carregar campanhas</p>
          <button onclick="location.reload()" class="btn btn-secondary" style="margin-top: 16px;">Tentar novamente</button>
        `;
      }
    }

    function populateClientFilter() {
      const select = document.getElementById('clientFilter');
      select.innerHTML = '<option value="">Todos os clientes</option>';
      clients.sort((a, b) => a.name.localeCompare(b.name)).forEach(client => {
        select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
      });
    }

    function renderCampaigns() {
      const statusFilter = document.getElementById('statusFilter').value;
      const clientFilter = currentClientId;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

      console.log('[ClientHome] renderCampaigns called');
      console.log('[ClientHome] statusFilter:', statusFilter);
      console.log('[ClientHome] campaigns:', campaigns);
      console.log('[ClientHome] campaigns.length:', campaigns.length);

      // Filter campaigns
      let filtered = campaigns.filter(c => {
        const stepConfig = STEP_CONFIG[c.current_step] || { group: 'setup' };
        console.log('[ClientHome] Filtering campaign:', c.campaign_name, 'step:', c.current_step, 'group:', stepConfig.group);

        // Search filter (by campaign name, project name, or client name)
        if (searchTerm) {
          const campaignName = (c.campaign_name || '').toLowerCase();
          const projectName = (c.project_name || '').toLowerCase();
          const clientName = (c.client_name || '').toLowerCase();
          const nicho = (c.nicho_principal || '').toLowerCase();
          if (!campaignName.includes(searchTerm) &&
              !projectName.includes(searchTerm) &&
              !clientName.includes(searchTerm) &&
              !nicho.includes(searchTerm)) {
            return false;
          }
        }

        // Status filter
        if (statusFilter) {
          if (statusFilter === 'setup' && stepConfig.group !== 'setup') return false;
          if (statusFilter === 'active' && stepConfig.group !== 'active') return false;
          if (statusFilter === 'completed' && stepConfig.group !== 'completed') return false;
          if (statusFilter === 'pending' && stepConfig.group !== 'pending') return false;
        }

        // Client filter (admin only)
        if (clientFilter && c.client_id !== clientFilter) return false;

        return true;
      });

      // Update stats
      updateStats(campaigns);

      // Group by status
      const setup = filtered.filter(c => {
        const g = (STEP_CONFIG[c.current_step] || {}).group;
        return g === 'setup' || g === 'pending';
      });
      const active = filtered.filter(c => (STEP_CONFIG[c.current_step] || {}).group === 'active');
      const completed = filtered.filter(c => (STEP_CONFIG[c.current_step] || {}).group === 'completed');

      const container = document.getElementById('campaignsContainer');

      if (filtered.length === 0) {
        container.innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';

        if (statusFilter || clientFilter) {
          // Filtro aplicado mas sem resultados
          document.getElementById('emptyTitle').textContent = 'Nenhuma campanha encontrada';
          document.getElementById('emptyMessage').textContent = 'Nenhuma campanha encontrada com os filtros selecionados.';
          document.getElementById('btnNewCampaign').style.display = 'none';
        } else if (allCampaignsCount === 0) {
          // Cliente novo - nunca teve campanhas
          document.getElementById('emptyTitle').textContent = 'Bem Vindo!';
          document.getElementById('emptyMessage').textContent = 'Comece sua jornada, pressione em Proposta para conhecer nossa proposta de trabalho.';
          document.getElementById('btnNewCampaign').style.display = 'inline-flex';
        } else {
          // Cliente retornando - já teve campanhas antes
          document.getElementById('emptyTitle').textContent = 'Nova Campanha';
          document.getElementById('emptyMessage').textContent = 'Inicie mais uma jornada, pressione em Proposta para aceitar.';
          document.getElementById('btnNewCampaign').style.display = 'inline-flex';
        }
        return;
      }

      document.getElementById('emptyState').style.display = 'none';

      let html = '';

      // Active campaigns first
      if (active.length > 0) {
        html += renderSection('Campanhas Ativas', active, 'active');
      }

      // Setup campaigns
      if (setup.length > 0) {
        html += renderSection('Em Configuracao', setup, 'setup');
      }

      // Completed campaigns
      if (completed.length > 0) {
        html += renderSection('Concluidas', completed, 'completed');
      }

      container.innerHTML = html;
    }

    function renderSection(title, items, type) {
      return `
        <div class="campaigns-section">
          <div class="section-header">
            <h2>${title}</h2>
            <span class="section-count">${items.length}</span>
          </div>
          <div class="campaigns-grid">
            ${items.map(c => renderCampaignCard(c, type)).join('')}
          </div>
        </div>
      `;
    }

    function renderCampaignCard(campaign, type) {
      const stepConfig = STEP_CONFIG[campaign.current_step] || {
        label: 'Iniciando',
        action: 'Configurar campanha',
        icon: 'proposta',
        progress: 5
      };

      const statusClass = type === 'active' ? 'active' : type === 'completed' ? 'completed' : 'setup';
      const statusLabel = type === 'active' ? 'Ativa' : type === 'completed' ? 'Concluida' : 'Em Setup';

      // Build URL with campaign ID
      const campaignUrl = getCampaignUrl(campaign);

      return `
        <div class="campaign-card ${type === 'active' ? 'active' : ''}" onclick="window.location.href='${campaignUrl}'">
          <div class="campaign-card-header">
            <div>
              <div class="campaign-name">${campaign.campaign_name || 'Campanha sem nome'}</div>
              ${isAdmin ? `<div class="campaign-client">${campaign.client_name || 'Cliente'}</div>` : ''}
            </div>
            <span class="campaign-status ${statusClass}">
              ${statusLabel}
            </span>
          </div>

          <div class="campaign-progress">
            <div class="progress-header">
              <span class="progress-label">Progresso</span>
              <span class="progress-percent">${stepConfig.progress}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${stepConfig.progress}%"></div>
            </div>
          </div>

          <div class="campaign-step">
            <div class="step-icon">${ICONS[stepConfig.icon] || ICONS.proposta}</div>
            <div class="step-info">
              <div class="step-title">${stepConfig.label}</div>
              <div class="step-action">${stepConfig.action}</div>
            </div>
            <div class="step-arrow">${ICONS.arrow}</div>
          </div>
        </div>
      `;
    }

    function getCampaignUrl(campaign) {
      const step = campaign.current_step;

      // Map step to appropriate page with campaign ID
      // proposta_aceita deve ir para contrato (próximo passo)
      if (step === 'proposta_aceita') {
        return `/cliente/contrato?campaign=${campaign.id}`;
      } else if (step.includes('proposta')) {
        return `/cliente/proposta?campaign=${campaign.id}`;
      } else if (step.includes('contrato')) {
        return `/cliente/contrato?campaign=${campaign.id}`;
      } else if (step.includes('pagamento')) {
        return `/cliente/pagamento?campaign=${campaign.id}`;
      } else if (step.includes('credenciais')) {
        return `/cliente/credenciais?campaign=${campaign.id}`;
      } else if (step.includes('briefing')) {
        return `/cliente/briefing?campaign=${campaign.id}`;
      } else if (step.includes('onboarding')) {
        return `/cliente/onboarding?campaign=${campaign.id}`;
      } else if (step.includes('campanha')) {
        return `/cliente/dashboard?campaign=${campaign.id}`;
      }

      return `/cliente/proposta?campaign=${campaign.id}`;
    }

    // Filter by clicking on stat cards
    function filterByStatus(status) {
      console.log('[ClientHome] filterByStatus called with:', status);
      const statusFilter = document.getElementById('statusFilter');
      const statCards = document.querySelectorAll('.stat-card.clickable');

      // Se clicar no mesmo filtro, limpa o filtro
      if (statusFilter.value === status) {
        statusFilter.value = '';
        statCards.forEach(card => card.classList.remove('selected'));
      } else {
        statusFilter.value = status;
        // Atualizar visual dos cards
        statCards.forEach(card => {
          if (card.dataset.status === status) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
        });
      }

      // Disparar evento de change para refiltrar
      statusFilter.dispatchEvent(new Event('change'));
    }

    function updateStats(allCampaigns) {
      let setup = 0, active = 0, completed = 0, pending = 0;

      allCampaigns.forEach(c => {
        const group = (STEP_CONFIG[c.current_step] || {}).group || 'setup';
        if (group === 'active') active++;
        else if (group === 'completed') completed++;
        else if (group === 'pending') pending++;
        else setup++;
      });

      document.getElementById('statSetup').textContent = setup;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statPending').textContent = pending;

      // Atualizar visual do card selecionado baseado no filtro atual
      const currentFilter = document.getElementById('statusFilter').value;
      const statCards = document.querySelectorAll('.stat-card.clickable');
      statCards.forEach(card => {
        if (card.dataset.status === currentFilter) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });
    }

    // Initialize - aguardar Supabase carregar sessão do localStorage
    supabaseClient.auth.onAuthStateChange((event, session) => {
      console.log('[ClientHome] Auth state change:', event, session ? 'has session' : 'no session');
      if (event === 'INITIAL_SESSION') {
        init();
      }
    });

    // Mobile sidebar toggle
    function toggleMobileSidebar() {
      const sidebar = document.getElementById('aic-sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const btn = document.getElementById('mobileMenuBtn');
      if (sidebar) {
        const isOpen = sidebar.classList.contains('open');
        if (isOpen) {
          sidebar.classList.remove('open');
          sidebar.classList.add('collapsed');
          overlay.classList.remove('active');
          btn.innerHTML = '&#9776;';
        } else {
          sidebar.classList.add('open');
          sidebar.classList.remove('collapsed');
          overlay.classList.add('active');
          btn.innerHTML = '&#10005;';
        }
      }
    }
    window.toggleMobileSidebar = toggleMobileSidebar;
    window.filterByStatus = filterByStatus;

    // Adicionar event listeners nos cards de estatisticas
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[ClientHome] Adding click listeners to stat cards');
      document.getElementById('statCardSetup')?.addEventListener('click', () => filterByStatus('setup'));
      document.getElementById('statCardActive')?.addEventListener('click', () => filterByStatus('active'));
      document.getElementById('statCardCompleted')?.addEventListener('click', () => filterByStatus('completed'));
      document.getElementById('statCardPending')?.addEventListener('click', () => filterByStatus('pending'));
    });
  </script>
  <script src="/components/aic-client-sidebar.js"></script>
</body>
</html>
