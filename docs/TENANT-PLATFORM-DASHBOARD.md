# Tenant-Platform Dashboard System

## Vis√£o Geral

O **Tenant-Platform Dashboard** √© um sistema separado e dedicado que permite aos Super Admins visualizar como um tenant espec√≠fico contribui e participa na plataforma como um todo. Diferente do dashboard regular que mostra m√©tricas isoladas do tenant, este sistema foca na **participa√ß√£o percentual** e **contribui√ß√£o relativa** do tenant em rela√ß√£o aos totais da plataforma.

## Arquitetura do Sistema

### üéØ **Conceito Principal**

O sistema implementa **tr√™s cen√°rios distintos de dashboard**:

1. **Dashboard Sistema** (Super Admin) - M√©tricas gerais da plataforma
2. **Dashboard Tenant** (Tenant Admin) - M√©tricas isoladas do tenant
3. **Dashboard Tenant-Platform** (Super Admin) - Participa√ß√£o do tenant na plataforma

### üìä **Diferen√ßa Conceitual**

| Aspecto | Dashboard Regular | Dashboard Tenant-Platform |
|---------|------------------|---------------------------|
| **P√∫blico** | Tenant Admin | Super Admin |
| **Perspectiva** | M√©tricas isoladas | Participa√ß√£o na plataforma |
| **Receita** | R$ 5.000 do tenant | 10% da receita da plataforma |
| **Agendamentos** | 50 agendamentos | 8% dos agendamentos totais |
| **Clientes** | 20 clientes | 12% da base de clientes |
| **Crescimento** | +15% vs m√™s anterior | +2% de participa√ß√£o |

## Implementa√ß√£o T√©cnica

### üèóÔ∏è **Estrutura de Arquivos**

```
src/
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ tenant-platform-dashboard.html     # Dashboard dedicado
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îî‚îÄ‚îÄ ubs-template-standardizer.js   # Widgets padr√£o
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ admin.js                          # Rotas API
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ analytics.service.ts              # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ tenant-platform-metrics-schema.sql # Schema de tabelas
‚îî‚îÄ‚îÄ scripts/
    ‚îî‚îÄ‚îÄ populate-tenant-platform-metrics.js # Popula√ß√£o de dados
```

### üîå **API Endpoints**

#### 1. Dashboard HTML
```http
GET /admin/tenant-platform?tenantId=uuid
```
- **Middleware**: `adminAuth.requireSuperAdmin`
- **Retorna**: HTML do dashboard tenant-platform
- **Acesso**: Apenas Super Admins

#### 2. API de M√©tricas
```http
GET /api/admin/tenant-platform/:tenantId?period=30d
```
- **Middleware**: `adminAuth.verifyToken`
- **Par√¢metros**: 
  - `tenantId` (required): ID do tenant
  - `period` (optional): Per√≠odo de an√°lise (7d, 30d, 90d, 1y)
- **Retorna**: M√©tricas de participa√ß√£o estruturadas

### üìà **Estrutura de Dados Retornada**

```typescript
{
  tenant: {
    id: string,
    name: string,
    domain: string,
    ranking: number,
    totalTenants: number
  },
  platformContext: {
    totalRevenue: number,
    totalTenants: number,
    totalAppointments: number,
    totalCustomers: number
  },
  participation: {
    revenue: {
      value: number,        // Valor do tenant
      percentage: number,   // % da plataforma
      trend: number        // Varia√ß√£o
    },
    appointments: { value, percentage, trend },
    customers: { value, percentage, trend },
    ai: { value, percentage, trend }
  },
  charts: {
    participationEvolution: {
      labels: string[],
      revenue: number[],
      appointments: number[]
    },
    servicesDistribution: {
      labels: string[],
      values: number[]
    },
    ranking: {
      labels: string[],
      positions: number[]
    },
    contribution: {
      labels: string[],
      tenantValues: number[],
      platformAverage: number[]
    }
  },
  ranking: {
    position: number,
    previousPosition: number,
    change: number,
    totalScore: number,
    // ... outros scores
  },
  riskAssessment: {
    score: number,
    status: string
  }
}
```

## Frontend Implementation

### üé® **Interface do Dashboard**

O dashboard √© constru√≠do com **Bootstrap 5** e **Chart.js**, seguindo o padr√£o visual do sistema:

#### Header Section
```html
<div class="dashboard-header">
  <h1>Vis√£o Tenant-Platform</h1>
  <p>Participa√ß√£o e contribui√ß√£o na plataforma</p>
</div>
```

#### Tenant Information
```html
<div class="tenant-info">
  <h3 id="tenantName">Nome do Tenant</h3>
  <p id="tenantDomain">Dom√≠nio: beauty</p>
  <div class="ranking-position">
    <i class="fas fa-trophy"></i>
    Posi√ß√£o: 2¬∫ de 10
  </div>
</div>
```

#### Platform Context
```html
<div class="platform-context">
  <div class="row">
    <div class="col-md-3">
      <h4 id="platformTotalRevenue">R$ 150.000</h4>
      <small>Receita Total da Plataforma</small>
    </div>
    <!-- ... outros totais -->
  </div>
</div>
```

#### Participation Metrics
```html
<div class="participation-metrics">
  <div class="card stat-card">
    <div class="stat-value">12.5%</div>
    <div class="stat-label">Participa√ß√£o na Receita</div>
    <div class="metric-trend">
      <i class="fas fa-arrow-up trend-up"></i>
      <span>+2.3%</span>
    </div>
  </div>
</div>
```

### üìä **Visualiza√ß√µes de Gr√°ficos**

#### 1. Evolu√ß√£o da Participa√ß√£o
```javascript
new Chart(ctx, {
  type: 'line',
  data: {
    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
    datasets: [
      {
        label: 'Participa√ß√£o na Receita (%)',
        data: [8.5, 9.2, 10.1, 11.3, 10.8, 12.5],
        borderColor: '#2D5A9B'
      },
      {
        label: 'Participa√ß√£o em Agendamentos (%)',
        data: [12.3, 11.8, 13.2, 12.9, 13.5, 14.2],
        borderColor: '#28A745'
      }
    ]
  }
});
```

#### 2. Distribui√ß√£o de Servi√ßos
```javascript
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Corte', 'Colora√ß√£o', 'Hidrata√ß√£o', 'Escova'],
    datasets: [{
      data: [45, 30, 15, 10],
      backgroundColor: ['#2D5A9B', '#28A745', '#FFC107', '#DC3545']
    }]
  }
});
```

#### 3. Ranking Position
```javascript
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
    datasets: [{
      label: 'Posi√ß√£o no Ranking',
      data: [4, 3, 2, 2, 1, 2],
      backgroundColor: '#FFC107'
    }]
  },
  options: {
    scales: {
      y: {
        reverse: true // Posi√ß√£o 1 no topo
      }
    }
  }
});
```

#### 4. Contribui√ß√£o vs M√©dia
```javascript
new Chart(ctx, {
  type: 'radar',
  data: {
    labels: ['Receita', 'Agendamentos', 'Clientes', 'IA'],
    datasets: [
      {
        label: 'Este Tenant',
        data: [12.5, 14.2, 10.8, 15.6],
        borderColor: '#2D5A9B'
      },
      {
        label: 'M√©dia da Plataforma',
        data: [10, 10, 10, 10],
        borderColor: '#6C757D'
      }
    ]
  }
});
```

## Backend Implementation

### üîß **Analytics Service**

#### M√©todo Principal
```typescript
async getTenantPlatformMetrics(tenantId: string, period: string = '30d'): Promise<any> {
  // 1. Obter dados do tenant
  const tenantData = await this.getTenantAnalytics(tenantId, period);
  
  // 2. Obter dados da plataforma
  const platformData = await this.getSystemDashboardData(period);
  
  // 3. Calcular participa√ß√µes
  const participation = {
    revenue: {
      value: tenantData.revenue?.total || 0,
      percentage: (tenantData.revenue?.total / platformData.totalRevenue) * 100,
      trend: tenantData.revenue?.growth || 0
    },
    // ... outros c√°lculos
  };
  
  // 4. Retornar estrutura completa
  return { tenant, platformContext, participation, charts, ranking };
}
```

#### C√°lculos de Participa√ß√£o
```typescript
// Participa√ß√£o na receita
const revenueParticipation = platformTotal > 0 ? 
  (tenantValue / platformTotal) * 100 : 0;

// Participa√ß√£o em agendamentos
const appointmentsParticipation = platformAppointments > 0 ? 
  (tenantAppointments / platformAppointments) * 100 : 0;

// Participa√ß√£o em clientes
const customersParticipation = platformCustomers > 0 ? 
  (tenantCustomers / platformCustomers) * 100 : 0;
```

### üóÑÔ∏è **Database Schema**

O sistema inclui tabelas para m√©tricas pr√©-calculadas:

#### tenant_platform_metrics
```sql
CREATE TABLE tenant_platform_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  metric_month DATE NOT NULL,
  
  -- Participa√ß√£o na receita
  platform_revenue_participation_pct DECIMAL(5,2) DEFAULT 0,
  tenant_revenue_value DECIMAL(12,2) DEFAULT 0,
  platform_total_revenue DECIMAL(12,2) DEFAULT 0,
  
  -- Participa√ß√£o em agendamentos
  platform_appointments_participation_pct DECIMAL(5,2) DEFAULT 0,
  tenant_appointments_count INTEGER DEFAULT 0,
  platform_total_appointments INTEGER DEFAULT 0,
  
  -- Ranking
  ranking_position INTEGER DEFAULT 0,
  total_tenants_in_ranking INTEGER DEFAULT 0,
  
  -- Risk assessment
  risk_score INTEGER DEFAULT 0,
  risk_status VARCHAR(20) DEFAULT 'Unknown',
  
  calculated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### tenant_platform_evolution
```sql
CREATE TABLE tenant_platform_evolution (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  evolution_date DATE NOT NULL,
  
  -- Evolu√ß√£o da participa√ß√£o
  revenue_participation_pct DECIMAL(5,2) DEFAULT 0,
  appointments_participation_pct DECIMAL(5,2) DEFAULT 0,
  customers_participation_pct DECIMAL(5,2) DEFAULT 0,
  
  -- Varia√ß√£o vs m√™s anterior
  revenue_participation_change_pct DECIMAL(5,2) DEFAULT 0,
  appointments_participation_change_pct DECIMAL(5,2) DEFAULT 0,
  
  calculated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### tenant_platform_ranking
```sql
CREATE TABLE tenant_platform_ranking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ranking_date DATE NOT NULL,
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  
  position INTEGER NOT NULL,
  previous_position INTEGER DEFAULT 0,
  position_change INTEGER DEFAULT 0,
  
  -- Crit√©rios de ranking
  total_score DECIMAL(8,2) DEFAULT 0,
  revenue_score DECIMAL(8,2) DEFAULT 0,
  appointments_score DECIMAL(8,2) DEFAULT 0,
  growth_score DECIMAL(8,2) DEFAULT 0,
  engagement_score DECIMAL(8,2) DEFAULT 0,
  
  total_tenants INTEGER DEFAULT 0,
  percentile DECIMAL(5,2) DEFAULT 0,
  
  calculated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Sistema de Popula√ß√£o de Dados

### üîÑ **Script de Popula√ß√£o**

O script `populate-tenant-platform-metrics.js` √© respons√°vel por calcular e armazenar as m√©tricas:

```javascript
class TenantPlatformMetricsPopulator {
  async populateAll() {
    // 1. Popula contexto da plataforma
    await this.populatePlatformContextMetrics();
    
    // 2. Popula m√©tricas dos tenants
    await this.populateTenantPlatformMetrics();
    
    // 3. Popula evolu√ß√£o hist√≥rica
    await this.populateTenantPlatformEvolution();
    
    // 4. Popula ranking
    await this.populateTenantPlatformRanking();
    
    // 5. Popula distribui√ß√£o de servi√ßos
    await this.populateTenantServicesDistribution();
  }
}
```

### ‚öôÔ∏è **Cron Job Configuration**

Para manter os dados atualizados:

```bash
# Executar diariamente √†s 02:00
0 2 * * * node /path/to/scripts/populate-tenant-platform-metrics.js

# Executar semanalmente para an√°lise completa
0 3 * * 0 node /path/to/scripts/populate-tenant-platform-metrics.js --full
```

## Guia de Uso

### üöÄ **Acesso ao Dashboard**

1. **Login como Super Admin**
2. **Navegar para**: `/admin/tenant-platform?tenantId=UUID`
3. **Visualizar**:
   - Contexto da plataforma
   - Participa√ß√£o do tenant
   - Evolu√ß√£o temporal
   - Ranking e posi√ß√£o
   - Distribui√ß√£o de servi√ßos

### üìä **Interpreta√ß√£o de M√©tricas**

#### Participa√ß√£o na Receita
```
Tenant: R$ 12.500 (12.5% da plataforma)
Plataforma: R$ 100.000 total
Tend√™ncia: +2.3% vs m√™s anterior
```

#### Participa√ß√£o em Agendamentos
```
Tenant: 85 agendamentos (14.2% da plataforma)
Plataforma: 600 agendamentos total
Tend√™ncia: +1.8% vs m√™s anterior
```

#### Ranking
```
Posi√ß√£o: 2¬∫ de 10 tenants
Percentil: 80% (top 20%)
Varia√ß√£o: +1 posi√ß√£o vs m√™s anterior
```

### üéØ **Casos de Uso**

#### 1. An√°lise de Performance
- Identificar tenants com maior participa√ß√£o
- Acompanhar evolu√ß√£o de participa√ß√£o
- Comparar com m√©dia da plataforma

#### 2. Gest√£o de Riscos
- Monitorar tenants com baixa participa√ß√£o
- Identificar tend√™ncias de decl√≠nio
- Avaliar impacto de churn

#### 3. Estrat√©gia de Crescimento
- Identificar oportunidades de expans√£o
- Analisar balanceamento da plataforma
- Planejar aloca√ß√£o de recursos

## Seguran√ßa e Permiss√µes

### üîí **Controle de Acesso**

```typescript
// Middleware de autentica√ß√£o
router.get('/tenant-platform', adminAuth.requireSuperAdmin, (req, res) => {
  // Apenas Super Admins podem acessar
});

// API de m√©tricas
router.get('/api/admin/tenant-platform/:tenantId', adminAuth.verifyToken, (req, res) => {
  // Verifica√ß√£o adicional de permiss√µes
  if (req.admin.role !== 'super_admin') {
    return res.status(403).json({ error: 'Forbidden' });
  }
});
```

### üõ°Ô∏è **Valida√ß√µes**

```typescript
// Valida√ß√£o de tenant ID
if (!tenantId || !isValidUUID(tenantId)) {
  return res.status(400).json({ error: 'Invalid tenant ID' });
}

// Valida√ß√£o de per√≠odo
const validPeriods = ['7d', '30d', '90d', '1y'];
if (!validPeriods.includes(period)) {
  return res.status(400).json({ error: 'Invalid period' });
}
```

## Performance e Otimiza√ß√£o

### ‚ö° **Estrat√©gias de Performance**

#### 1. Dados Pr√©-calculados
```sql
-- √çndices para performance
CREATE INDEX idx_tenant_platform_metrics_tenant_id 
ON tenant_platform_metrics(tenant_id);

CREATE INDEX idx_tenant_platform_metrics_month 
ON tenant_platform_metrics(metric_month);
```

#### 2. Cache de Resultados
```javascript
// Cache em mem√≥ria para dados frequentemente acessados
const cache = new Map();
const cacheKey = `tenant_platform_${tenantId}_${period}`;

if (cache.has(cacheKey)) {
  return cache.get(cacheKey);
}
```

#### 3. Queries Paralelas
```typescript
// Executar consultas em paralelo
const [tenantData, platformData] = await Promise.all([
  this.getTenantAnalytics(tenantId, period),
  this.getSystemDashboardData(period)
]);
```

## Monitoramento e Logs

### üìù **Logging**

```typescript
// Logs estruturados
console.log('üìä Tenant Platform Metrics Request', {
  tenantId,
  period,
  timestamp: new Date().toISOString(),
  userRole: req.admin.role
});

// Logs de performance
const startTime = Date.now();
const result = await this.getTenantPlatformMetrics(tenantId, period);
const duration = Date.now() - startTime;

console.log('‚ö° Performance Metrics', {
  method: 'getTenantPlatformMetrics',
  duration,
  tenantId
});
```

### üìä **M√©tricas de Uso**

```typescript
// Tracking de uso do dashboard
const usageMetrics = {
  endpoint: '/api/admin/tenant-platform',
  tenant: tenantId,
  user: req.admin.id,
  timestamp: new Date(),
  responseTime: duration
};

await this.trackUsage(usageMetrics);
```

## Troubleshooting

### üêõ **Problemas Comuns**

#### 1. Dados N√£o Aparecem
```bash
# Verificar se as tabelas existem
npm run db:migrate

# Verificar se h√° dados populados
node scripts/populate-tenant-platform-metrics.js
```

#### 2. Percentuais Incorretos
```javascript
// Verificar se os totais da plataforma est√£o corretos
const platformTotal = await this.getSystemDashboardData(period);
console.log('Platform totals:', platformTotal);

// Verificar se o tenant tem dados
const tenantData = await this.getTenantAnalytics(tenantId, period);
console.log('Tenant data:', tenantData);
```

#### 3. Gr√°ficos N√£o Carregam
```javascript
// Verificar estrutura dos dados
console.log('Chart data structure:', JSON.stringify(chartData, null, 2));

// Verificar se Chart.js est√° carregado
if (typeof Chart === 'undefined') {
  console.error('Chart.js not loaded');
}
```

### üîß **Debug Mode**

```javascript
// Ativar debug no frontend
const dashboard = new TenantPlatformDashboard();
dashboard.debugMode = true;

// Logs detalhados no backend
process.env.DEBUG_TENANT_PLATFORM = 'true';
```

## Extensibilidade

### üîÆ **Futuras Melhorias**

#### 1. Alertas Autom√°ticos
```typescript
// Sistema de alertas para mudan√ßas significativas
if (participation.revenue.trend < -5) {
  await this.createAlert({
    type: 'revenue_drop',
    tenant: tenantId,
    severity: 'warning',
    message: 'Participa√ß√£o na receita caiu mais de 5%'
  });
}
```

#### 2. Compara√ß√£o entre Tenants
```typescript
// Comparar m√∫ltiplos tenants
async getTenantComparison(tenantIds: string[], period: string) {
  const comparisons = await Promise.all(
    tenantIds.map(id => this.getTenantPlatformMetrics(id, period))
  );
  
  return this.buildComparisonChart(comparisons);
}
```

#### 3. Previs√µes e Tend√™ncias
```typescript
// Usar machine learning para prever tend√™ncias
async predictTenantParticipation(tenantId: string) {
  const historicalData = await this.getHistoricalParticipation(tenantId);
  return this.mlService.predict(historicalData);
}
```

## Conclus√£o

O **Tenant-Platform Dashboard** representa uma solu√ß√£o completa para visualiza√ß√£o de participa√ß√£o e contribui√ß√£o de tenants na plataforma. Com arquitetura separada, APIs dedicadas e visualiza√ß√µes especializadas, o sistema oferece insights valiosos para gest√£o estrat√©gica da plataforma SaaS multi-tenant.

O sistema est√° preparado para escalar com o crescimento da plataforma, incluindo otimiza√ß√µes de performance, seguran√ßa robusta e extensibilidade para futuras funcionalidades.