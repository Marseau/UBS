{
  "meta": {
    "instanceId": "n8n-appointment-reminders-001"
  },
  "createdAt": "2025-08-11T00:00:00.000Z",
  "updatedAt": "2025-08-11T00:00:00.000Z",
  "id": "appointment-confirmation-reminders",
  "name": "Appointment Confirmation & Reminders (Multi-tenant)",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/15 * * * *"
            }
          ]
        }
      },
      "id": "appointment-cron-trigger",
      "name": "â° Every 15 Minutes",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "resource": "table",
        "operation": "getAll",
        "table": "appointments",
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "status",
              "condition": "equals",
              "keyValue": "confirmed"
            },
            {
              "keyName": "start_time",
              "condition": "dateTimeBetween",
              "keyValue": "={{ new Date().toISOString() }}",
              "keyValue2": "={{ new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString() }}"
            }
          ]
        }
      },
      "id": "fetch-upcoming-appointments",
      "name": "ğŸ“… Fetch Appointments",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [400, 300],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-main",
          "name": "Supabase Main"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// ğŸ” REMINDER SCHEDULER\n// Determina quais lembretes enviar baseado no timing\n\nconst appointmentData = $input.all();\nconst remindersToSend = [];\n\nfor (const appointment of appointmentData) {\n  const appointmentTime = new Date(appointment.json.start_time);\n  const now = new Date();\n  const timeDifference = appointmentTime.getTime() - now.getTime();\n  const hoursUntilAppointment = timeDifference / (1000 * 60 * 60);\n  \n  // Verificar se precisa enviar lembrete\n  let reminderType = null;\n  \n  // Lembrete 24 horas antes\n  if (hoursUntilAppointment <= 24 && hoursUntilAppointment > 23) {\n    reminderType = '24h_reminder';\n  }\n  // Lembrete 2 horas antes\n  else if (hoursUntilAppointment <= 2 && hoursUntilAppointment > 1.5) {\n    reminderType = '2h_reminder';\n  }\n  // Lembrete 30 minutos antes\n  else if (hoursUntilAppointment <= 0.5 && hoursUntilAppointment > 0.25) {\n    reminderType = '30min_reminder';\n  }\n  \n  if (reminderType) {\n    // Buscar dados do tenant\n    const tenantId = appointment.json.tenant_id;\n    const userId = appointment.json.user_id;\n    \n    // Mapear domÃ­nios de negÃ³cio por tenant (em produÃ§Ã£o viria de query)\n    const tenantDomainMapping = {\n      'tenant_1_beleza': { domain: 'beauty', name: 'SalÃ£o ElegÃ¢ncia Premium' },\n      'tenant_2_saude': { domain: 'healthcare', name: 'ClÃ­nica Vida SaudÃ¡vel' },\n      'tenant_3_juridico': { domain: 'legal', name: 'Advocacia Silva & Santos' },\n      'tenant_4_educacao': { domain: 'education', name: 'EduTech Cursos' },\n      'tenant_5_esportes': { domain: 'sports', name: 'FitPro Academia' },\n      'tenant_6_consultoria': { domain: 'consulting', name: 'BizConsult' }\n    };\n    \n    const tenantInfo = tenantDomainMapping[tenantId] || { domain: 'general', name: 'Empresa' };\n    \n    remindersToSend.push({\n      appointment_id: appointment.json.id,\n      tenant_id: tenantId,\n      tenant_name: tenantInfo.name,\n      business_domain: tenantInfo.domain,\n      user_id: userId,\n      start_time: appointment.json.start_time,\n      end_time: appointment.json.end_time,\n      appointment_data: appointment.json.appointment_data,\n      quoted_price: appointment.json.quoted_price,\n      reminder_type: reminderType,\n      hours_until_appointment: hoursUntilAppointment,\n      reminder_scheduled_at: new Date().toISOString()\n    });\n  }\n}\n\nreturn remindersToSend.map(reminder => ({ json: reminder }));"
      },
      "id": "reminder-scheduler",
      "name": "ğŸ“‹ Reminder Scheduler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [600, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has_reminders",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "has-reminders-check",
      "name": "ğŸ“¬ Has Reminders?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [800, 300]
    },
    {
      "parameters": {
        "functionCode": "// ğŸ’¬ REMINDER MESSAGE GENERATOR\n// Gera mensagens personalizadas por domÃ­nio e tipo de lembrete\n\nconst reminderData = $json;\n\n// Preparar dados bÃ¡sicos\nconst appointmentTime = new Date(reminderData.start_time);\nconst dateStr = appointmentTime.toLocaleDateString('pt-BR', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\nconst timeStr = appointmentTime.toLocaleTimeString('pt-BR', {\n  hour: '2-digit',\n  minute: '2-digit'\n});\n\n// Extrair informaÃ§Ãµes do agendamento\nconst appointmentDetails = reminderData.appointment_data ? \n  JSON.parse(reminderData.appointment_data) : {};\nconst serviceName = appointmentDetails.service_name || 'ServiÃ§o agendado';\n\n// Templates de mensagem por domÃ­nio\nconst domainTemplates = {\n  beauty: {\n    '24h_reminder': {\n      emoji: 'ğŸ’„âœ¨',\n      title: 'LEMBRETE - Seu agendamento Ã© amanhÃ£!',\n      content: `OlÃ¡! ğŸ˜Š\\n\\nVocÃª tem um agendamento conosco amanhÃ£:\\n\\nğŸ’… *ServiÃ§o:* ${serviceName}\\nğŸ“… *Data:* ${dateStr}\\nğŸ• *HorÃ¡rio:* ${timeStr}\\nğŸ’° *Valor:* R$ ${reminderData.quoted_price},00\\n\\nâœ¨ *Dicas importantes:*\\nâ€¢ Chegue 10 min antes\\nâ€¢ Traga uma referÃªncia se for coloraÃ§Ã£o\\nâ€¢ Cabelo limpo e seco para corte\\n\\nAguardamos vocÃª! ğŸ’–`\n    },\n    '2h_reminder': {\n      emoji: 'ğŸ’„â°',\n      title: 'SEU AGENDAMENTO Ã‰ EM 2 HORAS!',\n      content: `Oi, linda! ğŸ’…\\n\\nSeu agendamento Ã© em 2 horas:\\n\\nğŸ’„ *${serviceName}*\\nğŸ• *${timeStr}* (em 2 horas)\\nğŸ’° *R$ ${reminderData.quoted_price},00*\\n\\nğŸ“ *Ãšltimo lembrete:*\\nâ€¢ Chegue 10 minutos antes\\nâ€¢ Traga documento com foto\\n\\nNos vemos logo! âœ¨`\n    },\n    '30min_reminder': {\n      emoji: 'ğŸ’„ğŸƒâ€â™€ï¸',\n      title: 'PARTIU! Seu horÃ¡rio Ã© em 30 min!',\n      content: `Hey! ğŸ˜Š\\n\\nâ° Seu horÃ¡rio Ã© em *30 minutos*\\nğŸ’… ${serviceName}\\nğŸ• ${timeStr}\\n\\nğŸƒâ€â™€ï¸ *JÃ¡ estÃ¡ a caminho?*\\n\\nTe esperamos! ğŸ’–`\n    }\n  },\n  \n  healthcare: {\n    '24h_reminder': {\n      emoji: 'ğŸ¥ğŸ“‹',\n      title: 'LEMBRETE - Consulta mÃ©dica amanhÃ£',\n      content: `OlÃ¡!\\n\\nLembramos que vocÃª tem consulta marcada:\\n\\nğŸ©º *Consulta:* ${serviceName}\\nğŸ“… *Data:* ${dateStr}\\nğŸ• *HorÃ¡rio:* ${timeStr}\\nğŸ’° *Valor:* R$ ${reminderData.quoted_price},00\\n\\nğŸ“‹ *Importante trazer:*\\nâ€¢ Documento com foto\\nâ€¢ Carteirinha do convÃªnio\\nâ€¢ Exames anteriores (se houver)\\nâ€¢ Lista de medicamentos em uso\\n\\nğŸ¥ Chegue 15 minutos antes\\n\\nCuidamos da sua saÃºde! ğŸ’™`\n    },\n    '2h_reminder': {\n      emoji: 'ğŸ¥â°',\n      title: 'CONSULTA EM 2 HORAS',\n      content: `OlÃ¡!\\n\\nSua consulta Ã© em 2 horas:\\n\\nğŸ©º *${serviceName}*\\nğŸ• *${timeStr}*\\nğŸ’° *R$ ${reminderData.quoted_price},00*\\n\\nğŸ“‹ *NÃ£o esqueÃ§a:*\\nâ€¢ Documento e convÃªnio\\nâ€¢ Chegar 15 min antes\\nâ€¢ Jejum (se solicitado)\\n\\nTe esperamos! ğŸ¥`\n    },\n    '30min_reminder': {\n      emoji: 'ğŸ¥ğŸš¨',\n      title: 'CONSULTA EM 30 MINUTOS',\n      content: `OlÃ¡!\\n\\nâ° Sua consulta Ã© em *30 minutos*\\nğŸ©º ${serviceName}\\nğŸ• ${timeStr}\\n\\nğŸš¨ *JÃ¡ estÃ¡ a caminho?*\\n\\nSaÃºde em primeiro lugar! ğŸ’™`\n    }\n  },\n  \n  legal: {\n    '24h_reminder': {\n      emoji: 'âš–ï¸ğŸ“„',\n      title: 'LEMBRETE - ReuniÃ£o jurÃ­dica amanhÃ£',\n      content: `Prezado(a) cliente,\\n\\nLembramos de nossa reuniÃ£o:\\n\\nâš–ï¸ *Assunto:* ${serviceName}\\nğŸ“… *Data:* ${dateStr}\\nğŸ• *HorÃ¡rio:* ${timeStr}\\nğŸ’° *HonorÃ¡rios:* R$ ${reminderData.quoted_price},00\\n\\nğŸ“„ *Documentos necessÃ¡rios:*\\nâ€¢ RG e CPF\\nâ€¢ Documentos do caso\\nâ€¢ ProcuraÃ§Ã£o (se aplicÃ¡vel)\\nâ€¢ Contratos relacionados\\n\\nğŸ›ï¸ Pontualidade Ã© fundamental\\n\\nJustiÃ§a e transparÃªncia! âš–ï¸`\n    },\n    '2h_reminder': {\n      emoji: 'âš–ï¸â°',\n      title: 'REUNIÃƒO EM 2 HORAS',\n      content: `Prezado(a),\\n\\nSua reuniÃ£o Ã© em 2 horas:\\n\\nâš–ï¸ *${serviceName}*\\nğŸ• *${timeStr}*\\nğŸ’° *R$ ${reminderData.quoted_price},00*\\n\\nğŸ“„ *Confirme se trouxe:*\\nâ€¢ Todos os documentos\\nâ€¢ Lista de dÃºvidas\\nâ€¢ ProcuraÃ§Ã£o atualizada\\n\\nAguardamos! âš–ï¸`\n    },\n    '30min_reminder': {\n      emoji: 'âš–ï¸ğŸƒâ€â™‚ï¸',\n      title: 'REUNIÃƒO EM 30 MINUTOS',\n      content: `Prezado(a),\\n\\nâ° ReuniÃ£o em *30 minutos*\\nâš–ï¸ ${serviceName}\\nğŸ• ${timeStr}\\n\\nğŸ“ *JÃ¡ estÃ¡ a caminho?*\\n\\nJustiÃ§a nÃ£o espera! âš–ï¸`\n    }\n  },\n  \n  education: {\n    '24h_reminder': {\n      emoji: 'ğŸ“šğŸ“',\n      title: 'LEMBRETE - Aula amanhÃ£!',\n      content: `OlÃ¡, estudante! ğŸ˜Š\\n\\nSua aula Ã© amanhÃ£:\\n\\nğŸ“š *MatÃ©ria:* ${serviceName}\\nğŸ“… *Data:* ${dateStr}\\nğŸ• *HorÃ¡rio:* ${timeStr}\\nğŸ’° *Valor:* R$ ${reminderData.quoted_price},00\\n\\nğŸ’ *Para a aula:*\\nâ€¢ Material da matÃ©ria\\nâ€¢ Caderno para anotaÃ§Ãµes\\nâ€¢ DÃºvidas listadas\\nâ€¢ ExercÃ­cios anteriores\\n\\nğŸ“ Preparado para aprender?\\n\\nVamos conquistar seus objetivos! ğŸ“š`\n    },\n    '2h_reminder': {\n      emoji: 'ğŸ“šâ°',\n      title: 'AULA EM 2 HORAS!',\n      content: `E aÃ­, estudante!\\n\\nSua aula Ã© em 2 horas:\\n\\nğŸ“š *${serviceName}*\\nğŸ• *${timeStr}*\\nğŸ’° *R$ ${reminderData.quoted_price},00*\\n\\nğŸ’ *NÃ£o esqueÃ§a:*\\nâ€¢ Material da matÃ©ria\\nâ€¢ DÃºvidas anotadas\\nâ€¢ ExercÃ­cios para revisar\\n\\nVamos arrasar! ğŸ“`\n    },\n    '30min_reminder': {\n      emoji: 'ğŸ“šğŸƒâ€â™€ï¸',\n      title: 'AULA EM 30 MINUTOS!',\n      content: `Opa!\\n\\nâ° Aula em *30 minutos*\\nğŸ“š ${serviceName}\\nğŸ• ${timeStr}\\n\\nğŸƒâ€â™€ï¸ *JÃ¡ estÃ¡ indo?*\\n\\nBora estudar! ğŸ“`\n    }\n  },\n  \n  sports: {\n    '24h_reminder': {\n      emoji: 'ğŸ’ªğŸƒâ€â™‚ï¸',\n      title: 'LEMBRETE - Treino amanhÃ£!',\n      content: `Fala, atleta! ğŸ’ª\\n\\nSeu treino Ã© amanhÃ£:\\n\\nğŸ‹ï¸ *Atividade:* ${serviceName}\\nğŸ“… *Data:* ${dateStr}\\nğŸ• *HorÃ¡rio:* ${timeStr}\\nğŸ’° *Valor:* R$ ${reminderData.quoted_price},00\\n\\nğŸ‘Ÿ *Para o treino:*\\nâ€¢ Roupa de treino\\nâ€¢ TÃªnis adequado\\nâ€¢ Toalha e garrafa d'Ã¡gua\\nâ€¢ AlimentaÃ§Ã£o leve antes\\n\\nğŸ”¥ Bora quebrar limites!\\n\\nSeu melhor desempenho te espera! ğŸ’ª`\n    },\n    '2h_reminder': {\n      emoji: 'ğŸ’ªâ°',\n      title: 'TREINO EM 2 HORAS!',\n      content: `E aÃ­, atleta!\\n\\nSeu treino Ã© em 2 horas:\\n\\nğŸ‹ï¸ *${serviceName}*\\nğŸ• *${timeStr}*\\nğŸ’° *R$ ${reminderData.quoted_price},00*\\n\\nğŸ’ª *Se preparando:*\\nâ€¢ HidrataÃ§Ã£o constante\\nâ€¢ Lanche leve se precisar\\nâ€¢ Equipamentos em dia\\n\\nVamos treinar! ğŸ”¥`\n    },\n    '30min_reminder': {\n      emoji: 'ğŸ’ªğŸ”¥',\n      title: 'TREINO EM 30 MINUTOS!',\n      content: `Bora!\\n\\nâ° Treino em *30 minutos*\\nğŸ‹ï¸ ${serviceName}\\nğŸ• ${timeStr}\\n\\nğŸ”¥ *Preparado?*\\n\\nSua forÃ§a te espera! ğŸ’ª`\n    }\n  },\n  \n  consulting: {\n    '24h_reminder': {\n      emoji: 'ğŸ’¼ğŸ“Š',\n      title: 'LEMBRETE - ReuniÃ£o estratÃ©gica amanhÃ£',\n      content: `Prezado(a) cliente,\\n\\nReuniÃµes estratÃ©gicas amanhÃ£:\\n\\nğŸ’¼ *Consultoria:* ${serviceName}\\nğŸ“… *Data:* ${dateStr}\\nğŸ• *HorÃ¡rio:* ${timeStr}\\nğŸ’° *Investimento:* R$ ${reminderData.quoted_price},00\\n\\nğŸ“Š *PreparaÃ§Ã£o recomendada:*\\nâ€¢ RelatÃ³rios financeiros atuais\\nâ€¢ KPIs do perÃ­odo\\nâ€¢ Lista de desafios especÃ­ficos\\nâ€¢ Objetivos para prÃ³ximo trimestre\\n\\nğŸ¯ Foco em resultados!\\n\\nVamos potencializar seu negÃ³cio! ğŸ’¼`\n    },\n    '2h_reminder': {\n      emoji: 'ğŸ’¼â°',\n      title: 'REUNIÃƒO ESTRATÃ‰GICA EM 2H',\n      content: `OlÃ¡!\\n\\nSua reuniÃ£o Ã© em 2 horas:\\n\\nğŸ’¼ *${serviceName}*\\nğŸ• *${timeStr}*\\nğŸ’° *R$ ${reminderData.quoted_price},00*\\n\\nğŸ“Š *Confirme se tem:*\\nâ€¢ RelatÃ³rios financeiros\\nâ€¢ Lista de desafios\\nâ€¢ KPIs atualizados\\n\\nVamos acelerar! ğŸ¯`\n    },\n    '30min_reminder': {\n      emoji: 'ğŸ’¼âš¡',\n      title: 'REUNIÃƒO EM 30 MINUTOS!',\n      content: `OlÃ¡!\\n\\nâ° ReuniÃ£o em *30 minutos*\\nğŸ’¼ ${serviceName}\\nğŸ• ${timeStr}\\n\\nâš¡ *JÃ¡ estÃ¡ a caminho?*\\n\\nResultados te esperam! ğŸ¯`\n    }\n  }\n};\n\n// Obter template para este domÃ­nio e tipo\nconst templates = domainTemplates[reminderData.business_domain] || domainTemplates.education;\nconst template = templates[reminderData.reminder_type] || templates['24h_reminder'];\n\n// Preparar mensagem final\nconst whatsappMessage = `${template.emoji}\\n\\n*${template.title}*\\n\\n${template.content}`;\n\n// Preparar payload WhatsApp\nconst whatsappPayload = {\n  messaging_product: 'whatsapp',\n  to: reminderData.user_id,\n  type: 'text',\n  text: {\n    body: whatsappMessage\n  }\n};\n\nreturn [{\n  ...reminderData,\n  \n  // Dados da mensagem\n  whatsapp_message: whatsappMessage,\n  whatsapp_payload: whatsappPayload,\n  message_template_used: template.emoji,\n  \n  // Controle\n  reminder_generated_at: new Date().toISOString()\n}];"
      },
      "id": "reminder-message-generator",
      "name": "ğŸ’¬ Message Generator",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{ $env.WHATSAPP_PHONE_NUMBER_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.WHATSAPP_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "jsonBody": "={{ JSON.stringify($json.whatsapp_payload) }}",
        "options": {}
      },
      "id": "send-reminder-whatsapp",
      "name": "ğŸ“¤ Send Reminder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1200, 200]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "insert",
        "table": "appointment_reminders",
        "columns": {
          "values": [
            {
              "column": "appointment_id",
              "value": "={{ $json.appointment_id }}"
            },
            {
              "column": "tenant_id",
              "value": "={{ $json.tenant_id }}"
            },
            {
              "column": "user_id",
              "value": "={{ $json.user_id }}"
            },
            {
              "column": "reminder_type",
              "value": "={{ $json.reminder_type }}"
            },
            {
              "column": "message_sent",
              "value": "={{ $json.whatsapp_message }}"
            },
            {
              "column": "sent_at",
              "value": "={{ $json.reminder_generated_at }}"
            },
            {
              "column": "appointment_time",
              "value": "={{ $json.start_time }}"
            },
            {
              "column": "hours_before",
              "value": "={{ $json.hours_until_appointment }}"
            },
            {
              "column": "business_domain",
              "value": "={{ $json.business_domain }}"
            },
            {
              "column": "status",
              "value": "sent"
            },
            {
              "column": "test_execution_id",
              "value": "={{ $json.test_execution_id }}"
            }
          ]
        }
      },
      "id": "log-reminder-sent",
      "name": "ğŸ“ Log Reminder",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1400, 200],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-main",
          "name": "Supabase Main"
        }
      }
    },
    {
      "parameters": {
        "path": "appointment-actions",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "appointment-actions-webhook",
      "name": "ğŸ“² Actions Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 600],
      "webhookId": "appointment-actions"
    },
    {
      "parameters": {
        "functionCode": "// ğŸ”„ APPOINTMENT ACTION PROCESSOR\n// Processa aÃ§Ãµes do cliente: confirmar, reagendar, cancelar\n\nconst actionData = $json;\n\n// Extrair dados da aÃ§Ã£o\nconst action = actionData.action; // 'confirm', 'reschedule', 'cancel'\nconst appointmentId = actionData.appointment_id;\nconst userId = actionData.user_id;\nconst tenantId = actionData.tenant_id;\nconst newDateTime = actionData.new_datetime; // Para reagendamento\nconst cancelReason = actionData.cancel_reason; // Para cancelamento\n\n// Validar aÃ§Ã£o\nconst validActions = ['confirm', 'reschedule', 'cancel', 'no_show'];\nif (!validActions.includes(action)) {\n  return [{\n    error: 'Invalid action',\n    valid_actions: validActions,\n    received_action: action\n  }];\n}\n\n// Preparar resposta baseada na aÃ§Ã£o\nlet responseMessage = '';\nlet appointmentStatus = '';\nlet actionDescription = '';\n\nswitch(action) {\n  case 'confirm':\n    appointmentStatus = 'confirmed';\n    actionDescription = 'Agendamento confirmado pelo cliente';\n    responseMessage = 'âœ… *Agendamento Confirmado!*\\n\\nObrigado por confirmar! Te esperamos no horÃ¡rio marcado. ğŸ˜Š';\n    break;\n    \n  case 'reschedule':\n    appointmentStatus = 'rescheduled';\n    actionDescription = 'Cliente solicitou reagendamento';\n    responseMessage = 'ğŸ”„ *Reagendamento Solicitado*\\n\\nRecebemos sua solicitaÃ§Ã£o! Em breve entraremos em contato para confirmar o novo horÃ¡rio.';\n    break;\n    \n  case 'cancel':\n    appointmentStatus = 'cancelled';\n    actionDescription = `Cancelado pelo cliente: ${cancelReason || 'Motivo nÃ£o informado'}`;\n    responseMessage = 'âŒ *Agendamento Cancelado*\\n\\nSeu agendamento foi cancelado. Esperamos vÃª-lo em breve! ğŸ˜Š';\n    break;\n    \n  case 'no_show':\n    appointmentStatus = 'no_show';\n    actionDescription = 'Cliente nÃ£o compareceu';\n    responseMessage = 'ğŸ˜” *Que pena que vocÃª nÃ£o veio!*\\n\\nEsperamos uma prÃ³xima oportunidade. Entre em contato para reagendar!';\n    break;\n}\n\nreturn [{\n  // Dados originais\n  ...actionData,\n  \n  // Dados do processamento\n  appointment_id: appointmentId,\n  user_id: userId,\n  tenant_id: tenantId,\n  action_type: action,\n  new_status: appointmentStatus,\n  action_description: actionDescription,\n  response_message: responseMessage,\n  new_datetime: newDateTime,\n  cancel_reason: cancelReason,\n  \n  // Controle\n  action_processed_at: new Date().toISOString(),\n  requires_status_update: true\n}];"
      },
      "id": "appointment-action-processor",
      "name": "ğŸ”„ Action Processor",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [400, 600]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "update",
        "table": "appointments",
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "equals",
              "keyValue": "={{ $json.appointment_id }}"
            }
          ]
        },
        "columns": {
          "values": [
            {
              "column": "status",
              "value": "={{ $json.new_status }}"
            },
            {
              "column": "updated_at",
              "value": "={{ $json.action_processed_at }}"
            }
          ]
        }
      },
      "id": "update-appointment-status",
      "name": "ğŸ’¾ Update Status",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [600, 600],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-main",
          "name": "Supabase Main"
        }
      }
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "insert",
        "table": "appointment_actions",
        "columns": {
          "values": [
            {
              "column": "appointment_id",
              "value": "={{ $json.appointment_id }}"
            },
            {
              "column": "tenant_id",
              "value": "={{ $json.tenant_id }}"
            },
            {
              "column": "user_id",
              "value": "={{ $json.user_id }}"
            },
            {
              "column": "action_type",
              "value": "={{ $json.action_type }}"
            },
            {
              "column": "action_description",
              "value": "={{ $json.action_description }}"
            },
            {
              "column": "new_status",
              "value": "={{ $json.new_status }}"
            },
            {
              "column": "new_datetime",
              "value": "={{ $json.new_datetime }}"
            },
            {
              "column": "cancel_reason",
              "value": "={{ $json.cancel_reason }}"
            },
            {
              "column": "processed_at",
              "value": "={{ $json.action_processed_at }}"
            },
            {
              "column": "test_execution_id",
              "value": "={{ $json.test_execution_id }}"
            }
          ]
        }
      },
      "id": "log-appointment-action",
      "name": "ğŸ“‹ Log Action",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [800, 600],
      "credentials": {
        "supabaseApi": {
          "id": "supabase-main",
          "name": "Supabase Main"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// ğŸ’¬ ACTION RESPONSE GENERATOR\n// Gera resposta de confirmaÃ§Ã£o da aÃ§Ã£o\n\nconst responseData = $json;\n\n// Preparar payload WhatsApp para resposta\nconst whatsappPayload = {\n  messaging_product: 'whatsapp',\n  to: responseData.user_id,\n  type: 'text',\n  text: {\n    body: responseData.response_message\n  }\n};\n\nreturn [{\n  ...responseData,\n  \n  // Resposta WhatsApp\n  whatsapp_payload: whatsappPayload,\n  response_sent_at: new Date().toISOString()\n}];"
      },
      "id": "action-response-generator",
      "name": "ğŸ’¬ Response Generator",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 600]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{ $env.WHATSAPP_PHONE_NUMBER_ID }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.WHATSAPP_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "jsonBody": "={{ JSON.stringify($json.whatsapp_payload) }}",
        "options": {}
      },
      "id": "send-action-response",
      "name": "ğŸ“¤ Send Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1200, 600]
    },
    {
      "parameters": {
        "functionCode": "// âœ… SUCCESS RESPONSE\n// Resposta final de sucesso\n\nconst successData = $json;\n\n// Contar lembretes enviados (para cron)\nconst remindersCount = $input.all().length;\n\n// Preparar resposta baseada no tipo de trigger\nlet response = {};\n\nif (successData.appointment_id) {\n  // Resposta de aÃ§Ã£o de agendamento\n  response = {\n    status: 'appointment_action_processed',\n    message: 'Appointment action processed successfully',\n    data: {\n      appointment_id: successData.appointment_id,\n      action_type: successData.action_type,\n      new_status: successData.new_status,\n      user_notified: true,\n      processed_at: successData.action_processed_at\n    }\n  };\n} else {\n  // Resposta de execuÃ§Ã£o de cron\n  response = {\n    status: 'reminders_processed',\n    message: `${remindersCount} reminders processed successfully`,\n    data: {\n      reminders_sent: remindersCount,\n      processing_completed_at: new Date().toISOString()\n    }\n  };\n}\n\nresponse.timestamp = new Date().toISOString();\n\nreturn [response];"
      },
      "id": "final-success-response",
      "name": "âœ… Success Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1400, 400]
    }
  ],
  "connections": {
    "â° Every 15 Minutes": {
      "main": [
        [
          {
            "node": "ğŸ“… Fetch Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“… Fetch Appointments": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Reminder Scheduler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Reminder Scheduler": {
      "main": [
        [
          {
            "node": "ğŸ“¬ Has Reminders?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¬ Has Reminders?": {
      "main": [
        [
          {
            "node": "âœ… Success Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ’¬ Message Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¬ Message Generator": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Send Reminder": {
      "main": [
        [
          {
            "node": "ğŸ“ Log Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Log Reminder": {
      "main": [
        [
          {
            "node": "âœ… Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“² Actions Webhook": {
      "main": [
        [
          {
            "node": "ğŸ”„ Action Processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Action Processor": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Update Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Update Status": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Log Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Log Action": {
      "main": [
        [
          {
            "node": "ğŸ’¬ Response Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¬ Response Generator": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Send Response": {
      "main": [
        [
          {
            "node": "âœ… Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "hash": "appointment-reminders-hash-001",
  "versionId": 1
}