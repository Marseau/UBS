/**
 * INSPE√á√ÉO SISTEM√ÅTICA COMPLETA DO BANCO DE DADOS
 * 
 * Este script faz uma verifica√ß√£o detalhada de:
 * 1. Dados base nas tabelas principais
 * 2. Tabelas de m√©tricas existentes
 * 3. Fun√ß√µes SQL dispon√≠veis
 * 4. Estado atual do tenant espec√≠fico
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
);

const TARGET_TENANT = 'ea1e9c71-2cde-4959-b367-81fa177407d8';

async function inspecaoCompleta() {
    console.log('üîç INICIANDO INSPE√á√ÉO SISTEM√ÅTICA COMPLETA DO BANCO DE DADOS');
    console.log('=' .repeat(80));
    
    // 1. VERIFICAR DADOS BASE DO TENANT ESPEC√çFICO
    await verificarDadosBaseTenant();
    
    // 2. VERIFICAR ESTRUTURA DE TABELAS DE M√âTRICAS
    await verificarTabelasMetricas();
    
    // 3. VERIFICAR FUN√á√ïES SQL DISPON√çVEIS
    await verificarFuncoesSQL();
    
    // 4. VERIFICAR DADOS POPULADOS EM TABELAS DE M√âTRICAS
    await verificarDadosMetricas();
    
    // 5. TESTAR FUN√á√ïES EXISTENTES
    await testarFuncoes();
    
    // 6. RELAT√ìRIO FINAL
    await relatorioFinal();
}

async function verificarDadosBaseTenant() {
    console.log('\nüìä 1. VERIFICA√á√ÉO DE DADOS BASE DO TENANT');
    console.log('-' .repeat(50));
    
    try {
        // Verificar tenant espec√≠fico
        const { data: tenant, error: tenantError } = await supabase
            .from('tenants')
            .select('*')
            .eq('id', TARGET_TENANT)
            .single();
        
        if (tenantError) {
            console.log('‚ùå Tenant n√£o encontrado:', tenantError.message);
            return;
        }
        
        console.log('‚úÖ Tenant encontrado:', {
            id: tenant.id,
            company_name: tenant.company_name,
            business_domain: tenant.business_domain,
            status: tenant.status,
            created_at: tenant.created_at
        });
        
        // Verificar appointments do tenant
        const { data: appointments, error: aptError } = await supabase
            .from('appointments')
            .select('*')
            .eq('tenant_id', TARGET_TENANT);
        
        console.log(`üìÖ Appointments: ${appointments?.length || 0} registros`);
        if (appointments && appointments.length > 0) {
            console.log('   - Status:', appointments.reduce((acc, apt) => {
                acc[apt.status] = (acc[apt.status] || 0) + 1;
                return acc;
            }, {}));
        }
        
        // Verificar users relacionados ao tenant
        const { data: userTenants, error: utError } = await supabase
            .from('user_tenants')
            .select('user_id')
            .eq('tenant_id', TARGET_TENANT);
        
        console.log(`üë• Usu√°rios: ${userTenants?.length || 0} registros`);
        
        // Verificar services do tenant
        const { data: services, error: servError } = await supabase
            .from('services')
            .select('*')
            .eq('tenant_id', TARGET_TENANT);
        
        console.log(`üõ†Ô∏è Servi√ßos: ${services?.length || 0} registros`);
        
        // Verificar conversation_history
        const { data: conversations, error: convError } = await supabase
            .from('conversation_history')
            .select('id, created_at, is_from_user')
            .eq('tenant_id', TARGET_TENANT);
        
        console.log(`üí¨ Conversas: ${conversations?.length || 0} registros`);
        
    } catch (error) {
        console.error('üí• Erro na verifica√ß√£o de dados base:', error);
    }
}

async function verificarTabelasMetricas() {
    console.log('\nüìà 2. VERIFICA√á√ÉO DE TABELAS DE M√âTRICAS');
    console.log('-' .repeat(50));
    
    const tabelasMetricas = [
        'analytics_tenant_metrics',
        'analytics_system_metrics', 
        'analytics_service_performance',
        'analytics_cache',
        'platform_metrics',
        'saas_metrics',
        'tenant_daily_metrics',
        'mv_daily_appointment_stats',
        'mv_ai_interaction_stats',
        'mv_service_popularity'
    ];
    
    for (const tabela of tabelasMetricas) {
        try {
            const { data, error } = await supabase
                .from(tabela)
                .select('*')
                .limit(1);
            
            if (error) {
                console.log(`‚ùå ${tabela}: ${error.message}`);
            } else {
                const { count } = await supabase
                    .from(tabela)
                    .select('*', { count: 'exact', head: true });
                
                console.log(`‚úÖ ${tabela}: ${count || 0} registros`);
                
                if (data && data.length > 0) {
                    console.log(`   Campos: ${Object.keys(data[0]).join(', ')}`);
                }
            }
        } catch (err) {
            console.log(`‚ùå ${tabela}: Erro ao acessar - ${err.message}`);
        }
    }
}

async function verificarFuncoesSQL() {
    console.log('\n‚öôÔ∏è 3. VERIFICA√á√ÉO DE FUN√á√ïES SQL');
    console.log('-' .repeat(50));
    
    const funcoes = [
        'get_saas_metrics',
        'get_tenant_metrics',
        'get_platform_metrics_complete', 
        'calculate_platform_metrics_complete',
        'update_platform_metrics_complete',
        'aggregate_tenant_daily_metrics',
        'aggregate_system_daily_metrics',
        'refresh_analytics_materialized_views'
    ];
    
    for (const funcao of funcoes) {
        try {
            // Tentar buscar informa√ß√µes da fun√ß√£o no cat√°logo do PostgreSQL
            const { data, error } = await supabase
                .rpc('sql', {
                    query: `
                        SELECT 
                            proname as function_name,
                            prosrc as function_body,
                            proargnames as argument_names
                        FROM pg_proc 
                        WHERE proname = '${funcao}'
                        LIMIT 1
                    `
                });
            
            if (error) {
                // Tentar chamar a fun√ß√£o para ver se existe
                try {
                    await supabase.rpc(funcao);
                    console.log(`‚úÖ ${funcao}: Fun√ß√£o existe (mas erro no cat√°logo)`);
                } catch (callError) {
                    if (callError.message.includes('does not exist')) {
                        console.log(`‚ùå ${funcao}: Fun√ß√£o n√£o existe`);
                    } else {
                        console.log(`‚úÖ ${funcao}: Fun√ß√£o existe (erro de par√¢metros)`);
                    }
                }
            } else if (data && data.length > 0) {
                console.log(`‚úÖ ${funcao}: Fun√ß√£o encontrada`);
            } else {
                console.log(`‚ùå ${funcao}: Fun√ß√£o n√£o encontrada`);
            }
        } catch (err) {
            console.log(`‚ùì ${funcao}: Verifica√ß√£o inconclusiva - ${err.message}`);
        }
    }
}

async function verificarDadosMetricas() {
    console.log('\nüìä 4. VERIFICA√á√ÉO DE DADOS EM TABELAS DE M√âTRICAS');
    console.log('-' .repeat(50));
    
    // Verificar analytics_tenant_metrics para o tenant espec√≠fico
    try {
        const { data: tenantMetrics } = await supabase
            .from('analytics_tenant_metrics')
            .select('*')
            .eq('tenant_id', TARGET_TENANT)
            .order('metric_date', { ascending: false })
            .limit(5);
        
        console.log(`üìà analytics_tenant_metrics para ${TARGET_TENANT}:`);
        console.log(`   Registros: ${tenantMetrics?.length || 0}`);
        if (tenantMetrics && tenantMetrics.length > 0) {
            tenantMetrics.forEach(metric => {
                console.log(`   - ${metric.metric_date}: ${metric.total_appointments} appointments, R$ ${metric.total_revenue}`);
            });
        }
    } catch (error) {
        console.log('‚ùå Erro ao verificar analytics_tenant_metrics:', error.message);
    }
    
    // Verificar platform_metrics
    try {
        const { data: platformMetrics } = await supabase
            .from('platform_metrics')
            .select('*')
            .order('metric_date', { ascending: false })
            .limit(3);
        
        console.log(`üè¢ platform_metrics:`);
        console.log(`   Registros: ${platformMetrics?.length || 0}`);
        if (platformMetrics && platformMetrics.length > 0) {
            platformMetrics.forEach(metric => {
                console.log(`   - ${metric.metric_date}: MRR: R$ ${metric.total_mrr}, Tenants: ${metric.active_tenants}`);
            });
        }
    } catch (error) {
        console.log('‚ùå Erro ao verificar platform_metrics:', error.message);
    }
}

async function testarFuncoes() {
    console.log('\nüß™ 5. TESTE DE FUN√á√ïES EXISTENTES');
    console.log('-' .repeat(50));
    
    // Tentar chamar get_platform_metrics_complete
    try {
        const { data, error } = await supabase
            .rpc('get_platform_metrics_complete');
        
        if (error) {
            console.log('‚ùå get_platform_metrics_complete:', error.message);
        } else {
            console.log('‚úÖ get_platform_metrics_complete: Funcionando');
            console.log('   Resultado:', JSON.stringify(data, null, 2));
        }
    } catch (err) {
        console.log('‚ùå get_platform_metrics_complete: Erro -', err.message);
    }
    
    // Tentar chamar get_saas_metrics
    try {
        const { data, error } = await supabase
            .rpc('get_saas_metrics');
        
        if (error) {
            console.log('‚ùå get_saas_metrics:', error.message);
        } else {
            console.log('‚úÖ get_saas_metrics: Funcionando');
            console.log('   Registros retornados:', data?.length || 0);
        }
    } catch (err) {
        console.log('‚ùå get_saas_metrics: Erro -', err.message);
    }
    
    // Tentar chamar get_tenant_metrics para o tenant espec√≠fico
    try {
        const { data, error } = await supabase
            .rpc('get_tenant_metrics', { p_tenant_id: TARGET_TENANT });
        
        if (error) {
            console.log('‚ùå get_tenant_metrics:', error.message);
        } else {
            console.log('‚úÖ get_tenant_metrics: Funcionando');
            console.log('   Resultado:', JSON.stringify(data, null, 2));
        }
    } catch (err) {
        console.log('‚ùå get_tenant_metrics: Erro -', err.message);
    }
}

async function relatorioFinal() {
    console.log('\nüìã 6. RELAT√ìRIO FINAL E RECOMENDA√á√ïES');
    console.log('=' .repeat(80));
    
    console.log(`
üéØ RESUMO DA INSPE√á√ÉO:

DADOS BASE:
- Tenant ${TARGET_TENANT}: Verificar se existe e tem dados
- Appointments: Verificar quantos registros existem
- Users: Verificar relacionamentos
- Services: Verificar configura√ß√µes

TABELAS DE M√âTRICAS:
- Verificar quais tabelas existem
- Verificar se est√£o populadas
- Identificar tabelas em falta

FUN√á√ïES SQL:
- Verificar quais fun√ß√µes est√£o implementadas
- Testar funcionamento das fun√ß√µes principais
- Identificar fun√ß√µes necess√°rias

PR√ìXIMOS PASSOS RECOMENDADOS:
1. Se dados base existem mas m√©tricas est√£o vazias ‚Üí Executar scripts de popula√ß√£o
2. Se fun√ß√µes n√£o existem ‚Üí Executar scripts SQL de cria√ß√£o
3. Se dados base n√£o existem ‚Üí Criar dados de teste
4. Se tudo existe ‚Üí Verificar configura√ß√£o do AnalyticsService

ARQUIVOS IMPORTANTES IDENTIFICADOS:
- /database/complete-platform-metrics-with-all-data.sql
- /database/analytics-optimization-schema.sql  
- /src/services/analytics.service.ts
- /src/routes/dashboard-apis.ts
    `);
}

// Executar inspe√ß√£o
if (require.main === module) {
    inspecaoCompleta()
        .then(() => {
            console.log('\nüéØ INSPE√á√ÉO SISTEM√ÅTICA COMPLETA FINALIZADA!');
            process.exit(0);
        })
        .catch(error => {
            console.error('üí• Erro fatal na inspe√ß√£o:', error);
            process.exit(1);
        });
}

module.exports = { inspecaoCompleta };